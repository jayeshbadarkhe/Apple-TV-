!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).MusicKit={})}(this,(function(e){"use strict";var t=void 0!==typeof self?self:this;
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */function __decorate$1(e,t,i,r){var s,n=arguments.length,a=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(s=e[o])&&(a=(n<3?s(a):n>3?s(t,i,a):s(t,i))||a);return n>3&&a&&Object.defineProperty(t,i,a),a}function __metadata$1(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function __awaiter$1(e,t,i,r){return new(i||(i=Promise))((function(s,n){function fulfilled(e){try{step(r.next(e))}catch(t){n(t)}}function rejected(e){try{step(r.throw(e))}catch(t){n(t)}}function step(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(fulfilled,rejected)}step((r=r.apply(e,t||[])).next())}))}var i="undefined"!=typeof FastBoot?FastBoot.require("buffer").Buffer:"undefined"!=typeof process&&null!==process.versions&&null!==process.versions.node?Buffer:window.Buffer;function memoize(e){return function(...t){let i="",r=t.length;for(e._memoized=e._memoized||{};r--;){const e=t[r];i+=e===Object(e)?JSON.stringify(e):e}return i in e._memoized?e._memoized[i]:e._memoized[i]=e(...t)}}function isObject$1(e){return!!e&&"object"==typeof e&&!Array.isArray(e)}function generateUUID(){let e=strRandomizer()+strRandomizer();for(;e.length<16;)e+=strRandomizer();return e.slice(0,16)}function strRandomizer(){return Math.random().toString(16).substring(2)}const r=memoize(e=>/^[a|i|l|p]{1}\.[a-zA-Z0-9]+$/.test(e)),s=memoize(e=>/^(a\.)?[a-zA-Z0-9]+$/.test(e));function isNodeEnvironment$1(e){const isDefined=e=>null!=e;return 0===arguments.length&&"undefined"!=typeof process&&(e=process),isDefined(e)&&isDefined(e.versions)&&isDefined(e.versions.node)||"undefined"!=typeof FastBoot}const n=memoize(isNodeEnvironment$1()?e=>i.from(e,"base64").toString("binary"):e=>window.atob(e));memoize(isNodeEnvironment$1()?e=>i.from(e).toString("base64"):e=>window.btoa(e));const debounce=(e,t=250,i={isImmediate:!1})=>{let r;return function(...s){const n=this,a=i.isImmediate&&void 0===r;void 0!==r&&clearTimeout(r),r=setTimeout((function(){r=void 0,i.isImmediate||e.apply(n,s)}),t),a&&e.apply(n,s)}},arrayEquals=(e,t)=>!!e&&!!t&&[].every.call(e,(e,i)=>e===t[i]),a=memoize(e=>{const t=new Uint16Array(e),i=t.length;let r="";for(let s=0;s<i;s++)r+=String.fromCharCode(t[s]);return r}),o=memoize(e=>{const t=n(e);return l(t)});function ensureArray(e=[]){return Array.isArray(e)?e:[e]}const l=memoize(e=>{const t=e.length,i=new ArrayBuffer(t),r=new Uint8Array(i);for(let s=0;s<t;s++)r[s]=e.charCodeAt(s);return r}),d=memoize(e=>{const t=e.length,i=new ArrayBuffer(2*t),r=new Uint16Array(i);for(let s=0;s<t;s++)r[s]=e.charCodeAt(s);return r}),c=memoize(e=>{let t,i,r,s,n,a,o,l=0;const d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";let c="";for(;l<e.length;)t=e[l++],i=l<e.length?e[l++]:Number.NaN,r=l<e.length?e[l++]:Number.NaN,s=t>>2,n=(3&t)<<4|i>>4,a=(15&i)<<2|r>>6,o=63&r,isNaN(i)?a=o=64:isNaN(r)&&(o=64),c+=d.charAt(s)+d.charAt(n)+d.charAt(a)+d.charAt(o);return c});
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */
function __rest(e,t){var i={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(i[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(r=Object.getOwnPropertySymbols(e);s<r.length;s++)t.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(e,r[s])&&(i[r[s]]=e[r[s]])}return i}function __decorate(e,t,i,r){var s,n=arguments.length,a=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(s=e[o])&&(a=(n<3?s(a):n>3?s(t,i,a):s(t,i))||a);return n>3&&a&&Object.defineProperty(t,i,a),a}function __metadata(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function __awaiter(e,t,i,r){return new(i||(i=Promise))((function(s,n){function fulfilled(e){try{step(r.next(e))}catch(t){n(t)}}function rejected(e){try{step(r.throw(e))}catch(t){n(t)}}function step(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(fulfilled,rejected)}step((r=r.apply(e,t||[])).next())}))}function hasOwn(e,t){return Object.prototype.hasOwnProperty.call(Object(e),t)}function transform$a(e,t,i=!1){return i&&(e=Object.keys(e).reduce((t,i)=>(t[e[i]]=i,t),{})),Object.keys(e).reduce((i,r)=>{const s=e[r],n="function"==typeof s?s():function(e,t){return t.split(".").reduce((e,t)=>{if(void 0!==e)return e[t]},e)}(t,s);return n&&function(e,t,i){t.split(".").reduce((t,r,s,n)=>{const a=s===n.length-1,o=hasOwn(t,r),l=t[r]instanceof Object,d=null===t[r];if(!a&&o&&(!l||d))throw new TypeError(`Value at ${n.slice(0,s+1).join(".")} in keypath is not an Object.`);return a?(t[r]=i,e):o?t[r]:t[r]={}},e)}(i,r,n),i},{})}function transformKeys(e,t){return Object.keys(e).reduce((i,r)=>(i[t(r)]=e[r],i),{})}class GenericStorage{constructor(e={}){this.data=e}get data(){return this._data}set data(e){this._data=e}get length(){return this.keys.length}get keys(){return Object.keys(this.data)}getItem(e){return this.data[e]||null}setItem(e,t){this.data[e]=t}removeItem(e){delete this.data[e]}clear(){this.keys.forEach(e=>this.removeItem(e))}key(e){return this.keys[e]||null}}function getCookie(e="",t=document.cookie){const i=t.match(new RegExp(`(?:^|;\\s*)${e}=([^;]*)`));if(i)return i[1]}function setCookie(e,t,i="",r=14,s,n){const a=new Date;s=null!=s?s:window;const o=(n=null!=n?n:/\./.test(s.location.hostname)?s.location.hostname:"").length>0?`domain=${n}; `:"";a.setTime(a.getTime()+24*r*60*60*1e3);let l="";"https:"===s.location.protocol&&(l="; secure"),s.document.cookie=`${e}=${t}; expires=${a.toUTCString()}; ${o}path=${i}${l}`}function removeCookie(e,t,i){setCookie(e,"","/",0,t,i)}function hasSessionStorage(){let e=!1;try{e="undefined"!=typeof sessionStorage}catch(t){}return e}function getSessionStorage(){let e;return hasSessionStorage()&&(e=sessionStorage),e}function hasLocalStorage(){let e=!1;try{e="undefined"!=typeof localStorage}catch(t){}return e}function getLocalStorage(){let e;return hasLocalStorage()&&(e=localStorage),e}class Notifications{constructor(e=[],t){this._eventRegistry={},e.forEach(e=>{this._eventRegistry[e]=[]}),t&&t.namespace&&(this.dispatchNamespace="com.apple."+t.namespace),this.shouldStorageDispatch&&(this._handleGlobalStorageEvent=this._handleGlobalStorageEvent.bind(this),window.addEventListener("storage",this._handleGlobalStorageEvent))}get shouldStorageDispatch(){return"undefined"!=typeof window&&hasSessionStorage()&&this.dispatchNamespace}addEventListener(e,t){Array.isArray(this._eventRegistry[e])&&this._eventRegistry[e].push(t)}dispatchEvent(e,t){Array.isArray(this._eventRegistry[e])&&this._eventRegistry[e].forEach(e=>e(t))}dispatchDistributedEvent(e,t){var i;if(this.dispatchEvent(e,t),this.shouldStorageDispatch){const r=`${this.dispatchNamespace}:${e}`;null===(i=getSessionStorage())||void 0===i||i.setItem(r,JSON.stringify(t))}}removeEventListener(e,t){if(Array.isArray(this._eventRegistry[e])){const i=this._eventRegistry[e].indexOf(t);this._eventRegistry[e].splice(i,1)}}_handleGlobalStorageEvent(e){var t;if(this.dispatchNamespace&&(null===(t=e.key)||void 0===t?void 0:t.startsWith(this.dispatchNamespace+":"))){const t=e.key.substring(this.dispatchNamespace.length+1);this.dispatchEvent(t,JSON.parse(e.newValue))}}}let isMergeableObject=function(e){return function(e){return!!e&&"object"==typeof e}(e)&&!function(e){let t=Object.prototype.toString.call(e);return"[object RegExp]"===t||"[object Date]"===t||function(e){return e.$$typeof===u}(e)}(e)};let u="function"==typeof Symbol&&Symbol.for?Symbol.for("react.element"):60103;function cloneUnlessOtherwiseSpecified(e,t){return!1!==t.clone&&t.isMergeableObject(e)?deepmerge((i=e,Array.isArray(i)?[]:{}),e,t):e;var i}function defaultArrayMerge(e,t,i){return e.concat(t).map((function(e){return cloneUnlessOtherwiseSpecified(e,i)}))}function getKeys(e){return Object.keys(e).concat(function(e){return Object.getOwnPropertySymbols?Object.getOwnPropertySymbols(e).filter((function(t){return e.propertyIsEnumerable(t)})):[]}(e))}function mergeObject(e,t,i){let r={};return i.isMergeableObject(e)&&getKeys(e).forEach((function(t){r[t]=cloneUnlessOtherwiseSpecified(e[t],i)})),getKeys(t).forEach((function(s){i.isMergeableObject(t[s])&&e[s]?r[s]=function(e,t){if(!t.customMerge)return deepmerge;let i=t.customMerge(e);return"function"==typeof i?i:deepmerge}(s,i)(e[s],t[s],i):r[s]=cloneUnlessOtherwiseSpecified(t[s],i)})),r}function deepmerge(e,t,i){(i=i||{}).arrayMerge=i.arrayMerge||defaultArrayMerge,i.isMergeableObject=i.isMergeableObject||isMergeableObject;let r=Array.isArray(t);return r===Array.isArray(e)?r?i.arrayMerge(e,t,i):mergeObject(e,t,i):cloneUnlessOtherwiseSpecified(t,i)}var h;deepmerge.all=function(e,t){if(!Array.isArray(e))throw new Error("first argument should be an array");return e.reduce((function(e,i){return deepmerge(e,i,t)}),{})},function(e){e.dataRecordDidDelete="dataRecordDidDelete",e.dataRecordWillDelete="dataRecordWillDelete",e.dataRecordDidMaterialize="dataRecordDidMaterialize",e.dataRecordDidPopulate="dataRecordDidPopulate",e.dataRecordWillPopulate="dataRecordWillPopulate"}(h||(h={}));const isDataRecord=e=>!(!e||"function"!=typeof e.hasAttributes||"function"!=typeof e.hasRelationships||"function"!=typeof e.hasViews||"function"!=typeof e.serialize);class DataRecord{constructor(e,t,i={}){this.type=e,this.id=t,this._mjs={attributes:[],relationships:[],views:[]},this._meta={},this._mjs=Object.assign(Object.assign({},this._mjs),i)}hasProperties(e){return!e||(e.attributes||e.relationships||e.views?!(e.attributes&&!this.hasAttributes(e.attributes))&&(!(e.relationships&&!this.hasRelationships(e.relationships))&&!(e.views&&!this.hasViews(e.views))):this.hasAttributes()||this.hasRelationships()||this.hasViews())}hasAttributes(e){return this._hasProperties(this._mjs.attributes,e)}hasRelationships(e){return this._hasProperties(this._mjs.relationships,e)}hasViews(e){return this._hasProperties(this._mjs.views,e)}meta(e){return e?this._meta[e]:this._meta}serialize(e=!0,t={},i={}){const r={id:this.id,type:this.type};return t[`${this.type}-${this.id}`]&&!i.allowFullDuplicateSerializations?r:(t[`${this.type}-${this.id}`]=!0,this.hasAttributes()&&(r.attributes=this._mjs.attributes.reduce((e,t)=>(e[t]=this[t],e),{})),this._mjs.relationships.length>0&&(r.relationships=this._serializeRelatedData(this._mjs.relationships,t,i)),this._mjs.views.length>0&&(r.views=this._serializeRelatedData(this._mjs.views,t,i)),e?{data:r}:r)}setProperty(e,t,i="attributes",r={}){function isMergeableObject(e){return!(!e||"object"!=typeof e||e instanceof DataRecord)}hasOwn(this,e)||(this._mjs[i]||(this._mjs[i]=[]),this._mjs[i].push(e));const setDescriptor=e=>({value:e,writable:!0,configurable:!0,enumerable:!0});this[e]&&t&&"object"==typeof this[e]&&"object"==typeof t?"attributes"===i?Object.defineProperty(this,e,setDescriptor(deepmerge(this[e],t,{arrayMerge:function(e,t,i){return t},isMergeableObject:isMergeableObject}))):"relationships"===i&&Array.isArray(this[e])&&r.extendRelationships?Object.defineProperty(this,e,setDescriptor(deepmerge(this[e],t,{isMergeableObject:isMergeableObject}))):Object.defineProperty(this,e,setDescriptor(t)):Object.defineProperty(this,e,setDescriptor(t))}removeRelative(e,t){this[e]&&(Array.isArray(this[e])?this[e]=this[e].filter(e=>e.id!==t):delete this[e])}setParent(e){const t=this._mjs.parents,i=t&&t.length>0;this._mjs.parents=i?t.concat(e):e}_hasProperties(e,t){return!!e&&(t?ensureArray(t).every(t=>e.includes(t)):e.length>0)}_serializeRelatedData(e,t={},i={}){return e.reduce((e,r)=>{if(i.excludeRelationships&&i.excludeRelationships.has(r))return e;if(i.includeRelationships&&!i.includeRelationships.has(r))return e;const s=this[r];return Array.isArray(s)?e[r]={data:s.map(e=>"function"==typeof e.serialize?e.serialize(!1,t,i):e)}:e[r]=s&&"function"==typeof s.serialize?s.serialize(!1,t,i):s,e},{})}}class DataStore extends Notifications{constructor(e={}){super([h.dataRecordDidDelete,h.dataRecordWillDelete,h.dataRecordDidMaterialize,h.dataRecordWillPopulate,h.dataRecordDidPopulate]),this._removeOnExpiration=!1,this._shouldDisableRecordReuse=!0,this._records={},this._expiryRecords=new Set,this._removeOnExpiration=!!e.removeOnExpiration,this._mapping=e.mapping,this._shouldDisableRecordReuse=!!e.shouldDisableRecordReuse,this.filter=e.filter}get mapping(){return this._mapping}set mapping(e){this._mapping=e}clear(){this._records={},this._expiryRecords=new Set}peek(e,t,i){if(this._checkForExpiredRecords(),!this._records[e])return t?null:[];if(!t)return Object.values(this._records[e]);if(Array.isArray(t))return t.map(t=>{const r=this._records[e][t];if(r&&r.hasProperties(i))return r});const r=this._records[e][t];return r&&r.hasProperties(i)?r:null}populateDataRecords(e,t={},i={}){if(!e.data)return[];if(!Array.isArray(e.data))return this.populateDataRecord(e.data,t,i);const r=[];return e.data.forEach((e,s)=>{const n=Object.assign(Object.assign({},i),{parents:i.parents?[Object.assign(Object.assign({},i.parents[0]),{position:s})]:[]});i.parents&&(i.parents[0].position=s);const a=this.populateDataRecord(e,t,n);r.push(a)}),r}populateDataRecord(e,t={},i){const r=i.filter||this.filter,s=i.mapping||this.mapping;if(r&&!r(e))return;if(s){let t="function"==typeof s?s(e):transform$a(s,e);Object.assign(e,t)}this._shouldDisableRecordReuse&&(t={});const n=this._materializeRecord(t,Object.assign({id:e.id,type:e.type},i));return e.meta&&(n._meta=e.meta),e.attributes&&e.attributes.cachingPolicy&&e.attributes.cachingPolicy.maxAge&&(n._mjs.expiration=Date.now()+1e3*e.attributes.cachingPolicy.maxAge,this._removeOnExpiration&&this._expiryRecords.add(n)),this._populateDataAttributes(e,n),"object"==typeof e.relationships&&Object.keys(e.relationships).forEach(r=>{let a=e.relationships[r];a&&"data"in a&&(a=this.populateDataRecords(a,t,{mapping:s,parents:[{relationshipName:r,parentType:n.type,parentId:n.id}]}),n.setProperty(r,a,"relationships",i))}),"object"==typeof e.views&&Object.keys(e.views).forEach(i=>{const r=e.views[i];if(r.attributes||r.data){const e=new DataRecord("view",i);if(this._populateDataAttributes(r,e),r.data){const i=this.populateDataRecords(r,t,s);e.setProperty("data",i,"relationships")}n.setProperty(i,e,"views")}}),n}query(e,t){this._checkForExpiredRecords();let includeRecord=e=>!1;return"string"==typeof e&&t?includeRecord=i=>(null==i?void 0:i[e])===t:"function"==typeof e?includeRecord=t=>{try{return e(t)}catch(i){return!1}}:"object"==typeof e&&(includeRecord=t=>{const i=Object.keys(e);let r=0;return i.forEach(i=>{(null==t?void 0:t[i])===e[i]&&r++}),i.length===r}),Object.values(this._records).reduce((e,t)=>(Object.values(t).forEach(t=>{includeRecord(t)&&e.push(t)}),e),[])}remove(e,t){setTimeout(this._checkForExpiredRecords.bind(this),0);if(!hasOwn(this._records,e))return;const i=this.peek(e,t);i&&(this.dispatchEvent(h.dataRecordWillDelete,[e,t]),i._mjs.parents&&i._mjs.parents.length>0&&i._mjs.parents.forEach(({relationshipName:e,parentType:t,parentId:r})=>{this.peek(t,r).removeRelative(e,i.id)}),delete this._records[e][t],this.dispatchEvent(h.dataRecordDidDelete,[e,t]))}save(e,t={}){return setTimeout(this._checkForExpiredRecords.bind(this),0),this.populateDataRecords(e,this._records,t)}_populateDataAttributes(e,t){"object"==typeof e.attributes&&(this.dispatchEvent(h.dataRecordWillPopulate,[t.type,t.id]),Object.keys(e.attributes).forEach(i=>{t.setProperty(i,e.attributes[i],"attributes")}),this.dispatchEvent(h.dataRecordDidPopulate,[t.type,t.id]))}_materializeRecord(e,t){const{type:i,id:r}=t,s=__rest(t,["type","id"]);return e[i]=e[i]||{},e[i][r]?e[i][r].setParent(s.parents||[]):e[i][r]=new DataRecord(i,r,s),this.dispatchEvent(h.dataRecordDidMaterialize,[i,r]),e[i][r]}_checkForExpiredRecords(){const e=[];this._expiryRecords.forEach(t=>{Date.now()>t._mjs.expiration&&(e.push([t.type,t.id]),this._expiryRecords.delete(t))}),e.forEach(e=>{this.remove(...e)})}}class DeveloperToken{constructor(e){if(this.token=e,!e||!/^[a-z0-9\-\_]{16,}\.[a-z0-9\-\_]{16,}\.[a-z0-9\-\_]{16,}/i.test(e))throw new Error("Invalid token.");const[t,i]=e.split("."),{exp:r,iss:s}=this._decode(i);if(this.expiration=1e3*r,this.isExpired)throw new Error("Initialized with an expired token.");this.teamId=s;const{kid:n}=this._decode(t);this.keyId=n}get isExpired(){return this.expiration<Date.now()}_decode(e){return JSON.parse(n(e))}}const p={400:"REQUEST_ERROR",401:"UNAUTHORIZED_ERROR",403:"ACCESS_DENIED",404:"NOT_FOUND",405:"NOT_FOUND",413:"REQUEST_ERROR",414:"REQUEST_ERROR",429:"QUOTA_EXCEEDED",500:"SERVER_ERROR",501:"NOT_FOUND",503:"SERVICE_UNAVAILABLE"},y={"-1004":"DEVICE_LIMIT",1010:p[404],2002:"AUTHORIZATION_ERROR",2034:"TOKEN_EXPIRED",3059:"DEVICE_LIMIT",3063:"SUBSCRIPTION_ERROR",3076:"CONTENT_UNAVAILABLE",3082:"CONTENT_RESTRICTED",3084:"STREAM_UPSELL",5002:p[500],180202:"PLAYREADY_CBC_ENCRYPTION_ERROR",190121:"WIDEVINE_CDM_EXPIRED"},m=[],g=new Set(["UNSUPPORTED_ERROR","CONTENT_EQUIVALENT","CONTENT_UNAVAILABLE","CONTENT_UNSUPPORTED","SERVER_ERROR","SUBSCRIPTION_ERROR"]);class MKError extends Error{constructor(e,t){super(),this.errorCode="UNKNOWN_ERROR",e&&g.has(e)?(this.name=this.errorCode=e,this.message=this.description=t||e):t||"string"!=typeof e?(this.name=this.errorCode=e||"UNKNOWN_ERROR",t&&(this.message=this.description=t)):(this.name=this.errorCode="UNKNOWN_ERROR",this.message=this.description=e),m.push(this),Error.captureStackTrace&&Error.captureStackTrace(this,MKError)}static get errors(){return m}static playActivityError(e){return new this("PLAY_ACTIVITY",e)}static parseError(e){return new this("PARSE_ERROR",e)}static responseError(e){const{status:t,statusText:i}=e,r=new this(p[t]||"NETWORK_ERROR",i||""+t);return r.data=e,r}static serverError(e){let{status:t,dialog:i,failureType:r,customerMessage:s,errorMessage:n,message:a}=e;i&&(a=i.message||i.customerMessage||i.errorMessage,i.message=a);const o=y[r]||y[t]||"UNKNOWN_ERROR",l=new this(o,a||s||n);return"STREAM_UPSELL"===o&&i&&i.okButtonAction&&i.okButtonAction.url&&(i.okButtonAction.url=i.okButtonAction.url.replace(/\&(?:challenge|key-system|uri|user-initiated)=[^\&]+/gim,"")),l.dialog=i,l}static internalError(e){return new this(MKError.INTERNAL_ERROR,e)}}MKError.ACCESS_DENIED=p[403],MKError.AGE_VERIFICATION="AGE_VERIFICATION",MKError.AUTHORIZATION_ERROR=y[2002],MKError.CONFIGURATION_ERROR="CONFIGURATION_ERROR",MKError.CONTENT_EQUIVALENT="CONTENT_EQUIVALENT",MKError.CONTENT_RESTRICTED=y[3082],MKError.CONTENT_UNAVAILABLE=y[3076],MKError.CONTENT_UNSUPPORTED="CONTENT_UNSUPPORTED",MKError.DEVICE_LIMIT=y[3059],MKError.INVALID_ARGUMENTS="INVALID_ARGUMENTS",MKError.PLAYREADY_CBC_ENCRYPTION_ERROR="PLAYREADY_CBC_ENCRYPTION_ERROR",MKError.MEDIA_CERTIFICATE="MEDIA_CERTIFICATE",MKError.MEDIA_DESCRIPTOR="MEDIA_DESCRIPTOR",MKError.MEDIA_LICENSE="MEDIA_LICENSE",MKError.MEDIA_KEY="MEDIA_KEY",MKError.MEDIA_PLAYBACK="MEDIA_PLAYBACK",MKError.MEDIA_SESSION="MEDIA_SESSION",MKError.NETWORK_ERROR="NETWORK_ERROR",MKError.NOT_FOUND=y[1010],MKError.PARSE_ERROR="PARSE_ERROR",MKError.PLAY_ACTIVITY="PLAY_ACTIVITY",MKError.QUOTA_EXCEEDED=p[429],MKError.REQUEST_ERROR=p[400],MKError.SERVER_ERROR=y[5002],MKError.SERVICE_UNAVAILABLE=p[503],MKError.STREAM_UPSELL=y[3084],MKError.SUBSCRIPTION_ERROR=y[3063],MKError.TOKEN_EXPIRED=y[2034],MKError.UNAUTHORIZED_ERROR=p[401],MKError.UNKNOWN_ERROR="UNKNOWN_ERROR",MKError.UNSUPPORTED_ERROR="UNSUPPORTED_ERROR",MKError.INTERNAL_ERROR="INTERNAL_ERROR",MKError.OUTPUT_RESTRICTED="OUTPUT_RESTRICTED",MKError.WIDEVINE_CDM_EXPIRED="WIDEVINE_CDM_EXPIRED";function invoke(e){return void 0===e||(e=>"function"!=typeof e)(e)?e:e()}const f=["trace","debug","info","warn","error"];class Nonsole{}f.forEach(e=>{Nonsole.prototype[e]=()=>{}});const v=new Nonsole,getConsole=()=>"undefined"==typeof console?v:console,_={},createLocalStorageFlag=e=>{const t=getLocalStorage(),i=e.toLowerCase().replace(/[^a-zA-Z0-9]+(.)/g,(e,t)=>t.toUpperCase());let r;return _.hasOwnProperty(i)?r=_[i]:(r={get:()=>null==t?void 0:t.getItem(e),json:()=>{const i=null==t?void 0:t.getItem(e);try{return i?JSON.parse(i):void 0}catch(r){return}},setJson:i=>{try{const r=JSON.stringify(i);null==t||t.setItem(e,r)}catch(r){}},remove:()=>null==t?void 0:t.removeItem(e),set:i=>null==t?void 0:t.setItem(e,i)},_[i]=r),r};createLocalStorageFlag("mk-debug"),createLocalStorageFlag("mk-debug-topic");const b=getLocalStorage(),getConfiguredLevel=(e="mk-debug",t=f.length)=>parseInt(T(e,t),10),T=memoize((e,t)=>{var i,r;return null!==(r=null===(i=null==b?void 0:b.getItem)||void 0===i?void 0:i.call(b,e))&&void 0!==r?r:""+t}),getAllowedLevels=e=>isNaN(e)||e<0?[]:f.slice(e),canLogTopic=(e,t)=>{const i=((e="mk-debug-topic",t="*")=>T(e,t))(t);return S(i).some(t=>t.test(e))},S=memoize(e=>e.split(/[\s,]+/).map(e=>{const t=e.replace(/\*/g,".*?");return new RegExp("^"+t+"$")})),trace=(e,...t)=>logMessage(Object.assign({level:"trace"},e),...t),debug=(e,...t)=>logMessage(Object.assign({level:"debug"},e),...t),info=(e,...t)=>logMessage(Object.assign({level:"info"},e),...t),warn=(e,...t)=>logMessage(Object.assign({level:"warn"},e),...t),error$1=(e,...t)=>logMessage(Object.assign({level:"error"},e),...t),log=(e,...t)=>logMessage(e,...t),logMessage=(e,...t)=>{let{level:i,levelKey:r,topic:s,topicKey:n}=e;if(i=null!=i?i:"debug",!((e,t)=>-1!==getAllowedLevels(getConfiguredLevel(t)).indexOf(e))(i,r))return;if(!canLogTopic(s,n))return;const a=getConsole();if("function"!=typeof a[i])return;let[o,...l]=t;void 0!==s&&(o=`${s}: ${o}`),a[i](o,...l)};class Logger$1{constructor(e){var t,i,r,s;this._levelFilterKey="mk-debug","string"==typeof e?(this._levelFilterKey=e,this.level=getConfiguredLevel(this._levelFilterKey,5)):"object"==typeof e?(this._levelFilterKey=null!==(t=e.levelFilterStorageKey)&&void 0!==t?t:this._levelFilterKey,this._topicFilterKey=null!==(i=e.topicFilterStorageKey)&&void 0!==i?i:this.generateDefaultTopicFilterStorageKey(this._levelFilterKey),this.topic=e.topic,this.level=null!==(r=e.level)&&void 0!==r?r:getConfiguredLevel(this._levelFilterKey,5)):this.level=null!=e?e:getConfiguredLevel(this._levelFilterKey,5),this._topicFilterKey=null!==(s=this._topicFilterKey)&&void 0!==s?s:this.generateDefaultTopicFilterStorageKey(this._levelFilterKey)}get enabled(){return this.level<5}set enabled(e){this.level=e?1:5}debug(e,...t){this.callLogMethod(debug,e,...t)}error(e,...t){this.callLogMethod(error$1,e,...t)}log(e,...t){this.callLogMethod(log,e,...t)}info(e,...t){this.callLogMethod(info,e,...t)}trace(e,...t){this.callLogMethod(trace,e,...t)}warn(e,...t){this.callLogMethod(warn,e,...t)}callLogMethod(e,t,...i){var r,s;const n={levelKey:this._levelFilterKey,topicKey:this._topicFilterKey,topic:this.topic};let a=t;var o;"object"==typeof(o=t)&&null!==o&&"string"==typeof o.topic&&(n.topic=null!==(r=t.topic)&&void 0!==r?r:n.topic,a=null!==(s=t.message)&&void 0!==s?s:i.shift()),e(n,a,...i)}generateDefaultTopicFilterStorageKey(e){return e+"-topic"}}const E=new Logger$1,DEFAULT_CACHE_KEY_FUNCTION=(e,t)=>`${t}${e}`;class NetworkCache{constructor(e={}){this.storage=e.storage||new GenericStorage,this.prefix=e.prefix||"",this.ttl=e.ttl||3e5,this.cacheKeyFunction=e.cacheKeyFunction||DEFAULT_CACHE_KEY_FUNCTION}getItem(e){const t=this.cacheKeyForPath(e),i=this.storage.getItem(t);if(null!==i){const{x:e,d:r}=JSON.parse(i);if(e>Date.now())return r;this.storage.removeItem(t)}}setItem(e,t,i=this.ttl){const r=this.cacheKeyForPath(e);this.storage.setItem(r,JSON.stringify({x:Date.now()+i,d:t}))}removeItem(e){const t=this.cacheKeyForPath(e);this.storage.removeItem(t)}removeItemsMatching(e,t=!0){const i=this.cacheKeyForPath(e);this.removeItemsMatchingCacheKey(i,t)}clear(){this.removeItemsMatchingCacheKey(this.prefix,!1)}removeItemsMatchingCacheKey(e,t){const i=new RegExp(`^${e}${t?"$":""}`);(this.storage instanceof GenericStorage?this.storage.keys:Object.keys(this.storage)).forEach(e=>{e&&i.test(e)&&this.storage.removeItem(e)})}cacheKeyForPath(e){return this.cacheKeyFunction(e,this.prefix)}}const addPathToURL=(e,t)=>void 0===e||""===e?t||"":void 0===t?e:(e.endsWith("/")&&(e=e.slice(0,-1)),t.startsWith("/")&&(t=t.slice(1)),`${e}/${t}`),addQueryParamsToURL=(e,t)=>{const i=urlEncodeParameters(t);return""===i?e:e.endsWith("&")||e.endsWith("?")?`${e}${i}`:e.includes("?")?`${e}&${i}`:`${e}?${i}`},k="undefined"!=typeof Headers,headersToDict=e=>{let t={};var i;return i=e,k&&i instanceof Headers?e.forEach((e,i)=>t[i]=e):Array.isArray(e)?e.forEach(([e,i])=>t[e]=i):t=e,t},mergeFetchHeaders=(e={},t={})=>Object.assign(Object.assign({},headersToDict(e)),headersToDict(t)),mergeFetchOptions=(e,t)=>{if(e||t)return(null==e?void 0:e.headers)&&(null==t?void 0:t.headers)?Object.assign(Object.assign(Object.assign({},e),t),{headers:mergeFetchHeaders(e.headers,t.headers)}):Object.assign(Object.assign({},e),t)};function parseQueryParams(e){var t;if(!e||e.startsWith("http")&&!e.includes("?"))return{};try{return parseParams(null!==(t=e.split("?")[1])&&void 0!==t?t:e,"&",decodeURIComponent)}catch(i){return{}}}function parseParams(e,t="&",i=(e=>e)){return"string"!=typeof e?{}:e.split(t).map(e=>e.trim().split("=",2)).reduce((e,t)=>{const[r,s]=t;return""===r&&void 0===s||(e[i(r)]=i(s),void 0===s&&(e[i(r)]=void 0)),e},{})}function getMaxAgeFromHeaders(e){const t=function(e,t){if(void 0!==t)return k&&t instanceof Headers?t.get(e):t[e]}("cache-control",e);if(t){return(e=>{const t=Number(e);if(Number.isFinite(t))return t})(parseParams(t,",")["max-age"])}}function rewriteLastUrlPath(e,t){const i=e.split("/");return i.pop(),i.push(t),i.join("/")}const recursiveEncodeParameters=(e,t)=>Object.keys(e).reduce((i,r)=>{const s=e[r],n=t?`${t}[${encodeURIComponent(r)}]`:encodeURIComponent(r);return`${i}${i?"&":""}${isObject$1(s)?recursiveEncodeParameters(s,n):`${n}=${encodeURIComponent(""+s)}`}`},"");function urlEncodeParameters(e){return e?recursiveEncodeParameters(e):""}var P;!function(e){e.JSON="application/json",e.FORM="application/x-www-form-urlencoded"}(P||(P={}));class URLSession{constructor(e,t){var i;if(this.prefix="",this.method="GET",this.url=e,(t=t||{}).storage&&t.underlyingStorage)throw new Error("only pass storage OR underlyingStorage in sessionOptions to URLSession");const r=t.underlyingStorage||{};if(this.storage=t.storage||new GenericStorage(r),this.networkCache=new NetworkCache({storage:this.storage,prefix:this.prefix,cacheKeyFunction:this._key.bind(this)}),this.ttl=t.ttl||3e5,this._fetchOptions=Object.assign({},t.fetchOptions),"function"!=typeof t.fetch&&"function"!=typeof fetch)throw new Error("window.fetch is not defined");this._fetchFunction=null!==(i=t.fetch)&&void 0!==i?i:fetch.bind(window),this.headers=this._fetchOptions.headers||new Headers,delete this._fetchOptions.headers}clearCacheForRequest(e,t){"object"==typeof e&&(t=e,e=void 0);const i=this.constructURL(e,t);this.networkCache.removeItemsMatching(i)}request(e,t,i){var r;return __awaiter(this,void 0,void 0,(function*(){i||"object"!=typeof e||(i=t||{},t=e,e=void 0);let s={};"object"==typeof(i=Object.assign(Object.assign({method:this.method,headers:this.headers,reload:!1},this._fetchOptions),i)).queryParameters?(s=i.queryParameters,delete i.queryParameters):"GET"!==i.method&&"DELETE"!==i.method||(s=t);const n=this.constructURL(e,s),{method:a,reload:o=!1,useRawResponse:l}=i;if(i.headers=this.buildHeaders(i),delete i.reload,delete i.useRawResponse,"GET"===a&&!o){const e=this.getCacheItem(n);if(e)return Promise.resolve(e)}t&&Object.keys(t).length&&("POST"===a||"PUT"===a)&&(i.body=i.body||t,i.contentType===P.FORM?(i.body=urlEncodeParameters(i.body),i.headers.set("Content-Type",P.FORM)):(i.body=JSON.stringify(i.body),i.headers.set("Content-Type",P.JSON)));const d=yield this._fetchFunction(n,i);if(!d.ok)return Promise.reject(d);let c;try{c=yield d.json()}catch(h){c={}}if(c.errors)return Promise.reject(c.errors);const u=l?c:c.results||c.data||c;if("GET"===a){const e=null!==(r=getMaxAgeFromHeaders(d.headers))&&void 0!==r?r:this.ttl;this.setCacheItem(n,u,e)}return u}))}buildHeaders({headers:e,reload:t=!1}={}){void 0===e&&(e=this.headers);const i=(e=>new e.constructor(e))(e);return t&&i.set("Cache-Control","no-cache"),i}constructURL(e,t){return((e,t,i)=>addQueryParamsToURL(addPathToURL(e,t),i))(this.url,e,t)}getCacheItem(e){const t=this.networkCache.storage,i=`${this.prefix}${this.prefix}cache-mut`,r=t.getItem(i)||null,s=this.headers.get("Music-User-Token")||this.headers.get("Media-User-Token")||null;return s!==r&&(this.networkCache.clear(),null===s?t.removeItem(i):t.setItem(i,s)),this.networkCache.getItem(e)}setCacheItem(e,t,i=this.ttl){this.networkCache.setItem(e,t,i)}clearNetworkCache(){this.networkCache.clear()}_key(e,t){const i=function(e){try{const[t,i]=e.split("?",2);if(void 0===i)return t;const r=i.split("&").map(e=>e.split("=",2)),s=[...Array(r.length).keys()];s.sort((e,t)=>{const i=r[e],s=r[t];return i<s?-1:i>s?1:e-t});const n=s.map(e=>r[e]);return`${t}?${n.map(([e,t])=>void 0!==t?`${e}=${t}`:e).join("&")}`}catch(t){return e}}(e).toLowerCase().replace(this.url,"");return`${this.prefix}${i.replace(/[^-_0-9a-z]{1,}/g,".")}`}}class TokenSession extends URLSession{constructor(e,t,i){super(e,i),this._developerToken=new DeveloperToken(t),this.headers.set("Authorization","Bearer "+this.developerToken),i=i||{},this.userToken=i.userToken,this.userToken&&this.headers.set("Media-User-Token",this.userToken)}get developerToken(){return this._developerToken.token}}Date.now();function formatArtworkURL(e,t,i){return t=t||e.height||100,i=i||e.width||100,window.devicePixelRatio>=1.5&&(i*=2,t*=2),e.url.replace("{h}",""+t).replace("{w}",""+i).replace("{f}","jpeg")}var I,A,w,R;isNodeEnvironment$1(),e.PlaybackType=void 0,(I=e.PlaybackType||(e.PlaybackType={}))[I.none=0]="none",I[I.preview=1]="preview",I[I.unencryptedFull=2]="unencryptedFull",I[I.encryptedFull=3]="encryptedFull",function(e){e[e.none=0]="none",e[e.loading=1]="loading",e[e.ready=2]="ready",e[e.playing=3]="playing",e[e.ended=4]="ended",e[e.unavailable=5]="unavailable",e[e.restricted=6]="restricted",e[e.error=7]="error",e[e.unsupported=8]="unsupported"}(A||(A={})),e.PlaybackStates=void 0,(w=e.PlaybackStates||(e.PlaybackStates={}))[w.none=0]="none",w[w.loading=1]="loading",w[w.playing=2]="playing",w[w.paused=3]="paused",w[w.stopped=4]="stopped",w[w.ended=5]="ended",w[w.seeking=6]="seeking",w[w.waiting=8]="waiting",w[w.stalled=9]="stalled",w[w.completed=10]="completed",e.PresentationMode=void 0,(R=e.PresentationMode||(e.PresentationMode={}))[R.pictureinpicture=0]="pictureinpicture",R[R.inline=1]="inline";var O="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==t?t:"undefined"!=typeof self?self:{};function unwrapExports(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function createCommonjsModule(e,t){return e(t={exports:{}},t.exports),t.exports}var C=createCommonjsModule((function(e){var t=e.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=t)})),M=createCommonjsModule((function(e){var t=e.exports={version:"2.6.12"};"number"==typeof __e&&(__e=t)}));M.version;var _isObject=function(e){return"object"==typeof e?null!==e:"function"==typeof e},_anObject=function(e){if(!_isObject(e))throw TypeError(e+" is not an object!");return e},_fails=function(e){try{return!!e()}catch(t){return!0}},D=!_fails((function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})),N=C.document,L=_isObject(N)&&_isObject(N.createElement),x=!D&&!_fails((function(){return 7!=Object.defineProperty((e="div",L?N.createElement(e):{}),"a",{get:function(){return 7}}).a;var e})),U=Object.defineProperty,F={f:D?Object.defineProperty:function(e,t,i){if(_anObject(e),t=function(e,t){if(!_isObject(e))return e;var i,r;if(t&&"function"==typeof(i=e.toString)&&!_isObject(r=i.call(e)))return r;if("function"==typeof(i=e.valueOf)&&!_isObject(r=i.call(e)))return r;if(!t&&"function"==typeof(i=e.toString)&&!_isObject(r=i.call(e)))return r;throw TypeError("Can't convert object to primitive value")}(t,!0),_anObject(i),x)try{return U(e,t,i)}catch(r){}if("get"in i||"set"in i)throw TypeError("Accessors not supported!");return"value"in i&&(e[t]=i.value),e}},j=D?function(e,t,i){return F.f(e,t,function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}(1,i))}:function(e,t,i){return e[t]=i,e},B={}.hasOwnProperty,_has=function(e,t){return B.call(e,t)},$=0,V=Math.random(),_uid=function(e){return"Symbol(".concat(void 0===e?"":e,")_",(++$+V).toString(36))},W=createCommonjsModule((function(e){var t=C["__core-js_shared__"]||(C["__core-js_shared__"]={});(e.exports=function(e,i){return t[e]||(t[e]=void 0!==i?i:{})})("versions",[]).push({version:M.version,mode:"global",copyright:"© 2020 Denis Pushkarev (zloirock.ru)"})})),H=W("native-function-to-string",Function.toString),z=createCommonjsModule((function(e){var t=_uid("src"),i=(""+H).split("toString");M.inspectSource=function(e){return H.call(e)},(e.exports=function(e,r,s,n){var a="function"==typeof s;a&&(_has(s,"name")||j(s,"name",r)),e[r]!==s&&(a&&(_has(s,t)||j(s,t,e[r]?""+e[r]:i.join(String(r)))),e===C?e[r]=s:n?e[r]?e[r]=s:j(e,r,s):(delete e[r],j(e,r,s)))})(Function.prototype,"toString",(function(){return"function"==typeof this&&this[t]||H.call(this)}))})),_ctx=function(e,t,i){if(function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!")}(e),void 0===t)return e;switch(i){case 1:return function(i){return e.call(t,i)};case 2:return function(i,r){return e.call(t,i,r)};case 3:return function(i,r,s){return e.call(t,i,r,s)}}return function(){return e.apply(t,arguments)}},$export=function(e,t,i){var r,s,n,a,o=e&$export.F,l=e&$export.G,d=e&$export.S,c=e&$export.P,u=e&$export.B,h=l?C:d?C[t]||(C[t]={}):(C[t]||{}).prototype,p=l?M:M[t]||(M[t]={}),y=p.prototype||(p.prototype={});for(r in l&&(i=t),i)n=((s=!o&&h&&void 0!==h[r])?h:i)[r],a=u&&s?_ctx(n,C):c&&"function"==typeof n?_ctx(Function.call,n):n,h&&z(h,r,n,e&$export.U),p[r]!=n&&j(p,r,a),c&&y[r]!=n&&(y[r]=n)};C.core=M,$export.F=1,$export.G=2,$export.S=4,$export.P=8,$export.B=16,$export.W=32,$export.U=64,$export.R=128;var q,Y,G=$export,Q={}.toString,X=Object("z").propertyIsEnumerable(0)?Object:function(e){return"String"==function(e){return Q.call(e).slice(8,-1)}(e)?e.split(""):Object(e)},_defined=function(e){if(null==e)throw TypeError("Can't call method on  "+e);return e},_toIobject=function(e){return X(_defined(e))},J=Math.ceil,Z=Math.floor,_toInteger=function(e){return isNaN(e=+e)?0:(e>0?Z:J)(e)},ee=Math.min,te=Math.max,ie=Math.min,re=W("keys"),se=(q=!1,function(e,t,i){var r,s,n=_toIobject(e),a=(r=n.length)>0?ee(_toInteger(r),9007199254740991):0,o=function(e,t){return(e=_toInteger(e))<0?te(e+t,0):ie(e,t)}(i,a);if(q&&t!=t){for(;a>o;)if((s=n[o++])!=s)return!0}else for(;a>o;o++)if((q||o in n)&&n[o]===t)return q||o||0;return!q&&-1}),ne=re[Y="IE_PROTO"]||(re[Y]=_uid(Y)),ae="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(","),oe=Object.keys||function(e){return function(e,t){var i,r=_toIobject(e),s=0,n=[];for(i in r)i!=ne&&_has(r,i)&&n.push(i);for(;t.length>s;)_has(r,i=t[s++])&&(~se(n,i)||n.push(i));return n}(e,ae)},le={f:Object.getOwnPropertySymbols},de={f:{}.propertyIsEnumerable},_toObject=function(e){return Object(_defined(e))},ce=Object.assign,ue=!ce||_fails((function(){var e={},t={},i=Symbol(),r="abcdefghijklmnopqrst";return e[i]=7,r.split("").forEach((function(e){t[e]=e})),7!=ce({},e)[i]||Object.keys(ce({},t)).join("")!=r}))?function(e,t){for(var i=_toObject(e),r=arguments.length,s=1,n=le.f,a=de.f;r>s;)for(var o,l=X(arguments[s++]),d=n?oe(l).concat(n(l)):oe(l),c=d.length,u=0;c>u;)o=d[u++],D&&!a.call(l,o)||(i[o]=l[o]);return i}:ce;G(G.S+G.F,"Object",{assign:ue}),M.Object.assign;var he="undefined"!=typeof globalThis&&globalThis||"undefined"!=typeof self&&self||void 0!==he&&he,pe="URLSearchParams"in he,ye="Symbol"in he&&"iterator"in Symbol,me="FileReader"in he&&"Blob"in he&&function(){try{return new Blob,!0}catch(e){return!1}}(),ge="FormData"in he,fe="ArrayBuffer"in he;if(fe)var ve=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],_e=ArrayBuffer.isView||function(e){return e&&ve.indexOf(Object.prototype.toString.call(e))>-1};function normalizeName(e){if("string"!=typeof e&&(e=String(e)),/[^a-z0-9\-#$%&'*+.^_`|~!]/i.test(e)||""===e)throw new TypeError('Invalid character in header field name: "'+e+'"');return e.toLowerCase()}function normalizeValue(e){return"string"!=typeof e&&(e=String(e)),e}function iteratorFor(e){var t={next:function(){var t=e.shift();return{done:void 0===t,value:t}}};return ye&&(t[Symbol.iterator]=function(){return t}),t}function Headers$1(e){this.map={},e instanceof Headers$1?e.forEach((function(e,t){this.append(t,e)}),this):Array.isArray(e)?e.forEach((function(e){this.append(e[0],e[1])}),this):e&&Object.getOwnPropertyNames(e).forEach((function(t){this.append(t,e[t])}),this)}function consumed(e){if(e.bodyUsed)return Promise.reject(new TypeError("Already read"));e.bodyUsed=!0}function fileReaderReady(e){return new Promise((function(t,i){e.onload=function(){t(e.result)},e.onerror=function(){i(e.error)}}))}function readBlobAsArrayBuffer(e){var t=new FileReader,i=fileReaderReady(t);return t.readAsArrayBuffer(e),i}function bufferClone(e){if(e.slice)return e.slice(0);var t=new Uint8Array(e.byteLength);return t.set(new Uint8Array(e)),t.buffer}function Body(){return this.bodyUsed=!1,this._initBody=function(e){var t;this.bodyUsed=this.bodyUsed,this._bodyInit=e,e?"string"==typeof e?this._bodyText=e:me&&Blob.prototype.isPrototypeOf(e)?this._bodyBlob=e:ge&&FormData.prototype.isPrototypeOf(e)?this._bodyFormData=e:pe&&URLSearchParams.prototype.isPrototypeOf(e)?this._bodyText=e.toString():fe&&me&&((t=e)&&DataView.prototype.isPrototypeOf(t))?(this._bodyArrayBuffer=bufferClone(e.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):fe&&(ArrayBuffer.prototype.isPrototypeOf(e)||_e(e))?this._bodyArrayBuffer=bufferClone(e):this._bodyText=e=Object.prototype.toString.call(e):this._bodyText="",this.headers.get("content-type")||("string"==typeof e?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):pe&&URLSearchParams.prototype.isPrototypeOf(e)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},me&&(this.blob=function(){var e=consumed(this);if(e)return e;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){if(this._bodyArrayBuffer){var e=consumed(this);return e||(ArrayBuffer.isView(this._bodyArrayBuffer)?Promise.resolve(this._bodyArrayBuffer.buffer.slice(this._bodyArrayBuffer.byteOffset,this._bodyArrayBuffer.byteOffset+this._bodyArrayBuffer.byteLength)):Promise.resolve(this._bodyArrayBuffer))}return this.blob().then(readBlobAsArrayBuffer)}),this.text=function(){var e,t,i,r=consumed(this);if(r)return r;if(this._bodyBlob)return e=this._bodyBlob,t=new FileReader,i=fileReaderReady(t),t.readAsText(e),i;if(this._bodyArrayBuffer)return Promise.resolve(function(e){for(var t=new Uint8Array(e),i=new Array(t.length),r=0;r<t.length;r++)i[r]=String.fromCharCode(t[r]);return i.join("")}(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},ge&&(this.formData=function(){return this.text().then(decode)}),this.json=function(){return this.text().then(JSON.parse)},this}Headers$1.prototype.append=function(e,t){e=normalizeName(e),t=normalizeValue(t);var i=this.map[e];this.map[e]=i?i+", "+t:t},Headers$1.prototype.delete=function(e){delete this.map[normalizeName(e)]},Headers$1.prototype.get=function(e){return e=normalizeName(e),this.has(e)?this.map[e]:null},Headers$1.prototype.has=function(e){return this.map.hasOwnProperty(normalizeName(e))},Headers$1.prototype.set=function(e,t){this.map[normalizeName(e)]=normalizeValue(t)},Headers$1.prototype.forEach=function(e,t){for(var i in this.map)this.map.hasOwnProperty(i)&&e.call(t,this.map[i],i,this)},Headers$1.prototype.keys=function(){var e=[];return this.forEach((function(t,i){e.push(i)})),iteratorFor(e)},Headers$1.prototype.values=function(){var e=[];return this.forEach((function(t){e.push(t)})),iteratorFor(e)},Headers$1.prototype.entries=function(){var e=[];return this.forEach((function(t,i){e.push([i,t])})),iteratorFor(e)},ye&&(Headers$1.prototype[Symbol.iterator]=Headers$1.prototype.entries);var be=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];function Request(e,t){if(!(this instanceof Request))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');var i,r,s=(t=t||{}).body;if(e instanceof Request){if(e.bodyUsed)throw new TypeError("Already read");this.url=e.url,this.credentials=e.credentials,t.headers||(this.headers=new Headers$1(e.headers)),this.method=e.method,this.mode=e.mode,this.signal=e.signal,s||null==e._bodyInit||(s=e._bodyInit,e.bodyUsed=!0)}else this.url=String(e);if(this.credentials=t.credentials||this.credentials||"same-origin",!t.headers&&this.headers||(this.headers=new Headers$1(t.headers)),this.method=(i=t.method||this.method||"GET",r=i.toUpperCase(),be.indexOf(r)>-1?r:i),this.mode=t.mode||this.mode||null,this.signal=t.signal||this.signal,this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&s)throw new TypeError("Body not allowed for GET or HEAD requests");if(this._initBody(s),!("GET"!==this.method&&"HEAD"!==this.method||"no-store"!==t.cache&&"no-cache"!==t.cache)){var n=/([?&])_=[^&]*/;if(n.test(this.url))this.url=this.url.replace(n,"$1_="+(new Date).getTime());else{this.url+=(/\?/.test(this.url)?"&":"?")+"_="+(new Date).getTime()}}}function decode(e){var t=new FormData;return e.trim().split("&").forEach((function(e){if(e){var i=e.split("="),r=i.shift().replace(/\+/g," "),s=i.join("=").replace(/\+/g," ");t.append(decodeURIComponent(r),decodeURIComponent(s))}})),t}function Response(e,t){if(!(this instanceof Response))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');t||(t={}),this.type="default",this.status=void 0===t.status?200:t.status,this.ok=this.status>=200&&this.status<300,this.statusText=void 0===t.statusText?"":""+t.statusText,this.headers=new Headers$1(t.headers),this.url=t.url||"",this._initBody(e)}Request.prototype.clone=function(){return new Request(this,{body:this._bodyInit})},Body.call(Request.prototype),Body.call(Response.prototype),Response.prototype.clone=function(){return new Response(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new Headers$1(this.headers),url:this.url})},Response.error=function(){var e=new Response(null,{status:0,statusText:""});return e.type="error",e};var Te=[301,302,303,307,308];Response.redirect=function(e,t){if(-1===Te.indexOf(t))throw new RangeError("Invalid status code");return new Response(null,{status:t,headers:{location:e}})};var Se=he.DOMException;try{new Se}catch(sl){(Se=function(e,t){this.message=e,this.name=t;var i=Error(e);this.stack=i.stack}).prototype=Object.create(Error.prototype),Se.prototype.constructor=Se}function fetch$1(e,t){return new Promise((function(i,r){var s=new Request(e,t);if(s.signal&&s.signal.aborted)return r(new Se("Aborted","AbortError"));var n=new XMLHttpRequest;function abortXhr(){n.abort()}n.onload=function(){var e,t,r={status:n.status,statusText:n.statusText,headers:(e=n.getAllResponseHeaders()||"",t=new Headers$1,e.replace(/\r?\n[\t ]+/g," ").split("\r").map((function(e){return 0===e.indexOf("\n")?e.substr(1,e.length):e})).forEach((function(e){var i=e.split(":"),r=i.shift().trim();if(r){var s=i.join(":").trim();t.append(r,s)}})),t)};r.url="responseURL"in n?n.responseURL:r.headers.get("X-Request-URL");var s="response"in n?n.response:n.responseText;setTimeout((function(){i(new Response(s,r))}),0)},n.onerror=function(){setTimeout((function(){r(new TypeError("Network request failed"))}),0)},n.ontimeout=function(){setTimeout((function(){r(new TypeError("Network request failed"))}),0)},n.onabort=function(){setTimeout((function(){r(new Se("Aborted","AbortError"))}),0)},n.open(s.method,function(e){try{return""===e&&he.location.href?he.location.href:e}catch(t){return e}}(s.url),!0),"include"===s.credentials?n.withCredentials=!0:"omit"===s.credentials&&(n.withCredentials=!1),"responseType"in n&&(me?n.responseType="blob":fe&&s.headers.get("Content-Type")&&-1!==s.headers.get("Content-Type").indexOf("application/octet-stream")&&(n.responseType="arraybuffer")),!t||"object"!=typeof t.headers||t.headers instanceof Headers$1?s.headers.forEach((function(e,t){n.setRequestHeader(t,e)})):Object.getOwnPropertyNames(t.headers).forEach((function(e){n.setRequestHeader(e,normalizeValue(t.headers[e]))})),s.signal&&(s.signal.addEventListener("abort",abortXhr),n.onreadystatechange=function(){4===n.readyState&&s.signal.removeEventListener("abort",abortXhr)}),n.send(void 0===s._bodyInit?null:s._bodyInit)}))}fetch$1.polyfill=!0,he.fetch||(he.fetch=fetch$1,he.Headers=Headers$1,he.Request=Request,he.Response=Response);const K=()=>{},asAsync=e=>{e.then(K,K)},Ee=K,ke=isNodeEnvironment$1();class Browser{constructor(e){var t;e||(e="undefined"!=typeof window&&(null===(t=null===window||void 0===window?void 0:window.navigator)||void 0===t?void 0:t.userAgent)?window.navigator.userAgent:"");const i=e.toLowerCase();this.isEdge=/\sedge\//.test(i),this.isChrome=!this.isEdge&&/chrome/.test(i),this.isSafari=!this.isEdge&&!this.isChrome&&/safari/.test(i),this.isFirefox=!this.isEdge&&!this.isChrome&&!this.isSafari&&/firefox/.test(i),this.isIE=!this.isEdge&&!this.isChrome&&!this.isSafari&&!this.isFirefox&&/trident|msie/.test(i),this.isMobile=/mobile/.test(i),this.isAndroid=/android/.test(i),this.isiOS=this.isMobile&&/iphone|ipad|ipod/.test(i),this.isMacOs=!this.isMobile&&/macintosh/.test(i),this.isWebView=/(webview|(iphone|ipod|ipad)(?!.*safari\/)|android.*(wv|\.0\.0\.0)|\bfb[\w_]+\/(?:messenger)?|\binstagram|\btwitter)/.test(i),this.isEdge?this.engineVersion=i.match(/(?:edge).(\d+)/):(this.version=i.match(/(?:chrome|version|firefox|msie|rv).(\d+)\.(\d+)/),this.engineVersion=i.match(/(?:applewebkit|gecko|trident).(\d+)/)),this.version&&(this.majorVersion=parseInt(this.version[1],10),this.minorVersion=parseInt(this.version[2],10)),this.engineVersion&&(this.engineMajorVersion=parseInt(this.engineVersion[1],10))}static supportsEs6(){if("undefined"==typeof Symbol)return!1;try{new Function('"use strict";class Foo {}')(),new Function('"use strict";var bar = (x) => x+1')()}catch(e){return!1}return!0}}const Pe=new Browser;var Ie;!function(e){e.NONE="none",e.FAIRPLAY="com.apple.fps",e.PLAYREADY="com.microsoft.playready",e.WIDEVINE="com.widevine.alpha"}(Ie||(Ie={}));const Ae={app:{},features:{},urls:{}},we="mk-player-tsid",Re=document.createElement("video"),Oe=[],Ce=[];function deferPlayback(){fillAvailableElements("audio",Ce),fillAvailableElements("video",Oe),E.debug(`dom-helpers: defer playback called.  There are ${Oe.length} available video elements and ${Ce.length} available audio elements.`)}function fillAvailableElements(e,t){let i=100-t.length;for(;i>0;){const r=document.createElement(e);r.load(),t.push(r),i--}}var Me,De,Ne;function findMediaKeySystemAccess(e,t){return __awaiter(this,void 0,void 0,(function*(){for(let r=0;r<e.length;r++)try{const i=e[r];return[i,yield navigator.requestMediaKeySystemAccess(i,t)]}catch(i){}return[]}))}!function(e){e.playbackLicenseError="playbackLicenseError",e.playbackSessionError="playbackSessionError",e.manifestParsed="manifestParsed",e.audioCodecIdentified="audioCodecIdentified",e.audioTracksSwitched="audioTracksSwitched",e.audioTracksUpdated="audioTracksUpdated",e.textTracksSwitched="textTracksSwitched",e.textTracksUpdated="textTracksUpdated",e.inlineStylesParsed="inlineStylesParsed",e.levelUpdated="levelUpdated"}(Me||(Me={})),function(e){e.MP4="audio/mp4",e.AVC1="video/mp4"}(De||(De={})),function(e){e.WIDEVINE="urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed",e.PLAYREADY="com.microsoft.playready",e.FAIRPLAY="com.apple.streamingkeydelivery"}(Ne||(Ne={}));let Le;const{NONE:xe,FAIRPLAY:Ue,WIDEVINE:Fe,PLAYREADY:je}=Ie;function supportsDrm(){if(!Le)throw new Error("findKeySystemPreference has not been invoked");return Le!==xe}function potentialKeySystemsForAccess(){return function(){const e=getSessionStorage();return!!e&&"true"===e.getItem("mk-playready-cbcs-unsupported")}()?[Fe]:Ae.features["prefer-playready"]?[je,Fe]:[Fe,je]}function findKeySystemPreference(){var e,t;return __awaiter(this,void 0,void 0,(function*(){if(!ke){if(null===(e=window.WebKitMediaKeys)||void 0===e?void 0:e.isTypeSupported(Ue+".1_0",De.AVC1))Le=Ue;else if(null===(t=window.MSMediaKeys)||void 0===t?void 0:t.isTypeSupported(je,De.AVC1))Le=je;else{const e=Re;if(hasMediaKeySupport()&&e.canPlayType('video/mp4;codecs="avc1.42E01E"')&&e.canPlayType('audio/mp4;codecs="mp4a.40.2"')){const e=[{initDataTypes:["keyids","cenc"],distinctiveIdentifier:"optional",persistentState:"required",videoCapabilities:[{contentType:'video/mp4;codecs="avc1.42E01E"',robustness:"SW_SECURE_CRYPTO"}],audioCapabilities:[{contentType:'audio/mp4;codecs="mp4a.40.2"'}]}],t=potentialKeySystemsForAccess(),[i]=yield findMediaKeySystemAccess(t,e);Le=i}}return Le=null!=Le?Le:xe,Le}Le=xe}))}function hasMediaKeySupport(){return!!(navigator&&navigator.requestMediaKeySystemAccess&&window.MediaKeys&&window.MediaKeySystemAccess)}const AsyncDebounce=(e=100,t)=>(i,r,s)=>{const n=s.value,a=asyncDebounce(n,e,t);s.value=a},asyncDebounce=(e,t=250,i={isImmediate:!1})=>{let r,s;function fulfill(e){return hasOwn(i,"cancelledValue")?null==e?void 0:e.resolve(i.cancelledValue):null==e?void 0:e.reject(new Error("cancelled"))}const clearLastPromise=()=>{r&&(r.resolved||(fulfill(r),r.timeoutId&&clearTimeout(r.timeoutId)),r=void 0)},invokeFn=(t,i,s,n)=>{e.apply(t,n).then(e=>{i(e),r&&(r.resolved=!0)}).catch(s)};return i.isImmediate?function(...e){const i=Date.now(),n=this;return s&&i>=s&&clearLastPromise(),s=Date.now()+t,r?fulfill(Promise):new Promise((t,i)=>{r={resolve:t,reject:i},invokeFn(n,t,i,e)})}:function(...e){const i=this;return r&&clearLastPromise(),new Promise((function(s,n){const a=setTimeout(invokeFn.bind(void 0,i,s,n,e),t);r={resolve:s,reject:n,timeoutId:a}}))}};function isLive(e){var t;return!!(null===(t=null==e?void 0:e.attributes)||void 0===t?void 0:t.isLive)}function isStream(e){var t,i;return"stream"===(null===(i=null===(t=null==e?void 0:e.attributes)||void 0===t?void 0:t.playParams)||void 0===i?void 0:i.format)}function isLiveRadioStation(e){return isLive(e)&&isStream(e)}function isLiveRadioKind(e,t){var i;return isLiveRadioStation(e)&&(null===(i=e.attributes)||void 0===i?void 0:i.mediaKind)===t}function isBroadcastRadio(e){return isLive(e)&&isStream(e)&&void 0!==e.attributes.stationProviderName&&"Shoutcast"===e.attributes.streamingRadioSubType}function getFilterFromFlags(e){const t=e.includes("radio-live"),i=e.includes("radio-aod"),r=e.includes("radio-broadcast");return e=>(!t||t&&!isLiveRadioStation(e))&&(!i||i&&!function(e){return!isLive(e)&&isStream(e)&&"Episode"===e.attributes.streamingRadioSubType}(e))&&(!r||r&&!isBroadcastRadio(e))}const Be={album:"albums",albums:"albums",artist:"artists",artists:"artists",song:"songs",songs:"songs"};function normalizeContentType(e){let t=Be[e];return t||(t=e.replace(/_|[A-Z]/g,(e,t)=>"_"===e?"-":(e=e.toLowerCase(),0===t?e:"-"+e)),e.endsWith("y")?t=t.substring(0,t.length-1)+"ies":t.endsWith("s")||(t+="s"),Be[e]=t,t)}const Ke={AFG:"143610",AGO:"143564",AIA:"143538",ALB:"143575",AND:"143611",ARE:"143481",ARG:"143505",ARM:"143524",ATG:"143540",AUS:"143460",AUT:"143445",AZE:"143568",BEL:"143446",BEN:"143576",BFA:"143578",BGD:"143490",BGR:"143526",BHR:"143559",BHS:"143539",BIH:"143612",BLR:"143565",BLZ:"143555",BMU:"143542",BOL:"143556",BRA:"143503",BRB:"143541",BRN:"143560",BTN:"143577",BWA:"143525",CAF:"143623",CAN:"143455",CHE:"143459",CHL:"143483",CHN:"143465",CIV:"143527",CMR:"143574",COD:"143613",COG:"143582",COL:"143501",CPV:"143580",CRI:"143495",CYM:"143544",CYP:"143557",CZE:"143489",DEU:"143443",DMA:"143545",DNK:"143458",DOM:"143508",DZA:"143563",ECU:"143509",EGY:"143516",ESP:"143454",EST:"143518",ETH:"143569",FIN:"143447",FJI:"143583",FRA:"143442",FSM:"143591",GAB:"143614",GBR:"143444",GEO:"143615",GHA:"143573",GIN:"143616",GMB:"143584",GNB:"143585",GRC:"143448",GRD:"143546",GTM:"143504",GUY:"143553",HKG:"143463",HND:"143510",HRV:"143494",HUN:"143482",IDN:"143476",IND:"143467",IRL:"143449",IRQ:"143617",ISL:"143558",ISR:"143491",ITA:"143450",JAM:"143511",JOR:"143528",JPN:"143462",KAZ:"143517",KEN:"143529",KGZ:"143586",KHM:"143579",KNA:"143548",KOR:"143466",KWT:"143493",LAO:"143587",LBN:"143497",LBR:"143588",LBY:"143567",LCA:"143549",LIE:"143522",LKA:"143486",LTU:"143520",LUX:"143451",LVA:"143519",MAC:"143515",MAR:"143620",MCO:"143618",MDA:"143523",MDG:"143531",MDV:"143488",MEX:"143468",MKD:"143530",MLI:"143532",MLT:"143521",MMR:"143570",MNE:"143619",MNG:"143592",MOZ:"143593",MRT:"143590",MSR:"143547",MUS:"143533",MWI:"143589",MYS:"143473",NAM:"143594",NER:"143534",NGA:"143561",NIC:"143512",NLD:"143452",NOR:"143457",NPL:"143484",NRU:"143606",NZL:"143461",OMN:"143562",PAK:"143477",PAN:"143485",PER:"143507",PHL:"143474",PLW:"143595",PNG:"143597",POL:"143478",PRT:"143453",PRY:"143513",PSE:"143596",QAT:"143498",ROU:"143487",RUS:"143469",RWA:"143621",SAU:"143479",SEN:"143535",SGP:"143464",SLB:"143601",SLE:"143600",SLV:"143506",SRB:"143500",STP:"143598",SUR:"143554",SVK:"143496",SVN:"143499",SWE:"143456",SWZ:"143602",SYC:"143599",TCA:"143552",TCD:"143581",THA:"143475",TJK:"143603",TKM:"143604",TON:"143608",TTO:"143551",TUN:"143536",TUR:"143480",TWN:"143470",TZA:"143572",UGA:"143537",UKR:"143492",URY:"143514",USA:"143441",UZB:"143566",VCT:"143550",VEN:"143502",VGB:"143543",VNM:"143471",VUT:"143609",WSM:"143607",XKX:"143624",YEM:"143571",ZAF:"143472",ZMB:"143622",ZWE:"143605"},logDeprecation=(e,t={})=>{if(E&&E.enabled){const i=[];i.push("Deprecation warning:"),i.push(t.message||e+" has been deprecated."),void 0!==t.until&&i.push(`${e} will be removed in version ${t.until}.`),E.warn(i.join(" "))}},$e={AW:"ABW",AF:"AFG",AO:"AGO",AI:"AIA",AX:"ALA",AL:"ALB",AD:"AND",AE:"ARE",AR:"ARG",AM:"ARM",AS:"ASM",AQ:"ATA",TF:"ATF",AG:"ATG",AU:"AUS",AT:"AUT",AZ:"AZE",BI:"BDI",BE:"BEL",BJ:"BEN",BQ:"BES",BF:"BFA",BD:"BGD",BG:"BGR",BH:"BHR",BS:"BHS",BA:"BIH",BL:"BLM",BY:"BLR",BZ:"BLZ",BM:"BMU",BO:"BOL",BR:"BRA",BB:"BRB",BN:"BRN",BT:"BTN",BV:"BVT",BW:"BWA",CF:"CAF",CA:"CAN",CC:"CCK",CH:"CHE",CL:"CHL",CN:"CHN",CI:"CIV",CM:"CMR",CD:"COD",CG:"COG",CK:"COK",CO:"COL",KM:"COM",CV:"CPV",CR:"CRI",CU:"CUB",CW:"CUW",CX:"CXR",KY:"CYM",CY:"CYP",CZ:"CZE",DE:"DEU",DJ:"DJI",DM:"DMA",DK:"DNK",DO:"DOM",DZ:"DZA",EC:"ECU",EG:"EGY",ER:"ERI",EH:"ESH",ES:"ESP",EE:"EST",ET:"ETH",FI:"FIN",FJ:"FJI",FK:"FLK",FR:"FRA",FO:"FRO",FM:"FSM",GA:"GAB",GB:"GBR",GE:"GEO",GG:"GGY",GH:"GHA",GI:"GIB",GN:"GIN",GP:"GLP",GM:"GMB",GW:"GNB",GQ:"GNQ",GR:"GRC",GD:"GRD",GL:"GRL",GT:"GTM",GF:"GUF",GU:"GUM",GY:"GUY",HK:"HKG",HM:"HMD",HN:"HND",HR:"HRV",HT:"HTI",HU:"HUN",ID:"IDN",IM:"IMN",IN:"IND",IO:"IOT",IE:"IRL",IR:"IRN",IQ:"IRQ",IS:"ISL",IL:"ISR",IT:"ITA",JM:"JAM",JE:"JEY",JO:"JOR",JP:"JPN",KZ:"KAZ",KE:"KEN",KG:"KGZ",KH:"KHM",KI:"KIR",KN:"KNA",KR:"KOR",KW:"KWT",LA:"LAO",LB:"LBN",LR:"LBR",LY:"LBY",LC:"LCA",LI:"LIE",LK:"LKA",LS:"LSO",LT:"LTU",LU:"LUX",LV:"LVA",MO:"MAC",MF:"MAF",MA:"MAR",MC:"MCO",MD:"MDA",MG:"MDG",MV:"MDV",MX:"MEX",MH:"MHL",MK:"MKD",ML:"MLI",MT:"MLT",MM:"MMR",ME:"MNE",MN:"MNG",MP:"MNP",MZ:"MOZ",MR:"MRT",MS:"MSR",MQ:"MTQ",MU:"MUS",MW:"MWI",MY:"MYS",YT:"MYT",NA:"NAM",NC:"NCL",NE:"NER",NF:"NFK",NG:"NGA",NI:"NIC",NU:"NIU",NL:"NLD",NO:"NOR",NP:"NPL",NR:"NRU",NZ:"NZL",OM:"OMN",PK:"PAK",PA:"PAN",PN:"PCN",PE:"PER",PH:"PHL",PW:"PLW",PG:"PNG",PL:"POL",PR:"PRI",KP:"PRK",PT:"PRT",PY:"PRY",PS:"PSE",PF:"PYF",QA:"QAT",RE:"REU",RO:"ROU",RU:"RUS",RW:"RWA",SA:"SAU",SD:"SDN",SN:"SEN",SG:"SGP",GS:"SGS",SH:"SHN",SJ:"SJM",SB:"SLB",SL:"SLE",SV:"SLV",SM:"SMR",SO:"SOM",PM:"SPM",RS:"SRB",SS:"SSD",ST:"STP",SR:"SUR",SK:"SVK",SI:"SVN",SE:"SWE",SZ:"SWZ",SX:"SXM",SC:"SYC",SY:"SYR",TC:"TCA",TD:"TCD",TG:"TGO",TH:"THA",TJ:"TJK",TK:"TKL",TM:"TKM",TL:"TLS",TO:"TON",TT:"TTO",TN:"TUN",TR:"TUR",TV:"TUV",TW:"TWN",TZ:"TZA",UG:"UGA",UA:"UKR",UM:"UMI",UY:"URY",US:"USA",UZ:"UZB",VA:"VAT",VC:"VCT",VE:"VEN",VG:"VGB",VI:"VIR",VN:"VNM",VU:"VUT",WF:"WLF",WS:"WSM",XK:"XKX",YE:"YEM",ZA:"ZAF",ZM:"ZMB",ZW:"ZWE"};class PubSub{constructor(){this.events={}}publish(e,t){const i=this.getSubscribersForType(e);void 0!==i&&i.forEach(i=>{i(e,t)})}subscribe(e,t){this.getSubscribersForType(e,!0).push(t)}subscribeOnce(e,t){const onceCallback=(e,i)=>{this.unsubscribe(e,onceCallback),t(e,i)};this.subscribe(e,onceCallback)}unsubscribe(e,t){const i=this.getSubscribersForType(e);if(void 0!==i)for(const r in i)if(i[r]===t){delete i[r];break}}clear(e){void 0===e?this.events={}:delete this.events[e]}getSubscribersForType(e,t=!1){return!this.events.hasOwnProperty(e)&&t&&(this.events[e]=[]),this.events[e]}}const Ve={},SerialAsync=e=>{let t=Promise.resolve();return(i,r,s)=>{const n=s.value;return s.value=function(...i){return __awaiter(this,void 0,void 0,(function*(){return e&&(t=(e=>{let t=Ve[e];return t||(t=Promise.resolve(),Ve[e]=t),t})(e)),t=t.catch(()=>{}).then(()=>n.apply(this,i)),e&&(Ve[e]=t),t}))},s}};var We,He,ze;e.PlaybackBitrate=void 0,(We=e.PlaybackBitrate||(e.PlaybackBitrate={}))[We.STANDARD=64]="STANDARD",We[We.HIGH=256]="HIGH",function(e){e.apiStorefrontChanged="apiStorefrontChanged",e.hlsLevelUpdated="hlsLevelUpdated",e.mediaContentComplete="mediaContentComplete",e.playbackPause="playbackPause",e.playbackPlay="playbackPlay",e.playbackScrub="playbackScrub",e.playbackSeek="playbackSeek",e.playbackSkip="playbackSkip",e.playbackStop="playbackStop",e.playerActivate="playerActivate",e.playerExit="playerExit",e.queueModified="queueModified",e.userActivityIntent="userActivityIntent",e.applicationActivityIntent="applicationActivityIntent"}(He||(He={})),function(e){e[e.ACCURATE=0]="ACCURATE",e[e.ROUND=1]="ROUND"}(ze||(ze={}));class TimingAccuracy{constructor(e=!1){this.mode=e?ze.ACCURATE:ze.ROUND}time(e=0){return this.mode===ze.ROUND?Math.round(e):e}}createLocalStorageFlag("mk-player-debug");const qe=new Logger$1({levelFilterStorageKey:"mk-player-debug",topic:"mk-player"}),Ye={audioTrackAdded:"audioTrackAdded",audioTrackChanged:"audioTrackChanged",audioTrackRemoved:"audioTrackRemoved",bufferedProgressDidChange:"bufferedProgressDidChange",drmUnsupported:"drmUnsupported",forcedTextTrackChanged:"forcedTextTrackChanged",mediaCanPlay:"mediaCanPlay",mediaElementCreated:"mediaElementCreated",mediaPlaybackError:"mediaPlaybackError",nowPlayingItemDidChange:"nowPlayingItemDidChange",nowPlayingItemWillChange:"nowPlayingItemWillChange",metadataDidChange:"metadataDidChange",playbackBitrateDidChange:"playbackBitrateDidChange",playbackDurationDidChange:"playbackDurationDidChange",playbackProgressDidChange:"playbackProgressDidChange",playbackRateDidChange:"playbackRateDidChange",playbackStateDidChange:"playbackStateDidChange",playbackStateWillChange:"playbackStateWillChange",playbackTargetAvailableDidChange:"playbackTargetAvailableDidChange",playbackTargetIsWirelessDidChange:"playbackTargetIsWirelessDidChange",playbackTimeDidChange:"playbackTimeDidChange",playbackVolumeDidChange:"playbackVolumeDidChange",playerTypeDidChange:"playerTypeDidChange",presentationModeDidChange:"presentationModeDidChange",primaryPlayerDidChange:"primaryPlayerDidChange",textTrackAdded:"textTrackAdded",textTrackChanged:"textTrackChanged",textTrackRemoved:"textTrackRemoved",timedMetadataDidChange:"timedMetadataDidChange"};class BitrateCalculator{constructor(t,i=e.PlaybackBitrate.STANDARD){var r,s;this._downlinkSamples=[],this._bitrate=i,this._dispatcher=t,void 0!==(null===(s=null===(r=null===window||void 0===window?void 0:window.navigator)||void 0===r?void 0:r.connection)||void 0===s?void 0:s.downlink)&&this._recalculateBitrate(100*(window.navigator.connection.downlink||0))}get bitrate(){return this._bitrate}set bitrate(e){this._bitrate!==e&&(this._bitrate=e,this._dispatcher.publish(Ye.playbackBitrateDidChange,{bitrate:e}))}_calculateAverageDownlink(){return 0===this._downlinkSamples.length?0:this._downlinkSamples.reduce((e,t)=>e+t,0)/this._downlinkSamples.length||0}_recalculateBitrate(t){qe.debug("_recalculateBitrate",t),this._downlinkSamples.push(t);this._calculateAverageDownlink()>e.PlaybackBitrate.STANDARD?(qe.debug("setting bitrate to",e.PlaybackBitrate.HIGH),this.bitrate=e.PlaybackBitrate.HIGH):(qe.debug("setting bitrate to",e.PlaybackBitrate.STANDARD),this.bitrate=e.PlaybackBitrate.STANDARD)}}var Ge,Qe,Xe,Je,Ze,et,tt;!function(e){e.MUSICKIT="music_kit-integration",e.OTHER="other",e.MINI="mini",e.SONG="song",e.ALBUM="album",e.ALBUM_CLASSICAL="album-classical",e.ARTIST="artist",e.COMPILATION="compilation",e.COMPILATION_CLASSICAL="compilation-classical",e.PLAYLIST="playlist",e.PLAYLIST_CLASSICAL="playlist-classical",e.RADIO="radio",e.SEARCH="search",e.STATION="station"}(Ge||(Ge={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.RADIO=1]="RADIO",e[e.PLAYLIST=2]="PLAYLIST",e[e.ALBUM=3]="ALBUM",e[e.ARTIST=4]="ARTIST"}(Qe||(Qe={})),function(e){e[e.NOT_APPLICABLE=0]="NOT_APPLICABLE",e[e.OTHER=1]="OTHER",e[e.TRACK_SKIPPED_FORWARDS=2]="TRACK_SKIPPED_FORWARDS",e[e.PLAYBACK_MANUALLY_PAUSED=3]="PLAYBACK_MANUALLY_PAUSED",e[e.PLAYBACK_SUSPENDED=4]="PLAYBACK_SUSPENDED",e[e.MANUALLY_SELECTED_PLAYBACK_OF_A_DIFF_ITEM=5]="MANUALLY_SELECTED_PLAYBACK_OF_A_DIFF_ITEM",e[e.PLAYBACK_PAUSED_DUE_TO_INACTIVITY=6]="PLAYBACK_PAUSED_DUE_TO_INACTIVITY",e[e.NATURAL_END_OF_TRACK=7]="NATURAL_END_OF_TRACK",e[e.PLAYBACK_STOPPED_DUE_TO_SESSION_TIMEOUT=8]="PLAYBACK_STOPPED_DUE_TO_SESSION_TIMEOUT",e[e.TRACK_BANNED=9]="TRACK_BANNED",e[e.FAILED_TO_LOAD=10]="FAILED_TO_LOAD",e[e.PAUSED_ON_TIMEOUT=11]="PAUSED_ON_TIMEOUT",e[e.SCRUB_BEGIN=12]="SCRUB_BEGIN",e[e.SCRUB_END=13]="SCRUB_END",e[e.TRACK_SKIPPED_BACKWARDS=14]="TRACK_SKIPPED_BACKWARDS",e[e.NOT_SUPPORTED_BY_CLIENT=15]="NOT_SUPPORTED_BY_CLIENT",e[e.QUICK_PLAY=16]="QUICK_PLAY",e[e.EXITED_APPLICATION=17]="EXITED_APPLICATION"}(Xe||(Xe={})),e.SeekReasonType=void 0,(Je=e.SeekReasonType||(e.SeekReasonType={}))[Je.Manual=0]="Manual",Je[Je.Interval=1]="Interval",Je[Je.SkipIntro=2]="SkipIntro",function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.NO_RIGHTS=1]="NO_RIGHTS",e[e.PURCHASED=2]="PURCHASED",e[e.UPLOADED=3]="UPLOADED",e[e.MATCHED=4]="MATCHED",e[e.ADDED=5]="ADDED",e[e.SUBSCRIBED=6]="SUBSCRIBED",e[e.NOT_SUPPORTED=7]="NOT_SUPPORTED"}(Ze||(Ze={})),function(e){e[e.NO_SELECTION_PLAY=0]="NO_SELECTION_PLAY",e[e.RESUME_LAST_PLAYED_SONG=1]="RESUME_LAST_PLAYED_SONG",e[e.RESUME_CURRENT_DEVICE_POSITION=2]="RESUME_CURRENT_DEVICE_POSITION"}(et||(et={})),function(e){e[e.NOT_APPLICABLE=0]="NOT_APPLICABLE",e[e.SIMILARITIES=1]="SIMILARITIES",e[e.ESSENTIALS=2]="ESSENTIALS",e[e.USER_LIBRARY=3]="USER_LIBRARY",e[e.ALGO_HEATSEEKER=4]="ALGO_HEATSEEKER",e[e.SEED_TRACK=5]="SEED_TRACK",e[e.GN_1M_TEMPORARY=6]="GN_1M_TEMPORARY",e[e.VECTOR=8]="VECTOR",e[e.ARTIST_SIMILARITIES=9]="ARTIST_SIMILARITIES",e[e.STORY_ALBUM_LISTENERS_ALSO_BOUGHT=10]="STORY_ALBUM_LISTENERS_ALSO_BOUGHT",e[e.STORY_ALBUM_SALES_LEADER=11]="STORY_ALBUM_SALES_LEADER",e[e.STORY_BILLBOARD=12]="STORY_BILLBOARD",e[e.STORY_COMPLETE_MY_ALBUM=13]="STORY_COMPLETE_MY_ALBUM",e[e.STORY_CRITICAL_PICK=14]="STORY_CRITICAL_PICK",e[e.STORY_ITUNES_ESSENTIAL=15]="STORY_ITUNES_ESSENTIAL",e[e.STORY_HEATSEEKER=16]="STORY_HEATSEEKER",e[e.STORY_IDENTITY=17]="STORY_IDENTITY",e[e.STORY_POWER_SONG=18]="STORY_POWER_SONG",e[e.STORY_SONG_SALES_LEADER=20]="STORY_SONG_SALES_LEADER",e[e.GENRE_SIMILARITIES=21]="GENRE_SIMILARITIES",e[e.STORY_IMIX=22]="STORY_IMIX",e[e.STORY_OTHER_MIX=23]="STORY_OTHER_MIX",e[e.EDITORIAL=24]="EDITORIAL",e[e.TOP_SONGS=25]="TOP_SONGS",e[e.SUBFORMAT_SONGS=26]="SUBFORMAT_SONGS",e[e.CRITICAL_PICKS=27]="CRITICAL_PICKS",e[e.US_ARTIST_SIMS=28]="US_ARTIST_SIMS",e[e.HEAVY_ROTATION=29]="HEAVY_ROTATION",e[e.STORY_FORMAT_STATION_HEAVY_ROTATION=30]="STORY_FORMAT_STATION_HEAVY_ROTATION",e[e.ARTIST_BASED_CORE_SIMILAR_ARTISTS=31]="ARTIST_BASED_CORE_SIMILAR_ARTISTS",e[e.ARTIST_BASED_FAMILIAR_SIMILAR_ARTISTS=32]="ARTIST_BASED_FAMILIAR_SIMILAR_ARTISTS",e[e.ARTIST_BASED_DISCOVERIES=33]="ARTIST_BASED_DISCOVERIES",e[e.ARTIST_BASED_HOT_SONGS=34]="ARTIST_BASED_HOT_SONGS",e[e.ARTIST_BASED_SEED_ARTIST=35]="ARTIST_BASED_SEED_ARTIST",e[e.ARTIST_BASED_COMPOSER=36]="ARTIST_BASED_COMPOSER",e[e.EDITORIAL_STATION_INTRO=37]="EDITORIAL_STATION_INTRO",e[e.EDITORIAL_RELATIVE_REPEAT=38]="EDITORIAL_RELATIVE_REPEAT",e[e.EDITORIAL_ABSOLUTE_REPEAT=39]="EDITORIAL_ABSOLUTE_REPEAT",e[e.EDITORIAL_SCHEDULED=40]="EDITORIAL_SCHEDULED",e[e.EDITORIAL_SUGGESTED_ARTIST=41]="EDITORIAL_SUGGESTED_ARTIST",e[e.FOR_YOU_FAMILIAR=42]="FOR_YOU_FAMILIAR",e[e.FOR_YOU_RECOMMENDED=43]="FOR_YOU_RECOMMENDED",e[e.FOR_YOU_FAVORITE_ARTIST=44]="FOR_YOU_FAVORITE_ARTIST",e[e.FOR_YOU_RECOMMENDED_ARTIST=45]="FOR_YOU_RECOMMENDED_ARTIST",e[e.EDITORIAL_POSITIONAL=46]="EDITORIAL_POSITIONAL",e[e.SIMILAR_SONGS=47]="SIMILAR_SONGS",e[e.SONG_ATTRIBUTE_FAVORITE_ARTIST=48]="SONG_ATTRIBUTE_FAVORITE_ARTIST",e[e.SONG_ATTRIBUTE_FAVORITE_ARTIST_DERIVED=49]="SONG_ATTRIBUTE_FAVORITE_ARTIST_DERIVED",e[e.SONG_ATTRIBUTE_FAVORITE_ARTIST_EDITORIAL=50]="SONG_ATTRIBUTE_FAVORITE_ARTIST_EDITORIAL",e[e.SONG_ATTRIBUTE_RECOMMENDED=51]="SONG_ATTRIBUTE_RECOMMENDED",e[e.SONG_ATTRIBUTE_RECOMMENDED_DERIVED=52]="SONG_ATTRIBUTE_RECOMMENDED_DERIVED",e[e.SONG_ATTRIBUTE_RECOMMENDED_EDITORIAL=53]="SONG_ATTRIBUTE_RECOMMENDED_EDITORIAL",e[e.SONG_ATTRIBUTE_NON_PERSONALIZED=54]="SONG_ATTRIBUTE_NON_PERSONALIZED",e[e.SONG_ATTRIBUTE_NON_PERSONALIZED_DERIVED=55]="SONG_ATTRIBUTE_NON_PERSONALIZED_DERIVED",e[e.SONG_ATTRIBUTE_NON_PERSONALIZED_EDITORIAL=56]="SONG_ATTRIBUTE_NON_PERSONALIZED_EDITORIAL",e[e.PERSONAL_STATION=57]="PERSONAL_STATION",e[e.PERSONAL_STATION_FAVORITE_ARTIST=58]="PERSONAL_STATION_FAVORITE_ARTIST",e[e.PERSONAL_STATION_RECOMMENDED=59]="PERSONAL_STATION_RECOMMENDED",e[e.NEW_MUSIC_STATION=60]="NEW_MUSIC_STATION",e[e.NEW_MUSIC_STATION_FAVORITE_ARTIST=61]="NEW_MUSIC_STATION_FAVORITE_ARTIST",e[e.NEW_MUSIC_STATION_RECOMMENDED=62]="NEW_MUSIC_STATION_RECOMMENDED"}(tt||(tt={}));var it,rt,st,nt,at,ot,lt,dt,ct,ut,ht,pt;function formattedSeconds(e){return{hours:Math.floor(e/3600),minutes:Math.floor(e%3600/60)}}!function(e){e[e.UNSPECIFIED=0]="UNSPECIFIED",e[e.STATIC=1]="STATIC",e[e.TIME_SYNCED=2]="TIME_SYNCED"}(it||(it={})),function(e){e[e.REPEAT_UNKNOWN=0]="REPEAT_UNKNOWN",e[e.REPEAT_OFF=1]="REPEAT_OFF",e[e.REPEAT_ONE=2]="REPEAT_ONE",e[e.REPEAT_ALL=3]="REPEAT_ALL"}(rt||(rt={})),function(e){e[e.SHUFFLE_UNKNOWN=0]="SHUFFLE_UNKNOWN",e[e.SHUFFLE_OFF=1]="SHUFFLE_OFF",e[e.SHUFFLE_ON=2]="SHUFFLE_ON"}(st||(st={})),function(e){e[e.AUTO_UNKNOWN=0]="AUTO_UNKNOWN",e[e.AUTO_OFF=1]="AUTO_OFF",e[e.AUTO_ON=2]="AUTO_ON",e[e.AUTO_ON_CONTENT_UNSUPPORTED=3]="AUTO_ON_CONTENT_UNSUPPORTED"}(nt||(nt={})),function(e){e[e.NOT_SPECIFIED=0]="NOT_SPECIFIED",e[e.CONTAINER_CHANGED=1]="CONTAINER_CHANGED"}(at||(at={})),function(e){e[e.PLAY_END=0]="PLAY_END",e[e.PLAY_START=1]="PLAY_START",e[e.LYRIC_DISPLAY=2]="LYRIC_DISPLAY"}(ot||(ot={})),function(e){e[e.INVALID=0]="INVALID",e[e.ITUNES_STORE_CONTENT=1]="ITUNES_STORE_CONTENT",e[e.NON_SONG_CLIP=2]="NON_SONG_CLIP",e[e.AD=3]="AD",e[e.STREAM=4]="STREAM",e[e.AUDIO_AD=5]="AUDIO_AD",e[e.VIDEO_AD=6]="VIDEO_AD",e[e.TIMED_METADATA_PING=7]="TIMED_METADATA_PING",e[e.ARTIST_UPLOADED_CONTENT=8]="ARTIST_UPLOADED_CONTENT",e[e.AGGREGATE_NON_CATALOG_PLAY_TIME=9]="AGGREGATE_NON_CATALOG_PLAY_TIME",e[e.ORIGINAL_CONTENT_MOVIES=10]="ORIGINAL_CONTENT_MOVIES",e[e.ORIGINAL_CONTENT_SHOWS=11]="ORIGINAL_CONTENT_SHOWS"}(lt||(lt={})),function(e){e[e.AUDIO=0]="AUDIO",e[e.VIDEO=1]="VIDEO"}(dt||(dt={})),function(e){e[e.AUTO=0]="AUTO",e[e.MANUAL=1]="MANUAL"}(ct||(ct={})),function(e){e[e.ORIGINATING_DEVICE=0]="ORIGINATING_DEVICE",e[e.PAIRED_WATCH=1]="PAIRED_WATCH",e[e.SONOS=2]="SONOS",e[e.CAR_PLAY=3]="CAR_PLAY",e[e.WEB_AUC=4]="WEB_AUC",e[e.TWITTER_AUC=5]="TWITTER_AUC",e[e.MUSIC_SDK=6]="MUSIC_SDK",e[e.ATV_REMOTE=7]="ATV_REMOTE",e[e.WEBPLAYER=8]="WEBPLAYER",e[e.WHOLE_HOUSE_AUDIO=9]="WHOLE_HOUSE_AUDIO",e[e.MUSICKIT=10]="MUSICKIT",e[e.VW=11]="VW",e[e.UNKNOWN_SOURCE_TYPE=12]="UNKNOWN_SOURCE_TYPE",e[e.AMAZON=13]="AMAZON",e[e.PORSCHE=14]="PORSCHE",e[e.CHROMECAST=15]="CHROMECAST",e[e.WEB_APP=16]="WEB_APP",e[e.MERCEDES_BENZ=17]="MERCEDES_BENZ",e[e.THIRD_PARTY_TV=18]="THIRD_PARTY_TV",e[e.SAMSUNG=18]="SAMSUNG",e[e.SEAT=19]="SEAT",e[e.CUPRA=20]="CUPRA"}(ut||(ut={})),function(e){e[e.EPISODE=1]="EPISODE",e[e.SHOUTCAST=2]="SHOUTCAST"}(ht||(ht={})),new Map([["play",ot.PLAY_START],["playbackstarted",ot.PLAY_START],["stop",ot.PLAY_END],["playbackstopped",ot.PLAY_END]]),new Map([["exit",Xe.EXITED_APPLICATION],["next",Xe.TRACK_SKIPPED_FORWARDS],["pause",Xe.PLAYBACK_MANUALLY_PAUSED],["playbackfinished",Xe.NATURAL_END_OF_TRACK],["playbackstopped",Xe.PLAYBACK_MANUALLY_PAUSED],["previous",Xe.TRACK_SKIPPED_BACKWARDS],["scrub_begin",Xe.SCRUB_BEGIN],["scrub_end",Xe.SCRUB_END],["stop",Xe.NATURAL_END_OF_TRACK]]),function(e){e[e.ALEXA=13]="ALEXA"}(pt||(pt={})),new Logger$1;const yt=["Bonus","contributors","Episode","modalities","Movie","musicVideo","podcast-episodes","Preview","Promotional","radioStation","Season","Show","song","SportingEvent","uploaded-audios","uploadedAudio","uploaded-videos","uploadedVideo","Vod","workouts","workout-programs","LiveService"],mt={"uploaded-videos":!0,uploadedVideo:!0,"uploaded-audios":!0,uploadedAudio:!0,"podcast-episodes":!0},gt={mediaItemStateDidChange:"mediaItemStateDidChange",mediaItemStateWillChange:"mediaItemStateWillChange"},ft=new Logger$1,{none:vt,loading:_t,ready:bt,playing:Tt,ended:St,unavailable:Et,restricted:kt,error:Pt,unsupported:It}=A,At={[vt]:{allowed:[_t],unknown:[St,Et,kt,Pt,It]},[_t]:{allowed:[bt,kt,Pt,It],unknown:[]},[bt]:{allowed:[Tt],unknown:[Pt]},[Tt]:{allowed:[St,Pt],unknown:[Et,kt,It]},[St]:{allowed:[],unknown:[]},[Et]:{allowed:[],unknown:[]},[kt]:{allowed:[],unknown:[]},[Pt]:{allowed:[],unknown:[]},[It]:{allowed:[],unknown:[]}},toName=e=>A[e],createMediaItemStateGuard=(e=vt)=>{const t={current:e,set(e){const{current:i}=t;if(!((e,t)=>At[e].allowed.includes(t))(i,e)){const t=((e,t)=>At[e].unknown.includes(t))(i,e);ft.debug(`MediaItem.state was changed from ${toName(i)} to ${toName(e)}`,t?"but it is unknown whether it should be allowed or not.":"and it should not be happening")}t.current=e}};return t};function isStringNotEmpty(e){return!function(e){return void 0===e||""===e.trim()}(e)}function transform$9(e){return transform$a({"attributes.albumName":"metadata.playlistName","attributes.artistName":"metadata.artistName","attributes.artwork"(){const t=null==e?void 0:e.artworkURL;if(t)return function(e){const t=e.split("/").pop(),[i,r]=!!t&&t.match(/\d+/g)||["100","100"];return{width:parseInt(i,10),height:parseInt(r,10),url:e.replace(`${i}x${r}`,"{w}x{h}")}}(t)},"attributes.composerName":"metadata.composerName","attributes.contentRating"(){var t;if(1===(null===(t=null==e?void 0:e.metadata)||void 0===t?void 0:t.explicit))return"explicit"},"attributes.discNumber"(){var t;return(null===(t=null==e?void 0:e.metadata)||void 0===t?void 0:t.discNumber)||1},"attributes.durationInMillis":"metadata.duration","attributes.genreNames"(){var t;return[null===(t=null==e?void 0:e.metadata)||void 0===t?void 0:t.genre]},"attributes.isrc"(){var t;const i=null===(t=null==e?void 0:e.metadata)||void 0===t?void 0:t.xid;if(i)return i.replace(/^([^:]+):isrc:/,"$1")},"attributes.name":"metadata.itemName","attributes.playParams.id":"metadata.itemId","attributes.playParams.kind":"metadata.kind","attributes.previews":()=>[{url:null==e?void 0:e.previewURL}],"attributes.releaseDate":"metadata.releaseDate","attributes.trackNumber":"metadata.trackNumber",assetURL:"URL",cloudId:"metadata.cloud-id",id(){var t;return""+(null===(t=null==e?void 0:e.metadata)||void 0===t?void 0:t.itemId)},flavor:"flavor",type:"metadata.kind"},e)}const wt=createLocalStorageFlag("mk-linear-scrubbing-enabled"),{mediaItemStateDidChange:Rt,mediaItemStateWillChange:Ot}=gt,Ct={isEntitledToPlay:!0};class MediaItem extends Notifications{constructor(t={}){super([Rt,Ot]),this.bingeWatching=!1,this.hlsMetadata={},this.playbackType=e.PlaybackType.none,this._assets=[],this._state=createMediaItemStateGuard(),ft.debug("media-item: creating Media Item with options:",t);t.id&&t.attributes?(Object.keys(t).forEach(e=>{hasOwn(Ct,e)||(this[e]=t[e])}),this.type=this.playParams&&this.playParams.kind?this.playParams.kind:this.type||"song"):(this.id=t.id||generateUUID(),this.type=t.type||"song",this.attributes={playParams:{id:this.id,kind:this.type}}),this._context=t.context||{},t.container?this._container=t.container:t.containerId&&t.containerType&&(this._container={id:t.containerId,type:t.containerType})}get ageGatePolicy(){var e;return null===(e=this.defaultPlayable)||void 0===e?void 0:e.ageGatePolicy}get albumInfo(){const{albumName:e,artistName:t}=this,i=[];return t&&i.push(t),e&&i.push(e),i.join(" - ")}get albumName(){return this.attributes.albumName}get artistName(){return this.attributes.genreNames&&this.attributes.genreNames.indexOf("Classical")>-1&&this.attributes.composerName?this.attributes.composerName:this.attributes.artistName}get artwork(){var e,t;return null!==(e=this.attributes.artwork)&&void 0!==e?e:null===(t=this.attributes.images)||void 0===t?void 0:t.coverArt16X9}get artworkURL(){if(this.artwork&&this.artwork.url)return this.artwork.url}get assets(){return this._assets}get canPlay(){return this.isPlayable&&this.isReady}get container(){return this._container}set container(e){this._container=e}get contentRating(){return this.attributes.contentRating}get context(){return this._context}set context(e){this._context=e}get defaultPlayable(){var e;return null===(e=this.playables)||void 0===e?void 0:e[0]}get discNumber(){return this.attributes.discNumber}get hasContainerArtwork(){return this.container&&this.container.attributes&&this.container.attributes.artwork&&this.container.attributes.artwork.url}get hasPlaylistContainer(){return this.container&&"playlists"===this.container.type&&this.container.attributes}get isEntitledToPlay(){var e,t;const{attributes:i,playables:r}=this;return null!==(t=i.isEntitledToPlay||(null===(e=null==r?void 0:r[0])||void 0===e?void 0:e.isEntitledToPlay))&&void 0!==t&&t}get supportsLinearScrubbing(){var e,t,i,r;return wt.json()&&this.isLinearStream&&!0===(null===(r=null===(i=null===(t=null===(e=this.playables)||void 0===e?void 0:e[0])||void 0===t?void 0:t.assets)||void 0===i?void 0:i.streamCapability)||void 0===r?void 0:r.supportsLinearScrubbing)}get isAssetScrubbingDisabled(){return!!this.isLinearStream&&!this.supportsLinearScrubbing}get isLinearStream(){return"LiveService"===(null==(e=this)?void 0:e.type)||"SportingEvent"===(null==e?void 0:e.type)&&"Event"===(null===(i=null===(t=e.playables)||void 0===t?void 0:t[0])||void 0===i?void 0:i.type);var e,t,i}get isLiveRadioStation(){return isLiveRadioStation(this)}get isLiveAudioStation(){return isLiveRadioKind(this,"audio")}get isLiveVideoStation(){return isLiveRadioKind(this,"video")}get isSong(){return"song"===this.type}get info(){return`${this.title} - ${this.albumInfo}`}get isCloudItem(){return this.playParams&&this.playParams.isLibrary||r(this.id)}get isCloudUpload(){return-1===this._songId}get isExplicitItem(){return"explicit"===this.contentRating}get isLoading(){return this.state===A.loading}get isPlayableMediaType(){return-1!==yt.indexOf(this.type)}get isPlayable(){var e;return!!this.isPlayableMediaType&&(!(!this.isLiveRadioStation&&!this.hasOffersHlsUrl)||(this.needsPlayParams?!!this.playParams:this.isUTS?this.isEntitledToPlay:!!this.attributes.assetUrl||!!(null===(e=this.attributes.previews)||void 0===e?void 0:e.length)))}get isPlaying(){return this.state===A.playing}get isPreparedToPlay(){if("song"===this.type)return!!this._assets&&!!this.keyURLs&&!!this._songId;if(this.isUTS){const e=isStringNotEmpty(this.assetURL),t=!!(this.keyURLs&&isStringNotEmpty(this.keyURLs["hls-key-cert-url"])&&isStringNotEmpty(this.keyURLs["hls-key-server-url"])&&isStringNotEmpty(this.keyURLs["widevine-cert-url"]));return e&&t}return!!isStringNotEmpty(this.assetURL)||this.playRawAssetURL&&!!isStringNotEmpty(this.attributes.assetUrl)}get isrc(){return this.attributes.isrc}get isReady(){return this.state===A.ready}get isRestricted(){return this.state===A.restricted}get isUTS(){return["Bonus","Episode","Movie","MusicMovie","Preview","Promotional","Season","Show","SportingEvent","Vod","LiveService"].includes(this.type)}get isUnavailable(){return this.state===A.unavailable}get needsPlayParams(){return["musicVideo","song"].includes(this.type)}get normalizedType(){return normalizeContentType(this.type)}get offers(){return this.attributes.offers}get offersHlsUrl(){const{offers:e}=this,t=null==e?void 0:e.find(e=>{var t;return!!(null===(t=e.hlsUrl)||void 0===t?void 0:t.length)});return null==t?void 0:t.hlsUrl}get hasOffersHlsUrl(){return isStringNotEmpty(this.offersHlsUrl)}set playbackData(e){if(void 0===e)return;this.previewURL&&(e.previewURL=this.previewURL);const t=transform$9(e);this.artwork&&t.artwork&&delete t.artwork,t.id!==this.id&&delete t.id,this.playParams&&t.attributes.playParams&&(t.attributes.playParams=this.playParams),Object.assign(this,t),ft.debug("media-item: item merged with playbackData",this),this.state=A.ready}get playbackDuration(){return this.attributes.durationInMillis||this.attributes.durationInMilliseconds}get playEvent(){var e;return null===(e=this.defaultPlayable)||void 0===e?void 0:e.playEvent}get playlistArtworkURL(){var e,t,i;return this.hasPlaylistContainer&&this.hasContainerArtwork?null===(i=null===(t=null===(e=this.container)||void 0===e?void 0:e.attributes)||void 0===t?void 0:t.artwork)||void 0===i?void 0:i.url:this.artworkURL}get playlistName(){var e,t;return this.hasPlaylistContainer?null===(t=null===(e=this.container)||void 0===e?void 0:e.attributes)||void 0===t?void 0:t.name:this.albumName}get playParams(){return this.attributes.playParams}get playRawAssetURL(){return this.offers?this.offers.some(e=>"STDQ"===e.type):!(!this.isCloudUpload&&!mt[this.type])}get previewURL(){var e,t,i,r,s,n,a,o,l,d,c,u,h,p,y;return(null===(i=null===(t=null===(e=this.attributes)||void 0===e?void 0:e.previews)||void 0===t?void 0:t[0])||void 0===i?void 0:i.url)||(null===(n=null===(s=null===(r=this.attributes)||void 0===r?void 0:r.previews)||void 0===s?void 0:s[0])||void 0===n?void 0:n.hlsUrl)||(null===(d=null===(l=null===(o=null===(a=this.attributes)||void 0===a?void 0:a.trailers)||void 0===o?void 0:o[0])||void 0===l?void 0:l.assets)||void 0===d?void 0:d.hlsUrl)||(null===(h=null===(u=null===(c=this.attributes)||void 0===c?void 0:c.movieClips)||void 0===u?void 0:u[0])||void 0===h?void 0:h.hlsUrl)||(null===(y=null===(p=this.attributes)||void 0===p?void 0:p.video)||void 0===y?void 0:y.hlsUrl)}get rating(){return this.attributes.rating}get releaseDate(){if(this._releaseDate)return this._releaseDate;if(this.attributes&&(this.attributes.releaseDate||this.attributes.releaseDateTime)){const e=this.attributes.releaseDate||this.attributes.releaseDateTime;return this._releaseDate=/^\d{4}-\d{1,2}-\d{1,2}/.test(e)?new Date(e):void 0,this._releaseDate}}set releaseDate(e){this._releaseDate="string"==typeof e?/^\d{4}-\d{1,2}-\d{1,2}/.test(e)?new Date(e):void 0:"number"==typeof e?new Date(e):e}get songId(){return this._songId&&-1!==this._songId?this._songId:this.id}get state(){return this._state.current}set state(e){const t={oldState:this._state.current,state:e};this._stateWillChange&&this._stateWillChange(this),this.dispatchEvent(Ot,t),this._state.set(e),this._stateDidChange&&this._stateDidChange(this),this.dispatchEvent(Rt,t)}get title(){return this.attributes.name||this.attributes.title}get trackNumber(){return this.attributes.trackNumber}beginMonitoringStateDidChange(e){this._stateDidChange=e}beginMonitoringStateWillChange(e){this._stateWillChange=e}endMonitoringStateDidChange(){this._stateDidChange=void 0}endMonitoringStateWillChange(){this._stateWillChange=void 0}isEqual(e){return this.id===e.id&&this.type===e.type&&this.attributes===e.attributes}resetState(){this.endMonitoringStateWillChange(),this.endMonitoringStateDidChange(),this.state=A.none}restrict(){this.isExplicitItem&&(this.state=A.restricted,this._removePlayableData())}notSupported(){this.state=A.unsupported,this._removePlayableData()}updateFromLoadError(e){switch(e.errorCode){case MKError.CONTENT_RESTRICTED:this.state=A.restricted;break;case MKError.CONTENT_UNAVAILABLE:this.state=A.unavailable;break;default:this.state=A.error}}updateFromSongList(e){"musicVideo"===this.type?this.updateWithLoadedAssets(void 0,e["hls-playlist-url"]):this.updateWithLoadedAssets(e.assets),this._songId=e.songId,this.updateWithLoadedKeys({"hls-key-cert-url":e["hls-key-cert-url"],"hls-key-server-url":e["hls-key-server-url"],"widevine-cert-url":e["widevine-cert-url"]})}updateWithLoadedKeys(e,t){this.keyURLs=e,t&&(this.keyServerQueryParameters=t)}updateWithLoadedAssets(e,t){e&&(this._assets=e),t&&(this.assetURL=t)}_removePlayableData(){var e,t,i;null===(e=this.attributes)||void 0===e||delete e.playParams,null===(t=this.attributes)||void 0===t||delete t.previews,null===(i=this.attributes)||void 0===i||delete i.trailers}}const Mt=["exitFullscreen","webkitExitFullscreen","mozCancelFullScreen","msExitFullscreen"],Dt=["fullscreenElement","webkitFullscreenElement","mozFullScreenElement","msFullscreenElement"],Nt=["requestFullscreen","webkitRequestFullscreen","mozRequestFullScreen","msRequestFullscreen"],noop=()=>Promise.resolve(),Lt=(e=>{if(void 0===e)return noop;const t=Mt.find(t=>"function"==typeof e.prototype[t]);return"string"!=typeof t?noop:(e=self.document)=>{var i;return null===(i=null==e?void 0:e[t])||void 0===i?void 0:i.call(e)}})(HTMLDocument),xt=(e=>{if(void 0===e)return()=>!1;const t=Dt.find(t=>t in e.prototype);return"string"!=typeof t?()=>!1:(e=self.document)=>!!e[t]})(HTMLDocument),Ut=(e=>{if(void 0===e)return noop;const t=Nt.find(t=>"function"==typeof e.prototype[t]);return"string"!=typeof t?noop:e=>null==e?void 0:e[t]()})(HTMLElement);class Fullscreen{constructor(e){this.player=e}exit(){return __awaiter(this,void 0,void 0,(function*(){if(this.isInFullscreen())return this.stopDispatchingEvents(()=>this.exitFullscreen())}))}request(e){return __awaiter(this,void 0,void 0,(function*(){if(void 0!==e)return this.stopDispatchingEvents(()=>this.requestFullscreenForElement(e))}))}stopDispatchingEvents(e){return __awaiter(this,void 0,void 0,(function*(){return this.player.windowHandlers.stopListeningToVisibilityChanges(e)}))}exitFullscreen(){return Lt()}isInFullscreen(){return xt()}requestFullscreenForElement(e){return Ut(e)}}class UnsupportedSeeker{constructor(){this.ended=!1}start(){E.warn("seeker.start is not supported in this playback method")}end(){E.warn("seeker.end is not supported in this playback method")}seekToTime(e){return E.warn("seekToTime is not supported in this playback method"),Promise.resolve()}}class PlayerSeeker{constructor(e){this._ended=!1,this._lastSeekedTime=-1,this._startTime=-1,E.debug("seeker: new"),this._player=e}get ended(){return this._ended}get isEngagedInPlayback(){return this._player.isEngagedInPlayback}get stillPlayingSameItem(){return this._currentItem===this._player.nowPlayingItem}end(){E.debug("seeker: end"),-1!==this._startTime?this._ended?E.warn("seeker: Cannot end the same seeker twice."):(this.dispatchStartEvent(),this.dispatchEndEvent()):E.warn("seeker: Cannot end a seeker before starting it.")}seekToTime(e){return __awaiter(this,void 0,void 0,(function*(){var t;if(E.debug("seeker: seekToTime",e),!this.ended)return this.stillPlayingSameItem||(this._currentItem=this._player.nowPlayingItem,this._startTime=0),this._lastSeekedTime=e,t=this._player.seekToTime(e),__awaiter(void 0,void 0,void 0,(function*(){try{return yield t}catch(e){if("cancelled"!==e.message)throw e}}));E.warn("seeker: Cannot seek once the seeker has ended")}))}start(){E.debug("seeker: start"),-1===this._startTime?(this._currentItem=this._player.nowPlayingItem,this._startTime=this._player.currentPlaybackTime,this._lastSeekedTime=this._startTime):E.warn("seeker: Cannot start same seeker twice")}dispatch(e,t){this.isEngagedInPlayback?(E.debug("seeker: dispatch",e),this._player.dispatch(e,t)):E.debug("seeker: do not dispatch because isEngagedInPlayback",this.isEngagedInPlayback)}dispatchStartEvent(){this.stillPlayingSameItem||(this._startTime=0,this._lastSeekedTime=0),this.dispatch(He.playbackScrub,{position:this._startTime})}dispatchEndEvent(){this._ended=!0,this.dispatch(He.playbackScrub,{position:this._lastSeekedTime,endReasonType:Xe.SCRUB_END})}}const Bind=()=>(e,t,i)=>{if(void 0===i||"function"!=typeof i.value)throw new TypeError(`Only methods can be decorated with @Bind, but ${t} is not a method.`);return{configurable:!0,get(){const e=i.value.bind(this);return Object.defineProperty(this,t,{value:e,configurable:!0,writable:!0}),e}}},{visibilityChangeEvent:Ft,visibilityState:jt,unloadEventName:Bt}=(()=>{let e="visibilitychange",t="visibilityState";void 0!==document.mozHidden?(e="mozvisibilitychange",t="mozVisibilityState"):void 0!==document.msHidden?(e="msvisibilitychange",t="msVisibilityState"):document.webkitHidden&&(e="webkitvisibilitychange",t="webkitVisibilityState");return{visibilityChangeEvent:e,visibilityState:t,unloadEventName:"onpagehide"in window?"pagehide":"unload"}})();class WindowHandlers{constructor(e,t=Pe){this.browser=t,this.dispatchVisibilityChanges=!0,this.player=e}activate(e=self,t=self.document){t.addEventListener(Ft,this.visibilityChanged),e.addEventListener("storage",this.storage,!1),e.addEventListener(Bt,this.windowUnloaded)}deactivate(){document.removeEventListener(Ft,this.visibilityChanged),window.removeEventListener("storage",this.storage),window.addEventListener(Bt,this.windowUnloaded)}stopListeningToVisibilityChanges(e){return __awaiter(this,void 0,void 0,(function*(){this.dispatchVisibilityChanges=!1;const t=yield e();return this.dispatchVisibilityChanges=!0,t}))}dispatch(e,t={}){this.player.dispatch(e,t)}storage({key:e,newValue:t}){e===we&&this.player.tsidChanged(t)}visibilityChanged(e){const t=e.target[jt];E.log("dc visibilityState",t,e,xt()),this.browser.isiOS&&this.dispatchVisibilityChanges&&("hidden"===t?this.dispatch(He.playerExit,{position:this.player.currentPlaybackTime}):"visible"===t&&this.dispatch(He.playerActivate))}windowUnloaded(){this.player.isPlaying&&this.dispatch(He.playerExit,{position:this.player.currentPlaybackTime})}}__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object]),__metadata("design:returntype",void 0)],WindowHandlers.prototype,"storage",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Event]),__metadata("design:returntype",void 0)],WindowHandlers.prototype,"visibilityChanged",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],WindowHandlers.prototype,"windowUnloaded",null);const{bufferedProgressDidChange:Kt,mediaCanPlay:$t,mediaElementCreated:Vt,mediaPlaybackError:Wt,nowPlayingItemDidChange:Ht,nowPlayingItemWillChange:zt,metadataDidChange:qt,primaryPlayerDidChange:Yt,playbackDurationDidChange:Gt,playbackProgressDidChange:Qt,playbackStateDidChange:Xt,playbackRateDidChange:Jt,playbackStateWillChange:Zt,playbackTargetAvailableDidChange:ei,playbackTargetIsWirelessDidChange:ti,playbackTimeDidChange:ii,playbackVolumeDidChange:ri}=Ye,si=["canplay","durationchange","ended","error","loadedmetadata","loadstart","pause","play","playing","progress","ratechange","seeked","seeking","timeupdate","volumechange","waiting"],{ended:ni,loading:ai,paused:oi,playing:li,seeking:di,stopped:ci,waiting:ui}=e.PlaybackStates;class BasePlayer{constructor(t){var i;this.privateEnabled=!1,this.siriInitiated=!1,this.previewOnly=!1,this._currentBufferedProgress=0,this._paused=!1,this._playbackState=e.PlaybackStates.none,this._stopped=!1,this._playbackDidStart=!1,this._currentPlaybackProgress=0,this._isPrimaryPlayer=!0,this._playbackTargetAvailable=!1,this._playbackTargetIsWireless=!1,this._serial=Date.now().toString(),this._isDestroyed=!1,this._dispatcher=t.services.dispatcher,this._timing=t.services.timing,this._context=t.context||{},this.privateEnabled=t.privateEnabled||!1,this.siriInitiated=t.siriInitiated||!1,this._bitrateCalculator=t.services.bitrateCalculator,this.windowHandlers=new WindowHandlers(this),this.fullscreen=new Fullscreen(this),null===(i=getLocalStorage())||void 0===i||i.setItem(we,this._serial)}get bitrate(){return this._bitrateCalculator.bitrate}get currentBufferedProgress(){return this._currentBufferedProgress}set currentBufferedProgress(e){this._currentBufferedProgress!==e&&(this._currentBufferedProgress=e,this._dispatcher.publish(Kt,{progress:e}))}get _currentDuration(){return this._targetElement.duration}get _currentTime(){var e;const t=this._targetElement.currentTime,i=this._buffer;return t-(null!==(e=null==i?void 0:i.currentTimestampOffset)&&void 0!==e?e:0)}get currentPlaybackDuration(){const t=this.nowPlayingItem;if(!t)return 0;const i=(null==t?void 0:t.playbackType)===e.PlaybackType.encryptedFull||(null==t?void 0:t.playbackType)===e.PlaybackType.unencryptedFull,r=null==t?void 0:t.playbackDuration;return i&&r?this.calculateTime(r/1e3):this.calculateTime(this._currentDuration)}get currentPlaybackTime(){return this.calculateTime(this._currentTime)}calculateTime(e){return this._timing.time(e)}get currentPlaybackTimeRemaining(){return this.currentPlaybackDuration-this.currentPlaybackTime}get currentPlaybackProgress(){return this._currentPlaybackProgress||0}set currentPlaybackProgress(e){this._currentPlaybackProgress!==e&&(this._currentPlaybackProgress=e,this._dispatcher.publish(Qt,{progress:e}))}get formattedCurrentPlaybackDuration(){return formattedSeconds(this.currentPlaybackDuration)}get hasMediaElement(){return this._targetElement instanceof HTMLElement&&null!==this._targetElement.parentNode}get isEngagedInPlayback(){return!this._stopped&&!this.isPaused()}get isPlaying(){return this.playbackState===li}get isPrimaryPlayer(){return this._isPrimaryPlayer}set isPrimaryPlayer(e){var t;e!==this._isPrimaryPlayer&&(this._isPrimaryPlayer=e,this._isPrimaryPlayer?null===(t=getLocalStorage())||void 0===t||t.setItem(we,this._serial):(this._dispatcher.publish(Yt,{target:this}),this.pause({userInitiated:!1})))}get isReady(){return 0!==this._targetElement.readyState}get nowPlayingItem(){return this._nowPlayingItem}set nowPlayingItem(e){const t=this._dispatcher;if(void 0===e)return t.publish(zt,{item:e}),this._nowPlayingItem=e,void t.publish(Ht,{item:e});const i=this._nowPlayingItem,r=this._buffer;(null==i?void 0:i.isEqual(e))||(t.publish(zt,{item:e}),this.isPlaying&&(null==r?void 0:r.currentItem)!==e&&this._pauseMedia(),i&&(E.debug("setting state to ended on ",i.title),i.state=A.ended,i.endMonitoringStateDidChange(),i.endMonitoringStateWillChange()),this._nowPlayingItem=e,E.debug("setting state to playing on ",e.title),e.state=A.playing,e&&e.info&&this._setTargetElementTitle(e.info),t.publish(Ht,{item:e}),t.publish(Gt,{currentTarget:this._targetElement,duration:this.currentPlaybackDuration,target:this._targetElement,type:"durationchange"}))}get playbackRate(){return this._targetElement.playbackRate}set playbackRate(e){this._targetElement.playbackRate=e}get playbackState(){return this._playbackState}setPlaybackState(e,t){const i=this._playbackState;if(e===i)return;const r={oldState:i,state:e,nowPlayingItem:t};E.debug("BasePlayer.playbackState is changing",r),this._dispatcher.publish(Zt,r),this._playbackState=e,this._dispatcher.publish(Xt,r)}get playbackTargetAvailable(){return void 0!==window.WebKitPlaybackTargetAvailabilityEvent&&this._playbackTargetAvailable}set playbackTargetAvailable(e){e!==this._playbackTargetAvailable&&(this._playbackTargetAvailable=e,this._dispatcher.publish(ei,{available:e}))}get playbackTargetIsWireless(){return void 0!==window.WebKitPlaybackTargetAvailabilityEvent&&this._playbackTargetIsWireless}set playbackTargetIsWireless(e){e!==this._playbackTargetIsWireless&&(this._playbackTargetIsWireless=e,this._dispatcher.publish(ti,{playing:e}))}get volume(){return this._targetElement.volume}set volume(e){this._targetElement.volume=e}get isDestroyed(){return this._isDestroyed}clearNextManifest(){var e;null===(e=this._buffer)||void 0===e||e.clearNextManifest()}initialize(){return __awaiter(this,void 0,void 0,(function*(){E.debug("BasePlayer.initialize"),this.isPlayerSupported()?(yield this.initializeMediaElement(),yield this.initializeExtension(),this.initializeEventHandlers(),this._dispatcher.publish(Vt,this._targetElement)):E.warn("{this.constructor.name} not supported")}))}initializeEventHandlers(){if(this.windowHandlers.activate(),!this.hasMediaElement)return;const e=this._targetElement;window.WebKitPlaybackTargetAvailabilityEvent&&(e.addEventListener("webkitplaybacktargetavailabilitychanged",e=>{this.playbackTargetAvailable="available"===e.availability}),e.addEventListener("webkitcurrentplaybacktargetiswirelesschanged",e=>{this.playbackTargetIsWireless=e.target===this._targetElement&&!this.playbackTargetIsWireless})),si.forEach(t=>e.addEventListener(t,this)),this._dispatcher.publish(He.playerActivate)}removeEventHandlers(){si.forEach(e=>this._targetElement.removeEventListener(e,this)),this.windowHandlers.deactivate()}isPaused(){return this._paused}exitFullscreen(){return this.fullscreen.exit()}requestFullscreen(e){return this.fullscreen.request(e)}newSeeker(){var e;return null===(e=this._seeker)||void 0===e||e.end(),this._seeker=new PlayerSeeker(this),this._seeker}stop(e){return __awaiter(this,void 0,void 0,(function*(){E.debug("BasePlayer.stop",e),yield this._waitForPendingPlay(),this.isPlaying&&this.dispatch(He.playbackStop,Object.assign({position:this.currentPlaybackTime,startPosition:this.initialBufferPosition,playingDate:this.currentPlayingDate,startPlayingDate:this.initialPlayingDate},e)),yield this.stopMediaAndCleanup()}))}stopMediaAndCleanup(e=ci){return __awaiter(this,void 0,void 0,(function*(){E.debug("stopMediaAndCleanup"),yield this._stopMediaElement(),this._stopped=!0,this._paused=!1;const t=this.nowPlayingItem;this.nowPlayingItem=void 0,this.initialBufferPosition=void 0,this.initialPlayingDate=void 0,this.setPlaybackState(e,t)}))}_calculatePlaybackProgress(){this.currentPlaybackProgress=Math.round(100*(this.currentPlaybackTime/this.currentPlaybackDuration||0))/100}destroy(){var e,t;if(E.debug("BasePlayer.destroy"),this._isDestroyed=!0,!this.hasMediaElement)return;const i=this._targetElement;null===(e=this.extension)||void 0===e||e.destroy(i),this.removeEventHandlers(),this.cleanupElement(),null===(t=i.parentNode)||void 0===t||t.removeChild(i)}handleEvent(e){var t;return __awaiter(this,void 0,void 0,(function*(){"timeupdate"!==e.type&&E.debug("BasePlayer.handleEvent: ",e.type,e,this.isPaused(),this._stopped);const{nowPlayingItem:i}=this;switch(e.type){case"canplay":this._dispatcher.publish($t,e),this._playbackState!==ui||this._targetElement.paused||this.setPlaybackState(li,i);break;case"durationchange":this._targetElement.duration!==1/0&&(e.duration=this.currentPlaybackDuration,this._dispatcher.publish(Gt,e),this._calculatePlaybackProgress());break;case"ended":{if(E.debug('media element "ended" event'),null===(t=this.nowPlayingItem)||void 0===t?void 0:t.isLinearStream)return void E.warn("ignoring ended event for linear stream",e);if(this.isElementCleaned()){E.debug('media element already cleaned, ignoring "ended" event');break}const i=this.currentPlaybackTime,r=this.currentPlayingDate;yield this.stopMediaAndCleanup(ni),this.dispatch(He.playbackStop,{position:i,playingDate:r,endReasonType:Xe.NATURAL_END_OF_TRACK});break}case"error":E.error("Playback Error",e,this._targetElement.error),this._dispatcher.publish(Wt,new MKError(MKError.MEDIA_PLAYBACK,"Playback Error"));break;case"loadedmetadata":this._dispatcher.publish(qt,e);break;case"loadstart":this.setPlaybackState(ai,i);break;case"pause":this.setPlaybackState(this._stopped?ci:oi,i);break;case"play":case"playing":this._paused=!1,this._stopped=!1,this.isPrimaryPlayer=!0,this.setPlaybackState(li,i);break;case"progress":{const e=this._targetElement.buffered;this.handleBufferStart(),1===e.length&&0===e.start(0)&&(this.currentBufferedProgress=Math.round(e.end(0)/this.currentPlaybackDuration*100));break}case"ratechange":this._dispatcher.publish(Jt,e);break;case"seeked":this._stopped?this.setPlaybackState(ci,i):this._paused?this.setPlaybackState(oi,i):this.playbackState!==ni&&this.setPlaybackState(li,i);break;case"seeking":this.playbackState===oi?this._paused=!0:this.playbackState===ci&&(this._stopped=!0),this.playbackState!==ni&&this.setPlaybackState(di,i);break;case"timeupdate":{this._dispatcher.publish(ii,{currentPlaybackDuration:this.currentPlaybackDuration,currentPlaybackTime:this.currentPlaybackTime,currentPlaybackTimeRemaining:this.currentPlaybackTimeRemaining}),this._calculatePlaybackProgress();const e=this._buffer;e&&(e.currentTime=this.currentPlaybackTime);break}case"volumechange":this._dispatcher.publish(ri,e);break;case"waiting":this.setPlaybackState(ui,i)}}))}handleBufferStart(){const{_targetElement:e}=this;void 0!==this.initialBufferPosition||e.paused||0===e.buffered.length||(this.initialBufferPosition=e.buffered.start(0),this.initialPlayingDate=this.currentPlayingDate,E.debug("BasePlayer.handleBufferStart: setting initial buffer position ",this.initialBufferPosition))}pause(e={}){return __awaiter(this,void 0,void 0,(function*(){yield this._waitForPendingPlay(),this.isPlaying&&(yield this._pauseMedia(),this._paused=!0,this.dispatch(He.playbackPause,Object.assign({position:this.currentPlaybackTime,playingDate:this.currentPlayingDate},e)))}))}play(e=!0){return __awaiter(this,void 0,void 0,(function*(){if(E.debug("BasePlayer.play()"),this.nowPlayingItem)try{const afterPlay=()=>{E.debug("BasePlayer.play dispatching playbackPlay"),this.dispatch(He.playbackPlay,{userInitiated:e,position:this.currentPlaybackTime,playingDate:this.currentPlayingDate})};yield this._playMedia(afterPlay)}catch(t){return void("NotAllowedError"!==t.name&&"NotSupportedError"!==t.name||E.error("BasePlayer.play() rejected due to",t))}}))}preload(){return this._loadMedia()}showPlaybackTargetPicker(){this.playbackTargetAvailable&&this._targetElement.webkitShowPlaybackTargetPicker()}dispatch(e,t){void 0===t.item&&(t.item=this.nowPlayingItem),hasOwn(t,"isPlaying")||(t.isPlaying=this.isPlaying),this._dispatcher.publish(e,t)}tsidChanged(e){void 0!==e&&""!==e&&(this.isPrimaryPlayer=e===this._serial)}_waitForPendingPlay(){return __awaiter(this,void 0,void 0,(function*(){if(this._playPromise)try{yield this._playPromise}catch(e){E.error("BasePlayer._waitForPendingPlay playPromise rejected",e)}finally{this._playPromise=void 0}}))}_loadMedia(){return E.debug("BasePlayer._loadMedia",this._targetElement),this._targetElement.load(),Promise.resolve()}_pauseMedia(){return this._targetElement.pause(),Promise.resolve()}_playAssetURL(e,t){E.debug("BasePlayer._playAssetURL",e),this._targetElement.src=e;const i=this._loadMedia();return t?(E.debug("BasePlayer.loadOnly"),i):this._playMedia()}playItemFromUnencryptedSource(e,t,i){return(null==i?void 0:i.startTime)&&(e+="#t="+i.startTime),this._playAssetURL(e,t)}_playMedia(e=Ee){return __awaiter(this,void 0,void 0,(function*(){E.debug("BasePlayer._playMedia",this._targetElement,this.extension);const t=this._targetElement.play().then(e=>(this._playbackDidStart=!0,e));this._playPromise=t.then(e),yield t}))}_setTargetElementTitle(e){this.hasMediaElement&&(this._targetElement.title=e)}_licenseError(){this._playPromise=void 0}_stopMediaElement(){return __awaiter(this,void 0,void 0,(function*(){this.hasMediaElement&&(this._targetElement.pause(),this.cleanupElement())}))}cleanupElement(){const e=this._targetElement;e&&!this.isElementCleaned()&&(e.currentTime=0,e.removeAttribute("src"),e.removeAttribute("title"))}isElementCleaned(){const e=this._targetElement;return!e||0===e.currentTime&&""===e.src&&""===e.title}}function generateAssetUrl(e,t){return t.startOver&&(e=addQueryParamsToURL(e,{startOver:!0})),t.supportsLinearScrubbing&&(e=addQueryParamsToURL(e,{linearScrubbingSupported:!0})),e}function restoreSelectedTrack(e,t){E.debug("MEDIA_TRACKS restoreSelectedTrack");const i=e.getPersistedTrack(),r=e.fields,s=t.currentTrack;if(!i)return void E.debug("MEDIA_TRACKS no persisted track");if(s&&trackEquals(s,i,r))return void E.debug("MEDIA_TRACKS persisted track is equal to current track, not setting");const n=t.tracks;if(n&&n.length)for(let a=0;a<n.length;a++){const e=n[a];if(E.debug(`MEDIA_TRACKS testing track ${e.label} against persisted track ${JSON.stringify(i)}`),trackEquals(e,i,r)){E.debug("MEDIA_TRACKS found matching track "+e.label),t.currentTrack=e;break}}}function trackEquals(e,t,i){let r=!0;for(let s=0;s<i.length;s++){const n=i[s];if(e[n]!==t[n]){r=!1;break}}return r}class TrackPersistence{constructor(e,t){this.storageKey=e,this.fields=t}getPersistedTrack(){var e;if(!hasLocalStorage())return!1;const t=(null===(e=getLocalStorage())||void 0===e?void 0:e.getItem(this.storageKey))||"";try{return JSON.parse(t)}catch(i){return E.warn("MEDIA_TRACK could not parse persisted value "+t),!1}}setPersistedTrack(e){var t,i;if(!hasLocalStorage())return;if(E.debug(`MEDIA_TRACK setPersistedTrack ${e.language},${e.label},${e.kind} with keys ${this.fields}`),!e)return void(null===(t=getLocalStorage())||void 0===t||t.setItem(this.storageKey,""));const r=JSON.stringify(this.extractFieldValuesFromTrack(e));E.debug("MEDIA_TRACK Extracted values "+r),null===(i=getLocalStorage())||void 0===i||i.setItem(this.storageKey,r)}extractFieldValuesFromTrack(e){const t={};return this.fields.forEach(i=>{const r=e[i];null==r&&E.warn(`MEDIA_TRACK No value for field ${i} on track ${JSON.stringify(e)}`),t[i]=r}),t}}const{audioTrackAdded:hi,audioTrackChanged:pi,audioTrackRemoved:yi}=Ye,{audioTracksSwitched:mi,audioTracksUpdated:gi}=Me;class AudioTrackManager{constructor(e,t,i){if(this.mediaElement=e,this.dispatcher=t,this.extensionTracks=i,this._extensionTracks=[],this.trackPersistence=new TrackPersistence("mk-audio-track",["label","language","kind"]),this.extensionTracks){E.debug("MEDIA_TRACK Initializing audio track manager for hls track events"),this.onExtensionAudioTracksUpdated=this.onExtensionAudioTracksUpdated.bind(this),this.onExtensionAudioTrackSwitched=this.onExtensionAudioTrackSwitched.bind(this);const e=this.extensionTracks;e.addEventListener(gi,this.onExtensionAudioTracksUpdated),e.addEventListener(mi,this.onExtensionAudioTrackSwitched)}else{if(!e.audioTracks)return;E.debug("MEDIA_TRACK Initializing audio track manager for native track events"),this.onAudioTrackAdded=this.onAudioTrackAdded.bind(this),this.onAudioTrackChanged=this.onAudioTrackChanged.bind(this),this.onAudioTrackRemoved=this.onAudioTrackRemoved.bind(this),e.audioTracks.addEventListener("addtrack",this.onAudioTrackAdded),e.audioTracks.addEventListener("change",this.onAudioTrackChanged),e.audioTracks.addEventListener("removetrack",this.onAudioTrackRemoved)}}get currentTrack(){return this.tracks.find(e=>e.enabled)}set currentTrack(e){e&&(E.debug("MEDIA_TRACK Setting audio track "+e.label),this.extensionTracks?(E.debug(`MEDIA_TRACK Setting track on extension ${e.id}-${e.label}`),this.extensionTracks.audioTrack=e):(E.debug("MEDIA_TRACK disabling all audio tracks"),Array.from(this.mediaElement.audioTracks).forEach(t=>{t!==e&&(t.enabled=!1)}),E.debug("MEDIA_TRACK enabling",e),e.enabled=!0),this.trackPersistence.setPersistedTrack(e))}get tracks(){return this.extensionTracks?this._extensionTracks||this.extensionTracks.audioTracks||[]:Array.from(this.mediaElement.audioTracks)}destroy(){if(this.extensionTracks){const e=this.extensionTracks;e.removeEventListener(gi,this.onExtensionAudioTracksUpdated),e.removeEventListener(mi,this.onExtensionAudioTrackSwitched)}else{if(!this.mediaElement.audioTracks)return;this.mediaElement.audioTracks.removeEventListener("addtrack",this.onAudioTrackAdded),this.mediaElement.audioTracks.removeEventListener("change",this.onAudioTrackChanged),this.mediaElement.audioTracks.removeEventListener("removetrack",this.onAudioTrackRemoved)}}restoreSelectedTrack(){return restoreSelectedTrack(this.trackPersistence,this)}onExtensionAudioTracksUpdated(e){E.debug("MEDIA_TRACK Extension audio tracks updated "+JSON.stringify(e)),this._extensionTracks=e,this.restoreSelectedTrack(),this.dispatcher.publish(hi,e)}onExtensionAudioTrackSwitched(e){if(E.debug("MEDIA_TRACK Extension audio track switched "+JSON.stringify(e)),this._extensionTracks){const preserveSelectedTrack=t=>{t.enabled=e.selectedId===t.id};this._extensionTracks.forEach(preserveSelectedTrack)}this.dispatcher.publish(pi,e)}onAudioTrackAdded(e){!function(e,t,i){const r=t.getPersistedTrack();r&&trackEquals(e,r,t.fields)&&(E.debug("MEDIA_TRACK onTrackAdded with track that matches persisted track "+e.label),i.currentTrack=e)}(e.track,this.trackPersistence,this),this.dispatcher.publish(hi,e)}onAudioTrackChanged(e){this.dispatcher.publish(pi,e)}onAudioTrackRemoved(e){this.dispatcher.publish(yi,e)}}var fi=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.isValidPercentValue=function(e){return"number"==typeof e&&e>=0&&e<=100},t.isValidAlignSetting=function(e){return"string"==typeof e&&["start","center","end","left","right","middle"].includes(e)},t.isValidDirectionSetting=function(e){return"string"==typeof e&&["","rl","lr"].includes(e)},t.isValidLineAndPositionSetting=function(e){return"number"==typeof e||"auto"===e},t.isValidLineAlignSetting=function(e){return"string"==typeof e&&["start","center","end"].includes(e)},t.isValidPositionAlignSetting=function(e){return"string"==typeof e&&["line-left","center","line-right","auto","left","start","middle","end","right"].includes(e)},t.isValidScrollSetting=function(e){return["","up"].includes(e)}}));unwrapExports(fi),fi.isValidPercentValue,fi.isValidAlignSetting,fi.isValidDirectionSetting,fi.isValidLineAndPositionSetting,fi.isValidLineAlignSetting,fi.isValidPositionAlignSetting,fi.isValidScrollSetting;var vi=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0});const i={"&amp;":"&","&lt;":"<","&gt;":">","&lrm;":"‎","&rlm;":"‏","&nbsp;":" "},r={c:"span",i:"i",b:"b",u:"u",ruby:"ruby",rt:"rt",v:"span",lang:"span"},s={v:"title",lang:"lang"},n={rt:"ruby"},a={"text-combine-upright":"-webkit-text-combine:horizontal; text-orientation: mixed;"};class ParserUtility{static parseTimeStamp(e){function computeSeconds(e){const[t,i,r,s]=e.map(e=>e?parseInt(""+e):0);return 3600*t+60*i+r+s/1e3}const t=/^(\d+):(\d{2})(:\d{2})?\.(\d{3})/.exec(e);return t?t[3]?computeSeconds([t[1],t[2],t[3].substring(1),t[4]]):parseInt(t[1])>59?computeSeconds([t[1],t[2],null,t[4]]):computeSeconds([null,t[1],t[2],t[4]]):null}static parseContent(e,t,o){let l=t.text;function nextToken(){if(!l)return null;const e=/^([^<]*)(<[^>]+>?)?/.exec(l);return t=e[1]?e[1]:e[2],l=l.substr(t.length),t;var t}function unescape1(e){return i[e]}function shouldAdd(e,t){return!n[t.dataset.localName]||n[t.dataset.localName]===e.dataset.localName}function createElement(t,i,n){const l=r[t];if(!l)return null;const d=e.document.createElement(l);d.dataset.localName=l;const c=s[t];if(c&&n&&(d[c]=n.trim()),i)if(o[i]){const e=function(e){let t="";for(const i in e)t+=a[i]?a[i]:i+":"+e[i]+";";return t}(o[i]);d.setAttribute("style",e)}else console.info(`WebVTT: parseContent: Style referenced, but no style defined for '${i}'!`);return d}const d=e.document.createElement("div"),c=[];let u,h,p=d;for(;null!==(u=nextToken());)if("<"!==u[0])p.appendChild(e.document.createTextNode(u.replace(/&(amp|lt|gt|lrm|rlm|nbsp);/g,unescape1)));else{if("/"===u[1]){c.length&&c[c.length-1]===u.substr(2).replace(">","")&&(c.pop(),p=p.parentNode);continue}const t=ParserUtility.parseTimeStamp(u.substr(1,u.length-2));let i;if(t){i=e.document.createProcessingInstruction("timestamp",t.toString()),p.appendChild(i);continue}if(h=/^<([^.\s/0-9>]+)(\.[^\s\\>]+)?([^>\\]+)?(\\?)>?$/.exec(u),!h)continue;if(i=createElement(h[1],h[2],h[3]),!i)continue;if(!shouldAdd(p,i))continue;h[2],c.push(h[1]),p.appendChild(i),p=i}return d}}t.default=ParserUtility}));unwrapExports(vi);var _i=createCommonjsModule((function(e,t){var i=O&&O.__decorate||function(e,t,i,r){var s,n=arguments.length,a=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(s=e[o])&&(a=(n<3?s(a):n>3?s(t,i,a):s(t,i))||a);return n>3&&a&&Object.defineProperty(t,i,a),a};Object.defineProperty(t,"__esModule",{value:!0});let r=class{constructor(e,t,i){this._id="",this._pauseOnExit=!1,this._region=null,this._vertical="",this._snapToLines=!0,this._line="auto",this._lineAlign="start",this._position="auto",this._positionAlign="auto",this._size=100,this._align="center",this.hasBeenReset=!1,this._startTime=e,this._endTime=t,this._text=i}get id(){return this._id}set id(e){this._id=""+e}get pauseOnExit(){return this._pauseOnExit}set pauseOnExit(e){this._pauseOnExit=!!e}get startTime(){return this._startTime}set startTime(e){if("number"!=typeof e)throw new TypeError("Start time must be set to a number: "+e);this._startTime=e,this.hasBeenReset=!0}get endTime(){return this._endTime}set endTime(e){if("number"!=typeof e)throw new TypeError("End time must be set to a number: "+e);this._endTime=e,this.hasBeenReset=!0}get text(){return this._text}set text(e){this._text=""+e,this.hasBeenReset=!0}get region(){return this._region}set region(e){this._region=e,this.hasBeenReset=!0}get vertical(){return this._vertical}set vertical(e){if(!fi.isValidDirectionSetting(e))throw new SyntaxError("An invalid or illegal string was specified for vertical: "+e);this._vertical=e,this.hasBeenReset=!0}get snapToLines(){return this._snapToLines}set snapToLines(e){this._snapToLines=!!e,this.hasBeenReset=!0}get line(){return this._line}set line(e){if(!fi.isValidLineAndPositionSetting(e))throw new SyntaxError("An invalid number or illegal string was specified for line: "+e);this._line=e,this.hasBeenReset=!0}get lineAlign(){return this._lineAlign}set lineAlign(e){if(!fi.isValidLineAlignSetting(e))throw new SyntaxError("An invalid or illegal string was specified for lineAlign: "+e);this._lineAlign=e,this.hasBeenReset=!0}get position(){return this._position}set position(e){if(!fi.isValidLineAndPositionSetting(e))throw new Error("Position must be between 0 and 100 or auto: "+e);this._position=e,this.hasBeenReset=!0}get positionAlign(){return this._positionAlign}set positionAlign(e){if(!fi.isValidPositionAlignSetting(e))throw new SyntaxError("An invalid or illegal string was specified for positionAlign: "+e);this._positionAlign=e,this.hasBeenReset=!0}get size(){return this._size}set size(e){if(e<0||e>100)throw new Error("Size must be between 0 and 100: "+e);this._size=e,this.hasBeenReset=!0}get align(){return this._align}set align(e){if(!fi.isValidAlignSetting(e))throw new SyntaxError("An invalid or illegal string was specified for align: "+e);this._align=e,this.hasBeenReset=!0}getCueAsHTML(){return vi.default.parseContent(window,this,{})}static create(e){if(!e.hasOwnProperty("startTime")||!e.hasOwnProperty("endTime")||!e.hasOwnProperty("text"))throw new Error("You must at least have start time, end time, and text.");const t=new this(e.startTime,e.endTime,e.text);return Object.keys(e).forEach(i=>{t.hasOwnProperty(i)&&(t[i]=e[i])}),t}static fromJSON(e){return this.create(JSON.parse(e))}toJSON(){const e={};return Object.keys(this).forEach(t=>{this.hasOwnProperty(t)&&"getCueAsHTML"!==t&&"hasBeenReset"!==t&&"displayState"!==t&&(e[t]=this[t])}),e}};r=i([function(e){let t=e;"undefined"!=typeof window&&null!=window.VTTCue&&(t=window.VTTCue,t.create=e.create,t.fromJSON=e.fromJSON,t.prototype.toJSON=e.prototype.toJSON);return t}],r),t.VTTCue=r}));unwrapExports(_i),_i.VTTCue;var bi=createCommonjsModule((function(e,t){var i=O&&O.__decorate||function(e,t,i,r){var s,n=arguments.length,a=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(s=e[o])&&(a=(n<3?s(a):n>3?s(t,i,a):s(t,i))||a);return n>3&&a&&Object.defineProperty(t,i,a),a};Object.defineProperty(t,"__esModule",{value:!0});let r=class{constructor(){this._id="",this._lines=3,this._regionAnchorX=0,this._regionAnchorY=100,this._scroll="",this._viewportAnchorX=0,this._viewportAnchorY=100,this._width=100}get id(){return this._id}set id(e){if("string"!=typeof e)throw new Error("ID must be a string.");this._id=e}get lines(){return this._lines}set lines(e){if("number"!=typeof e)throw new TypeError("Lines must be set to a number.");this._lines=e}get regionAnchorX(){return this._regionAnchorX}set regionAnchorX(e){if(!fi.isValidPercentValue(e))throw new TypeError("RegionAnchorX must be between 0 and 100.");this._regionAnchorX=e}get regionAnchorY(){return this._regionAnchorY}set regionAnchorY(e){if(!fi.isValidPercentValue(e))throw new TypeError("RegionAnchorY must be between 0 and 100.");this._regionAnchorY=e}get scroll(){return this._scroll}set scroll(e){if("string"==typeof e){const t=e.toLowerCase();if(fi.isValidScrollSetting(t))return void(this._scroll=t)}throw new SyntaxError("An invalid or illegal string was specified.")}get viewportAnchorX(){return this._viewportAnchorX}set viewportAnchorX(e){if(!fi.isValidPercentValue(e))throw new TypeError("ViewportAnchorX must be between 0 and 100.");this._viewportAnchorX=e}get viewportAnchorY(){return this._viewportAnchorY}set viewportAnchorY(e){if(!fi.isValidPercentValue(e))throw new TypeError("ViewportAnchorY must be between 0 and 100.");this._viewportAnchorY=e}get width(){return this._width}set width(e){if(!fi.isValidPercentValue(e))throw new TypeError("Width must be between 0 and 100.");this._lines=e}toJSON(){const e={};return Object.keys(this).forEach(t=>{this.hasOwnProperty(t)&&(e[t]=this[t])}),e}static create(e){const t=new this;return Object.keys(e).forEach(i=>{t.hasOwnProperty(i)&&(t[i]=e[i])}),t}static fromJSON(e){return this.create(JSON.parse(e))}};r=i([function(e){let t=e;"undefined"!=typeof window&&null!=window.VTTRegion&&(t=window.VTTRegion,t.create=e.create,t.fromJSON=e.fromJSON,t.prototype.toJSON=e.prototype.toJSON);return t}],r),t.VTTRegion=r}));unwrapExports(bi),bi.VTTRegion;var Ti=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.VTTCue=_i.VTTCue,t.VTTRegion=bi.VTTRegion;class ParsingError extends Error{constructor(e,t){super(),this.name="ParsingError",this.code="number"==typeof e?e:e.code,t?this.message=t:e instanceof ParsingError&&(this.message=e.message)}}t.ParsingError=ParsingError,ParsingError.Errors={BadSignature:new ParsingError(0,"Malformed WebVTT signature."),BadTimeStamp:new ParsingError(1,"Malformed time stamp.")};class Settings{constructor(){this.values={}}set(e,t){this.get(e)||""===t||(this.values[e]=t)}get(e,t,i){return"object"==typeof t&&"string"==typeof i?this.has(e)?this.values[e]:t[i]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(e,t,i){for(let r=0;r<i.length;++r)if(t===i[r]){this.set(e,t);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}percent(e,t){if(t.match(/^([\d]{1,3})(\.[\d]*)?%$/))try{const i=parseFloat(t);if(i>=0&&i<=100)return this.set(e,i),!0}catch(sl){return!1}return!1}}class WebVTTParser{constructor(e,t,i){this.window=e,this.state="INITIAL",this.styleCollector="",this.buffer="",this.decoder=t||new TextDecoder("utf8"),this.regionList=[],this.onStylesParsedCallback=i,this._styles={}}static StringDecoder(){return{decode:e=>{if(!e)return"";if("string"!=typeof e)throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}}reportOrThrowError(e){if(!(e instanceof ParsingError&&"function"==typeof this.onparsingerror))throw e;this.onparsingerror(e)}parseOptions(e,t,i,r){const s=r?e.split(r):[e];for(const n of s){if("string"!=typeof n)continue;const e=n.split(i);if(2!==e.length)continue;t(e[0],e[1])}}parseCue(e,t,i){const r=e,consumeTimeStamp=()=>{const t=vi.default.parseTimeStamp(e);if(null===t)throw new ParsingError(ParsingError.Errors.BadTimeStamp,"Malformed timestamp: "+r);return e=e.replace(/^[^\sa-zA-Z-]+/,""),t},skipWhitespace=()=>{e=e.replace(/^\s+/,"")};if(skipWhitespace(),t.startTime=consumeTimeStamp(),skipWhitespace(),"--\x3e"!==e.substr(0,3))throw new ParsingError(ParsingError.Errors.BadTimeStamp,"Malformed time stamp (time stamps must be separated by '--\x3e'): "+r);e=e.substr(3),skipWhitespace(),t.endTime=consumeTimeStamp(),skipWhitespace(),((e,t)=>{const r=new Settings;this.parseOptions(e,(e,t)=>{let s,n;switch(e){case"region":for(let s=i.length-1;s>=0;s--)if(i[s].id===t){r.set(e,i[s].region);break}break;case"vertical":r.alt(e,t,["rl","lr"]);break;case"line":s=t.split(","),n=s[0],r.integer(e,n),r.percent(e,n)&&r.set("snapToLines",!1),r.alt(e,n,["auto"]),2===s.length&&r.alt("lineAlign",s[1],["start","center","end"]);break;case"position":if(s=t.split(","),r.percent(e,s[0]),2===s.length){let e=["line-left","line-right","center","auto","left","start","middle","end","right"];r.alt("positionAlign",s[1],e)}break;case"size":r.percent(e,t);break;case"align":let a=["start","center","end","left","right","middle"];r.alt(e,t,a)}},/:/,/\s/),t.region=r.get("region",null),t.vertical=r.get("vertical",""),t.line=r.get("line",void 0===t.line?"auto":t.line),t.lineAlign=r.get("lineAlign","start"),t.snapToLines=r.get("snapToLines",!0),t.size=r.get("size",100);let s=r.get("align","center");t.align="middle"===s?"center":s,t.position=r.get("position","auto");let n=r.get("positionAlign",{start:"start",left:"start",center:"center",right:"end",end:"end"},t.align);t.positionAlign={start:"start","line-left":"start",left:"start",center:"center",middle:"center","line-right":"end",right:"end",end:"end"}[n]})(e,t)}parseRegion(e){const t=new Settings;if(this.parseOptions(e,(e,i)=>{switch(e){case"id":t.set(e,i);break;case"width":t.percent(e,i);break;case"lines":t.integer(e,i);break;case"regionanchor":case"viewportanchor":{const r=i.split(",");if(2!==r.length)break;const s=new Settings;if(s.percent("x",r[0]),s.percent("y",r[1]),!s.has("x")||!s.has("y"))break;t.set(e+"X",s.get("x")),t.set(e+"Y",s.get("y"));break}case"scroll":t.alt(e,i,["up"])}},/=/,/\s/),t.has("id")){const e=new bi.VTTRegion;e.width=t.get("width",100),e.lines=t.get("lines",3),e.regionAnchorX=t.get("regionanchorX",0),e.regionAnchorY=t.get("regionanchorY",100),e.viewportAnchorX=t.get("viewportanchorX",0),e.viewportAnchorY=t.get("viewportanchorY",100),e.scroll=t.get("scroll",""),this.onregion&&this.onregion(e),this.regionList.push({id:t.get("id"),region:e})}}parseStyle(e){const parseStyles=e=>{const t={},i=e.split(";");for(let r=0;r<i.length;r++)if(i[r].includes(":")){const e=i[r].split(":",2),s=e[0].trim(),n=e[1].trim();""!==s&&""!==n&&(t[s]=n)}return t},t=e.split("}");t.pop();for(const i of t){let e=null,t=null;const r=i.split("{");r[0]&&(e=r[0].trim()),r[1]&&(t=parseStyles(r[1])),e&&t&&(this._styles[e]=t)}this.onStylesParsedCallback&&this.onStylesParsedCallback(this._styles)}parseHeader(e){this.parseOptions(e,(function(e,t){switch(e){case"Region":this.parseRegion(t)}}),/:/)}parse(e){e&&(this.buffer+=this.decoder.decode(e,{stream:!0}));const collectNextLine=()=>{const e=this.buffer;let t=0;const calculateBreakPosition=(e,t)=>{const i={start:-1,length:-1};if("\r"===e[t])i.start=t,i.length=1;else if("\n"===e[t])i.start=t,i.length=1;else if("<"===e[t]&&t+1<e.length&&"b"===e[t+1]&&t+2<e.length&&"r"===e[t+2]){let r=t+2;for(;r<e.length&&">"!==e[r++];);i.start=t,i.length=r-t}return i};let i={start:e.length,length:0};for(;t<e.length;){const r=calculateBreakPosition(e,t);if(r.length>0){i=r;break}++t}const r=e.substr(0,i.start);return this.buffer=e.substr(i.start+i.length),r};try{let e;if("INITIAL"===this.state){if(!/\r\n|\n/.test(this.buffer))return this;e=collectNextLine();const t=/^(ï»¿)?WEBVTT([ \t].*)?$/.exec(e);if(!t||!t[0])throw new ParsingError(ParsingError.Errors.BadSignature);this.state="HEADER"}let i=!1;for(;this.buffer;){if(!/\r\n|\n/.test(this.buffer))return this;switch(i?i=!1:e=collectNextLine(),this.state){case"HEADER":e.includes(":")?this.parseHeader(e):e||(this.state="ID");continue;case"NOTE":e||(this.state="ID");continue;case"STYLE":e?this.styleCollector+=e:(this.parseStyle(this.styleCollector),this.state="ID",this.styleCollector="");continue;case"ID":if(/^NOTE($|[ \t])/.test(e)){this.state="NOTE";break}if(/^STYLE($|[ \t])/.test(e)){this.state="STYLE";break}if(!e)continue;if(this.cue=new _i.VTTCue(0,0,""),this.state="CUE",!e.includes("--\x3e")){this.cue.id=e;continue}case"CUE":try{this.parseCue(e,this.cue,this.regionList)}catch(t){this.reportOrThrowError(t),this.cue=null,this.state="BADCUE";continue}this.state="CUETEXT";continue;case"CUETEXT":{const t=e.includes("--\x3e");if(!e||t){i=!0,this.oncue&&this.oncue(this.cue),this.cue=null,this.state="ID";continue}this.cue.text&&(this.cue.text+="\n"),this.cue.text+=e;continue}case"BADCUE":e||(this.state="ID");continue}}}catch(t){this.reportOrThrowError(t),"CUETEXT"===this.state&&this.cue&&this.oncue&&this.oncue(this.cue),this.cue=null,this.state="INITIAL"===this.state?"BADWEBVTT":"BADCUE"}return this}flush(){try{if(this.buffer+=this.decoder.decode(),(this.cue||"HEADER"===this.state)&&(this.buffer+="\n\n",this.parse()),"INITIAL"===this.state)throw new ParsingError(ParsingError.Errors.BadSignature)}catch(e){this.reportOrThrowError(e)}return this.onflush&&this.onflush(),this}styles(){return this._styles}}t.default=WebVTTParser,t.WebVTTParser=WebVTTParser}));unwrapExports(Ti),Ti.VTTCue,Ti.VTTRegion,Ti.ParsingError,Ti.WebVTTParser;var Si=createCommonjsModule((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.VTTCue=_i.VTTCue;const i=[/^(::cue\()(\..*)(\))/,/^(::cue\()(#.*)(\))/,/^(::cue\()(c|i|b|u|ruby|rt|v|lang)(\))/],r=[[1470,1470],[1472,1472],[1475,1475],[1478,1478],[1488,1514],[1520,1524],[1544,1544],[1547,1547],[1549,1549],[1563,1563],[1566,1610],[1645,1647],[1649,1749],[1765,1766],[1774,1775],[1786,1805],[1807,1808],[1810,1839],[1869,1957],[1969,1969],[1984,2026],[2036,2037],[2042,2042],[2048,2069],[2074,2074],[2084,2084],[2088,2088],[2096,2110],[2112,2136],[2142,2142],[2208,2208],[2210,2220],[8207,8207],[64285,64285],[64287,64296],[64298,64310],[64312,64316],[64318,64318],[64320,64321],[64323,64324],[64326,64449],[64467,64829],[64848,64911],[64914,64967],[65008,65020],[65136,65140],[65142,65276],[67584,67589],[67592,67592],[67594,67637],[67639,67640],[67644,67644],[67647,67669],[67671,67679],[67840,67867],[67872,67897],[67903,67903],[67968,68023],[68030,68031],[68096,68096],[68112,68115],[68117,68119],[68121,68147],[68160,68167],[68176,68184],[68192,68223],[68352,68405],[68416,68437],[68440,68466],[68472,68479],[68608,68680],[126464,126467],[126469,126495],[126497,126498],[126500,126500],[126503,126503],[126505,126514],[126516,126519],[126521,126521],[126523,126523],[126530,126530],[126535,126535],[126537,126537],[126539,126539],[126541,126543],[126545,126546],[126548,126548],[126551,126551],[126553,126553],[126555,126555],[126557,126557],[126559,126559],[126561,126562],[126564,126564],[126567,126570],[126572,126578],[126580,126583],[126585,126588],[126590,126590],[126592,126601],[126603,126619],[126625,126627],[126629,126633],[126635,126651],[1114109,1114109]];class StyleBox{applyStyles(e,t){t=t||this.div;for(const i in e)e.hasOwnProperty(i)&&(t.style[i]=e[i])}formatStyle(e,t){return 0===e?"0":e+t}}t.StyleBox=StyleBox;class CueStyleBox extends StyleBox{constructor(e,t,i,r,s){super(),this.cue=t;let n={textAlign:{start:"left","line-left":"left",left:"left",center:"center",middle:"center","line-right":"right",right:"right",end:"right"}[t.positionAlign]||t.align,whiteSpace:"pre-line",position:"absolute"};n.direction=this.determineBidi(this.cueDiv),n.writingMode=this.directionSettingToWritingMode(t.vertical),n.unicodeBidi="plaintext",this.div=e.document.createElement("div"),this.applyStyles(n),n={backgroundColor:r.backgroundColor,display:"inline-block"},this.parseOpacity(n.backgroundColor)&&(n.padding="5px",n.borderRadius="5px"),this.backgroundDiv=e.document.createElement("div"),this.applyStyles(n,this.backgroundDiv),n={color:i.color,backgroundColor:i.backgroundColor,textShadow:i.textShadow,fontSize:i.fontSize,fontFamily:i.fontFamily,position:"relative",left:"0",right:"0",top:"0",bottom:"0",display:"inline-block",textOrientation:"upright"},n.writingMode=this.directionSettingToWritingMode(t.vertical),n.unicodeBidi="plaintext",this.cueDiv=vi.default.parseContent(e,t,s),this.applyStyles(n,this.cueDiv),this.backgroundDiv.appendChild(this.cueDiv),this.div.appendChild(this.backgroundDiv);let a=0;if("number"==typeof t.position){let e=t.positionAlign||t.align;if(e)switch(e){case"start":case"left":a=t.position;break;case"center":case"middle":a=t.position-t.size/2;break;case"end":case"right":a=t.position-t.size}}""===t.vertical?this.applyStyles({left:this.formatStyle(a,"%"),width:this.formatStyle(t.size,"%")}):this.applyStyles({top:this.formatStyle(a,"%"),height:this.formatStyle(t.size,"%")})}determineBidi(e){let t,i=[],s="";if(!e||!e.childNodes)return"ltr";function pushNodes(e,t){for(let i=t.childNodes.length-1;i>=0;i--)e.push(t.childNodes[i])}function nextTextNode(e){if(!e||!e.length)return null;let t=e.pop(),i=t.textContent||t.innerText;if(i){const t=/^.*(\n|\r)/.exec(i);return t?(e.length=0,t[0]):i}return"ruby"===t.tagName?nextTextNode(e):t.childNodes?(pushNodes(e,t),nextTextNode(e)):void 0}function isContainedInCharacterList(e,t){for(const i of t)if(e>=i[0]&&e<=i[1])return!0;return!1}for(pushNodes(i,e);s=nextTextNode(i);)for(let e=0;e<s.length;e++)if(t=s.charCodeAt(e),isContainedInCharacterList(t,r))return"rtl";return"ltr"}parseOpacity(e){if(!e||"string"!=typeof e)return null;const t=(e=e.replace(/ /g,"").replace("rgba(","").replace(")","")).split(",");return t&&t.length>=4?t[3]:null}directionSettingToWritingMode(e){return""===e?"horizontal-tb":"lr"===e?"vertical-lr":"vertical-rl"}move(e){this.applyStyles({top:this.formatStyle(e.top,"px"),bottom:this.formatStyle(e.bottom,"px"),left:this.formatStyle(e.left,"px"),right:this.formatStyle(e.right,"px"),height:this.formatStyle(e.height,"px"),width:this.formatStyle(e.width,"px")})}}t.CueStyleBox=CueStyleBox;class BoxPosition{constructor(e){var t;let i,r,s,n,a,o;if(e instanceof CueStyleBox&&e.cue?(t=e.cue)&&""!==t.vertical?this.property="width":this.property="height":e instanceof BoxPosition&&(this.property=e.property||"height"),e instanceof CueStyleBox&&e.div){s=e.div.offsetHeight,n=e.div.offsetWidth,a=e.div.offsetTop;const t=e.div.firstChild;if(o=t?t.getBoundingClientRect():e.div.getBoundingClientRect(),i=o&&o[this.property]||null,t&&t.firstChild){const e=t.firstChild;if(e&&"string"==typeof e.textContent){r=i/this.calculateNewLines(e.textContent)}}}else e instanceof BoxPosition&&(o=e);this.left=o.left,this.right=o.right,this.top=o.top||a,this.height=o.height||s,this.bottom=o.bottom||a+(o.height||s),this.width=o.width||n,this.lineHeight=null!==i?i:o.lineHeight,this.singleLineHeight=null!==r?r:o.singleLineHeight,this.singleLineHeight||(this.singleLineHeight=41)}calculateNewLines(e){let t=1;for(let i=0;i<e.length;i++)"\n"===e[i]&&t++;return t}move(e,t){switch(t=void 0!==t?t:this.singleLineHeight,e){case"+x":this.left+=t,this.right+=t;break;case"-x":this.left-=t,this.right-=t;break;case"+y":this.top+=t,this.bottom+=t;break;case"-y":this.top-=t,this.bottom-=t}}overlaps(e){return this.left<e.right&&this.right>e.left&&this.top<e.bottom&&this.bottom>e.top}overlapsAny(e){for(const t of e)if(this.overlaps(t))return!0;return!1}within(e){return this.top>=e.top&&this.bottom<=e.bottom&&this.left>=e.left&&this.right<=e.right}moveIfOutOfBounds(e,t){switch(t){case"+x":this.left<e.left&&(this.left=e.left,this.right=this.left+this.width);break;case"-x":this.right>e.right&&(this.right=e.right,this.left=this.right-this.width);break;case"+y":this.top<e.top&&(this.top=e.top,this.bottom=this.top+this.height);break;case"-y":this.bottom>e.bottom&&(this.bottom=e.bottom,this.top=this.bottom-this.height)}}toCSSCompatValues(e){return{top:this.top-e.top,bottom:e.bottom-this.bottom,left:this.left-e.left,right:e.right-this.right,height:this.height,width:this.width}}static getSimpleBoxPosition(e){let t=null;e instanceof StyleBox&&e.div?t=e.div:e instanceof HTMLElement&&(t=e);let i=t.offsetHeight||0,r=t.offsetWidth||0,s=t.offsetTop||0,n=s+i,a=t.getBoundingClientRect();const{left:o,right:l}=a;return a.top&&(s=a.top),a.height&&(i=a.height),a.width&&(r=a.width),a.bottom&&(n=a.bottom),{left:o,right:l,top:s,height:i,bottom:n,width:r}}static getBoxPosition(e,t){if(e&&e.length>0){let i=0,r=e[0][t];for(let s=0;s<e.length;s++)t in["top","right"]?e[s][t]>r&&(i=s,r=e[s][t]):t in["bottom","left"]&&e[s][t]<r&&(i=s,r=e[s][t]);return e[i]}return null}static moveToMinimumDistancePlacement(e,t,i){"height"===e.property?"+y"===t?(e.top=i.topMostBoxPosition.bottom+0,e.bottom=e.top+e.height):"-y"===t&&(e.bottom=i.bottomMostBoxPosition.top-0,e.top=e.bottom-e.height):"width"===e.property&&("+x"===t?(e.left=i.rightMostBoxPosition.right+0,e.right=e.left+e.width):"-x"===t&&(e.right=i.leftMostBoxPosition.left-0,e.left=e.right-e.width))}static moveBoxToLinePosition(e,t,i){const r=e.cue;let s,n=new BoxPosition(e),a=function(e){if("number"==typeof e.line&&(e.snapToLines||e.line>=0&&e.line<=100))return e.line;if(!e.track||!e.track.textTrackList||!e.track.textTrackList.mediaElement)return-1;let t=0;const i=e.track,r=i.textTrackList;for(let s=0;s<r.length&&r[s]!==i;s++)"showing"===r[s].mode&&t++;return-1*++t}(r),o=[];if(r.snapToLines){let e=0;switch(r.vertical){case"":o=["+y","-y"],s="height";break;case"rl":o=["+x","-x"],s="width";break;case"lr":o=["-x","+x"],s="width"}const i=n.lineHeight,l=t[s]+i,d=o[0];if(a<0){let s=0;switch(r.vertical){case"":s=t.height-i-.05*t.height;break;case"rl":case"lr":s=-t.width+i+.05*t.width}e=s,o=o.reverse()}else{switch(r.vertical){case"":e=i*Math.round(a);break;case"rl":e=t.width-i*Math.round(a);break;case"lr":e=i*Math.round(a)}Math.abs(e)>l&&(e=e<0?-1:1,e*=Math.ceil(l/i)*i)}n.move(d,e)}else{const i=""===r.vertical?t.height:t.width,s=n.lineHeight/i*100;switch(r.lineAlign){case"center":a-=s/2;break;case"end":a-=s}switch(r.vertical){case"":e.applyStyles({top:e.formatStyle(a,"%")});break;case"rl":e.applyStyles({right:e.formatStyle(a,"%")});break;case"lr":e.applyStyles({left:e.formatStyle(a,"%")})}o=["+y","-y","+x","-x"],"+y"===r.axis?o=["+y","-y","+x","-x"]:"-y"===r.axis&&(o=["-y","+y","+x","-x"]),n=new BoxPosition(e)}const l=function(e,r){let s;for(let n=0;n<r.length;n++){e.moveIfOutOfBounds(t,r[n]);let a=0,o=!1;for(;e.overlapsAny(i)&&!(a>9);)o?e.move(r[n]):(i&&i.length>0&&(s||(s={topMostBoxPosition:BoxPosition.getBoxPosition(i,"top"),bottomMostBoxPosition:BoxPosition.getBoxPosition(i,"bottom"),leftMostBoxPosition:BoxPosition.getBoxPosition(i,"left"),rightMostBoxPosition:BoxPosition.getBoxPosition(i,"right")}),BoxPosition.moveToMinimumDistancePlacement(e,r[n],s)),o=!0),a++}return e}(n,o);e.move(l.toCSSCompatValues(t))}}t.BoxPosition=BoxPosition;class WebVTTRenderer{constructor(e,t,i=!0){if(!e)return null;this.window=e,this.overlay=t,this.loggingEnabled=i,this.foregroundStyleOptions={fontFamily:"Helvetica",fontSize:"36px",color:"rgba(255, 255, 255, 1)",textShadow:"",backgroundColor:"rgba(0, 0, 0, 0)"},this.backgroundStyleOptions={backgroundColor:"rgba(0, 0, 0, 0.5)"},this.globalStyleCollection={};const r=e.document.createElement("div");r.style.position="absolute",r.style.left="0",r.style.right="0",r.style.top="0",r.style.bottom="0",r.style.margin="1.5%",this.paddedOverlay=r,t.appendChild(this.paddedOverlay),this.initSubtitleCSS()}initSubtitleCSS(){const e=[new _i.VTTCue(0,0,"String to init CSS - Won't be visible to user")];this.paddedOverlay.style.opacity="0",this.processCues(e),this.processCues([]),this.paddedOverlay.style.opacity="1"}convertCueToDOMTree(e){return e?vi.default.parseContent(this.window,e,this.globalStyleCollection):null}setStyles(e){function applyStyles(e,t,i){for(const r in t)t.hasOwnProperty(r)&&(!0===i&&void 0!==e[r]||!1===i)&&(e[r]=t[r])}for(const t in e){let r=!1,s=null;"::cue"===t?(s=this.foregroundStyleOptions,r=!0):"::-webkit-media-text-track-display"===t&&(s=this.backgroundStyleOptions,r=!0);const n=e[t];if(!0===r)applyStyles(s,n,r);else for(let e=0;e<i.length;e++){const s=i[e].exec(t);if(s&&4===s.length){const e=s[2],t={};applyStyles(t,n,r),this.globalStyleCollection[e]=t}}}this.initSubtitleCSS(),this.loggingEnabled&&(console.log("WebVTTRenderer setStyles foregroundStyleOptions: "+JSON.stringify(this.foregroundStyleOptions)),console.log("WebVTTRenderer setStyles backgroundStyleOptions: "+JSON.stringify(this.backgroundStyleOptions)),console.log("WebVTTRenderer setStyles globalStyleCollection: "+JSON.stringify(this.globalStyleCollection)))}processCues(e){if(!e)return;for(;this.paddedOverlay.firstChild;)this.paddedOverlay.removeChild(this.paddedOverlay.firstChild);if(!function(e){for(let t=0;t<e.length;t++)if(e[t].hasBeenReset||!e[t].displayState)return!0;return!1}(e)){for(let t=0;t<e.length;t++)this.paddedOverlay.appendChild(e[t].displayState);return}const t=[],i=BoxPosition.getSimpleBoxPosition(this.paddedOverlay);e.length>1&&(e=function(e){const t=[];let i=0;for(let r=0;r<e.length;r++){let s=e[r];if("number"!=typeof s.line)return e;i+=s.line,t.push(s)}return i/=e.length,i>50?(t.forEach((function(e){e.axis="-y"})),t.sort((e,t)=>t.line-e.line)):(t.forEach((function(e){e.axis="+y"})),t.sort((e,t)=>e.line-t.line)),t}(e));for(let r=0;r<e.length;r++){let s=e[r],n=new CueStyleBox(this.window,s,this.foregroundStyleOptions,this.backgroundStyleOptions,this.globalStyleCollection);this.paddedOverlay.appendChild(n.div),BoxPosition.moveBoxToLinePosition(n,i,t),s.displayState=n.div,t.push(BoxPosition.getSimpleBoxPosition(n))}}setSize(e,t){e&&(this.overlay.style.width=e+"px"),t&&(this.overlay.style.height=t+"px")}getOverlay(){return this.overlay}}t.default=WebVTTRenderer,t.WebVTTRenderer=WebVTTRenderer}));unwrapExports(Si),Si.VTTCue,Si.StyleBox,Si.CueStyleBox,Si.BoxPosition,Si.WebVTTRenderer;var Ei=createCommonjsModule((function(e,t){function __export(e){for(var i in e)t.hasOwnProperty(i)||(t[i]=e[i])}Object.defineProperty(t,"__esModule",{value:!0}),__export(Ti),__export(Si)}));unwrapExports(Ei);var ki=Ei.WebVTTRenderer;class TrackManagerStub{get currentTrack(){return{}}set currentTrack(e){}get tracks(){return[]}destroy(){}restoreSelectedTrack(){}}const{audioTrackAdded:Pi,audioTrackChanged:Ii,forcedTextTrackChanged:Ai,textTrackAdded:wi,textTrackChanged:Ri,textTrackRemoved:Oi}=Ye,{textTracksSwitched:Ci,textTracksUpdated:Mi,inlineStylesParsed:Di}=Me;class TextTrackManager{constructor(e,t,i){this.mediaElement=e,this.dispatcher=t,this.extensionTracks=i,this._tracks=[],this.trackPersistence=new TrackPersistence("mk-text-track",["label","language","kind"]);const r=this.trackPersistence.getPersistedTrack();if(this._tracks.push({id:-2,label:"Off",language:"",kind:"subtitles",mode:!r||this.isTrackOff(r)?"showing":"disabled"}),this.extensionTracks){E.debug("MEDIA_TRACK Initializing text track manager for HLS.js track events");const t=e.parentElement;this.renderer=new ki(window,t,!1),this.renderer.setStyles({"::cue":{fontSize:"calc(1vw + 1em)"}}),this.onExtensionTextTracksAdded=this.onExtensionTextTracksAdded.bind(this),this.onExtensionTextTrackSwitched=this.onExtensionTextTrackSwitched.bind(this),this.onExtensionInlineStylesParsed=this.onExtensionInlineStylesParsed.bind(this),this.onCueChange=this.onCueChange.bind(this);const i=this.extensionTracks;i.addEventListener(Mi,this.onExtensionTextTracksAdded),i.addEventListener(Ci,this.onExtensionTextTrackSwitched),i.addEventListener(Di,this.onExtensionInlineStylesParsed)}else E.debug("MEDIA_TRACK Initializing text track manager for native track events"),this.onTextTrackAdded=this.onTextTrackAdded.bind(this),this.onTextTrackChanged=this.onTextTrackChanged.bind(this),this.onTextTrackRemoved=this.onTextTrackRemoved.bind(this),this.onPlayStart=this.onPlayStart.bind(this),e.textTracks.addEventListener("addtrack",this.onTextTrackAdded),e.textTracks.addEventListener("change",this.onTextTrackChanged),e.textTracks.addEventListener("removetrack",this.onTextTrackRemoved),e.addEventListener("playing",this.onPlayStart);this.onAudioTrackAddedOrChanged=debounce(this.onAudioTrackAddedOrChanged.bind(this)),t.subscribe(Ii,this.onAudioTrackAddedOrChanged),t.subscribe(Pi,this.onAudioTrackAddedOrChanged)}get currentTrack(){return this.tracks.find(e=>"showing"===e.mode)}set currentTrack(e){if(!e)return;let t;this.trackPersistence.setPersistedTrack(e),this.extensionTracks?(E.debug("MEDIA_TRACK Setting track on extension "+e.label),"Off"===e.label?(this.clearCurrentlyPlayingTrack(),t=this.extensionTracks.selectForcedTrack(),void 0===t&&this.onExtensionTextTrackSwitched({track:e})):this.extensionTracks.textTrack=e):(E.debug("MEDIA_TRACK Setting track on element "+e.label),this._tracks.forEach(t=>{t!==e&&"showing"===t.mode&&(t.mode="disabled")}),e&&(E.debug("MEDIA_TRACK setting track mode to showing for "+e.label),this.isTrackOff(e)?(this._tracks[0].mode="showing",t=this.selectNativeForcedTrack(this.mediaElement.audioTracks)):e.mode="showing")),this.dispatcher.publish(Ye.forcedTextTrackChanged,t)}get tracks(){return this._tracks}destroy(){if(this.clearCurrentlyPlayingTrack(),this.extensionTracks){const e=this.extensionTracks;e.removeEventListener(Mi,this.onExtensionTextTracksAdded),e.removeEventListener(Ci,this.onExtensionTextTrackSwitched),e.removeEventListener(Di,this.onExtensionInlineStylesParsed)}else this.mediaElement.textTracks.removeEventListener("addtrack",this.onTextTrackAdded),this.mediaElement.textTracks.removeEventListener("change",this.onTextTrackChanged),this.mediaElement.textTracks.removeEventListener("removetrack",this.onTextTrackRemoved),this.mediaElement.removeEventListener("playing",this.onPlayStart);this.dispatcher.unsubscribe(Ii,this.onAudioTrackAddedOrChanged),this.dispatcher.unsubscribe(Pi,this.onAudioTrackAddedOrChanged)}restoreSelectedTrack(){return restoreSelectedTrack(this.trackPersistence,this)}onExtensionInlineStylesParsed(e){E.debug("MEDIA_TRACK Extension inline styles parsed",e),this.renderer.setStyles(e.styles)}onExtensionTextTracksAdded(e){E.debug("MEDIA_TRACK Extension text tracks updated "+JSON.stringify(e)),this._tracks.push(...e),this.restoreSelectedTrack(),this.dispatcher.publish(wi,e)}onExtensionTextTrackSwitched(e){E.debug("MEDIA_TRACKS Extension text track switched "+e),this.handleVTT(e);const t=e.track;if(this._tracks){const preserveSelectedTrack=i=>{e.track?t.forced&&"Off"===i.label||"Off"===t.label&&"Off"===i.label?i.mode="showing":i.mode=e.track.persistentID===i.id?"showing":"disabled":i.mode="Off"===i.label?"showing":"disabled"};this._tracks.forEach(preserveSelectedTrack)}this.dispatcher.publish(Ri,e)}handleVTT(e){const t=e&&e.track&&e.track.id;if(void 0!==t&&t>=0){const e=this.filterSelectableTextTracks(this.mediaElement.textTracks)[t];this.onNativeTrackChange(e)}else this.clearCurrentlyPlayingTrack()}onAudioTrackAddedOrChanged(e,t){if(E.debug("MEDIA_TRACKS text track manager detects audio track change"),this.shouldForceSubtitle())if(this.extensionTracks){E.debug("MEDIA_TRACKS selecting forced text track via extension");const e=this.extensionTracks.selectForcedTrack();e?this.dispatcher.publish(Ai,e):this.clearCurrentlyPlayingTrack()}else E.debug("MEDIA_TRACKS selecting forced text track natively"),this.currentTrack=this._tracks[0]}onTextTrackAdded(e){this._tracks.push(e.track),this.dispatcher.publish(wi,e)}onPlayStart(){this.restoreSelectedTrack()}onTextTrackRemoved(e){this.dispatcher.publish(Oi,e)}onTextTrackChanged(e){const t=this.findNativeSelectedTextTrack();let i=this.trackPersistence.getPersistedTrack();if(i||(i=this._tracks[0]),t&&!trackEquals(t,i,this.trackPersistence.fields))if(this.isTrackOff(i)&&"forced"!==t.kind)this.currentTrack=i;else{const e=this.findNativeTrack(i);e&&(this.currentTrack=e)}else this.dispatcher.publish(Ri,e)}findNativeSelectedTextTrack(){for(let e=0;e<this.mediaElement.textTracks.length;e++){const t=this.mediaElement.textTracks[e];if("showing"===t.mode)return t}}findNativeTrack(e){for(let t=0;t<this.mediaElement.textTracks.length;t++){const i=this.mediaElement.textTracks[t];if(trackEquals(i,e,this.trackPersistence.fields))return i}}selectNativeForcedTrack(e){for(let t=0;t<e.length;t++){const i=e[t];if(i.enabled){const e=this.findNativeForcedTrack(i);return e&&"showing"!==e.mode&&(e.mode="showing"),e}}}findNativeForcedTrack(e){const t=this.mediaElement.textTracks;for(let i=0;i<t.length;i++){const r=t[i];if("forced"===r.kind&&r.language===e.language)return r}}onNativeTrackChange(e){this.clearCurrentlyPlayingTrack(),this._currentlyPlayingTrack=e,e.addEventListener("cuechange",this.onCueChange)}clearCurrentlyPlayingTrack(){var e;void 0!==this._currentlyPlayingTrack&&("string"==typeof(e=this._currentlyPlayingTrack).id&&"removeEventListener"in e)&&(this._currentlyPlayingTrack.removeEventListener("cuechange",this.onCueChange),this.renderer.processCues({}),delete this._currentlyPlayingTrack)}onCueChange(e){const t=e&&e.target&&e.target.activeCues;t&&this.renderer.processCues(t)}filterSelectableTextTracks(e){const t=[];for(let i=0;i<e.length;i++){const r=e[i];("captions"===r.kind||"subtitles"===r.kind||"metadata"===r.kind&&r.customTextTrackCueRenderer)&&t.push(r)}return t}shouldForceSubtitle(){E.debug("MEDIA_TRACKS Determining whether to select forced text track");const e=this.trackPersistence.getPersistedTrack();return!e||this.isTrackOff(e)}isTrackOff(e){return"Off"===e.label||"Auto"===e.label}}const Ni={"picture-in-picture":e.PresentationMode.pictureinpicture,inline:e.PresentationMode.inline},Li={};Li[e.PresentationMode.pictureinpicture]="picture-in-picture",Li[e.PresentationMode.inline]="inline";const{presentationModeDidChange:xi}=Ye,{playbackLicenseError:Ui}=Me,{stopped:Fi}=e.PlaybackStates;class VideoPlayer extends BasePlayer{constructor(e){super(e),this.mediaPlayerType="video",this._textTrackManager=new TrackManagerStub,this._audioTrackManager=new TrackManagerStub,this.userInitiated=!1,this.restrictPlatforms=!("restrict-platforms"in Ae.features)||Ae.features["restrict-platforms"],this.pipEventHandler=this.pipEventHandler.bind(this)}get audioTracks(){return this._audioTrackManager.tracks}get containerElement(){return this._context.videoContainerElement?this._context.videoContainerElement:document.getElementById("apple-music-video-container")}get currentAudioTrack(){return this._audioTrackManager.currentTrack}set currentAudioTrack(e){this._audioTrackManager.currentTrack=e}get currentTextTrack(){return this._textTrackManager.currentTrack}set currentTextTrack(e){this._textTrackManager.currentTrack=e}get _targetElement(){return this.video||Object.assign({},document.createElement("video"))}get textTracks(){return this._textTrackManager.tracks}initializeExtension(){return __awaiter(this,void 0,void 0,(function*(){this.restrictPlatforms&&Pe.isAndroid?E.warn("videoPlayer.initializeExtension Not supported on the current platform"):this.video||E.warn("videoPlayer.initializeExtension No video element, not initializing extension")}))}onPlaybackLicenseError(e){this._licenseError(),this._dispatcher.publish(Ui,e)}setupTrackManagers(e){var t,i,r,s;null===(i=null===(t=this._textTrackManager)||void 0===t?void 0:t.destroy)||void 0===i||i.call(t),this._textTrackManager=new TextTrackManager(this._targetElement,this._dispatcher,e),null===(s=null===(r=this._audioTrackManager)||void 0===r?void 0:r.destroy)||void 0===s||s.call(r),this._audioTrackManager=new AudioTrackManager(this._targetElement,this._dispatcher,e)}destroy(){this._textTrackManager.destroy(),this._audioTrackManager.destroy(),super.destroy()}initializeEventHandlers(){const e=Object.create(null,{initializeEventHandlers:{get:()=>super.initializeEventHandlers}});return __awaiter(this,void 0,void 0,(function*(){e.initializeEventHandlers.call(this),this.hasMediaElement&&(this._targetElement.addEventListener("webkitpresentationmodechanged",this.pipEventHandler),this._targetElement.addEventListener("enterpictureinpicture",this.pipEventHandler),this._targetElement.addEventListener("leavepictureinpicture",this.pipEventHandler))}))}removeEventHandlers(){if(super.removeEventHandlers(),!this.hasMediaElement)return;const{_targetElement:e}=this;e.removeEventListener("webkitpresentationmodechanged",this.pipEventHandler),e.removeEventListener("enterpictureinpicture",this.pipEventHandler),e.removeEventListener("leavepictureinpicture",this.pipEventHandler)}initializeMediaElement(){return __awaiter(this,void 0,void 0,(function*(){E.debug("videoPlayer.initializeMediaElement Initializing media element");const e=this.containerElement;e?(this.video=function(){let e=Oe.pop();return e?E.debug(`dom-helpers: retrieving video tag, ${Oe.length} remain`):(E.debug("dom-helpers: no available video tags, creating one"),e=document.createElement("video")),e}(),this.video.autoplay=!1,this.video.controls=!1,this.video.playsInline=!0,this.video.id="apple-music-video-player",e.appendChild(this.video)):E.warn("videoPlayer.initializeMediaElement No video element; no container defined")}))}isPlayerSupported(){return Browser.supportsEs6()}_stopMediaElement(){const e=Object.create(null,{_stopMediaElement:{get:()=>super._stopMediaElement}});return __awaiter(this,void 0,void 0,(function*(){yield e._stopMediaElement.call(this),this.destroy()}))}pipEventHandler(t){switch(t.type){case"enterpictureinpicture":this._dispatcher.publish(xi,{mode:e.PresentationMode.pictureinpicture});break;case"leavepictureinpicture":this._dispatcher.publish(xi,{mode:e.PresentationMode.inline});break;case"webkitpresentationmodechanged":{const e=this._targetElement;this._dispatcher.publish(xi,{mode:this._translateStringToPresentationMode(e.webkitPresentationMode)});break}}}playItemFromEncryptedSource(t,i=!1,r){return __awaiter(this,void 0,void 0,(function*(){if(E.debug("videoPlayer.playItemFromEncryptedSource",t,i),this.playbackState===Fi)return void E.debug("video-player.playItemFromEncryptedSource aborting playback because player is stopped");t.playbackType=e.PlaybackType.encryptedFull,this.nowPlayingItem=t,t.state=A.loading,this.userInitiated=i;const s=generateAssetUrl(t.assetURL,{startOver:!!(null==r?void 0:r.startOver),supportsLinearScrubbing:t.supportsLinearScrubbing});this.playHlsStream(s,t)}))}playItemFromUnencryptedSource(e,t,i){return __awaiter(this,void 0,void 0,(function*(){if(E.debug("videoPlayer.playItemFromUnencryptedSource",e,t),this.playbackState===Fi)return void E.debug("videoPlayer.playItemFromUnencryptedSource aborting playback because player is stopped");const[i]=e.split("?");return i.endsWith("m3u")||i.endsWith("m3u8")?void this.playHlsStream(e):this._playAssetURL(e,t)}))}setPresentationMode(t){return __awaiter(this,void 0,void 0,(function*(){const i=this._targetElement;if(i.webkitSupportsPresentationMode&&"function"==typeof i.webkitSetPresentationMode)return i.webkitSetPresentationMode(this._translatePresentationModeToString(t));if(i.requestPictureInPicture&&document.exitPictureInPicture){if(t===e.PresentationMode.pictureinpicture)return i.requestPictureInPicture();if(t===e.PresentationMode.inline)return document.exitPictureInPicture()}}))}_translateStringToPresentationMode(t){let i=Ni[t];return void 0===i&&(E.warn(`videoPlayer._translateStringToPresentationMode ${t} is not a valid presentation mode, setting to inline`),i=e.PresentationMode.inline),i}_translatePresentationModeToString(e){let t=Li[e];return void 0===t&&(E.warn(`videoPlayer._translatePresentationModeToString ${e} is not a valid presentation mode, setting to inline`),t="inline"),t}setNextSeamlessItem(e){return __awaiter(this,void 0,void 0,(function*(){}))}}__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object]),__metadata("design:returntype",void 0)],VideoPlayer.prototype,"onPlaybackLicenseError",null);const decayingOperation=(e,t,i,r=0)=>e().catch(s=>{const n=r+1;function possiblyRetry(r){if(r&&n<3){const r=1e3*n;return E.debug(`trying again in ${r}ms for ${i}`),new Promise((s,a)=>{setTimeout(()=>{decayingOperation(e,t,i,n).then(s,a)},r)})}throw s}const a=t(s);return"boolean"==typeof a?possiblyRetry(a):a.then(possiblyRetry)});let ji={developerToken:"developerTokenNotSet",musicUserToken:"musicUserTokenNotSet"};function createHlsOffersLicenseChallengeBody(e){return{"adam-id":e.id,id:1}}function createStreamingKeysLicenseChallengeBody(e,t=0){var i;const r=null!==(i=e.keyServerQueryParameters)&&void 0!==i?i:{};return Object.assign({id:t},r)}function createLicenseChallengeBody(e,t,i,r,s,n){let a;const o={challenge:r.challenge||c(r.licenseChallenge),"key-system":s,uri:r.keyuri};return a=i.isUTS?e.startsWith("https://play.itunes.apple.com/WebObjects/MZPlay.woa/web/video/subscription/license")?Object.assign(Object.assign({},o),function(e,t="start"){return{"extra-server-parameters":e.keyServerQueryParameters,"license-action":t}}(i,t)):{"streaming-request":{version:1,"streaming-keys":[Object.assign(Object.assign({},o),createStreamingKeysLicenseChallengeBody(i))]}}:i.isLiveRadioStation?Object.assign(Object.assign({},o),function(e){return{event:e.isLiveAudioStation?"beats1":"amtv"}}(i)):i.hasOffersHlsUrl?{"license-requests":[Object.assign(Object.assign({},o),createHlsOffersLicenseChallengeBody(i))]}:Object.assign(Object.assign({},o),function(e,t=!1){return{adamId:e.songId,isLibrary:e.isCloudItem,"user-initiated":t}}(i,n)),a}class License{fetch(e){const t={Authorization:"Bearer "+ji.developerToken,Accept:"application/json","Content-Type":"application/json","X-Apple-Music-User-Token":""+ji.musicUserToken};this.keySystem===Ie.WIDEVINE&&(t["X-Apple-Renewal"]=!0);const i=new Headers(t);return decayingOperation(()=>fetch(this.licenseUrl,{method:"POST",body:JSON.stringify(e),headers:i}),e=>e instanceof TypeError,"license fetch")}reset(){this.licenseUrl=void 0,this.playableItem=void 0,this.data=void 0,this.initiated=void 0,this.keySystem=void 0,this.startResponse=void 0}start(e,t,i,r,s=!1){var n,a,o,l;return __awaiter(this,void 0,void 0,(function*(){this.licenseUrl=e,this.playableItem=t,this.data=i,this.keySystem=r,this.initiated=s;const d=i.isRenewalRequest?"renew":"start",c=createLicenseChallengeBody(e,d,t,i,r,s);t.hasOffersHlsUrl&&(this.licenseUrl+="/"+d),this.startResponse=this.fetch(c);try{const e=yield this.startResponse;if(!e.ok){let t;try{t=yield e.json()}catch(u){}this.processJsonError(t)}const t=yield e.json();let i=t;return(null===(a=null===(n=null==t?void 0:t["streaming-response"])||void 0===n?void 0:n["streaming-keys"])||void 0===a?void 0:a.length)?i=t["streaming-response"]["streaming-keys"][0]:(null===(o=null==t?void 0:t["license-responses"])||void 0===o?void 0:o.length)&&(i=t["license-responses"][0]),i.status=null!==(l=i.status)&&void 0!==l?l:i.errorCode,0!==i.status&&this.processJsonError(i),i}catch(Pt){throw this.startResponse=void 0,Pt}}))}processJsonError(e){let t=new MKError(MKError.MEDIA_LICENSE,"Error acquiring license");if((null==e?void 0:e.errorCode)&&(e.status=e.errorCode),e&&0!==e.status){if(!e.message)switch(e.status){case-1004:e.message=MKError.DEVICE_LIMIT;break;default:e.message=MKError.MEDIA_LICENSE}t=MKError.serverError(e),t.data=e,t.errorCode===MKError.PLAYREADY_CBC_ENCRYPTION_ERROR&&function(){const e=getSessionStorage();e&&e.setItem("mk-playready-cbcs-unsupported","true")}()}throw t}stop(){return __awaiter(this,void 0,void 0,(function*(){if(this.startResponse)try{yield this.startResponse}catch(Pt){}if(!this.playableItem||!this.data||!this.licenseUrl)return;if(!this.playableItem.isUTS)return;const e=createLicenseChallengeBody(this.licenseUrl,"stop",this.playableItem,this.data,this.keySystem,this.initiated),t=this.fetch(e);this.reset();try{yield t}catch(Pt){E.warn("license.stop request error",Pt)}}))}}class KeySession extends Notifications{constructor(){super([Me.playbackLicenseError,Me.playbackSessionError]),this.initiated=!0,this.isLibrary=!1,this.keySystem=Ie.FAIRPLAY,this.mediaKeySessions={},this.boundDispatchKeyError=this.dispatchKeyError.bind(this),this.boundDispatchSessionError=this.dispatchSessionError.bind(this),this.boundHandleSessionCreation=this.handleSessionCreation.bind(this),this.boundStartLicenseSession=this.startLicenseSession.bind(this),this.license=new License}get extID(){if(this.extURI)return this.extURI.replace("data:;base64,","")}get isFairplay(){return this.keySystem===Ie.FAIRPLAY}get isPlayReady(){return this.keySystem===Ie.PLAYREADY}get isWidevine(){return this.keySystem===Ie.WIDEVINE}acquirePlaybackLicense(e,t,i,r){return __awaiter(this,void 0,void 0,(function*(){if(!this.keyServerURL||!this.developerToken||!this.userToken)return;const{keyServerURL:i,keySystem:s}=this;try{return yield this.license.start(i,r.item,{challenge:t,keyuri:e},s,this.initiated)}catch(n){this.dispatchEvent(Me.playbackLicenseError,n)}}))}startLicenseSession(e){let t;E.debug("Starting License Session",e);const{message:i,target:r,messageType:s}=e;if(this.keySystem!==Ie.FAIRPLAY&&"license-request"!==s)return void E.debug("not making license request for",s);if(this.isPlayReady){const e=String.fromCharCode.apply(null,new Uint16Array(i.buffer||i));t=(new DOMParser).parseFromString(e,"application/xml").getElementsByTagName("Challenge")[0].childNodes[0].nodeValue}else t=c(new Uint8Array(i));const n=r.extURI||this.extURI,a=this.mediaKeySessions[n];if(a)return this.acquirePlaybackLicense(n,t,this.initiated,a).then(e=>this.handleLicenseJson(e,r,n));E.debug("no key session info, aborting license request")}setKeyURLs(e){this.keyCertURL=e[this.isFairplay?"hls-key-cert-url":"widevine-cert-url"],this.keyServerURL=e["hls-key-server-url"]}dispatchKeyError(e){var t,i;this.isFairplay&&4294955417===(null===(i=null===(t=null==e?void 0:e.target)||void 0===t?void 0:t.error)||void 0===i?void 0:i.systemCode)?E.error("Ignoring error",e):(console.error(MKError.MEDIA_KEY+" error in dispatchKeyError:",e),this.dispatchEvent(Me.playbackSessionError,new MKError(MKError.MEDIA_KEY,e)))}dispatchSessionError(e){this.dispatchEvent(Me.playbackSessionError,new MKError(MKError.MEDIA_SESSION,e))}loadCertificateBuffer(){return __awaiter(this,void 0,void 0,(function*(){if(!this.keyCertURL)return Promise.reject(new MKError(MKError.MEDIA_SESSION,"No certificate URL"));const e=yield fetch(`${this.keyCertURL}?t=${Date.now()}`),t=yield e.arrayBuffer(),i=String.fromCharCode.apply(String,new Uint8Array(t));return/^\<\?xml/.test(i)?Promise.reject(new MKError(MKError.MEDIA_CERTIFICATE,"Invalid certificate.")):t}))}handleSessionCreation(e){return __awaiter(this,void 0,void 0,(function*(){return this.createSession(e).catch(e=>{this.dispatchSessionError(e)})}))}handleLicenseJson(e,t,i){return __awaiter(this,void 0,void 0,(function*(){if(E.debug(`updating session ${i} with license response`,e),null==e?void 0:e.license){const i=o(e.license);try{yield t.update(i)}catch(r){E.error("Failed to updated media keys",r),this.dispatchKeyError(r)}}}))}addMediaKeySessionInfo(e,t,i){const r=this.mediaKeySessions[e];r?(E.debug(`keySession info exists for ${i.title}, making existing session ${r.session.sessionId} the old session`),r.oldSession=r.session,r.session=t):(E.debug("creating key session info for "+i.title),this.mediaKeySessions[e]={session:t,item:i})}}__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object]),__metadata("design:returntype",void 0)],KeySession.prototype,"startLicenseSession",null);class FairplayEncryptedSession extends KeySession{constructor(){super(...arguments),this._mediaKeySessions={},this._mediaKeySessionRenewals={}}attachMedia(e,t){return __awaiter(this,void 0,void 0,(function*(){this.keySystem=t.keySystem,this._keySystemAccess=t,e.addEventListener("encrypted",this.boundHandleSessionCreation,!1)}))}detachMedia(e){e.removeEventListener("encrypted",this.boundHandleSessionCreation);const t=this._mediaKeySessions,i=this._mediaKeySessionRenewals;Object.values(t).forEach(e=>{e.removeEventListener("message",this.boundStartLicenseSession),asAsync(e.close())}),this._mediaKeySessions={},Object.values(i).forEach(e=>clearTimeout(e)),this._mediaKeySessionRenewals={}}createSession(e){return __awaiter(this,void 0,void 0,(function*(){E.debug("fairplay eme:  createSession",e);const t=this._keySystemAccess;if(!t)return;const{initData:i,target:r,initDataType:s}=e;this._mediaKeysPromise||(this._mediaKeysPromise=new Promise((e,i)=>__awaiter(this,void 0,void 0,(function*(){const s=yield t.createMediaKeys();try{yield r.setMediaKeys(s),this._mediaKeys=s;const e=yield this.loadCertificateBuffer();yield s.setServerCertificate(e)}catch(Pt){this.dispatchKeyError(Pt),i(Pt)}e(s)}))));const n=yield this._mediaKeysPromise,a=new Uint8Array(i),o=String.fromCharCode.apply(void 0,Array.from(a));if(this.mediaKeySessions[o])return void E.error("fairplay eme: not creating new session for extURI",o);const l=n.createSession();E.debug("fairplay eme: creating new key session for",o),this.addMediaKeySessionInfo(o,l,this.item),l.addEventListener("message",this.startFairplayLicenseSession),l.extURI=o,yield l.generateRequest(s,i),this._mediaKeySessions[l.sessionId]=l,E.debug("fairplay eme: created session",l)}))}startFairplayLicenseSession(e){const{message:t,target:i}=e,r=c(new Uint8Array(t)),s=i.extURI||this.extURI,n=this.mediaKeySessions[s];if(n)return this.acquirePlaybackLicense(s,r,this.initiated,n).then(e=>this.handleLicenseJson(e,i,s));E.debug("fairplay eme: no key session info, aborting license request",s)}handleLicenseJson(e,t,i){const r=Object.create(null,{handleLicenseJson:{get:()=>super.handleLicenseJson}});return __awaiter(this,void 0,void 0,(function*(){if(!e)return;const s=this.mediaKeySessions[i];if(!s)return void E.debug("fairplay eme: media key session does not exist, not updating");const n=e["renew-after"];if(e.license&&n){E.debug("fairplay eme: got renew after value",n,i);const e=this._mediaKeySessionRenewals,r=e[t.sessionId];r&&clearTimeout(r),e[t.sessionId]=setTimeout(()=>this._renewMediaKeySession(s,i),1e3*n)}yield r.handleLicenseJson.call(this,e,t,i)}))}_renewMediaKeySession(e,t){delete this._mediaKeySessionRenewals[e.session.sessionId],E.debug("fairplay eme: renewing session",e),e.session.update(l("renew"))}loadKeys(e){return __awaiter(this,void 0,void 0,(function*(){}))}clearSessions(){return __awaiter(this,void 0,void 0,(function*(){}))}}__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object]),__metadata("design:returntype",void 0)],FairplayEncryptedSession.prototype,"startFairplayLicenseSession",null);const Bi=/^(?:.*)(skd:\/\/.+)$/i;class WebKitSession extends KeySession{attachMedia(e,t){return this.target=e,e.addEventListener("webkitneedkey",this.boundHandleSessionCreation,!1),e.addEventListener("webkitkeyerror",this.boundDispatchKeyError),e}detachMedia(e){e&&(e.removeEventListener("webkitneedkey",this.boundHandleSessionCreation,!1),e.removeEventListener("webkitkeyerror",this.boundDispatchKeyError))}destroy(){E.debug("FPS destroy"),this.detachMedia(this.target),this.session&&(this.session.removeEventListener("webkitkeyerror",this.boundDispatchKeyError),this.session.removeEventListener("webkitkeymessage",this.boundStartLicenseSession))}createSession(e){E.debug("FPS createSession",e);const{initData:t,target:i}=e,{item:r}=this;if(!r)return E.error("Cannot createSession without item"),Promise.resolve();const s=this._extractAssetId(t);if(E.debug("extURI",s),!i.webkitKeys&&window.WebKitMediaKeys){const e=new window.WebKitMediaKeys(this.keySystem);i.webkitSetMediaKeys(e)}return this.loadCertificateBuffer().then(e=>{const n=this._concatInitDataIdAndCertificate(t,s,e),a="VIDEO"===i.tagName?De.AVC1:De.MP4,o=i.webkitKeys.createSession(a,n);this.addMediaKeySessionInfo(s,o,r),this.session=o,o.extURI=s,o.addEventListener("webkitkeyerror",this.boundDispatchKeyError),o.addEventListener("webkitkeymessage",this.boundStartLicenseSession)})}_extractAssetId(e){let t=String.fromCharCode.apply(null,new Uint16Array(e.buffer||e));const i=t.match(Bi);return i&&i.length>=2&&(t=i[1]),E.debug("Extracted assetId from EXT-X-KEY URI",t),t}_concatInitDataIdAndCertificate(e,t,i){"string"==typeof t&&(t=d(t)),i=new Uint8Array(i);let r=0;const s=new ArrayBuffer(e.byteLength+4+t.byteLength+4+i.byteLength),n=new DataView(s);new Uint8Array(s,r,e.byteLength).set(e),r+=e.byteLength,n.setUint32(r,t.byteLength,!0),r+=4;const a=new Uint8Array(s,r,t.byteLength);a.set(t),r+=a.byteLength,n.setUint32(r,i.byteLength,!0),r+=4;return new Uint8Array(s,r,i.byteLength).set(i),new Uint8Array(s,0,s.byteLength)}loadKeys(e){return __awaiter(this,void 0,void 0,(function*(){}))}clearSessions(){return __awaiter(this,void 0,void 0,(function*(){}))}}class MSSession extends KeySession{attachMedia(e,t){return this.keySystem=t.keySystem,e.addEventListener("msneedkey",this.boundHandleSessionCreation,!1),e.addEventListener("mskeyerror",this.boundDispatchKeyError),e}detachMedia(e){e.removeEventListener("msneedkey",this.boundHandleSessionCreation,!1),e.removeEventListener("mskeyerror",this.boundDispatchKeyError)}createSession(e){const{initData:t,target:i}=e;if(!i.msKeys){const e=new MSMediaKeys(this.keySystem);i.msSetMediaKeys(e)}const r=i.msKeys.createSession(De.MP4,t);return r.addEventListener("mskeyerror",this.dispatchKeyError),r.addEventListener("mskeymessage",this.startLicenseSession.bind(this)),r}loadKeys(e){return __awaiter(this,void 0,void 0,(function*(){}))}clearSessions(){return __awaiter(this,void 0,void 0,(function*(){}))}}const Ki={[Ie.WIDEVINE]:Ne.WIDEVINE,[Ie.FAIRPLAY]:Ne.FAIRPLAY,[Ie.PLAYREADY]:Ne.PLAYREADY},$i=[0,0,1,222,112,115,115,104,0,0,0,0,154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149,0,0,1,190],Vi=[190,1,0,0,1,0,1,0,180,1];function concatenate(e,...t){let i=0;for(const n of t)i+=n.length;const r=new e(i);let s=0;for(const n of t)r.set(n,s),s+=n.length;return r}const{WIDEVINE:Wi,PLAYREADY:Hi}=Ie,zi={};zi[Wi]=e=>{qe.debug("generating Widevine pssh for keyId");const t=new Uint8Array([0,0,0,52,112,115,115,104,0,0,0,0,237,239,139,169,121,214,74,206,163,200,39,220,213,29,33,237,0,0,0,20,8,1,18,16,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);for(let i=0;i<e.length;i++)t[t.length-16+i]=e[i];return qe.debug("generatePSSH",t),t},zi[Hi]=e=>{qe.debug("generating Playready pssh for keyId"),(e=>{const swap=(e,t,i)=>{const r=e[t];e[t]=e[i],e[i]=r};swap(e,0,3),swap(e,1,2),swap(e,4,5),swap(e,6,7)})(e);const t=c(e),i='<WRMHEADER xmlns="http://schemas.microsoft.com/DRM/2007/03/PlayReadyHeader" version="4.3.0.0"><DATA><PROTECTINFO><KIDS><KID ALGID="AESCTR" VALUE="[KEYID]"></KID></KIDS></PROTECTINFO></DATA></WRMHEADER>'.replace("[KEYID]",t),r=d(i),s=new Uint8Array(r.buffer,r.byteOffset,r.byteLength);return concatenate(Uint8Array,$i,Vi,s)};class PreloadingEncryptedSession extends KeySession{constructor(){super(...arguments),this._sessionRemovalTimeouts={},this._mediaKeySessionRenewals={}}attachMedia(e,t){this.keySystem=t.keySystem,this._keySystemAccess=t,this._target=e}detachMedia(){asAsync(this.clearSessions())}createSession(e){return __awaiter(this,void 0,void 0,(function*(){}))}_mediaKeysSetup(){return __awaiter(this,void 0,void 0,(function*(){const e=this._keySystemAccess;e&&(this._mediaKeysPromise||(this._mediaKeysPromise=new Promise((t,i)=>__awaiter(this,void 0,void 0,(function*(){var r;const s=yield e.createMediaKeys();try{yield null===(r=this._target)||void 0===r?void 0:r.setMediaKeys(s),this._mediaKeys=s}catch(Pt){this.dispatchKeyError(Pt),i(Pt)}if(this.isWidevine){const e=yield this.loadCertificateBuffer();yield s.setServerCertificate(e)}t(s)})))),yield this._mediaKeysPromise)}))}createSessionAndGenerateRequest(e,t,i=!1){var r;return __awaiter(this,void 0,void 0,(function*(){if(!i&&this.mediaKeySessions[e])return;qe.debug(`createSessionAndGenerateRequest for item ${t.title}, isRenewal ${i}`);const s=null===(r=this._mediaKeys)||void 0===r?void 0:r.createSession(),{keySystem:n}=this;if(!s)return;this.addMediaKeySessionInfo(e,s,t);const a=(e=>{if(e.includes("data")){const[t,i]=e.split(",");return i}return e})(e),l=o(a),d=this.isWidevine&&t.isSong||16===l.length;let u;var h;return qe.debug("extracted uri",e),this.isPlayReady&&!d?(qe.debug("handling Playready object"),s.extURI=e,h=l,u=concatenate(Uint8Array,new Uint8Array($i),h)):d?(qe.debug("handling keyId only initData"),s.extURI="data:;base64,"+c(l),u=((e,t)=>{const i=zi[t];if(!i)return qe.warn("No pssh generator for ",t),e;return i(Uint8Array.from(e))})(l,n)):(qe.debug("handling pssh initData"),s.extURI=e,u=l),s.addEventListener("message",this.startLicenseSession),s.generateRequest("cenc",u).catch(e=>{if(e.message.match(/generateRequest.*\(75\)/))return s.generateRequest("cenc",u);throw e})}))}handleLicenseJson(e,t,i){const r=Object.create(null,{handleLicenseJson:{get:()=>super.handleLicenseJson}});var s;return __awaiter(this,void 0,void 0,(function*(){if(!e)return;const n=this.mediaKeySessions[i];if(!n)return void qe.debug("media key session does not exist, not updating");const a=e["renew-after"];if(e.license&&a){qe.debug("Got renew after value",a,i);const e=this._mediaKeySessionRenewals,r=e[t.sessionId];r&&clearTimeout(r),e[t.sessionId]=setTimeout(()=>this._renewMediaKeySession(n,i),1e3*a)}yield r.handleLicenseJson.call(this,e,t,i);const o=null===(s=this.mediaKeySessions[i])||void 0===s?void 0:s.oldSession;o&&(qe.debug("removing old key session after updating",i),yield this._removeAndCloseSession(o),delete this.mediaKeySessions[i].oldSession,delete this._mediaKeySessionRenewals[o.sessionId])}))}_renewMediaKeySession(e,t){delete this._mediaKeySessionRenewals[e.session.sessionId],asAsync(this.createSessionAndGenerateRequest(t,e.item,!0))}loadKeys(e,t){return __awaiter(this,void 0,void 0,(function*(){yield this._mediaKeysSetup();const i=this.filterKeyValues(e);for(const e of i){const{dataUri:i}=e;yield this.createSessionAndGenerateRequest(i,t)}if(null==t?void 0:t.isLiveAudioStation){const e=Object.keys(this.mediaKeySessions),t=i.reduce((e,t)=>(e[t.dataUri]=!0,e),{});for(const i of e)t[i]||(yield this._scheduleRemoveSession(i))}}))}filterKeyValues(e){let t;if(1===e.length)t=e;else{const i=Ki[this.keySystem];t=e.filter(e=>e.keyFormat===i)}return t}clearSessions(e){return __awaiter(this,void 0,void 0,(function*(){const t=this.mediaKeySessions;if(null==e?void 0:e.length){const t=this.filterKeyValues(e);for(const e of t){const t=e.dataUri;clearTimeout(this._sessionRemovalTimeouts[t]),yield this._removeSessionImmediately(t)}}else{Object.values(this._sessionRemovalTimeouts).forEach(e=>clearTimeout(e)),qe.debug("clearing key sessions",t);for(const e of Object.keys(t))yield this._removeSessionImmediately(e)}}))}_scheduleRemoveSession(e){return __awaiter(this,void 0,void 0,(function*(){if(!this.mediaKeySessions[e])return void qe.warn("no session for dataUri, not scheduling remove",e);if(this._sessionRemovalTimeouts[e])return;const t=setTimeout(()=>{asAsync(this._removeSessionImmediately(e))},6e4);qe.debug("deferring removal of keysession for dataUri",e),this._sessionRemovalTimeouts[e]=t}))}_removeSessionImmediately(e){return __awaiter(this,void 0,void 0,(function*(){const t=this.mediaKeySessions[e];if(!t)return void qe.warn("no session for dataUri, not removing",e);qe.debug("removing keysession for",e);const{session:i,oldSession:r}=t;this._clearSessionRenewal(i),delete this.mediaKeySessions[e],yield this._removeAndCloseSession(i),r&&(yield this._removeAndCloseSession(r))}))}_removeAndCloseSession(e){return __awaiter(this,void 0,void 0,(function*(){e.removeEventListener("message",this.startLicenseSession),qe.debug("tearing down session",e.sessionId);try{yield e.remove()}catch(t){qe.warn("Error invoking session.remove()",t)}finally{try{yield e.close()}catch(t){qe.warn("Error invoking session.close()",t)}}}))}_clearSessionRenewal(e){const t=this._mediaKeySessionRenewals[e.sessionId];t&&(qe.debug("clearing scheduled license renewal for session",e.sessionId),clearTimeout(t),delete this._mediaKeySessionRenewals[e.sessionId])}}const qi=createLocalStorageFlag("mk-safari-modern-eme");class MediaExtension extends Notifications{constructor(e,t){super([Me.playbackLicenseError,Me.playbackSessionError]),this.mediaElement=e,this.contentType=t}get hasMediaKeySupport(){return hasMediaKeySupport()}get hasMediaSession(){return void 0!==this._session}get isFairplay(){return this._session.isFairplay}set extURI(e){this._session.extURI=e}set initiated(e){this._session.initiated=e}get session(){return this._session}clearSessions(e){var t;return __awaiter(this,void 0,void 0,(function*(){return null===(t=this.session)||void 0===t?void 0:t.clearSessions(e)}))}initializeKeySystem(){return __awaiter(this,void 0,void 0,(function*(){yield this._attachSession();const{_session:e}=this;e&&[Me.playbackLicenseError,Me.playbackSessionError].forEach(t=>{e.addEventListener(t,e=>{this.dispatchEvent(t,e)})})}))}_requestModernFairplayAccess(){return __awaiter(this,void 0,void 0,(function*(){const{contentType:e}=this,t=[{initDataTypes:["skd"],audioCapabilities:[{contentType:e,robustness:""}],videoCapabilities:[{contentType:e,robustness:""}],distinctiveIdentifier:"not-allowed",persistentState:"not-allowed",sessionTypes:["temporary"]}],[,i]=yield findMediaKeySystemAccess([Ie.FAIRPLAY],t);return i}))}_attachSession(){var e,t,i;return __awaiter(this,void 0,void 0,(function*(){const{mediaElement:r,contentType:s}=this;if(null===(e=window.WebKitMediaKeys)||void 0===e?void 0:e.isTypeSupported(Ie.FAIRPLAY+".1_0",De.MP4)){let e;!!qi.json()&&this.hasMediaKeySupport&&(e=yield this._requestModernFairplayAccess()),e?(E.warn("media-extension: Using Fairplay modern EME"),this._session=new FairplayEncryptedSession,this._session.attachMedia(r,e)):(E.warn("media-extension: Using Fairplay legacy EME"),this._session=new WebKitSession,this._session.attachMedia(r,{keySystem:Ie.FAIRPLAY}))}else if(null===(t=window.MSMediaKeys)||void 0===t?void 0:t.isTypeSupported(Ie.PLAYREADY,De.MP4))this._session=new MSSession,this._session.attachMedia(r,{keySystem:Ie.PLAYREADY});else if(this.hasMediaKeySupport&&r.canPlayType(s)){this._session=new PreloadingEncryptedSession;const e=[{initDataTypes:["cenc","keyids"],audioCapabilities:[{contentType:s}],distinctiveIdentifier:"optional",persistentState:"required"}],t=potentialKeySystemsForAccess(),[,n]=yield findMediaKeySystemAccess(t,e);n?null===(i=this._session)||void 0===i||i.attachMedia(r,n):E.warn("media-extension: No keysystem detected!")}}))}setMediaItem(e){!function(e,t){t.keyURLs&&(e.developerToken=ji.developerToken,e.userToken=ji.musicUserToken,e.item=t,e.adamId=t.songId,e.isLibrary=t.isCloudItem,e.setKeyURLs(t.keyURLs))}(this._session,e)}destroy(e){this._session&&this._session.detachMedia(e)}}const Yi=createLocalStorageFlag("mk-force-audio-mse"),shouldForceAudioMse=()=>!!Yi.json();class ByteRangeSegment{constructor({url:e,startByte:t,length:i,isInitSegment:r=!1}){this.url=e,this.isInitSegment=r,this.startByte=parseInt(t,10),this.length=parseInt(i,10),this.endByte=this.startByte+this.length-1,this.range=`bytes=${this.startByte}-${this.endByte}`}load(){return __awaiter(this,void 0,void 0,(function*(){const{url:e,range:t}=this;if(!e)return new Uint8Array;const i=new Headers;i.append("Range",t);const r=yield fetch(e,{headers:i}),s=yield r.arrayBuffer();return new Uint8Array(s)}))}}class ContinuousSegment{constructor(e,t=!1){this.url=e,this.isInitSegment=t}load(){return __awaiter(this,void 0,void 0,(function*(){const{url:e}=this;if(!e)return new Uint8Array;E.debug("radio-segment: loading",e);const t=yield fetch(e),i=yield t.arrayBuffer();return new Uint8Array(i)}))}}const Gi=/^#EXT-X-BYTERANGE:([^\n]+)\n/gim,Qi=/^#EXT-X-MAP:([^\n]+)\n/im,Xi=/#EXTINF:\d*\.\d*\,[\n](.+)|^#EXT-X-MAP:URI="([^"]*)"/gim,Ji=/#EXTINF:\d*\.\d*,\s*#EXT-X-BITRATE:\d{1,3}[\n](.+)|^#EXT-X-MAP:URI="([^"]*)"/gim;class SegmentList{constructor(){this._segments=[],this._addedSegments={}}get segments(){return this._segments}addSegment(e,t){this._addedSegments[t]||(E.debug("Adding segment",t),this._segments.push(e),this._addedSegments[t]=!0)}extractLiveRadioSegments(e,t){this._extractContinuousSegments(Xi,e,t)}extractHlsOffersSegments(e,t){this._extractContinuousSegments(Ji,e,t)}_extractContinuousSegments(e,t,i){if(!t||!e.test(t))return;let r;for(e.lastIndex=0;r=e.exec(t);){const e=r[0].startsWith("#EXT-X-MAP")?r[2]:r[1],t=rewriteLastUrlPath(i,e),s=r[0].startsWith("#EXT-X-MAP");this.addSegment(new ContinuousSegment(t,s),e)}}extractByteRangeSegments(e,t){var i,r;if(!e||!Gi.test(e))return;const s=function(e){if(!e||!Qi.test(e))return;const[,t]=e.match(Qi);return t.split(",").reduce((e,t)=>{const[i,r]=t.split("=");return e[i.toLowerCase()]=r.replace(/\"/gi,""),e},{})}(e),n=null!==(i=t.split("/").pop())&&void 0!==i?i:"",a=t.replace(n,s.uri),[o,l]=s.byterange.split("@"),d=new ByteRangeSegment({url:a,startByte:l,length:o});this.addSegment(d,d.range),(null!==(r=e.match(Gi))&&void 0!==r?r:[]).forEach(e=>{const[,t,i]=e.match(/^#EXT-X-BYTERANGE:(\d+)@(\d+)\n/),r=new ByteRangeSegment({url:a,startByte:i,length:t});this.addSegment(r,r.range)})}}var Zi;!function(e){e.keysParsed="keysParsed"}(Zi||(Zi={}));const er=/^#EXT-X-TARGETDURATION:(\d+)/im,tr=/^#EXT-X-KEY:[^\n]+URI="([^"]+)"/im,ir=/^#EXT-X-KEY:[^\n]+URI="([^"]+)",KEYFORMAT="([^"]+)"/gim;function loadManifestData(e){return __awaiter(this,void 0,void 0,(function*(){return(yield fetch(e)).text()}))}class Manifest extends Notifications{constructor(e,t){super([Me.manifestParsed,Zi.keysParsed]),this._downlink=0,this._segmentList=new SegmentList,this._data=e,this._item=t,this._url=t.assetURL}parse(){const e=this._item,t=this._data;if(Le!==Ie.FAIRPLAY||shouldForceAudioMse())if(this._detectKeyTags(),e.hasOffersHlsUrl)this._segmentList.extractHlsOffersSegments(t,e.assetURL);else if(e.isLiveRadioStation){this._segmentList.extractLiveRadioSegments(t,e.assetURL);const[,i]=this._data.match(er);E.debug(`manifest: setting up manifest refresh interval at ${i} seconds`);const r=1e3*parseInt(i,10);this._manifestRefreshInterval=setInterval(this.liveRadioRefresh,r)}else this._segmentList.extractByteRangeSegments(t,e.assetURL)}static load(e,t=!0){return __awaiter(this,void 0,void 0,(function*(){E.debug("loading manifest for item",e.title);const i=e.assetURL;let r;const s=getSessionStorage(),n=!!s&&t;if(n&&(r=null==s?void 0:s.getItem(i),r))return new this(r,e);const a=(new Date).getTime();r=yield loadManifestData(i);const o=new this(r,e);return o.downlink=function(e,t){return 8*t.length/(((new Date).getTime()-e)/1e3)/1024}(a,r),n&&(null==s||s.setItem(i,r)),Promise.resolve(o)}))}get downlink(){return this._downlink}set downlink(e){this._downlink=e}get mediaItem(){return this._item}liveRadioRefresh(){return __awaiter(this,void 0,void 0,(function*(){const e=yield loadManifestData(this._url);this._data=e,this._detectKeyTags(),this._segmentList.extractLiveRadioSegments(e,this._url),this.dispatchEvent(Me.manifestParsed)}))}segmentsForTimeRange(e){const t=Math.floor(e.start/10)+1,i=Math.floor(e.end/10)+1,{segments:r}=this;return[r[0],...r.slice(t,i+1)]}get segments(){return this._segmentList.segments}get extURI(){if(!this._extURI){const e=this._data.match(tr);E.debug("manifest: EXT_X_KEY_URI matches",e),this._extURI=e&&e[1]||void 0}return this._extURI}get keyValues(){let e=this._modernKeys;return e.length||(e=this._legacyKeys),e}_detectKeyTags(){const e=this.keyValues;e.length&&this.dispatchEvent(Zi.keysParsed,{item:this.mediaItem,keys:e})}get _legacyKeys(){const e=this._data.match(tr);E.debug("manifest: EXT_X_KEY_URI matches",e);const t=e&&e[1]||void 0;this._extURI=t;const i=[];return t&&i.push({keyFormat:Ne.WIDEVINE,dataUri:t}),i}get _modernKeys(){let e;ir.lastIndex=0;const t=[];for(;e=ir.exec(this._data);){const[i,r,s]=e;t.push({keyFormat:s,dataUri:r})}return t}stop(){this._manifestRefreshInterval&&clearInterval(this._manifestRefreshInterval)}}__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",Promise)],Manifest.prototype,"liveRadioRefresh",null);const rr="seamlessAudioTransition",sr="bufferTimedMetadataDidChange",nr=isNodeEnvironment$1()?require("util").TextDecoder:self.TextDecoder;function encodedArrayToString(e,t="utf-8"){if("iso-8859-1"===t)return String.fromCharCode(...e);return new nr(t).decode(e)}function readNullTerminatedString(e,t=0,i){const r=[];i=null!=i?i:e.length;for(let s=t;s<i;s++){const t=e[s];if("\0"===String.fromCharCode(t))break;r.push(String.fromCharCode(t))}return[r.join(""),r.length]}function isBitAtPositionOn(e,t){return 0!=(e&1<<t)}class BaseMp4Box{constructor(e,t,i,r){this.id=e,this.data=t,this.start=i,this.end=r}get size(){return this.end-this.start}get rawBytes(){return this.data.slice(this.start,this.end)}}const ar=[237,239,139,169,121,214,74,206,163,200,39,220,213,29,33,237];class PsshBox extends BaseMp4Box{constructor(e,t,i){super("pssh",e,t,i),this.view=new DataView(e.buffer,t)}get systemId(){const{data:e,start:t}=this,i=t+12;return e.slice(i,i+16)}get dataSize(){return this.view.getUint32(28)}get psshData(){const{data:e,start:t,dataSize:i}=this,r=t+32;return e.slice(r,r+i)}get keyBytes(){const{psshData:e}=this;return e.slice(2,18)}get isWidevine(){return arrayEquals(this.systemId,ar)}}class TencBox extends BaseMp4Box{constructor(e,t,i){super("tenc",e,t,i),this.data=e,this.start=t,this.end=i}get isProtected(){const{data:e,start:t}=this;return e[t+14]}get defaultKeyId(){const{data:e,start:t}=this;return e.slice(t+16,t+32)}set defaultKeyId(e){const{data:t,start:i}=this;for(let r=0;r<e.length;r++)t[r+i+16]=e[r]}}function findBox(e,t,i=[]){for(let r=t;r<e.length;){if(0===i.length)return;const t=new DataView(e.buffer,r).getUint32(0),s=encodedArrayToString(e.subarray(r+4,r+8)),n=r+t;if(1===i.length&&s===i[0])return new BaseMp4Box(s,e,r,n);if(s===i[0])return findBox(e,r+8,i.slice(1));r+=t}}const rewriteDefaultKid=e=>{const[t]=function(e){const t=findBox(e,0,["moov","trak","mdia","minf","stbl","stsd"]),i=[];if(!t)return i;for(let r=t.start+16;r<t.end;){let s=findBox(e,r,["enca"]),n=36;if(s||(s=findBox(e,r,["encv"]),n=86),!s)return i;const a=findBox(e,s.start+n,["sinf","schi","tenc"]);a?(i.push(new TencBox(a.data,a.start,a.end)),r=a.end):r=t.end}return i}(e);if(!t)return;const i=function(e){const t=findBox(e,0,["moov"]),i=[];if(!t)return i;const r=new DataView(e.buffer,0);for(let s=t.start+8;s<t.size;){const t=r.getUint32(s);"pssh"===encodedArrayToString(e.subarray(s+4,s+8))&&i.push(new PsshBox(e,s,s+t)),s+=t}return i}(e).find(e=>e.isWidevine);i&&(t.defaultKeyId=i.keyBytes)};function readSynchSafeUint32(e){return 2097152*(127&e[0])+16384*(127&e[1])+128*(127&e[2])+(127&e[3])}const or={0:"iso-8859-1",1:"utf-16",2:"utf-16be",3:"utf-8"},lr={TPE1:!0,TIT2:!0,WXXX:!0,PRIV:!0,TALB:!0,CHAP:!0};class ID3{constructor(e){this.frames=[],this.unsynchronized=!1,this.hasExtendedHeader=!1,this.hasFooter=!1,this.isExperimental=!1;let t=0;const i=a(e.subarray(t,t+3));if(t+=3,"ID3"!==i)return;this.minor=e[t++],this.revision=e[t++];const r=e[t++];this._parseID3Flags(r);const s=readSynchSafeUint32(e.subarray(t,t+4));t+=4,this.frameLength=s;const n=t+s;if(this.endPos=n,this.hasExtendedHeader){t+=readSynchSafeUint32(e.subarray(t,t+4))}this.minor>2&&this._parseID3Frames(this,e,t,n)}_parseID3Flags(e){this.unsynchronized=isBitAtPositionOn(e,7),this.hasExtendedHeader=isBitAtPositionOn(e,6),this.isExperimental=isBitAtPositionOn(e,5),this.hasFooter=isBitAtPositionOn(e,4)}_parseID3Frames(e,t,i,r){const s=new DataView(t.buffer,0,r),{minor:n}=this;for(;i+8<=r;){const o=a(t.subarray(i,i+4));i+=4;const l=4===n?readSynchSafeUint32(t.subarray(i,i+4)):s.getUint32(i);if(i+=4,t[i++],t[i++],lr[o]){const s=i,n=this._extractID3FramePayload(t,o,l,s,r);if(n){const t=this.decodeID3Frame(n);t&&e.frames.push(t)}i+=l}else i+=l}}_extractID3FramePayload(e,t,i,r,s){const n=r+i;let a;return n<=s&&(a={type:t,size:i,data:e.slice(r,n)}),a}decodeID3Frame(e){if("TXXX"!==e.type)return"WXXX"===e.type?this.decodeWxxxFrame(e):"PRIV"===e.type?this.decodePrivFrame(e):"CHAP"===e.type?this.decodeChapFrame(e):"T"===e.type[0]?this.decodeTextFrame(e):{key:e.type,data:e.data}}decodeChapFrame(e){const{data:t}=e,i=new DataView(t.buffer),r={key:"CHAP",frames:[]};let[s,n]=readNullTerminatedString(t,0,t.length);return r.id=s,n++,r.startTime=i.getUint32(n),n+=4,r.endTime=i.getUint32(n),n+=4,n+=4,n+=4,this._parseID3Frames(r,t,n,t.length),r}decodeTextFrame(e){const{data:t}=e,i=or[t[0]],r=encodedArrayToString(t.subarray(1),i);return{key:e.type,text:r}}decodeWxxxFrame(e){const{data:t}=e,i=or[t[0]];let r=1;const s=encodedArrayToString(t.subarray(r),i);r+=s.length+1;return{key:"WXXX",description:s,text:encodedArrayToString(t.subarray(r))}}decodePrivFrame(e){const t=encodedArrayToString(e.data);if(!t)return;return{key:"PRIV",info:t,data:e.data.slice(t.length+1)}}}function checkBoxName(e,t,i){return!(t+4>e.length)&&(e[t]===i[0]&&e[t+1]===i[1]&&e[t+2]===i[2]&&e[t+3]===i[3])}function findEmsgs(e){const t=e.length,i=[];if(function(e){return(null==e?void 0:e.length)>=8&&checkBoxName(e,4,[102,116,121,112])}(e))return i;for(let r=0;r<t;r++){if(checkBoxName(e,r,[109,111,111,102]))return i;if(checkBoxName(e,r,[101,109,115,103])){const t=r-4,s=new DataView(e.buffer,t).getUint32(0),n=e.subarray(t,t+s);r=r+s-1,i.push(n)}}return i}const dr={TALB:"album",TIT2:"title",TPE1:"performer"},cr=["performer","title","album"];class TimedMetadata{constructor(e){this.links=[],this.storefrontToIds={},e.forEach(e=>{var t,i;const{key:r}=e,s=dr[r];if(s)this[s]=null===(t=e.text)||void 0===t?void 0:t.replace(/\0/g,"");else if("WXXX"===e.key){if(e.description){const[t,i]=e.description.split("\0");this.links.push({description:t,url:i})}}else if("PRIV"===e.key){const t=null===(i=e.info)||void 0===i?void 0:i.split("\0");if(t&&t.length&&t[0].startsWith("com.apple.radio.adamid")){t[1].split(",").forEach(e=>{const[t,i]=e.split(":");t&&i&&"0"!==i&&!hasOwn(this.storefrontToIds,t)&&(this.storefrontToIds[t]=i)})}}})}resolveAdamIdFromStorefront(e){const t=this.storefrontToIds[e];this._adamId=t}get adamId(){return this._adamId}equals(e){if(!cr.every(t=>this[t]===e[t]))return!1;const{links:t}=this,i=e.links;if(t.length!==i.length)return!1;for(let r=0;r<t.length;r++){const e=t[r].description===i[r].description,s=t[r].url===i[r].url;if(!e||!s)return!1}return!0}}class Emsg{constructor(e){this.data=e;const t=new DataView(e.buffer);let i=8;if(1!==e[i])return;i+=4,this.timeScale=t.getUint32(i),i+=4;const r=t.getUint32(i);i+=4;const s=t.getUint32(i);if(i+=4,this.presentationTime=Math.pow(2,32)*r+s,!Number.isSafeInteger(this.presentationTime))throw this.presentationTime=Number.MAX_SAFE_INTEGER,new Error("Failed to create 64 bit integer");this.eventDuration=t.getUint32(i),i+=4,this.id=t.getUint32(i),i+=4;const[n,a]=readNullTerminatedString(e,i);i+=a+1,this.schemeIdUri=n;const[o,l]=readNullTerminatedString(e,i);i+=l+1,this.payload=e.subarray(i,e.byteLength),this.id3=new ID3(this.payload)}get length(){return this.data.length}get elementPresentationTime(){const{presentationTime:e,timeScale:t}=this;return e&&t?Math.round(e/t):NaN}get timedMetadata(){var e;if(this._timedMetadata)return this._timedMetadata;const t=null===(e=this.id3)||void 0===e?void 0:e.frames;return t?(this._timedMetadata=new TimedMetadata(t),this._timedMetadata):void 0}}class TimedMetadataManager{constructor(e,t){this._currentTime=e,this._onDidChange=t,this._emsgLookup={},this._getCurrentEmsg=this._getCurrentEmsg.bind(this)}processEmsgs(e){const t=findEmsgs(e);t.length&&(this._currentEmsgInterval||(this._currentEmsgInterval=setInterval(this._getCurrentEmsg,1e3)),t.forEach(e=>{const t=new Emsg(e);this._emsgLookup[t.elementPresentationTime]=t}))}stop(){const{_currentEmsgInterval:e}=this;e&&clearInterval(e)}_getCurrentEmsg(){const{_currentTime:e,_emsgLookup:t}=this,i=Math.round(e()),r=[],s=Object.keys(t);for(let a=0;a<s.length;a++){const e=parseInt(s[a],10);if(!(e<i))break;r.push(e)}const n=r.pop();if(n){const e=t[n];if(!e)return;const{_currentEmsg:i,_onDidChange:r}=this,s=null==i?void 0:i.payload,a=e.payload;s&&arrayEquals(s,a)||(this._currentEmsg=e,r(e)),this._cleanupEmsgs(n)}}_cleanupEmsgs(e){const{_emsgLookup:t}=this;Object.keys(t).forEach(i=>{parseInt(i,10)<e&&delete t[i]})}}class SegmentProcessor{constructor(e,t,i){this._item=e,this._timedMetadataManager=new TimedMetadataManager(()=>t.currentTime,e=>{i.publish(sr,e.timedMetadata)})}process(e,t){const{_item:i}=this;try{i.isLiveRadioStation?this._processLiveRadioSegment(t):i.hasOffersHlsUrl&&this._processHlsOffersSegment(e,t)}catch(r){E.error("Error processing segment",r)}}stop(){this._timedMetadataManager.stop()}_processHlsOffersSegment(e,t){e.isInitSegment&&rewriteDefaultKid(t)}_processLiveRadioSegment(e){this._timedMetadataManager.processEmsgs(e)}}const ur=new Logger$1({levelFilterStorageKey:"mk-mse-buffer",topic:"mse-buffer"}),hr=createLocalStorageFlag("mk-mse-buffer").get(),{manifestParsed:pr}=Me;class MseBuffer{constructor({dispatcher:e,element:t,manifest:i,currentTime:r,duration:s,clip:n}){this.firstSegmentLoadPromise=Promise.resolve(),this.hasKickstarted=!1,this.segmentIndexToFetch=-1,this.timeToTrim=10,this.isAtEndOfStream=!1,this.isFullyBuffered=!1,this.deferredRemoves=[],this.currentTimestampOffset=0,this.dispatcher=e,this.clip=n,this.element=t,this.mediaSource=new MediaSource,this.mediaSource.addEventListener("sourceopen",this.onSourceOpen),this.segmentProcessor=new SegmentProcessor(i.mediaItem,t,e),this.playbackTimeline={current:{manifest:i}},i.addEventListener(pr,this.onManifestParsed),this._currentTime=r||0,this.duration=s,window.mseBuffer=this}onSourceOpen(){ur.debug("mediaSource open handler");const{mediaSource:e}=this;if(e.activeSourceBuffers.length>0)return void ur.debug("not adding new source buffer");ur.debug("adding new source buffer");const t=e.addSourceBuffer('audio/mp4;codecs="mp4a.40.2"');this.sourceBuffer=t,t.addEventListener("updateend",this.updateEndHandler);const{clip:i,hasAppendWindowSupport:r}=this;i&&(r?(ur.debug("appendWindowStart/End",i.start,i.end),t.appendWindowStart=i.start,t.appendWindowEnd=i.end):(ur.debug("seeking for clip",i.start),asAsync(this.seek(i.start)))),this.updateSegmentToFetch(0,!0)}setNextManifest(e){ur.debug("setting next manifest for ",e.mediaItem.title),this.nextSeamlessTransition?(ur.debug("abandoning transition scheduled for "+this.nextSeamlessTransition),this.revertSeamlessTransition(!0),this.playbackTimeline.next={manifest:e}):(this.playbackTimeline.next={manifest:e},this.isFullyBuffered&&(ur.debug("current song is fully buffered, beginning transition to next"),this.transitionToNextManifest()))}isItemPlaying(e){var t,i;const{playbackTimeline:r}=this,s=this.nextSeamlessTransition?null===(t=r.previous)||void 0===t?void 0:t.manifest.mediaItem:null===(i=r.current)||void 0===i?void 0:i.manifest.mediaItem;return!!s&&(ur.debug(`isItemPlaying ${e.title}, ${s.title}, ${e.id===s.id}`),e.id===s.id)}get currentItem(){return this.manifest.mediaItem}get playableUrl(){let e=this._playableUrl;return e||(e=window.URL.createObjectURL(this.mediaSource),ur.debug("created url",e),this._playableUrl=e,e)}get segments(){const{manifest:e,clip:t}=this;return t?e.segmentsForTimeRange(t):e.segments||[]}get currentTime(){return this._currentTime}set currentTime(e){var t,i;if(e+=this.currentTimestampOffset,this._currentTime===e)return;const{nextSeamlessTransition:r}=this;if(r&&e>=r){ur.debug("setting offset to",r),this.currentTimestampOffset=r||0,this.nextSeamlessTransition=void 0,this.duration=this.manifest.mediaItem.playbackDuration/1e3,ur.debug("buffer setting duration to",this.duration);const e={previous:null===(i=null===(t=this.playbackTimeline.previous)||void 0===t?void 0:t.manifest)||void 0===i?void 0:i.mediaItem,current:this.manifest.mediaItem};ur.debug("dispatching seamless audio transition",e),this.dispatcher.publish(rr,e)}this._currentTime=e;const{isOverBufferLimit:s,timeToTrim:n}=this,a=e>this.timeToTrim;s&&a&&(ur.debug("buffer over limit, trimming to ",n),this.removeToTime(n),this.timeToTrim+=10)}get hasAppendWindowSupport(){var e;return void 0!==(null===(e=this.sourceBuffer)||void 0===e?void 0:e.appendWindowStart)}seek(e){return __awaiter(this,void 0,void 0,(function*(){const{duration:t,seekWhenUpdated:i,sourceBuffer:r}=this;if(this.resolveSeekPromise(!1),ur.debug("seek to ",e),(e=+e)>t&&(ur.debug("rounding seek time to duration",e,t),e=t),!r)return!1;if(this.revertSeamlessTransition(),r.updating)return ur.debug("sourcebuffer updating, deferring seek"),new Promise(t=>{i&&i.resolve(!1),this.seekWhenUpdated={seek:this.seek.bind(this,e),resolve:t}});this.currentlyLoadingSegmentIndex=void 0,this.updateSegmentToFetch(0,!0),this.removeToTime(e),this.timeToTrim=10*Math.floor(e/10);const s=this.getSegmentForTime(e);0!==s&&(yield this.firstSegmentLoadPromise),ur.debug("seeking to",e,"segment",s),this.updateSegmentToFetch(s,!0);const n=new Promise(t=>{this.seekResolver={time:e,resolve:t}});return this.checkSeekBuffered(),n}))}clearNextManifest(){this.revertSeamlessTransition(!0),this.playbackTimeline.next=void 0}revertSeamlessTransition(e=!1){const{playbackTimeline:t,nextSeamlessTransition:i}=this;if(!i||!t.previous)return void ur.debug("no need to revert, no transition");this.isAtEndOfStream=e,ur.debug("reverting seamless transition with discardNextManifest",e),e?this.clearBufferToEnd(i):this.clearBuffer(),ur.debug("abandoning transition to "+this.manifest.mediaItem.title),t.next=e?void 0:t.current,t.current=t.previous,t.previous=void 0;const r=this.manifest.mediaItem;ur.debug("current item reverted to "+r.title),this.nextSeamlessTransition=void 0,this.duration=r.playbackDuration/1e3,ur.debug("reverted duration to "+this.duration),e||(this.currentTimestampOffset=0,this.timestampOffsetAdjustment=0,ur.debug("reverted currentTimestampOffset and timestampOffsetAdjustment to 0")),this.printInfo(),this.segmentIndexToFetch=-1}get streamHasEnding(){return!this.manifest.mediaItem.isLiveRadioStation}stop(){this.segmentProcessor.stop(),this.setEndOfStream(),this.remove()}remove(){var e;ur.debug("removing sourceBuffer and mediaSource");const{sourceBuffer:t,mediaSource:i}=this;null===(e=this.seekResolver)||void 0===e||e.resolve(!1),this.manifest.removeEventListener(pr,this.onManifestParsed);const r=this._playableUrl;r&&(ur.debug("revoking url",r),window.URL.revokeObjectURL(r)),i.removeEventListener("sourceopen",this.onSourceOpen),t&&(t.removeEventListener("updateend",this.updateEndHandler),this.sourceBuffer=void 0)}onManifestParsed(){const e=this.segmentIndexToFetch+1;ur.debug("manifestParsed, loading segment",e),this.updateSegmentToFetch(e,!0)}updateEndHandler(){if(this.kickstartBuffer(),this.clearDeferredRemove())return;if(ur.debug("update end",this.seekWhenUpdated),this.seekWhenUpdated){ur.debug("updateEndHandler resolving seekWhenUpdated");const{seekWhenUpdated:e}=this;return asAsync(e.seek().then(e.resolve)),void(this.seekWhenUpdated=void 0)}this.checkSeekBuffered();const{clip:e,sourceBuffer:t,hasAppendWindowSupport:i}=this;if(e&&t&&!i){const{buffered:i}=t;if(this.isTimeBuffered(e.end+1)){const r=i.end(i.length-1);return ur.debug("clipping sourcebuffer to",e.end,r),void t.remove(e.end,r)}}if(this.isAtEndOfStream)return ur.debug("buffer is at end of stream"),this.streamHasEnding&&(ur.debug("isAtEndOfStream, not fetching any more segments"),this.playbackTimeline.next||this.setEndOfStream(),this.transitionToNextManifest()),void(this.isAtEndOfStream=!1);ur.debug("updateEndHandler invoking loadSegment"),asAsync(this.loadSegment())}clearDeferredRemove(){var e;if(0===this.deferredRemoves.length)return!1;const t=this.deferredRemoves.shift();return null===(e=this.sourceBuffer)||void 0===e||e.remove(t.start,t.end),!0}transitionToNextManifest(){var e;ur.debug("beginning transition to next manifest");const{playbackTimeline:t,sourceBuffer:i}=this;if(!t.next||!i)return void ur.debug("no next manifest");const r=this.endOfBufferTime||this.currentTimestampOffset;ur.debug("setting seamless transition at",r),this.nextSeamlessTransition=r,this.timestampOffsetAdjustment=r,this.playbackTimeline.current.endTime=r,t.previous=t.current,ur.debug("previous manifest set to",null===(e=t.previous)||void 0===e?void 0:e.manifest.mediaItem.title),t.current=t.next,ur.debug("current manifest set to",t.current.manifest.mediaItem.title),t.next=void 0,this.updateSegmentToFetch(0,!0),this.printInfo()}updateSegmentToFetch(e,t=!1){this.segments.length&&e<this.segments.length&&e!==this.segmentIndexToFetch&&(this.segmentIndexToFetch=e,t&&(ur.debug("updateSegmentToFetch invoking loadSegment"),asAsync(this.loadSegment())))}loadSegment(){return __awaiter(this,void 0,void 0,(function*(){const e=this.segmentIndexToFetch,t=this.segments[e];if(e!==this.currentlyLoadingSegmentIndex){if(t)try{ur.debug("begin loadSegment "+e),this.currentlyLoadingSegmentIndex=e;const r=t.load();0===e&&(this.firstSegmentLoadPromise=r);const s=yield r;if(0!==e&&e!==this.segmentIndexToFetch)return void ur.debug("load segment index to fetch changed, not processing bytes for segment",e);this.segmentProcessor.process(t,s),ur.debug("loadSegment processed: "+e);const{sourceBuffer:n,timestampOffsetAdjustment:a}=this;if(!n)return;try{"number"==typeof a&&(ur.debug("adjusting timestampOffset of sourcebuffer to",a),n.timestampOffset=a,this.timestampOffsetAdjustment=void 0),n.appendBuffer(s),this.isFullyBuffered=!1,this.isOverBufferLimit=!1,ur.debug("appended to buffer",s.length),this.printBufferTimes(),e===this.segments.length-1?this.isAtEndOfStream=!0:e===this.segmentIndexToFetch&&(ur.debug("loadSegment bumping segment index to fetch to ",e+1),this.updateSegmentToFetch(e+1))}catch(i){"QuotaExceededError"===i.name?(this.isOverBufferLimit=!0,ur.debug("reached buffer limit")):ur.warn("Error appending to source buffer",i)}}catch(r){ur.error("Error loading segment",r)}finally{this.currentlyLoadingSegmentIndex=void 0}}else ur.debug(`segment ${e} is currently loading, not loading it again`)}))}setEndOfStream(){const{sourceBuffer:e,mediaSource:t}=this;e&&"ended"!==t.readyState&&(e.updating||"open"!==t.readyState?ur.error("Could not end of stream (updating, readyState)",e.updating,t.readyState):(ur.debug("mediaSource.endOfStream"),t.endOfStream(),this.isFullyBuffered=!0))}removeToTime(e){ur.debug("removing to time",e),e>0&&(this.isTimeBuffered(e)||this.isOverBufferLimit)&&this.safeSourceBufferRemove(0,e)}safeSourceBufferRemove(e,t){const{sourceBuffer:i}=this;i&&(i.updating?this.deferredRemoves.push({start:e,end:t}):i.remove(e,t))}get previousOffset(){var e,t;return(null===(t=null===(e=this.playbackTimeline)||void 0===e?void 0:e.previous)||void 0===t?void 0:t.endTime)||0}get manifest(){var e;return null===(e=this.playbackTimeline.current)||void 0===e?void 0:e.manifest}checkSeekBuffered(){const{seekResolver:e,currentTimestampOffset:t}=this;if(!e)return;const{time:i}=e,r=i+t,s=this.isTimeBuffered(r);ur.debug("resolving seek for time, adjustedTime, isBuffered",i,r,s),this.printBufferTimes(),s&&(ur.debug("resolving seek to true for time:",r),this.element.currentTime=r,this.resolveSeekPromise(!0))}resolveSeekPromise(e){this.seekResolver&&(this.seekResolver.resolve(e),this.seekResolver=void 0)}get endOfBufferTime(){var e;const t=null===(e=this.sourceBuffer)||void 0===e?void 0:e.buffered;return!(!t||!t.length)&&t.end(t.length-1)}isTimeBuffered(e){var t;const i=null===(t=this.sourceBuffer)||void 0===t?void 0:t.buffered;if(!i)return!1;for(let r=0;r<i.length;r++)if(ur.debug("isTimeBuffered",i.start(r),e,i.end(r)),e>=i.start(r)&&e<=i.end(r))return!0;return!1}clearBufferToEnd(e){const{sourceBuffer:t}=this;if(!t||!t.buffered)return;const i=t.buffered.end(t.buffered.length-1);this.safeSourceBufferRemove(e,i)}clearBuffer(){const{sourceBuffer:e}=this;if(!e||!e.buffered)return;const t=e.buffered;for(let i=0;i<t.length;i++)this.safeSourceBufferRemove(t.start(i),t.end(i))}get bufferTimesString(){var e;const t=null===(e=this.sourceBuffer)||void 0===e?void 0:e.buffered;if(!t)return"";const i=[];for(let r=0;r<t.length;r++)i.push(`start ${t.start(r)} end: ${t.end(r)}`);return i.join(",")}printBufferTimes(){hr&&ur.debug("buffer times",this.bufferTimesString)}getSegmentForTime(e){return Math.floor(e/10)+1}kickstartBuffer(){const{hasKickstarted:e,element:t,clip:i}=this,{buffered:r}=t;e||(this.manifest.mediaItem.isSong?i&&this.isTimeBuffered(i.start)&&(t.currentTime=i.start,this.hasKickstarted=!0):r.length&&(t.currentTime=r.start(0),this.hasKickstarted=!0))}printInfo(){var e,t;const{playbackTimeline:i}=this;ur.info("---- Buffer Info ----"),ur.info("currently buffering item",i.current.manifest.mediaItem.title),ur.info("next item to buffer",null===(e=i.next)||void 0===e?void 0:e.manifest.mediaItem.title),ur.info("previously buffered item",null===(t=i.previous)||void 0===t?void 0:t.manifest.mediaItem.title),ur.info("currentTimestampOffset",this.currentTimestampOffset),ur.info("currentTime",this.currentTime),ur.info("duration",this.duration),ur.info("nextSeamlessTransition",this.nextSeamlessTransition),ur.info("timestampOffsetAdjustment",this.timestampOffsetAdjustment),ur.info("buffered times",this.bufferTimesString),ur.info("isAtEndOfStream",this.isAtEndOfStream),ur.info("isFullyBuffered",this.isFullyBuffered),ur.info("segmentIndexToFetch",this.segmentIndexToFetch),ur.info("segments.length",this.segments.length),ur.info("---- End Buffer Info ----")}}__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],MseBuffer.prototype,"onSourceOpen",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],MseBuffer.prototype,"onManifestParsed",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],MseBuffer.prototype,"updateEndHandler",null);const{mediaPlaybackError:yr}=Ye,mr=createLocalStorageFlag("mk-linear-scrubbing-enabled");class AudioPlayer extends BasePlayer{constructor(e){var t;super(e),this.currentAudioTrack=void 0,this.currentTextTrack=void 0,this.textTracks=[],this.audioTracks=[],this.isSeamlessAudioTransitionsEnabled=!1,this.mediaPlayerType="audio",this.isSeamlessAudioTransitionsEnabled=!!(null===(t=null==e?void 0:e.bag)||void 0===t?void 0:t.features["seamless-audio-transitions"]),window.audioPlayer=this}get currentPlayingDate(){}get _targetElement(){return this.audio}initializeExtension(){return __awaiter(this,void 0,void 0,(function*(){this.extension=new MediaExtension(this.audio,'audio/mp4;codecs="mp4a.40.2"'),yield this.extension.initializeKeySystem(),this.extension.addEventListener(Me.playbackLicenseError,e=>{this._licenseError(),this._dispatcher.publish(yr,e)}),this.extension.addEventListener(Me.playbackSessionError,e=>{this._dispatcher.publish(yr,new MKError(MKError.MEDIA_SESSION,e))})}))}initializeMediaElement(){return __awaiter(this,void 0,void 0,(function*(){const e=function(){let e=Ce.pop();return e?E.debug(`dom-helpers: retrieving audio tag, ${Ce.length} remain`):(E.debug("dom-helpers: no available audio tags, creating one"),e=document.createElement("audio")),e}();e.autoplay=!1,e.id="apple-music-player",e.controls=!1,e.muted=!1,e.playbackRate=1,e.preload="metadata",e.volume=1,this.audio=e,document.body.appendChild(e),E.debug("initializedMediaElement",e)}))}removeEventHandlers(){this._targetElement.removeEventListener("timeupdate",this.onTimeUpdate),super.removeEventHandlers()}isPlayerSupported(){return!0}_stopMediaElement(){const e=Object.create(null,{_stopMediaElement:{get:()=>super._stopMediaElement}});var t;return __awaiter(this,void 0,void 0,(function*(){yield e._stopMediaElement.call(this),yield this.tearDownManifests(),null===(t=this._buffer)||void 0===t||t.stop(),this._buffer=void 0}))}setNextSeamlessItem(e){return __awaiter(this,void 0,void 0,(function*(){const{extension:t,nextManifest:i}=this,r=this._buffer;if(!r||!t)return;if((null==i?void 0:i.mediaItem.id)===e.id)return void E.debug("already have next manifest for ",e.title);this._targetElement.removeEventListener("timeupdate",this.onTimeUpdate),this._targetElement.addEventListener("timeupdate",this.onTimeUpdate),E.debug("player preparing next manifest for",e.title);const s=yield this.loadAndParseManifest(e,!1);r.setNextManifest(s),t.setMediaItem(e),t.extURI=s.extURI,this.nextManifest=s}))}playItemFromEncryptedSource(t,i=!1,r){return __awaiter(this,void 0,void 0,(function*(){const s=this._paused&&!i;if(E.debug("playItemFromEncryptedSource",t.title),t.playRawAssetURL)return t.playbackType=e.PlaybackType.unencryptedFull,this.nowPlayingItem=t,this._playAssetURL(t.assetURL,s);const{extension:n}=this;if(!n)return;n.initiated=i,n.setMediaItem(t),t.playbackType=e.PlaybackType.encryptedFull,this.nowPlayingItem=t,t.state=A.loading;const a=yield this.getManifestForItem(t);this.manifest=a;const o=shouldForceAudioMse();if((t.isSong||n.isFairplay&&o)&&(n.extURI=a.extURI),t.state=A.ready,n.isFairplay&&!o){let e=t.assetURL;return(null==r?void 0:r.startTime)&&(e+="#t="+r.startTime),this._playAssetURL(e,s)}{const e=this._buffer;if(!(e&&this.isSeamlessAudioTransitionsEnabled&&e.isItemPlaying(a.mediaItem)))return this.beginNewBufferForItem(s,a,r);E.debug("already have buffer, continuing playback")}}))}getManifestForItem(e){var t,i;return __awaiter(this,void 0,void 0,(function*(){E.debug("reconciling item to play against playing item");const{nextManifest:r,manifest:s,isSeamlessAudioTransitionsEnabled:n}=this,a=this._buffer;if(!a||!s)return E.debug("no buffer or manifest, creating manifest [title, buffer, manifest]",e.title,!!a,!!s),this.loadAndParseManifest(e);if(!n)return E.debug("seamless transitions disabled, stopping and creating manifest for",e.title),yield this.tearDownManifests(),this.loadAndParseManifest(e);const o=!a.isItemPlaying(e);let l;return E.debug("itemMismatch",o),r&&!o?(E.debug(`replacing manifest for ${s.mediaItem.title} with next manifest ${r.mediaItem.title}`),l=r,this.nextManifest=void 0,E.debug("cease listening for keys on manifest for",s.mediaItem.title),yield this.tearDownManifest(s)):o?(null==r?void 0:r.mediaItem.id)!==e.id?(E.debug(`item to play ${e.title} does not match playing or next items, tearing down all manifests`),yield this.tearDownManifests(),l=yield this.loadAndParseManifest(e)):(E.debug(`item to play ${e.title} matches next item, tearing down current manifest`),yield this.tearDownManifest(s),l=r):(E.debug("item is already playing, returning existing manifest"),l=s),E.debug("getManifestForItem loading keys for",s.mediaItem.title),null===(i=null===(t=this.extension)||void 0===t?void 0:t.session)||void 0===i||i.loadKeys(l.keyValues,l.mediaItem),l}))}seekToTime(e){return __awaiter(this,void 0,void 0,(function*(){const t=this._buffer;if(t){E.debug("audio-player: buffer seek to",e);if(!(yield t.seek(e)))return;this.isSeamlessAudioTransitionsEnabled&&this.onTimeUpdate()}else E.debug("audio-player: media element seek to",e),this._targetElement.currentTime=e}))}tearDownManifests(){return __awaiter(this,void 0,void 0,(function*(){this.manifest=yield this.tearDownManifest(this.manifest),this.nextManifest=yield this.tearDownManifest(this.nextManifest)}))}tearDownManifest(e){return __awaiter(this,void 0,void 0,(function*(){const{extension:t}=this;e&&(E.debug("tearing down manifest for",e.mediaItem.title),e.stop(),t&&(yield t.clearSessions(e.keyValues)),e.removeEventListener(Zi.keysParsed,this.loadKeysHandler))}))}loadAndParseManifest(e,t=!0){return __awaiter(this,void 0,void 0,(function*(){E.debug(`will load and parse manifest for ${e.title}, loadKeys ${t}`);const i=yield Manifest.load(e,!1);return t&&i.addEventListener(Zi.keysParsed,this.loadKeysHandler),i.parse(),i}))}onTimeUpdate(){var e,t;if(!this._buffer)return;const{currentPlaybackTimeRemaining:i,nextManifest:r}=this;r&&i<15&&(E.debug("player loading keys for",r.mediaItem.title),null===(t=null===(e=this.extension)||void 0===e?void 0:e.session)||void 0===t||t.loadKeys(r.keyValues,r.mediaItem),this._targetElement.removeEventListener("timeupdate",this.onTimeUpdate))}loadKeysHandler(e){var t,i;null===(i=null===(t=this.extension)||void 0===t?void 0:t.session)||void 0===i||i.loadKeys(e.keys,e.item)}beginNewBufferForItem(e,t,i){return __awaiter(this,void 0,void 0,(function*(){if(E.debug("creating new MseBuffer for item",t.mediaItem.title,e),this._buffer&&(E.debug("stopping old buffer"),this._buffer.stop()),this._buffer=new MseBuffer({dispatcher:this._dispatcher,element:this._targetElement,duration:t.mediaItem.playbackDuration/1e3,manifest:t}),yield this._playAssetURL(this._buffer.playableUrl,!0),!e){let e=Promise.resolve();return(null==i?void 0:i.startTime)&&(e=this.seekToTime(i.startTime)),mr.json()?e.then(()=>this.play()):e.then(()=>this._playMedia())}}))}setPresentationMode(e){return __awaiter(this,void 0,void 0,(function*(){return Promise.resolve()}))}}__decorate([AsyncDebounce(250),__metadata("design:type",Function),__metadata("design:paramtypes",[Number]),__metadata("design:returntype",Promise)],AudioPlayer.prototype,"seekToTime",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],AudioPlayer.prototype,"onTimeUpdate",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object]),__metadata("design:returntype",void 0)],AudioPlayer.prototype,"loadKeysHandler",null);class EncryptedSession extends KeySession{attachMedia(e,t){return __awaiter(this,void 0,void 0,(function*(){this.keySystem=t.keySystem,this._keySystemAccess=t,e.addEventListener("encrypted",this.boundHandleSessionCreation,!1)}))}detachMedia(e){e.removeEventListener("encrypted",this.boundHandleSessionCreation)}createSession(e){return __awaiter(this,void 0,void 0,(function*(){E.debug("Encrypted createSession",e);const t=this._keySystemAccess;if(!t)return;const{initData:i,initDataType:r,target:s}=e;return this._mediaKeysPromise||(this._mediaKeysPromise=new Promise((e,i)=>__awaiter(this,void 0,void 0,(function*(){const r=yield t.createMediaKeys();try{yield s.setMediaKeys(r)}catch(Pt){this.dispatchKeyError(Pt),i(Pt)}const n=yield this.loadCertificateBuffer();yield r.setServerCertificate(n),this._mediaKeysServerCertificate=n,e(r)})))),yield this._mediaKeysPromise,this._mediaKeysServerCertificate?this._createSession(s,i,r):void 0}))}generatePSSH(e){const t=new Uint8Array([0,0,0,52,112,115,115,104,0,0,0,0,237,239,139,169,121,214,74,206,163,200,39,220,213,29,33,237,0,0,0,20,8,1,18,16,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),i=o(e);for(let r=0;r<i.length;r++)t[t.length-16+r]=i[r];return E.debug("generatePSSH",t),t}_createSession(e,t,i){const r=e.mediaKeys.createSession(),{item:s}=this;if(!s)return;this._teardownCurrentSession(),E.debug("creating media key session",r);let n;if(this.isWidevine&&s.isSong)n=this.generatePSSH(this.extID);else{const e=function(e){const t=[],i=new DataView(e.buffer);for(let r=0;r<e.length;){const s=i.getUint32(r);t.push(new PsshBox(e,r,r+s)),r+=s}return t}(new Uint8Array(t)).find(e=>e.isWidevine),i=null==e?void 0:e.rawBytes,s=c(i);E.debug("extracted uri",s),r.extURI=s,n=t}return r.addEventListener("message",this.startLicenseSession),this._currentSession=r,r.generateRequest(i,n).catch(e=>{if(e.message.match(/generateRequest.*\(75\)/))return r.generateRequest(i,n);throw e})}_teardownCurrentSession(){this._currentSession&&(E.debug("tearing down media key session",this._currentSession),this._currentSession.removeEventListener("message",this.startLicenseSession),this._currentSession=void 0)}loadKeys(e,t){return __awaiter(this,void 0,void 0,(function*(){}))}clearSessions(){return __awaiter(this,void 0,void 0,(function*(){}))}}class MediaExtensionStub extends Notifications{constructor(e){super(e),this.audioTracks=[],this.textTracks=[],this.extURI="",this.hasMediaKeySupport=!0,this.initiated=!0,this.isFairplay=!0,this.hasMediaKeySupport=!0,this.hasMediaSession=!0}destroy(e){}setMediaItem(e){}initializeKeySystem(){return __awaiter(this,void 0,void 0,(function*(){this.session=new EncryptedSession}))}clearSessions(){return __awaiter(this,void 0,void 0,(function*(){}))}}class PlayerStub{constructor(t){this.bitrate=e.PlaybackBitrate.STANDARD,this.audioTracks=[],this.currentBufferedProgress=0,this.currentPlaybackDuration=0,this.currentPlaybackProgress=0,this.currentPlaybackTime=0,this.currentPlaybackTimeRemaining=0,this.currentPlayingDate=void 0,this.formattedCurrentPlaybackDuration={hours:0,minutes:0},this.isPlaying=!1,this.isPrimaryPlayer=!0,this.isReady=!1,this.paused=!1,this.playbackState=e.PlaybackStates.none,this.playbackTargetAvailable=!1,this.playbackTargetIsWireless=!1,this.previewOnly=!1,this.textTracks=[],this.extension=new MediaExtensionStub([]),this.hasAuthorization=!0,this.isDestroyed=!1,this._volume=1,this._playbackRate=1,this._dispatcher=t.services.dispatcher,this.windowHandlers=new WindowHandlers(this)}get hasMediaElement(){return!0}get isEngagedInPlayback(){return!this.paused}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e,this._dispatcher.publish(Ye.playbackRateDidChange,new Event("ratechange"))}get volume(){return this._volume}set volume(e){this._volume=e,this._dispatcher.publish(Ye.playbackVolumeDidChange,new Event("volumeChange"))}destroy(){}dispatch(){}exitFullscreen(){return __awaiter(this,void 0,void 0,(function*(){}))}initialize(){return __awaiter(this,void 0,void 0,(function*(){}))}isPaused(){return this.paused}calculateTime(e){return e}clearNextManifest(){}mute(){}newSeeker(){return new PlayerSeeker(this)}pause(e){return __awaiter(this,void 0,void 0,(function*(){}))}play(){return __awaiter(this,void 0,void 0,(function*(){}))}playItemFromEncryptedSource(e,t,i){return __awaiter(this,void 0,void 0,(function*(){}))}playItemFromUnencryptedSource(e,t,i){return __awaiter(this,void 0,void 0,(function*(){}))}preload(){return __awaiter(this,void 0,void 0,(function*(){}))}prepareToPlay(e,t,i){return __awaiter(this,void 0,void 0,(function*(){}))}seekToTime(e){return __awaiter(this,void 0,void 0,(function*(){}))}requestFullscreen(){return __awaiter(this,void 0,void 0,(function*(){}))}setPlaybackState(e,t){}setPresentationMode(e){return __awaiter(this,void 0,void 0,(function*(){}))}showPlaybackTargetPicker(){}stop(e){return __awaiter(this,void 0,void 0,(function*(){}))}stopMediaAndCleanup(){return __awaiter(this,void 0,void 0,(function*(){}))}supportsPictureInPicture(){return!1}tsidChanged(){}setNextSeamlessItem(e){return __awaiter(this,void 0,void 0,(function*(){}))}}e.version="2.2224.3";const gr=e.version.split("."),fr=gr[0],vr=gr[gr.length-1];gr[0]="3",gr[gr.length-1]=vr+"-prerelease",gr[0]=fr,gr[gr.length-1]=vr,e.version=gr.join(".");const _r={af:48,sq:1,ar:34,eu:1,bg:49,be:1,ca:42,zh:19,"zh-tw":18,"zh-cn":19,"zh-hk":45,"zh-sg":19,hr:41,cs:22,da:11,nl:10,"nl-be":65,en:1,"en-us":1,"en-eg":26,"en-au":27,"en-gb":2,"en-ca":6,"en-nz":27,"en-ie":26,"en-za":26,"en-jm":26,"en-bz":26,"en-tt":26,"en-001":26,et:30,fo:1,fa:59,fi:12,fr:3,"fr-ca":5,gd:2,de:4,"de-ch":57,el:23,he:36,hi:50,hu:21,is:31,id:37,it:7,ja:9,ko:13,lv:33,lt:32,mk:1,mt:1,no:14,nb:14,nn:14,pl:20,"pt-br":15,pt:24,rm:1,ro:39,ru:16,sr:1,sk:40,sl:52,es:8,"es-mx":28,"es-419":44,sv:17,th:35,ts:1,tn:1,tr:25,uk:29,ur:55,ve:1,vi:43,xh:1,yi:1,zu:56,ms:38,iw:36,lo:46,tl:47,kk:51,ta:53,te:54,bn:58,ga:60,ht:61,la:62,pa:63,sa:64};let br="Music-User-Token";function getLanguages(){if("undefined"==typeof navigator)return[];if(navigator.languages)return navigator.languages;const e=navigator.language||navigator.userLanguage;return e?[e]:[]}br="Media-User-Token";const Tr=createLocalStorageFlag("mk-hlsjs-automation-config"),Sr=new RegExp("^https://([a-z0-9]+-)?"+("js-cdn.music.apple.com"+"/musickit/v3/".replace(/v3/,"(v2|v3)")).replace(/[\.\/]/g,"\\$&"),"i"),Er=/^([a-z]+:)?\/\//;function findScript(e){return isNodeEnvironment$1()||!e?null:document.querySelector(`script[src*="${e}"]`)}function determineCdnBasePrefix(){for(const e of"undefined"!=typeof document&&document.querySelectorAll?Array.from(document.querySelectorAll("script[src]")):[]){const t=Sr.exec(e.src);if(t)return t[1]||""}return""}function determineCdnBaseHost(){if(isNodeEnvironment$1())return"";return`//${determineCdnBasePrefix()}js-cdn.music.apple.com`}const kr=createLocalStorageFlag("mk-hlsjs-log-level");function getHlsJsCdnConfig(){const e={hls:"",rtc:""};if(isNodeEnvironment$1())return e;const t=determineCdnBaseHost();let i="2.162.2";i=createLocalStorageFlag("mk-hlsjs-version").get()||i;const r=function(){let e;switch(kr.get()){case"trace":case"debug":e="hls.dev.js";break;case"info":case"error":case"warn":e="hls.production.verbose.min.js";break;default:e="hls.js"}return e}();return e.hls=`https:${t}/hls.js/${i}/hls.js/${r}`,e.rtc=`https:${t}/hls.js/${i}/rtc.js/rtc.min.js`,function(e){const t=Tr.json();if(!(null==t?void 0:t.url))return;const{url:i}=t;isAppleHostname(i)&&"carry-"===determineCdnBasePrefix()&&(e.hls=i)}(e),e}function isAppleHostname(e){try{return new URL(e).hostname.endsWith(".apple.com")}catch(t){}return!1}function cdnBaseURL(e,t=window){var i;if(isNodeEnvironment$1())return"";const r=null===(i=getLocalStorage())||void 0===i?void 0:i.getItem("mkCDNBaseURLOverride");if(r)return r;const s=findScript(e);return s?s.getAttribute("src").replace(new RegExp(e+"$"),""):determineCdnBaseHost()+"/musickit/v3/"}const Pr=new Map;function loadScript(e,t){const i=Pr.get(e);if(i)return i;const r=new Promise((i,r)=>{isNodeEnvironment$1()&&r("Dynamic script loading is unsupported in Node environments.");if(findScript(e))return i();const s=document.createElement("script");let n;if(t&&Object.keys(t).forEach(e=>{s.setAttribute(e,t[e])}),s.onload=()=>{i()},s.onerror=e=>{r(e)},Er.test(e))n=e;else{n=`${cdnBaseURL(e)}${e}`}s.src=n,document.head.appendChild(s)});return Pr.set(e,r),r}const Ir=new Logger$1("sk-debug");class AuthBridgeApp extends class{constructor(){this._targetOrigin="*"}init(e,t){var i;this._receiveWindow=e,this._sendWindow=t,this.handleMessage=this.handleMessage.bind(this),null===(i=this._receiveWindow)||void 0===i||i.addEventListener("message",this.handleMessage)}sendMessage(e,t){const i={action:"mediakit:"+e,data:t};this._sendWindow&&this._sendWindow.postMessage(JSON.stringify(i),this._targetOrigin)}handleMessage(e){if(!this._isOriginAllowed(e.origin))return;let t;try{t=JSON.parse(e.data)}catch(r){}if(!t||!this._isNamespacedData(t))return;"*"===this._targetOrigin&&(this._targetOrigin=e.origin),Ir.debug("auth-bridge: handleMessage",t);const i=t.action.replace("mediakit:","");this[i]?this[i](t.data):Ir.debug("auth-bridge: unsupported method",i)}_isOriginAllowed(e){if(!e)return!1;const[t,i]=e.split("://");let r="";return i&&(r=i.split(":")[0]),"https"===t&&!!r&&r.endsWith(".apple.com")}_isNamespacedData(e){return e.action&&-1!==e.action.indexOf("mediakit:")}}{constructor(){super(),this.whenFrameInited=new Promise(e=>this._frameInitResolve=e),this.whenAuthCompleted=new Promise(e=>this._authUpdateResolve=e),this.frame=document.createElement("iframe"),this.frame.src=this._getIframeSrc(),this.frame.style.display="none",document.body.appendChild(this.frame),this.init(window,this.frame.contentWindow)}requestAuthUpdate(){this.whenFrameInited.then(()=>this.sendMessage("requestAuthUpdate"))}setCookieItem(e,t){this.whenFrameInited.then(()=>this.sendMessage("setCookieItem",{name:e,value:t}))}clearAuth(){this.whenFrameInited.then(()=>this.sendMessage("clearAuth"))}frameInit(){var e;null===(e=this._frameInitResolve)||void 0===e||e.call(this),this.requestAuthUpdate()}updateAuth(e){if((null==e?void 0:e.enabled)&&(null==e?void 0:e.cookies)){const t=e.cookies;Object.keys(t).forEach(e=>{var i;const r=null!==(i=t[e])&&void 0!==i?i:"";r?setCookie(e,r,"/",7):removeCookie(e)})}this._authUpdateResolve&&(this._authUpdateResolve(),this._authUpdateResolve=void 0)}authClearedFromOtherFrame(){Ir.warn("Override auth-bridge/app's authClearedFromOtherFrame to trigger app-specific sign out behavior")}_getIframeSrc(){let e=determineCdnBasePrefix();return e&&(e="?env="+e.substring(0,e.length-1)),"https://mediaauth.apple.com/auth-bridge/"+e}}const Ar=new Set(["apps","books","music","podcasts","tv"]),wr=/\.apple\.com$/;function getCommerceHostname(e,t){!t&&"undefined"!=typeof location&&location.hostname&&(t=location);let i=e+".itunes.apple.com";if(!t)return i;const r=function(e){if(!e||!wr.test(e))return;const t=e.split(".");let i=t[t.length-3];const r=i;if(i&&i.includes("-")){const e=i.split("-");i=e[e.length-1]}return Ar.has(i)?r:void 0}(t.hostname);return r&&(i=`${e}.${r}.apple.com`),i}var Rr;function buildQueryParams(e={app:Rr.APP,p:Rr.P}){return void 0===e.app&&(e.app=Rr.APP),void 0===e.p&&(e.p=Rr.P),Object.keys(e).map(t=>`${encodeURIComponent(t)}=${encodeURIComponent(e[t])}`).join("&")}!function(e){e.APP="music",e.P="subscribe"}(Rr||(Rr={}));const Or={2:"com.apple.onboarding.tvapp",0:"com.apple.onboarding.applemusic"},Cr={2:"pltvcid",0:"pldfltcid"},Mr={"com.apple.onboarding.tvapp":5,"com.apple.onboarding.applemusic":3};var Dr;!function(e){e[e.ParseError=-32700]="ParseError",e[e.InvalidRequest=-32600]="InvalidRequest",e[e.MethodNotFound=-32601]="MethodNotFound",e[e.InvalidParams=-32602]="InvalidParams",e[e.InternalError=-32603]="InternalError"}(Dr||(Dr={}));class Dispatch{constructor(e={}){this._registry={},this._sequence=0,this.handle=e=>{e.data&&"2.0"===e.data.jsonrpc&&("*"!==this.origin&&this.origin!==e.origin||(e.data.method&&this.destination?this.handleRequest(e.data).then(e=>{this.send(this.destination,e)}):(hasOwn(e.data,"result")||e.data.error)&&this.handleResponse(e.data)))},this.destination=e.destination,this.methods=e.methods||{},this.origin=e.origin||"*",e.source&&(this.source=e.source)}get source(){return this._source}set source(e){if(!e&&this._source)return this._source.removeEventListener("message",this.handle),void(this._source=void 0);e.addEventListener("message",this.handle),this._source=e}apply(e,t){if(!this.destination)throw new Error("No destination");const i=this._sequence++,r=new Promise((e,t)=>{this._registry[i]={resolve:e,reject:t}});return this.send(this.destination,{jsonrpc:"2.0",id:i,method:e,params:t}),r}call(e,...t){return this.apply(e,t)}handleRequest(e){return __awaiter(this,void 0,void 0,(function*(){const t={jsonrpc:"2.0",id:e.id},i=this.methods[e.method];if(!i)return Object.assign(t,{error:{code:Dr.MethodNotFound,message:"Method not found"}});try{const r=yield i.apply(void 0,ensureArray(e.params));return Object.assign(t,{result:r})}catch(Pt){return Object.assign(t,{error:{code:Pt.code||Dr.InternalError,message:Pt.message}})}}))}handleResponse(e){const t=this._registry[e.id];delete this._registry[e.id],t&&(e.error?t.reject(Object.assign(Error(),e.error)):t.resolve(e.result))}send(e,t){e.postMessage(t,e.window===e?this.origin:void 0)}}var Nr;function validateToken(e){var t;if("string"!=typeof e)return!1;const i=e.match(/[a-zA-Z0-9=\/+]{32,}==$/);return null!==(t=i&&i.length>0)&&void 0!==t&&t}!function(e){e[e.UNAVAILABLE=-1]="UNAVAILABLE",e[e.NOT_DETERMINED=0]="NOT_DETERMINED",e[e.DENIED=1]="DENIED",e[e.RESTRICTED=2]="RESTRICTED",e[e.AUTHORIZED=3]="AUTHORIZED"}(Nr||(Nr={}));const Lr=`https://${getCommerceHostname("buy")}/commerce/account/authenticateMusicKitRequest`,xr="https://authorize.music.apple.com",Ur=/^https?:\/\/(.+\.)*(apple\.com|apps\.mzstatic\.com)(\/[\w\d]+)*$/;var Fr,jr,Br,Kr;!function(e){e[e.AUTHORIZE=0]="AUTHORIZE",e[e.SUBSCRIBE=1]="SUBSCRIBE"}(Fr||(Fr={}));class ServiceSetupView{constructor(e,t={}){var i,r;if(this.developerToken=e,this.authenticateMethod="GET",this.target="apple-music-service-view",this.deeplinkParameters=t&&t.deeplinkParameters||{},this.iconURL=t&&t.iconURL,this.authenticateMethod=t&&t.authenticateMethod||"GET",this.isServiceView&&window.opener!==window){const e=null===(i=getSessionStorage())||void 0===i?void 0:i.getItem("ac"),t=null!=e?new URL(e).origin:void 0;t&&(this.dispatch=new Dispatch({destination:null!==(r=window.opener)&&void 0!==r?r:void 0,origin:t,source:window}))}}get isServiceView(){return/(authorize\.(.+\.)*apple\.com)/i.test(window.location.hostname)||window&&window.name===this.target||!1}focus(){this._window&&window.focus&&this._window.focus()}load(e={action:Fr.AUTHORIZE}){return __awaiter(this,void 0,void 0,(function*(){return e.action===Fr.SUBSCRIBE?this._subscribeAction(e.parameters):this._authorizeAction(e.parameters)}))}present(e="",t){const{height:i,left:r,top:s,width:n}=this._calculateClientDimensions(),a={height:650,menubar:"no",resizable:"no",scrollbars:"no",status:"no",toolbar:"no",width:650},o=Object.assign(Object.assign(Object.assign({},a),{left:n/2-a.width/2+r,top:i/2-a.height/2+s}),t),l=Object.keys(o).map(e=>`${e}=${o[e]}`).join(",");return/trident|msie/i.test(navigator.userAgent)?(this._window=window.open(window.location.href,this.target,l)||void 0,this._window.location.href=e):this._window=window.open(e,this.target,l)||void 0,/\bedge\b/i.test(navigator.userAgent)&&(this._window.opener=self),this.focus(),this._window}_startPollingForWindowClosed(e){this._window&&void 0===this._windowClosedInterval&&(this._windowClosedInterval=setInterval(()=>{var t;(null===(t=this._window)||void 0===t?void 0:t.closed)&&(this._stopPollingForWindowClosed(),e())},500))}_stopPollingForWindowClosed(){void 0!==this._windowClosedInterval&&(clearInterval(this._windowClosedInterval),this._windowClosedInterval=void 0)}_authorizeAction(e={}){var t;return __awaiter(this,void 0,void 0,(function*(){let i,r;const s=(null===(t=window.location)||void 0===t?void 0:t.href)||"";return"GET"===this.authenticateMethod?r=`${xr}/woa?${buildQueryParams(Object.assign(Object.assign({},this.deeplinkParameters),{a:btoa(this._thirdPartyInfo()),referrer:s}))}`:(i=this._buildFormElement(Lr),document.body.appendChild(i)),new Promise((t,s)=>{const n=this.present(r);this._startPollingForWindowClosed(()=>{s(Nr.NOT_DETERMINED)}),this.dispatch=new Dispatch({methods:{authorize(e,i,r){validateToken(e)?t({restricted:i&&"1"===i,userToken:e,cid:r}):s(Nr.NOT_DETERMINED)},close(){},decline(){s(Nr.DENIED)},switchUserId(){s(Nr.NOT_DETERMINED)},thirdPartyInfo:()=>this._thirdPartyInfo(this.developerToken,Object.assign(Object.assign({},this.deeplinkParameters),e)),unavailable(){s(Nr.UNAVAILABLE)}},origin:xr,source:window,destination:n}),i&&i.submit()})}))}_buildFormElement(e,t=this.target,i=this.developerToken){const r=document.createElement("form");r.setAttribute("method","post"),r.setAttribute("action",e),r.setAttribute("target",t),r.style.display="none";const s=document.createElement("input");s.setAttribute("name","jwtToken"),s.setAttribute("value",i),r.appendChild(s);const n=document.createElement("input");n.setAttribute("name","isWebPlayer"),n.setAttribute("value","true"),r.appendChild(n);const a=document.createElement("input");return a.setAttribute("name","LogoURL"),a.setAttribute("value",""),r.appendChild(a),r}_calculateClientDimensions(e=window){return{height:e.innerHeight?e.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:screen.height,left:e.screenLeft?e.screenLeft:screen.availLeft||screen.left,top:e.screenTop?e.screenTop:screen.availTop||screen.top,width:e.innerWidth?e.innerWidth:document.documentElement.clientWidth?document.documentElement.clientWidth:screen.width}}_subscribeAction(e={}){return __awaiter(this,void 0,void 0,(function*(){return Object.assign(e,this.deeplinkParameters),new Promise((t,i)=>{const r="https://authorize.music.apple.com/upsell?"+buildQueryParams(e);this.present(r),window.addEventListener("message",({data:e,origin:r,source:s})=>{const{closeWindow:n,launchClient:a}="string"==typeof e?JSON.parse(e):e;r&&!Ur.test(r)||(a?0===a.supported?i("Unable to subscribe on this platform."):t(a):i("Subscribe action error."))})})}))}_thirdPartyInfo(e=this.developerToken,t){var i;let r=this.iconURL;const s=window.location.host||document.referrer,n=[...[].slice.call(document.querySelectorAll('link[rel="apple-music-app-icon"]')),...[].slice.call(document.querySelectorAll('link[rel="apple-touch-icon-precomposed"]')),...[].slice.call(document.querySelectorAll('link[rel="apple-touch-icon"]'))];if(n&&n[0]&&n[0].href){const e=n.find(e=>!!e.sizes&&"120x120"===e.sizes.value);r=null!==(i=null==e?void 0:e.href)&&void 0!==i?i:n[0].href}return JSON.stringify({thirdPartyIconURL:r,thirdPartyName:s,thirdPartyParameters:t,thirdPartyToken:e})}}!function(e){e.ID="us",e.LANGUAGE_TAG="en-gb"}(jr||(jr={}));class Storefront{constructor(e,t,i){this.id=e,this.attributes=t,this.type="storefronts",this.href=i||`/v1/${this.type}/${e}`}static inferFromLanguages(e,t=getLanguages()){return __awaiter(this,void 0,void 0,(function*(){const i=yield function(e,t="https://api.music.apple.com/v1"){return __awaiter(this,void 0,void 0,(function*(){const i=new Headers({Authorization:"Bearer "+e}),r=yield fetch(t+"/storefronts",{headers:i}),s=yield r.json();return s.errors?Promise.reject(s.errors):s.data}))}(e),r=i.map(e=>e.id),s=t[0]||"en-US",[n,a]=s.toLowerCase().split(/-|_/),o=r.includes(a)?a:"us";return i.find(e=>e.id===o)}))}}!function(e){e.DEFAULT_CID="pldfltcid",e.TV_CID="pltvcid",e.RESTRICTIONS_ENABLED="itre",e.STOREFRONT_COUNTRY_CODE="itua",e.USER_TOKEN="media-user-token"}(Br||(Br={})),function(e){e.authorizationStatusDidChange="authorizationStatusDidChange",e.authorizationStatusWillChange="authorizationStatusWillChange",e.eligibleForSubscribeView="eligibleForSubscribeView",e.needsGDPRDidChange="needsGDPRDidChange",e.storefrontCountryCodeDidChange="storefrontCountryCodeDidChange",e.storefrontIdentifierDidChange="storefrontIdentifierDidChange",e.userTokenDidChange="userTokenDidChange"}(Kr||(Kr={})),Br.DEFAULT_CID;let $r=!1;$r=!0;const Vr="https://"+getCommerceHostname("buy"),Wr=`https://${getCommerceHostname("play")}/WebObjects/MZPlay.woa/wa`;class StoreKit extends Notifications{constructor(e,t){super([Kr.authorizationStatusDidChange,Kr.authorizationStatusWillChange,Kr.eligibleForSubscribeView,Kr.needsGDPRDidChange,Kr.storefrontCountryCodeDidChange,Kr.userTokenDidChange,Kr.storefrontIdentifierDidChange]),this.developerToken=e,this.apiBase="https://api.music.apple.com/v1",this.iTunesBuyBase=Vr,this.meParameters={},this.persist="localstorage",this.playBase=Wr,this.prefix="music",this.realm=0,this.storage=getLocalStorage(),this._authorizationStatus=Nr.NOT_DETERMINED,this._disableLogoutURL=!1,this._dispatchedSubscribeView=!1,this._me=null,this._cids={},this._gdprVersion=-1,this._needsGDPR=void 0,this._dynamicUserToken=getCookie(Br.USER_TOKEN),t&&(t.apiBase&&(this.apiBase=t.apiBase),t.deeplink&&(this.deeplinkParameters=t.deeplink),t.meParameters&&(this.meParameters=t.meParameters),t.persist&&(this.persist=t.persist),t.prefix&&(this.prefix=t.prefix),void 0!==t.realm&&(this.realm=t.realm),void 0!==t.disableLogoutURL&&(this._disableLogoutURL=t.disableLogoutURL),this.bundleId=Or[this.realm]),this.cidNamespace=Cr[this.realm],this._developerToken=new DeveloperToken(e),this._serviceSetupView=new ServiceSetupView(e,{authenticateMethod:t&&t.authenticateMethod,iconURL:t&&t.iconURL,deeplinkParameters:this.deeplinkParameters}),this.storagePrefix=`${this.prefix}.${this._developerToken.teamId}`.toLocaleLowerCase(),this.updateUserTokenFromStorage(),this.developerToken&&this.userTokenIsValid&&(this._restrictedEnabled=this.restrictedEnabled,this.shouldDisplayPrivacyLink(this.bundleId).catch(()=>{})),this._storefrontCountryCode=this.storefrontCountryCode,this.whenAuthCompleted=Promise.resolve(),isNodeEnvironment$1()||(this._processLocationHash(window.location.hash),"cookie"!==this.persist||(null==t?void 0:t.disableAuthBridge)||(this.authBridgeApp=new AuthBridgeApp,this.authBridgeApp.authClearedFromOtherFrame=this.revokeUserToken.bind(this),this.whenAuthCompleted=this.authBridgeApp.whenAuthCompleted.then(()=>{this.updateUserTokenFromStorage()})))}updateUserTokenFromStorage(){const e=this._getStorageItem(Br.USER_TOKEN);this.userToken=e||void 0}get authorizationStatus(){return this._authorizationStatus}set authorizationStatus(e){this._authorizationStatus!==e&&(this._getIsActiveSubscription.updateCache(void 0),this.dispatchEvent(Kr.authorizationStatusWillChange,{authorizationStatus:this._authorizationStatus,newAuthorizationStatus:e}),this._authorizationStatus=e,this.dispatchEvent(Kr.authorizationStatusDidChange,{authorizationStatus:e}))}get cid(){if(!this._cids[this.cidNamespace]){const e=this._getStorageItem(this.cidNamespace);this._cids[this.cidNamespace]=e||void 0}return this._cids[this.cidNamespace]}set cid(e){e?this._setStorageItem(this.cidNamespace,e):this._removeStorageItem(this.cidNamespace),this._cids[this.cidNamespace]=e}eligibleForSubscribeView(){return __awaiter(this,void 0,void 0,(function*(){const e=yield this.hasMusicSubscription();return(!this.hasAuthorized||this.hasAuthorized&&!e)&&!this._dispatchedSubscribeView}))}get hasAuthorized(){return this.authorizationStatus>Nr.DENIED}get logoutURL(){if(!this._disableLogoutURL)return this.iTunesBuyBase+"/account/web/logout"}get parentalControls(){return this._parentalControls}set parentalControls(e){this._parentalControls=e,e&&(0===this.realm?this.restrictedEnabled=e.musicParentalControlsEnabled:2===this.realm&&e.videoContentRestrictions&&(this.authorizationStatus=Nr.RESTRICTED))}get _pldfltcid(){return this._cids[Br.DEFAULT_CID]}set _pldfltcid(e){this._cids[Br.DEFAULT_CID]=e}get privacyAcknowledgements(){return this._privacyAcknowledgements}set privacyAcknowledgements(e){if(this._privacyAcknowledgements=e,!e)return this._gdprVersion=-1,void(this._needsGDPR=void 0);this.bundleId&&(this._gdprVersion=e[this.bundleId]||0,this._needsGDPR=this._gdprVersion<(Mr[this.bundleId]||0),this._needsGDPR&&this.dispatchEvent(Kr.needsGDPRDidChange,{GDPRVersion:this._gdprVersion,needsGDPR:this._needsGDPR}))}get restrictedEnabled(){if(this.userToken&&"boolean"!=typeof this._restrictedEnabled){const e=this._getStorageItem(Br.RESTRICTIONS_ENABLED);if(e)this._restrictedEnabled="0"!==e;else if(this._storefrontCountryCode){const e=["br","ch","gt","hu","id","in","it","kr","la","lt","my","ru","sg","tr"];this._restrictedEnabled=-1!==e.indexOf(this._storefrontCountryCode)||void 0}}return this._restrictedEnabled}set restrictedEnabled(e){this.userToken&&void 0!==e&&this._setStorageItem(Br.RESTRICTIONS_ENABLED,e?"1":"0"),this._restrictedEnabled=e,e&&(this.authorizationStatus=Nr.RESTRICTED)}get storefrontCountryCode(){if(!this._storefrontCountryCode){const e=this._getStorageItem(Br.STOREFRONT_COUNTRY_CODE);this._storefrontCountryCode=(null==e?void 0:e.toLowerCase())||jr.ID}return this._storefrontCountryCode}set storefrontCountryCode(e){e&&this.userToken?this._setStorageItem(Br.STOREFRONT_COUNTRY_CODE,e):this._removeStorageItem(Br.STOREFRONT_COUNTRY_CODE),e!==this._storefrontCountryCode&&(this._storefrontCountryCode=e,this.dispatchEvent(Kr.storefrontCountryCodeDidChange,{storefrontCountryCode:e}))}get storefrontIdentifier(){return this._storefrontIdentifier}set storefrontIdentifier(e){this._storefrontIdentifier=e,this.dispatchEvent(Kr.storefrontIdentifierDidChange,{storefrontIdentifier:e})}runTokenValidations(e,t=!0){e&&validateToken(e)?(t&&this._setStorageItem(Br.USER_TOKEN,e),this.authorizationStatus=this.restrictedEnabled?Nr.RESTRICTED:Nr.AUTHORIZED):(this._removeStorageItem(Br.USER_TOKEN),this.authorizationStatus=Nr.NOT_DETERMINED)}wrapDynamicUserTokenForChanges(e,t=invoke(e)){if("function"!=typeof e)return e;let i=t;return()=>{const t=invoke(e);return i!==t&&(i=t,this.runTokenValidations(t,!1),this.dispatchEvent(Kr.userTokenDidChange,{userToken:t})),t||""}}get dynamicUserToken(){return this._dynamicUserToken}set dynamicUserToken(e){const t=invoke(e);this._dynamicUserToken=this.wrapDynamicUserTokenForChanges(e,t),this.runTokenValidations(t,"function"!=typeof e),this.dispatchEvent(Kr.userTokenDidChange,{userToken:t})}get userToken(){return invoke(this.dynamicUserToken)}set userToken(e){this.dynamicUserToken=e}get userTokenIsValid(){return validateToken(this.userToken)}deeplinkURL(e={}){return"https://finance-app.itunes.apple.com/deeplink?"+buildQueryParams(e=Object.assign(Object.assign({},this.deeplinkParameters||{}),e))}itunesDeeplinkURL(e={p:"browse"}){return"https://itunes.apple.com/deeplink?"+buildQueryParams(e=Object.assign(Object.assign({},this.deeplinkParameters||{}),e))}pldfltcid(){return __awaiter(this,void 0,void 0,(function*(){if(!this._cids[Br.DEFAULT_CID])try{yield this.infoRefresh()}catch(e){return}return this._cids[Br.DEFAULT_CID]}))}renewUserToken(){return __awaiter(this,void 0,void 0,(function*(){if(!this.userToken)return this.requestUserToken();const e=new Headers({Authorization:"Bearer "+this.developerToken,Accept:"application/json","Content-Type":"application/json","X-Apple-Music-User-Token":""+this.userToken}),t=yield fetch(this.playBase+"/renewMusicToken",{method:"POST",headers:e});if(401===t.status)return yield this.revokeUserToken(),Promise.reject(new Error("Renew token"));const i=yield t.json();return i["music-token"]&&(this.userToken=i["music-token"]),this.userToken}))}requestStorefrontCountryCode(){return __awaiter(this,void 0,void 0,(function*(){if(this.authorizationStatus<=Nr.DENIED)return Promise.reject("Not authorized: "+this.authorizationStatus);const e=new Headers({Authorization:"Bearer "+this.developerToken,[br]:this.userToken||""}),t=yield fetch(this.apiBase+"/me/storefront",{headers:e});if(t&&!t.ok)return this._reset(),Promise.reject("Storefront Country Code error.");const i=yield t.json();if(i.errors)return Promise.reject(i.errors);const[r]=i.data;return r&&r.id?(this.storefrontCountryCode=r.id,this.storefrontCountryCode):Promise.reject("Storefront Country Code error.")}))}requestStorefrontIdentifier(){return __awaiter(this,void 0,void 0,(function*(){if(!this.storefrontIdentifier){const e=yield Storefront.inferFromLanguages(this.developerToken);this.storefrontIdentifier=e.id}return this.storefrontIdentifier}))}requestUserToken(){return __awaiter(this,void 0,void 0,(function*(){if(this._serviceSetupView.isServiceView)return this.userToken||"";try{const e=yield this._serviceSetupView.load({action:Fr.AUTHORIZE});this.cid=e.cid,this.userToken=e.userToken,this.restrictedEnabled=e.restricted}catch(e){return this._reset(),this.authorizationStatus=e,Promise.reject(e)}return this.userToken}))}revokeUserToken(){var e;return __awaiter(this,void 0,void 0,(function*(){try{yield this._webPlayerLogout()}catch(t){}null===(e=this.authBridgeApp)||void 0===e||e.clearAuth(),this.dispatchEvent(Kr.authorizationStatusWillChange,{authorizationStatus:this.authorizationStatus,newAuthorizationStatus:Nr.NOT_DETERMINED}),this._reset(),this.dispatchEvent(Kr.authorizationStatusDidChange,{authorizationStatus:this.authorizationStatus}),this.dispatchEvent(Kr.userTokenDidChange,{userToken:this.userToken})}))}setCids(e){this._cids=Object.assign(Object.assign({},this._cids),e),Object.keys(this._cids).forEach(e=>{this._setStorageItem(e,this._cids[e])})}shouldDisplayPrivacyLink(e){return __awaiter(this,void 0,void 0,(function*(){return void 0!==this._needsGDPR||(yield this.me()),this._needsGDPR}))}hasMusicSubscription(){return __awaiter(this,void 0,void 0,(function*(){return!!this.hasAuthorized&&this._getIsActiveSubscription()}))}_getIsActiveSubscription(){var e;return __awaiter(this,void 0,void 0,(function*(){const t=yield this.me();return!!(null===(e=t.subscription)||void 0===e?void 0:e.active)}))}resetSubscribeViewEligibility(){this._dispatchedSubscribeView=!1}presentSubscribeViewForEligibleUsers(e={},t=!0){return __awaiter(this,void 0,void 0,(function*(){const i=yield this.eligibleForSubscribeView();if(!this._serviceSetupView.isServiceView&&i){if(!t)return this.dispatchEvent(Kr.eligibleForSubscribeView,e),void(this._dispatchedSubscribeView=!0);try{const e=yield this._serviceSetupView.load({action:Fr.SUBSCRIBE});return this._dispatchedSubscribeView=!0,e}catch(r){return this.revokeUserToken()}}}))}infoRefresh(){return __awaiter(this,void 0,void 0,(function*(){if(this.authorizationStatus<=Nr.DENIED)return Promise.reject("Not authorized: "+this.authorizationStatus);const e=new Headers({Authorization:"Bearer "+this.developerToken,[br]:this.userToken||""});try{const t=yield fetch(this.iTunesBuyBase+"/account/web/infoRefresh",{credentials:"include",headers:e}),i=yield t.json();this.setCids(i)}catch(t){}}))}me(){return this.authorizationStatus<=Nr.DENIED?Promise.reject("Not authorized: "+this.authorizationStatus):(this._me||(this._me=new Promise((e,t)=>__awaiter(this,void 0,void 0,(function*(){const i=new Headers({Authorization:"Bearer "+this.developerToken,[br]:this.userToken||""}),r=addQueryParamsToURL(this.apiBase+"/me/account",Object.assign({meta:"subscription"},this.meParameters)),s=yield fetch(r,{headers:i});if(s&&!s.ok)return 2!==this.realm&&this._reset(),t("Account error.");let n=yield s.json();if(n.errors)return t(n.errors);const{data:a,meta:o}=n;if(!o||!o.subscription)return t("Account error.");this.storefrontCountryCode=o.subscription.storefront;const l={meta:o,subscription:o.subscription};a&&a.length&&(l.attributes=a[0].attributes);try{let t=yield fetch(this.iTunesBuyBase+"/account/web/info",{credentials:"include",headers:i});if(n=yield t.json(),this.parentalControls=n.parentalControlsData,this.privacyAcknowledgements=n.privacyAcknowledgement,function(e){if("object"!=typeof e)throw new TypeError("Source is not an Object");for(const t in e)if(hasOwn(e,t))return!1;return!0}(this.privacyAcknowledgements||{})){try{yield this.infoRefresh()}catch(d){e(l)}t=yield fetch(this.iTunesBuyBase+"/account/web/info",{credentials:"include",headers:i}),n=yield t.json(),this.parentalControls=n.parentalControlsData,this.privacyAcknowledgements=n.privacyAcknowledgement}l.info=n}catch(c){console.warn("Failed to fetch privacyAcknowledgements",c)}return e(l)}))).then(e=>{var t;return this._getIsActiveSubscription.updateCache((null===(t=e.subscription)||void 0===t?void 0:t.active)||!1),this._me=null,e}).catch(e=>(this._me=null,Promise.reject(e)))),this._me)}musicSubscriptionOffers(e,t=getLanguages()){return __awaiter(this,void 0,void 0,(function*(){let i;if(this.hasAuthorized){i=(yield this.me()).info.storeFrontISO3A}else{if(!e){const i=yield Storefront.inferFromLanguages(this.developerToken,t);e=null==i?void 0:i.id}i=e&&$e[e.toUpperCase()]||"USA"}const r=function(e="en-US"){const t=_r[e.toLowerCase()];if(t)return t;if(e.includes("-")){const t=e.split("-")[0],i=_r[t.toLowerCase()];if(i)return i}return _r["en-us"]}(t[0]),s=Ke[i];if(!r||!s)return[];const n=new Headers({"X-Apple-Store-Front":`${s}-${r},8`});this.userToken&&(n.set("Authorization","Bearer "+this.developerToken),n.set("Music-User-Token",this.userToken));const a=yield fetch(this.iTunesBuyBase+"/commerce/web/subscription/offers/music",{headers:n});if(!a.ok)return Promise.reject(a.status);return(yield a.json()).offers}))}_getStorageItem(e){var t;if(e)return"cookie"===this.persist?getCookie(e):"localstorage"===this.persist?null===(t=this.storage)||void 0===t?void 0:t.getItem(`${this.storagePrefix}.${e}`):void 0}_processLocationHash(e){const t=/^\#([a-zA-Z0-9+\/]{200,}={0,2})$/;if(t.test(e)){const r=e.replace(t,"$1");try{const{itre:e,musicUserToken:t,cid:i}=JSON.parse(atob(r));this.restrictedEnabled=e&&"1"===e,this.userToken=t,this.cid=i}catch(i){}history.replaceState(null,document.title," ")}}_removeStorageItem(e){var t;if("cookie"===this.persist)this._removeCookieFromDomains(e);else if("localstorage"===this.persist)return null===(t=this.storage)||void 0===t?void 0:t.removeItem(`${this.storagePrefix}.${e}`)}_removeCookieFromDomains(e,t=window){removeCookie(e);const{hostname:i}=t.location,r=i.split(".");if(r.length&&(r.shift(),r.length>2))for(let s=r.length;s>2;s--){const i=r.join(".");r.shift(),removeCookie(e,t,i)}}_reset(e=Nr.NOT_DETERMINED){this._authorizationStatus=e,this._cids={},this._dispatchedSubscribeView=!1,this._restrictedEnabled=void 0,this._storefrontCountryCode=void 0,this._getIsActiveSubscription.updateCache(void 0),Object.keys(Cr).forEach(e=>{this._removeStorageItem(Cr[e])}),this._removeStorageItem(Br.RESTRICTIONS_ENABLED),this._removeStorageItem(Br.USER_TOKEN),this._removeStorageItem(Br.STOREFRONT_COUNTRY_CODE),this._dynamicUserToken=void 0,this._me=null,this.privacyAcknowledgements=void 0}_setStorageItem(e,t){var i,r;return"cookie"===this.persist?(null===(i=this.authBridgeApp)||void 0===i||i.setCookieItem(e,t),setCookie(e,t,"/",180)):"localstorage"===this.persist?null===(r=this.storage)||void 0===r?void 0:r.setItem(`${this.storagePrefix}.${e}`,t):void 0}_webPlayerLogout(){return __awaiter(this,void 0,void 0,(function*(){const e=this.logoutURL;if(!e)return;const t=new Headers({Authorization:"Bearer "+this.developerToken,Accept:"application/json","Content-Type":"application/json",["X-Apple-"+br]:""+this.userToken});t.delete("X-Apple-"+br),t.append(br,this.userToken||"");const i=yield fetch(e,{method:"POST",headers:t,credentials:"include"});return i&&!i.ok?Promise.reject(i.status):i.json()}))}}__decorate([((e=300)=>(t,i,r)=>{if(void 0===r||"function"!=typeof r.value)throw new TypeError(`Only methods can be decorated with @CachedResult, but ${i} is not a method.`);return{configurable:!0,get(){const t=r.value,s=1e3*e;let n,a=-1;function cachedResultMethod(...e){return __awaiter(this,void 0,void 0,(function*(){const i=Date.now();return(void 0===n||-1===a||a>0&&i>a+s)&&(a=i,n=yield t.apply(this,e)),n}))}return cachedResultMethod.updateCache=function(e){a=Date.now(),n=e},cachedResultMethod.getCachedValue=()=>n,Object.defineProperty(this,i,{value:cachedResultMethod,configurable:!0,writable:!0}),cachedResultMethod}}})(900),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",Promise)],StoreKit.prototype,"_getIsActiveSubscription",null);const Hr={configured:"musickitconfigured",loaded:"musickitloaded",audioTrackAdded:Ye.audioTrackAdded,audioTrackChanged:Ye.audioTrackChanged,audioTrackRemoved:Ye.audioTrackRemoved,authorizationStatusDidChange:Kr.authorizationStatusDidChange,authorizationStatusWillChange:Kr.authorizationStatusWillChange,bufferedProgressDidChange:Ye.bufferedProgressDidChange,capabilitiesChanged:"capabilitiesChanged",autoplayEnabledDidChange:"autoplayEnabledDidChange",drmUnsupported:Ye.drmUnsupported,eligibleForSubscribeView:Kr.eligibleForSubscribeView,forcedTextTrackChanged:Ye.forcedTextTrackChanged,mediaCanPlay:Ye.mediaCanPlay,mediaElementCreated:Ye.mediaElementCreated,mediaItemStateDidChange:gt.mediaItemStateDidChange,mediaItemStateWillChange:gt.mediaItemStateWillChange,mediaPlaybackError:Ye.mediaPlaybackError,mediaSkipAvailable:"mediaSkipAvailable",mediaRollEntered:"mediaRollEntered",mediaUpNext:"mediaUpNext",metadataDidChange:Ye.metadataDidChange,needsGDPRDidChange:"needsGDPRDidChange",nowPlayingItemDidChange:Ye.nowPlayingItemDidChange,nowPlayingItemWillChange:Ye.nowPlayingItemWillChange,playbackBitrateDidChange:Ye.playbackBitrateDidChange,playbackDurationDidChange:Ye.playbackDurationDidChange,playbackProgressDidChange:Ye.playbackProgressDidChange,playbackRateDidChange:Ye.playbackRateDidChange,playbackStateDidChange:Ye.playbackStateDidChange,playbackStateWillChange:Ye.playbackStateWillChange,playbackTargetAvailableDidChange:Ye.playbackTargetAvailableDidChange,playbackTargetIsWirelessDidChange:Ye.playbackTargetIsWirelessDidChange,playbackTimeDidChange:Ye.playbackTimeDidChange,playbackVolumeDidChange:Ye.playbackVolumeDidChange,playerTypeDidChange:Ye.playerTypeDidChange,presentationModeDidChange:Ye.presentationModeDidChange,primaryPlayerDidChange:Ye.primaryPlayerDidChange,queueIsReady:"queueIsReady",queueItemsDidChange:"queueItemsDidChange",queueItemForStartPosition:"queueItemForStartPosition",queuePositionDidChange:"queuePositionDidChange",shuffleModeDidChange:"shuffleModeDidChange",repeatModeDidChange:"repeatModeDidChange",storefrontCountryCodeDidChange:Kr.storefrontCountryCodeDidChange,storefrontIdentifierDidChange:Kr.storefrontIdentifierDidChange,textTrackAdded:Ye.textTrackAdded,textTrackChanged:Ye.textTrackChanged,textTrackRemoved:Ye.textTrackRemoved,timedMetadataDidChange:Ye.timedMetadataDidChange,userTokenDidChange:Kr.userTokenDidChange,webComponentsLoaded:"musickitwebcomponentsloaded"},parseSkipItems=e=>{const t=parseInt(e.hlsMetadata["skip.count"],10),i=[];if(isNaN(t)||0===t)return i;for(let r=0;r<t;r++)i.push({start:parseFloat(e.hlsMetadata[`skip.${r}.start`]),duration:parseFloat(e.hlsMetadata[`skip.${r}.duration`]),target:parseFloat(e.hlsMetadata[`skip.${r}.target`]),label:e.hlsMetadata[`skip.${r}.label`]});return i},parseRollItems=(e,t=["pre-roll","mid-roll","post-roll"])=>{if(void 0===e.hlsMetadata)return[];const i=[];return t.forEach(t=>{const r=parseInt(e.hlsMetadata[t+".count"],10);if(!isNaN(r))for(let s=0;s<r;s++){const r=`${t}.${s}`;i.push({index:s,type:t,skippable:"true"===e.hlsMetadata[r+".skippable"],"adam-id":e.hlsMetadata[r+".adam-id"],start:Math.round(parseFloat(e.hlsMetadata[r+".start"])),duration:Math.round(parseFloat(e.hlsMetadata[r+".duration"]))})}}),i},addRollItemDuration=(e,t)=>e+t.duration;class SpanWatcher{constructor(e,t,i,r,s=!1){this.dispatcher=e,this.callback=t,this.start=i,this.stop=r,this.allowMultiple=s,this.inWatchSpan=!1}startMonitor(){this.dispatcher.unsubscribe(Hr.playbackTimeDidChange,this.handleTimeChange),this.dispatcher.subscribe(Hr.playbackTimeDidChange,this.handleTimeChange)}stopMonitor(){this.dispatcher.unsubscribe(Hr.playbackTimeDidChange,this.handleTimeChange)}handleTimeChange(e,{currentPlaybackTime:t}){return __awaiter$1(this,void 0,void 0,(function*(){!Number.isFinite(t)||t<this.start||t>this.stop?this.inWatchSpan=!1:this.inWatchSpan||(this.allowMultiple||this.stopMonitor(),this.inWatchSpan=!0,yield this.callback(t,this))}))}}__decorate$1([Bind(),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[Object,Object]),__metadata$1("design:returntype",Promise)],SpanWatcher.prototype,"handleTimeChange",null);class PlaybackMonitor{constructor(e){this.isActive=!1,this.isMonitoring=!1,this.watchers=[],this.handlePlaybackThreshold=this.handlePlaybackThreshold.bind(this),this.playbackController=e.controller,this.dispatcher=e.services.dispatcher,this.dispatcher.subscribe(Hr.nowPlayingItemDidChange,this.handleMediaItemChange),this.apiManager=e.services.apiManager}activate(){this.isActive=!0,this.startMonitor()}deactivate(){this.isActive=!1,this.clearMonitor()}clearMonitor(){this.isMonitoring&&(this.watchers.forEach(e=>e.stopMonitor()),this.isMonitoring=!1)}shouldMonitor(){return this.isActive}startMonitor(){this.shouldMonitor()&&(this.watchers.forEach(e=>e.startMonitor()),this.isMonitoring=!0)}handleMediaItemChange(){this.isActive&&(this.clearMonitor(),this.shouldMonitor()&&this.startMonitor())}}__decorate$1([Bind(),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[]),__metadata$1("design:returntype",void 0)],PlaybackMonitor.prototype,"handleMediaItemChange",null);class RollMonitor extends PlaybackMonitor{constructor(e){super(e),this.rollMap=new Map}handlePlaybackThreshold(e,t){return __awaiter$1(this,void 0,void 0,(function*(){if(!this.rollMap.has(t))return;const e=this.rollMap.get(t);this.dispatcher.publish(Hr.mediaRollEntered,e),this.rollMap.delete(t)}))}shouldMonitor(){if(!super.shouldMonitor())return!1;return this.getRollMetadata().length>0}startMonitor(){this.setupWatchers(this.getRollMetadata()),super.startMonitor()}getRollMetadata(){const e=this.playbackController.nowPlayingItem;return void 0===e?[]:parseRollItems(e,["pre-roll","post-roll"])}setupWatchers(e){const t=[];e.forEach(e=>{const{start:i,duration:r}=e,s=new SpanWatcher(this.dispatcher,this.handlePlaybackThreshold,i,i+r);t.push(s),this.rollMap.set(s,e)}),this.watchers=t}}class SkipAvailable extends PlaybackMonitor{constructor(e){super(e),this.skipMap=new Map}handlePlaybackThreshold(e,t){return __awaiter$1(this,void 0,void 0,(function*(){if(!this.skipMap.has(t))return;const e=this.skipMap.get(t);this.dispatcher.publish(Hr.mediaSkipAvailable,e),this.skipMap.delete(t)}))}shouldMonitor(){if(!super.shouldMonitor())return!1;return this.getNowPlayingMetadata().length>0}startMonitor(){this.setupWatchers(this.getNowPlayingMetadata()),super.startMonitor()}getNowPlayingMetadata(){const e=this.playbackController.nowPlayingItem;return void 0===e?[]:parseSkipItems(e)}setupWatchers(e){const t=[];e.forEach(e=>{const{start:i,duration:r}=e,s=new SpanWatcher(this.dispatcher,this.handlePlaybackThreshold,i,i+r);t.push(s),this.skipMap.set(s,e)}),this.watchers=t}}const zr=new Logger$1,hasContentCompletionThresholdData=e=>!isNaN(getUpNextStart(e))&&!isNaN(getWatchedTime(e)),getUpNextStart=e=>parseFloat(e.hlsMetadata["up-next.start"]),getWatchedTime=e=>parseFloat(e.hlsMetadata["watched.time"]),fetchHLSMetadata=(e,t)=>__awaiter$1(void 0,void 0,void 0,(function*(){if(e.isUTS&&e.assetURL)try{const i=generateAssetUrl(e.assetURL,{startOver:!!(null==t?void 0:t.startOver),supportsLinearScrubbing:e.supportsLinearScrubbing}),r=(yield fetch(i).then(e=>e.text())).match(/^(?:#EXT-X-SESSION-DATA:?)DATA\-ID="([^"]+)".+VALUE="([^"]+)".*$/gm);r&&r.forEach(t=>{const i=t.split(",")[0].split("com.apple.hls.")[1].replace(/"/g,""),r=t.split(",")[1].split("VALUE=")[1].replace(/"/g,"");e.hlsMetadata[i]=r})}catch(sl){zr.log(sl)}}));class UpNextMonitor extends PlaybackMonitor{constructor(e){super(e);const t=this.handlePlaybackThreshold;this.watchers=[{startMonitor:()=>{this.dispatcher.unsubscribe(He.mediaContentComplete,t),this.dispatcher.subscribe(He.mediaContentComplete,t)},stopMonitor:()=>{this.dispatcher.unsubscribe(He.mediaContentComplete,t)}}]}handlePlaybackThreshold(){var e,t,i,r,s,n;return __awaiter$1(this,void 0,void 0,(function*(){const a=this.playbackController.nowPlayingItem;let o;if(null===(e=null==a?void 0:a.attributes)||void 0===e?void 0:e.showId){try{o=yield null===(t=this.apiManager.utsAPI)||void 0===t?void 0:t.showEpisodeNextepisode({showId:null===(i=null==a?void 0:a.attributes)||void 0===i?void 0:i.showId,episodeId:null===(r=null==a?void 0:a.defaultPlayable)||void 0===r?void 0:r.canonicalId})}catch(c){}if(o&&this.isAppleOriginal(o))return void this.dispatcher.publish(Hr.mediaUpNext,{item:o,isNextEpisode:!0})}let l=yield null===(s=this.apiManager.utsAPI)||void 0===s?void 0:s.getPostPlayShelf(null==a?void 0:a.id);if((null==l?void 0:l.items)||(l=yield null===(n=this.apiManager.utsAPI)||void 0===n?void 0:n.watchlistContinueWatching()),!(null==l?void 0:l.items)||!Array.isArray(l.items))return;const d=l.items.find(e=>this.isAppleOriginal(e)&&"Show"!==e.type);d&&this.dispatcher.publish(Hr.mediaUpNext,{item:d})}))}shouldMonitor(){return!!super.shouldMonitor()&&(void 0!==this.playbackController.nowPlayingItem&&hasContentCompletionThresholdData(this.playbackController.nowPlayingItem))}isAppleOriginal(e){var t;return e.isAppleOriginal||(null===(t=e.content)||void 0===t?void 0:t.isAppleOriginal)}}const qr=getHlsJsCdnConfig(),Yr={app:{},autoplay:{maxQueueSizeForAutoplay:50,maxQueueSizeInRequest:10,maxUpcomingTracksToMaintain:10},features:{xtrick:!0,isWeb:!0,bookmarking:!1,"seamless-audio-transitions":!0,"enhanced-hls":!1},urls:{hls:qr.hls,rtc:qr.rtc,mediaApi:"https://amp-api.music.apple.com/v1",webPlayback:`https://${getCommerceHostname("play")}/WebObjects/MZPlay.woa/wa/webPlayback`}},Gr=createLocalStorageFlag("mk-offers-key-urls").json();let Qr;Gr&&(Yr.urls.hlsOffersKeyUrls=Gr);class Store{constructor(e,t={}){this._hasAuthorized=!1,this._providedRequestUserToken=!1,this._ageVerificationRequired=(e,t)=>!0,this._dispatcher=t.services.dispatcher,t.precache&&(this.precache=t.precache),t.storefrontId&&(this.storefrontId=t.storefrontId),this._defaultStorefrontCountryCode=t.storefrontCountryCode,(t.affiliateToken||t.campaignToken)&&(t.linkParameters=Object.assign(Object.assign({},t.linkParameters||{}),{at:t.affiliateToken,ct:t.campaignToken})),t.ageVerificationRequired&&(this._ageVerificationRequired=t.ageVerificationRequired),this.storekit=new StoreKit(e,{apiBase:Yr.urls.mediaApi,authenticateMethod:Yr.features["legacy-authenticate-method"]?"POST":"GET",deeplink:t.linkParameters,disableAuthBridge:t.disableAuthBridge,iconURL:Yr.app.icon,meParameters:t.meParameters,persist:t.persist,realm:t.realm||0,disableLogoutURL:t.disableLogoutURL}),this.storekit.addEventListener(Hr.authorizationStatusDidChange,e=>{const{authorizationStatus:t}=e;this._hasAuthorized=[Nr.AUTHORIZED,Nr.RESTRICTED].includes(t)})}get authorizationStatus(){return this.storekit.authorizationStatus}get cid(){return this.storekit.cid}get developerToken(){return this.storekit.developerToken}get hasAuthorized(){return this._hasAuthorized}get isAuthorized(){return this.storekit.hasAuthorized}get isRestricted(){return this.storekit.authorizationStatus===Nr.RESTRICTED}get metricsClientId(){return this._metricsClientId}set metricsClientId(e){this._metricsClientId=e}get musicUserToken(){return this.storekit.userToken}set musicUserToken(e){this.storekit.userToken=e}updateUserTokenFromStorage(){return this.storekit.updateUserTokenFromStorage()}set dynamicMusicUserToken(e){this.storekit.dynamicUserToken=e}get needsGDPR(){zr.error("needsGDPR has been deprecated. Plesae migrate to shouldDisplayPrivacyLink()")}get realm(){return this.storekit.realm}set requestUserToken(e){this._providedRequestUserToken=!0,this.storekit.requestUserToken=e}get restrictedEnabled(){return this.storekit.restrictedEnabled}get storefrontCountryCode(){var e;return this.isAuthorized?this.storekit.storefrontCountryCode:null!==(e=this._defaultStorefrontCountryCode)&&void 0!==e?e:this.storekit.storefrontCountryCode}get storefrontId(){return this._apiStorefrontId||this.storekit.storefrontCountryCode}set storefrontId(e){e&&(e=e.toLowerCase()),e!==this._apiStorefrontId&&(this._apiStorefrontId=e,this._dispatcher.publish(He.apiStorefrontChanged,{storefrontId:e}))}get subscribeURL(){return this.storekit.deeplinkURL({p:"subscribe"})}get subscribeFamilyURL(){return this.storekit.deeplinkURL({p:"subscribe-family"})}get subscribeIndividualURL(){return this.storekit.deeplinkURL({p:"subscribe-individual"})}get subscribeStudentURL(){return this.storekit.deeplinkURL({p:"subscribe-student"})}get userToken(){return this.musicUserToken}authorize(){return __awaiter$1(this,void 0,void 0,(function*(){if(this.storekit.userTokenIsValid)return this.storekit.userToken;let e;try{e=yield this.storekit.requestUserToken()}catch(Pt){try{yield this.unauthorize()}catch(t){}throw new MKError(MKError.AUTHORIZATION_ERROR,"Unauthorized")}return this._providedRequestUserToken&&(this.storekit.userToken=e),this.storekit.userTokenIsValid?(yield this.storekit.requestStorefrontCountryCode().catch(e=>__awaiter$1(this,void 0,void 0,(function*(){return yield this.unauthorize(),Promise.reject(e)}))),e):void 0}))}shouldDisplayPrivacyLink(e){return __awaiter$1(this,void 0,void 0,(function*(){return this.storekit.shouldDisplayPrivacyLink(e)}))}unauthorize(){return __awaiter$1(this,void 0,void 0,(function*(){return this.storekit.revokeUserToken()}))}validateAgeVerification(e){return __awaiter$1(this,void 0,void 0,(function*(){if(2!==this.storekit.realm)return;const t=yield this.storekit.me();if(t.info){if(t.info.webAgeVerificationData&&!t.info.webAgeVerificationData.isVerified&&this._ageVerificationRequired(e.type,e.rating)&&!e.isLinearStream)return Promise.reject(new MKError(MKError.AGE_VERIFICATION,"Age verification required"));if(e.rating&&t.info.parentalControlsData&&t.info.parentalControlsData.videoContentRestrictions){const i=e.rating.system.replace(/[^a-z0-9]+/i,"-");if(t.info.parentalControlsData.videoContentRestrictions[i]<e.rating.value)return Promise.reject(new MKError(MKError.CONTENT_RESTRICTED,"Content restricted"))}}}))}}const Xr=/\/([a-z]{2})\/(album|artist|episode|movie|music-video|playlist|podcast|post|season|show|song|station)\/(?:[^\/]*\/)?(?:id)?(\d+|[a-z]{2}\.[a-z0-9\-]+|umc.cmc.[a-zA-Z0-9]+)(?:.*(?:[\?|\&]i=(\d+)).*)?.*$/i;function formattedMediaURL(e){if(!Xr.test(e))throw new TypeError("Invalid Media URL: "+e);let[,t,i,r,s]=e.match(Xr);return"music-video"===i&&(i="musicVideo"),-1!==["album","playlist"].indexOf(i)&&s?(i="song",r=s):"podcast"===i&&s&&(i="episode",r=s),{storefrontId:t,kind:i,contentId:r,isUTS:!!r&&r.startsWith("umc.")}}function hasAuthorization(e){return void 0===e&&(e=Qr&&Qr.storekit),void 0!==e&&e.hasAuthorized&&e.userTokenIsValid}function hasMusicSubscription(e){return __awaiter$1(this,void 0,void 0,(function*(){return void 0===e&&(e=Qr&&Qr.storekit),e.hasMusicSubscription()}))}class MediaSessionManager{constructor(e,t){this.capabilities=e,this.dispatcher=t,this.session=navigator.mediaSession,this.session&&(this.dispatcher.subscribe(Hr.nowPlayingItemDidChange,this.onNowPlayingItemDidChange),this.dispatcher.subscribe(Hr.capabilitiesChanged,this.onCapabilitiesChanged),this._setMediaSessionHandlers())}onCapabilitiesChanged(){this._resetHandlers(),this._setMediaSessionHandlers()}onNowPlayingItemDidChange(e,{item:t}){this._setMediaSessionMetadata(t)}_setMediaSessionMetadata(e){var t,i;this.session&&"MediaMetadata"in window&&e&&(this.session.metadata=new window.MediaMetadata({title:e.title,artist:null!==(t=e.artistName)&&void 0!==t?t:null===(i=e.attributes)||void 0===i?void 0:i.showTitle,album:e.albumName,artwork:e.artwork?[96,128,192,256,384,512].map(t=>({src:formatArtworkURL(e.artwork,t,t),sizes:`${t}x${t}`,type:"image/jpeg"})):[]}))}_setMediaSessionHandlers(){this.session&&(this._resetHandlers(),this.session.setActionHandler("play",()=>{var e;return null===(e=this.controller)||void 0===e?void 0:e.play()}),this.capabilities.canPause?this.session.setActionHandler("pause",()=>{var e;return null===(e=this.controller)||void 0===e?void 0:e.pause()}):this.session.setActionHandler("pause",()=>{var e;return null===(e=this.controller)||void 0===e?void 0:e.stop()}),this.capabilities.canSeek&&(this.session.setActionHandler("seekforward",()=>{var e;return null===(e=this.controller)||void 0===e?void 0:e.seekForward()}),this.session.setActionHandler("seekbackward",()=>{var e;return null===(e=this.controller)||void 0===e?void 0:e.seekBackward()})),this.capabilities.canSkipToNextItem&&this.session.setActionHandler("nexttrack",()=>{var e;return null===(e=this.controller)||void 0===e?void 0:e.skipToNextItem()}),this.capabilities.canSkipToPreviousItem&&this.session.setActionHandler("previoustrack",()=>{var e;return null===(e=this.controller)||void 0===e?void 0:e.skipToPreviousItem()}))}_resetHandlers(){this.session&&(this.session.setActionHandler("play",void 0),this.session.setActionHandler("pause",void 0),this.session.setActionHandler("seekforward",void 0),this.session.setActionHandler("seekbackward",void 0),this.session.setActionHandler("nexttrack",void 0),this.session.setActionHandler("previoustrack",void 0))}}var Jr;__decorate$1([Bind(),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[]),__metadata$1("design:returntype",void 0)],MediaSessionManager.prototype,"onCapabilitiesChanged",null),__decorate$1([Bind(),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[Object,Object]),__metadata$1("design:returntype",void 0)],MediaSessionManager.prototype,"onNowPlayingItemDidChange",null),function(e){e[e.PAUSE=0]="PAUSE",e[e.EDIT_QUEUE=1]="EDIT_QUEUE",e[e.SEEK=2]="SEEK",e[e.REPEAT=3]="REPEAT",e[e.SHUFFLE=4]="SHUFFLE",e[e.SKIP_NEXT=5]="SKIP_NEXT",e[e.SKIP_PREVIOUS=6]="SKIP_PREVIOUS",e[e.SKIP_TO_ITEM=7]="SKIP_TO_ITEM"}(Jr||(Jr={}));class Capabilities{constructor(e){this._dispatcher=e,this._checkCapability=e=>!1,this._mediaSession=new MediaSessionManager(this,e)}set controller(e){this._mediaSession.controller=e}updateChecker(e){this._checkCapability!==e&&(this._checkCapability=e,this._dispatcher.publish(Hr.capabilitiesChanged))}get canEditPlaybackQueue(){return this._checkCapability(Jr.EDIT_QUEUE)}get canPause(){return this._checkCapability(Jr.PAUSE)}get canSeek(){return this._checkCapability(Jr.SEEK)}get canSetRepeatMode(){return this._checkCapability(Jr.REPEAT)}get canSetShuffleMode(){return this._checkCapability(Jr.SHUFFLE)}get canSkipToNextItem(){return this._checkCapability(Jr.SKIP_NEXT)}get canSkipToMediaItem(){return this._checkCapability(Jr.SKIP_TO_ITEM)}get canSkipToPreviousItem(){return this._checkCapability(Jr.SKIP_PREVIOUS)}}const Zr={condition:()=>!0,toOptions:(e,t,i)=>[Object.assign(Object.assign({},e),{context:i})]},es={condition:e=>{var t;return"stations"===e.type&&(null===(t=e.attributes)||void 0===t?void 0:t.isLive)},toOptions:(e,t,i)=>[Object.assign(Object.assign({},e),{context:i,container:{attributes:e.attributes,id:e.id,type:e.type,name:null==i?void 0:i.featureName}})]},hasRelationship=e=>t=>{var i,r;return!!(null===(r=null===(i=t.relationships)||void 0===i?void 0:i[e])||void 0===r?void 0:r.data)},typeIs=(...e)=>({type:t})=>e.includes(t),withBagPrefix=e=>{if(void 0===e||""===e)return;const{prefix:t}=Yr;return t?`${t}:${e}`:e},getContainerName=(e,t)=>{var i,r;return null!==(r=null!=t?t:null===(i=null==e?void 0:e.container)||void 0===i?void 0:i.name)&&void 0!==r?r:Ge.SONG},ts={toOptions:(e,t,i)=>{const r=Object.assign(Object.assign({id:e.id},t),{name:withBagPrefix(getContainerName(e,null==i?void 0:i.featureName))});return[{relationships:e.relationships,attributes:e.attributes,id:e.id,type:e.type,container:r,context:i}]},condition:typeIs("songs","library-songs","music-videos")},parseAssets=({type:e,attributes:{assetTokens:t}})=>e.includes("udio")?(e=>{if(void 0===e)return;const[t]=Object.keys(e);return e[t]})(t):(e=>{if(void 0===e)return;const t=Object.keys(e);return e[t[t.length-1]]})(t),is={condition:typeIs("uploaded-audios","uploadedAudio","uploaded-videos","uploadedVideo"),toOptions:(e,t,i)=>{var r,s;const n=Object.assign(Object.assign({},e),{context:i,attributes:Object.assign(Object.assign({},e.attributes),{assetUrl:parseAssets(e),playParams:null!==(s=null===(r=null==e?void 0:e.attributes)||void 0===r?void 0:r.playParams)&&void 0!==s?s:{id:e.id,kind:e.type}})});return void 0!==t&&(n.container=t),void 0!==(null==i?void 0:i.featureName)&&(n.container=Object.assign(Object.assign({},n.container),{name:null==i?void 0:i.featureName})),[n]}},rs={toOptions:(e,t,i)=>e.relationships.episodes.data.map(e=>Object.assign(Object.assign({},e),{context:i})),condition:hasRelationship("episodes"),requiredRelationships:["episodes"]};function formatRatingsContentType(e,t){return r(t)&&s(t)?e.replace(/^library-/,""):r(t)&&!/^library-/.test(e)?"library-"+e:e}function normalizeAdamId(e){return e.replace(/^a\./,"")}function makeRequest(e,t,i,r={}){return __awaiter(this,void 0,void 0,(function*(){let s,n=t;const a=i&&i.ids;r=Object.assign({},r);const{shouldCacheResults:o=!0,returnRawJSONApiRecords:l=!1,includePagination:d=e.defaultIncludePaginationMetadata,includeResponseMeta:c=!1}=r;delete r.shouldCacheResults,delete r.returnRawJSONApiRecords,delete r.includePagination,delete r.includeResponseMeta,"string"==typeof a&&(n=`${t}/${encodeURIComponent(a)}`,i&&delete i.ids);try{(d||c)&&(r.useRawResponse=!0),s=yield e.request(n,i,r)}catch(u){return"status"in u?404===u.status?Promise.reject(new MKError(MKError.CONTENT_UNAVAILABLE,"The requested content is not available.")):Promise.reject(MKError.responseError(u)):Promise.reject(MKError.internalError(u))}try{const t=s.results||s.data||s;if("object"==typeof s&&"results"in s&&"meta"in s&&(t.meta=s.meta),0===t.length)return Promise.reject(new MKError(MKError.CONTENT_UNAVAILABLE,"The requested content is not available."));const n=l?t:e.parseResultData(o,t);if(!d&&!c)return n;if("results"in s){for(const t in s.results)"meta"!==t&&(n[t]=paginateResultSet(s.results[t],n[t],e,i,r));return n}return paginateResultSet(s,n,e,i,r)}catch(Pt){return Promise.reject(MKError.parseError(Pt))}}))}function paginateResultSet(e,t,i,r,s={}){let n,a;s.includePagination=!0;const o=Object.assign({},s);return delete o.offset,e.next&&(n=()=>makeRequest(i,formatPaginatedUrl(i.url,e.next),r,o)),e.previous&&(a=()=>makeRequest(i,formatPaginatedUrl(i.url,e.previous),r,o)),{data:t,next:n,previous:a,meta:e.meta}}function mapRequestResult(e,t){return"data"in e?(e.data=t(e.data),e):t(e)}function formatPaginatedUrl(e,t){if("function"!=typeof URL)throw new Error("formatPaginatedUrl requires an implementation of URL");const{pathname:i}=new URL(e),r=new RegExp(`^${i}/`);return t.replace(r,"")}const getFeatureName=(e,t)=>{if(t)return t;const i=function(e=[]){return 0!==e.length&&e.filter(({attributes:e})=>!!e&&(e.workName||e.movementName||e.movementCount||e.movementNumber)).length>0}(e.relationships.tracks.data);return"albums"===e.type||"library-albums"===e.type?i?Ge.ALBUM_CLASSICAL:Ge.ALBUM:"playlists"===e.type||"library-playlists"===e.type?i?Ge.PLAYLIST_CLASSICAL:Ge.PLAYLIST:void 0},ss=[{toOptions:(e,t,i)=>{const r={attributes:e.attributes,id:e.id,type:e.type,name:withBagPrefix(getFeatureName(e,null==i?void 0:i.featureName))};return e.relationships.tracks.data.map(e=>({attributes:e.attributes,id:e.id,type:e.type,container:r,context:i}))},condition:hasRelationship("tracks"),requiredRelationships:["tracks"]},rs,ts,es,is],ns=ss.reduce((e,t)=>{const i=t.requiredRelationships;return i&&e.push(...i),e},[]),as=new Set(ns),isArrayOf=(e,t)=>Array.isArray(e)&&(0===e.length||t(e[0])),isMediaAPIResource=e=>e&&void 0!==e.id&&void 0!==e.type,isMediaItem=e=>e&&void 0!==e.id,isMPMediaItem=e=>e&&void 0!==e.contentId&&void 0!==e.metadata&&void 0!==e.metadata.itemId&&void 0!==e.metadata.itemType,isQueueItems=e=>e&&e.items&&Array.isArray(e.items),isQueueLoaded=e=>e&&e.loaded,isQueueURLOption=e=>e&&e.url,descriptorToMediaItems=e=>{if(!isQueueItems(e)&&!isQueueLoaded(e))return[];const t=isQueueLoaded(e)?loadedDescriptorToMediaItem(e):unloadedDescriptorToMediaItem(e);return t.forEach(t=>t.context=Object.assign(Object.assign({},e.context),t.context)),t},unloadedDescriptorToMediaItem=({items:e})=>isArrayOf(e,isMPMediaItem)?e.map(e=>new MediaItem(function(e){const t=transform$a({id:"metadata.itemId",type:"metadata.itemType","attributes.contentRating"(){var t;if(1===(null===(t=null==e?void 0:e.metadata)||void 0===t?void 0:t.isExplicit))return"explicit"},"attributes.playParams"(){var t,i,r;return 0!==(null===(t=null==e?void 0:e.metadata)||void 0===t?void 0:t.isPlayable)&&{id:null===(i=null==e?void 0:e.metadata)||void 0===i?void 0:i.itemId,kind:null===(r=null==e?void 0:e.metadata)||void 0===r?void 0:r.itemType}},"container.id":"metadata.containerId","container.name":"metadata.containerName","container.type":"metadata.containerType"},e);return Object.assign({attributes:{}},t)}(e))):isArrayOf(e,isMediaItem)?e.map(e=>new MediaItem(e)):[],loadedDescriptorToMediaItem=e=>{const t=[],{loaded:i,container:r,context:s}=e;return void 0===i?[]:isArrayOf(i,isDataRecord)?(i.forEach(e=>{t.push(...dataRecordToMediaItems(e,r,s))}),t):isArrayOf(i,isMediaAPIResource)?(i.forEach(e=>{t.push(...resourceToMediaItem(e,r,s))}),t):isDataRecord(i)?dataRecordToMediaItems(i,r,s):isMediaAPIResource(i)?resourceToMediaItem(i,r,s):[]},dataRecordToMediaItems=(e,t,i={})=>{const{data:r}=e.serialize(!0,void 0,{includeRelationships:as,allowFullDuplicateSerializations:!0});return resourceToMediaItem(r,t,i)},resourceToMediaItem=(e,t,i={})=>(E.debug("_resourceToMediaItem",e),((e,t,i={})=>{var r,s,n,a;t=null!==(n=null===(s=null===(r=t)||void 0===r?void 0:r.serialize)||void 0===s?void 0:s.call(r).data)&&void 0!==n?n:t;return(null!==(a=ss.find(r=>r.condition(e,t,i)))&&void 0!==a?a:Zr).toOptions(e,t,i).map(e=>new MediaItem(e))})(e,t,i));class BaseModifiableQueue{constructor(){this.canModifyQueue=!1}append(e){zr.warn("Append is not supported for this type of playback")}clear(){zr.warn("Clear is not supported for this type of playback")}insertAt(e,t){zr.warn("InsertAt is not supported for this type of playback")}prepend(e,t=!1){zr.warn("Prepend is not supported for this type of playback")}}class ModifiableQueue{constructor(e,t){this.canModifyQueue=!0,this.queue=e,this._mediaItemPlayback=t}append(e){const t=descriptorToMediaItems(e);this.queue.splice(this.queue.appendTargetIndex,0,t)}clear(){this.queue.length&&(this.queue.splice(0,this.queue.length),this.queue.reset())}insertAt(e,t){const i=descriptorToMediaItems(t);this.queue.splice(e,0,i)}prepend(e,t=!1){const i=descriptorToMediaItems(e),r=this.prependIndex();t&&this.queue.splice(r,this.queue.length),this.queue.splice(r,0,i)}prependIndex(){const{_mediaItemPlayback:e}=this,{position:t}=this.queue;return void 0===e.nowPlayingItem&&0===t||t<0?0:t+1}}var os;!function(e){e[e.none=0]="none",e[e.one=1]="one",e[e.all=2]="all"}(os||(os={}));class BaseRepeatable{constructor(){this.canSetRepeatMode=!1}get repeatMode(){return os.none}set repeatMode(e){e!==this.repeatMode&&zr.warn("setting repeatMode is not supported in this playback method")}}class Repeatable{constructor(e){this.dispatcher=e,this.canSetRepeatMode=!0,this._mode=os.none}get repeatMode(){return this._mode}set repeatMode(e){e in os&&e!==this._mode&&(this._mode=e,this.dispatcher.publish(Hr.repeatModeDidChange,this._mode))}}const ls=Object.assign(Object.assign({},{NEXT_ITEM:"NEXT"}),Xe),asyncNoop=()=>__awaiter$1(void 0,void 0,void 0,(function*(){}));class BaseSeekable{constructor(e){this.mediaItemPlayback=e,this.canSeek=!1}getSeekSeconds(e){return zr.warn("Seeking by predetermined amounts are not supported in this playback method"),{BACK:0,FORWARD:0}}seekBackward(e=asyncNoop){zr.warn("seekBackward is not supported in this playback method")}seekForward(e=asyncNoop){zr.warn("seekForward is not supported in this playback method")}seekToTime(e,t){return __awaiter$1(this,void 0,void 0,(function*(){zr.warn("seekToTime is not supported in this playback method")}))}}class Seekable{constructor(e,t){this._dispatcher=e,this.mediaItemPlayback=t,this.canSeek=!0}getSeekSeconds(e){return(e=>{switch(e.type){case"Bonus":case"Episode":case"Movie":case"Preview":case"Promotional":case"Season":case"Show":case"Vod":case"EditorialVideoClip":case"uploaded-videos":case"uploadedVideo":case"musicVideo":return{FORWARD:10,BACK:10};default:return{FORWARD:30,BACK:15}}})(e)}seekBackward(t=this._seekToBeginning){return __awaiter$1(this,void 0,void 0,(function*(){if(void 0===this.mediaItemPlayback.nowPlayingItem)return void zr.warn("Cannot seekBackward when nowPlayingItem is not yet set.");const i=this.mediaItemPlayback.currentPlaybackTime-this.getSeekSeconds(this.mediaItemPlayback.nowPlayingItem).BACK;i<0?yield t.call(this):yield this.seekToTime(i,e.SeekReasonType.Interval)}))}seekForward(t=this._seekToEnd){return __awaiter$1(this,void 0,void 0,(function*(){if(void 0===this.mediaItemPlayback.nowPlayingItem)return void zr.warn("Cannot seekForward when nowPlayingItem is not yet set.");const i=this.mediaItemPlayback.currentPlaybackTime+this.getSeekSeconds(this.mediaItemPlayback.nowPlayingItem).FORWARD;i>this.mediaItemPlayback.currentPlaybackDuration?yield t.call(this):yield this.seekToTime(i,e.SeekReasonType.Interval)}))}seekToTime(t,i=e.SeekReasonType.Manual){return __awaiter$1(this,void 0,void 0,(function*(){if(void 0===this.mediaItemPlayback.nowPlayingItem)return void zr.warn("Cannot seekToTime when nowPlayingItem is not yet set.");const e=this.mediaItemPlayback.nowPlayingItem,r=this.mediaItemPlayback.currentPlaybackTime,s=this.mediaItemPlayback.currentPlayingDate,n=Math.min(Math.max(0,t),this.mediaItemPlayback.currentPlaybackDuration-1);let a;if(e.isLinearStream&&void 0!==s){const e=1e3*(n-r);a=new Date(s.getTime()+e)}yield this.mediaItemPlayback.seekToTime(n,i),this._dispatcher.publish(He.playbackSeek,{startPosition:r,position:n,playingDate:a,startPlayingDate:s,seekReasonType:i})}))}_seekToBeginning(){return __awaiter$1(this,void 0,void 0,(function*(){yield this.seekToTime(0,e.SeekReasonType.Interval)}))}_seekToEnd(){return __awaiter$1(this,void 0,void 0,(function*(){yield this.seekToTime(this.mediaItemPlayback.currentPlaybackDuration,e.SeekReasonType.Interval)}))}}const shuffleCollection=e=>{const t=[...e],{length:i}=t;for(let r=0;r<i;++r){const e=r+Math.floor(Math.random()*(i-r)),s=t[e];t[e]=t[r],t[r]=s}return t};class QueueItem{constructor(e,t){var i;this.isAutoplay=!1,this.item=e,this.isAutoplay=null!==(i=null==t?void 0:t.isAutoplay)&&void 0!==i&&i}restrict(){return this.item.restrict()}}function toQueueItems(e,t){return e.map(e=>new QueueItem(e,t))}function toMediaItems(e){return e.map(e=>e.item)}const parseQueueURLOption=e=>{if(!isQueueURLOption(e))return e;const{url:t}=e,i=function(e,t){var i={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(i[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(r=Object.getOwnPropertySymbols(e);s<r.length;s++)t.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(e,r[s])&&(i[r[s]]=e[r[s]])}return i}(e,["url"]),{contentId:r,kind:s,storefrontId:n}=formattedMediaURL(t);return i[s]=r,Qr.storefrontId=n,E.debug("parseQueueURLOption",i),i},{queueItemsDidChange:ds,queuePositionDidChange:cs}=Hr;class Queue{constructor(e){if(this.hasAutoplayStation=!1,this._itemIDs=[],this._queueItems=[],this._isRestricted=!1,this._nextPlayableItemIndex=-1,this._position=-1,this._dispatcher=e.services.dispatcher,!e.descriptor)return;const t=descriptorToMediaItems(e.descriptor).filter(e=>this._isItemPlayable(e));this._queueItems=toQueueItems(t),this._reindex(),this.position=this._getStartItemPosition(e.descriptor.startWith)}get isEmpty(){return 0===this.length}set isRestricted(e){this._isRestricted=e,this._isRestricted&&this._queueItems&&this._queueItems.forEach(e=>{e.restrict()})}get isRestricted(){return this._isRestricted}get appendTargetIndex(){let e=this.length;const t=this._queueItems.findIndex(e=>e.isAutoplay);return-1!==t&&this.position<t&&(e=t),e}get items(){return toMediaItems(this._queueItems)}get autoplayItems(){return toMediaItems(this._queueItems.filter(e=>e.isAutoplay))}get unplayedAutoplayItems(){return toMediaItems(this._unplayedQueueItems.filter(e=>e.isAutoplay))}get userAddedItems(){return toMediaItems(this._queueItems.filter(e=>!e.isAutoplay))}get unplayedUserItems(){return toMediaItems(this._unplayedQueueItems.filter(e=>!e.isAutoplay))}get length(){return this._queueItems.length}get nextPlayableItem(){if(-1!==this.nextPlayableItemIndex)return this.item(this.nextPlayableItemIndex)}get nextPlayableItemIndex(){return this._nextPlayableItemIndex=this._getNextPlayableItemIndex(),this._nextPlayableItemIndex}get position(){return this._position}set position(e){this._updatePosition(e)}get previousPlayableItem(){if(void 0!==this.previousPlayableItemIndex)return this.item(this.previousPlayableItemIndex)}get previousPlayableItemIndex(){if(void 0===this._previousPlayableItemIndex){let e=this.position-1;for(;e>-1;){const t=this.item(e);if(this._isItemPlayable(t)){this._previousPlayableItemIndex=e;break}e--}}return this._previousPlayableItemIndex}removeQueueItems(e){for(let t=this.length-1;t>=0;t--)e(this.queueItem(t),t)&&this.spliceQueueItems(t,1)}indexForItem(e){return("string"==typeof e?this._itemIDs:this.items).indexOf(e)}item(e){var t;return null===(t=this.queueItem(e))||void 0===t?void 0:t.item}get currentItem(){return this.item(this.position)}queueItem(e){var t;return null===(t=this._queueItems)||void 0===t?void 0:t[e]}get currentQueueItem(){return this.queueItem(this.position)}remove(e){if(logDeprecation("remove",{message:"The queue remove function has been deprecated"}),e===this.position)throw new MKError(MKError.INVALID_ARGUMENTS);this.splice(e,1)}append(e=[]){return this.appendQueueItems(toQueueItems(e))}appendQueueItems(e=[]){return this.spliceQueueItems(this.appendTargetIndex,0,e)}splice(e,t,i=[]){return toMediaItems(this.spliceQueueItems(e,t,toQueueItems(i)))}spliceQueueItems(e,t,i=[],r=!0){i=i.filter(e=>this._isItemPlayable(null==e?void 0:e.item));const s=this._queueItems.splice(e,t,...i);return this._itemIDs.splice(e,t,...i.map(e=>e.item.id)),r&&(this._dispatcher.publish(He.queueModified,{start:e,added:toMediaItems(i),removed:toMediaItems(s)}),this._dispatcher.publish(ds,this.items)),s}reset(){const e=this.position;this._position=-1,this._dispatcher.publish(cs,{oldPosition:e,position:this.position})}_isSameItems(e){if(e.length!==this.length)return!1;const t=e.map(e=>e.id).sort(),i=[...this._itemIDs].sort();let r,s;try{r=JSON.stringify(t),s=JSON.stringify(i)}catch(n){return!1}return r===s}_reindex(){this._queueItems&&(this._itemIDs=this._queueItems.map(e=>e.item.id))}_updatePosition(e){if(e===this._position)return;const t=this._position;this._position=this._getNextPlayableItemIndex(e),this._previousPlayableItemIndex=void 0,this._dispatcher.publish(cs,{oldPosition:t,position:this._position})}_getNextPlayableItemIndex(e=this.position+1){var t;let i=e;for(;i<this.length;){const e=this.item(i);if(this._isItemPlayable(e))return i;i++}if((null===(t=this.repeatable)||void 0===t?void 0:t.repeatMode)===os.all)for(i=0;i<=e;){const e=this.item(i);if(this._isItemPlayable(e))return i;i++}return-1}get _unplayedQueueItems(){const e=this.position<0?0:this.position;return this._queueItems.slice(e)}_getStartItemPosition(e){if(void 0===e)return-1;if("object"==typeof e&&"id"in e&&(e=e.id),"string"==typeof e)return this.indexForItem(e);const t=parseInt(""+e,10);return t>=0&&t<this.length?t:-1}_isItemPlayable(e){return(null==e?void 0:e.isPlayable)||(null==e?void 0:e.previewURL)}}var us;!function(e){e[e.off=0]="off",e[e.songs=1]="songs"}(us||(us={}));const hs="Shuffling is not supported in this playback method.";class BaseShuffler{constructor(){this.canSetShuffleMode=!1}set shuffle(e){zr.warn(hs)}get shuffleMode(){return us.off}set shuffleMode(e){zr.warn(hs)}checkAndReshuffle(e){zr.warn(hs)}}class Shuffler{constructor(e,{dispatcher:t}){this.controller=e,this.canSetShuffleMode=!0,this.mode=us.off,this._unshuffledIDs=[],this._isSpliceFromShuffle=!1,this.dispatcher=t,this.dispatcher.subscribe(He.queueModified,this.queueModifiedHandler),this._queue=e.queue}get queue(){return this._queue}set queue(e){this._queue=e,this._unshuffledIDs=e.userAddedItems.map(e=>e.id),this.checkAndReshuffle(!1)}queueModifiedHandler(e,t){if(this._isSpliceFromShuffle)return void(this._isSpliceFromShuffle=!1);const{start:i,added:r,removed:s}=t;if(s.length>0){const e=s.map(e=>e.id);this._unshuffledIDs=this._unshuffledIDs.filter(t=>!e.includes(t))}r.length>0&&this._unshuffledIDs.splice(i,0,...r.map(e=>e.id))}set shuffle(e){this.shuffleMode=e?us.songs:us.off}get shuffleMode(){return this.mode}set shuffleMode(e){e!==this.shuffleMode&&e in us&&(zr.debug(`mk: set shuffleMode from ${this.shuffleMode} to ${e}`),this.mode=e,this.mode===us.songs?this.shuffleQueue():this.unshuffleQueue(),this.controller.nowPlayingItem&&(this._queue.position=this._queue.indexForItem(this.controller.nowPlayingItem.id)),this.dispatcher.publish(Hr.shuffleModeDidChange,this.shuffleMode))}checkAndReshuffle(e=!1){this.shuffleMode===us.songs&&this.shuffleQueue(e)}shuffleQueue(e=!0){const{userAddedItems:t}=this._queue;if(t.length<=1)return t;const i=t.slice(0),r=this._queue.position>-1?i.splice(this._queue.position,1):[];let s=[];do{s=shuffleCollection(i)}while(arrayEquals(s,i));const n=[...r,...s];this._isSpliceFromShuffle=!0,this._queue.spliceQueueItems(0,n.length,toQueueItems(n),e)}unshuffleQueue(e=!0){let t=[];const i=this._unshuffledIDs.reduce((e,t,i)=>(e[t]=i,e),{}),r=[];let s=0;const n=this._queue.item(this._queue.position);this._queue.userAddedItems.forEach(e=>{const a=i[e.id];void 0===a&&r.push(e),t[a]=e,e.id===(null==n?void 0:n.id)&&(s=a)}),t=t.filter(Boolean);const a=t.concat(r);this._isSpliceFromShuffle=!0,this._queue.spliceQueueItems(0,a.length,toQueueItems(a),e),this._queue.position=s}}var ps;__decorate$1([Bind(),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[String,Object]),__metadata$1("design:returntype",void 0)],Shuffler.prototype,"queueModifiedHandler",null),function(e){e.continuous="continuous",e.serial="serial"}(ps||(ps={}));const{queueItemsDidChange:ys}=Hr,ms=createLocalStorageFlag("mk-linear-scrubbing-enabled"),isLinearScrubbingEnabled$2=()=>ms.json();class PlaybackController{constructor(e){var t;this._context={},this.onPlaybackStateDidChange=this.onPlaybackStateDidChange.bind(this),this._autoplayEnabled=null!==(t=null==e?void 0:e.autoplayEnabled)&&void 0!==t&&t,this._services=e.services,this._playerOptions=e,this.storekit=e.storekit,this._skipIntro=new SkipAvailable({controller:this,services:e.services}),this._upNext=new UpNextMonitor({controller:this,services:e.services}),this._rollMonitor=new RollMonitor({controller:this,services:e.services}),this._queueModifier=new BaseModifiableQueue,this._shuffler=new BaseShuffler,this._seekable=new BaseSeekable(this._mediaItemPlayback),this._repeatable=new BaseRepeatable,this._dispatcher.subscribe(Hr.autoplayEnabledDidChange,this.updateAutoplay)}updateAutoplay(e,t){this.autoplayEnabled=t}constructContext(e,t){var i;let r=e.context;return void 0!==e.featureName&&void 0===(null==r?void 0:r.featureName)&&(zr.warn("featureName is deprecated, pass it inside context"),r||(r={}),r.featureName=e.featureName),null!==(i=null!=r?r:t)&&void 0!==i?i:{}}get context(){return this._context}get continuous(){return this._continuous||this.hasAuthorization}set continuous(e){this._continuous=e}get autoplayEnabled(){return this._autoplayEnabled}set autoplayEnabled(e){this._autoplayEnabled=e}get previewOnly(){return this._mediaItemPlayback.previewOnly}get currentBufferedProgress(){return this._mediaItemPlayback.currentBufferedProgress}set currentBufferedProgress(e){this._mediaItemPlayback.currentBufferedProgress=e}set currentPlaybackProgress(e){this._mediaItemPlayback.currentPlaybackProgress=e}get _dispatcher(){return this._services.dispatcher}get formattedCurrentPlaybackDuration(){return this._mediaItemPlayback.formattedCurrentPlaybackDuration}get hasAuthorization(){return hasAuthorization(this.storekit)}get isPlaying(){return this._mediaItemPlayback.isPlaying}get isPrimaryPlayer(){return this._mediaItemPlayback.isPrimaryPlayer}set isPrimaryPlayer(e){this._mediaItemPlayback.isPrimaryPlayer=e}get isReady(){return this._mediaItemPlayback.isReady}get _mediaItemPlayback(){return this._services.mediaItemPlayback}get nowPlayingItem(){return this._mediaItemPlayback.nowPlayingItem}get nowPlayingItemIndex(){return this.queue?this.queue.position:-1}get queue(){return this._queue}set queue(e){this._prepareQueue(e),this._queue=e,this._shuffler.queue=this._queue,this._queueModifier.queue=this._queue,this._dispatcher.publish(ys,e.items)}get repeatMode(){return this._repeatable.repeatMode}set repeatMode(e){this._repeatable.repeatMode=e}get seekSeconds(){const{nowPlayingItem:e}=this;if(void 0!==e)return this._seekable.getSeekSeconds(e)}set shuffle(e){this._shuffler.shuffle=e}get shuffleMode(){return this._shuffler.shuffleMode}set shuffleMode(e){this._shuffler.shuffleMode=e}get storekit(){return this._storekit}set storekit(e){e&&(e.addEventListener(Kr.authorizationStatusWillChange,({authorizationStatus:e,newAuthorizationStatus:t})=>__awaiter$1(this,void 0,void 0,(function*(){this.isPlaying&&(e>Nr.DENIED&&t<Nr.RESTRICTED?yield this.stop({endReasonType:Xe.PLAYBACK_SUSPENDED,userInitiated:!1}):yield this.stop({userInitiated:!1}))}))),this._storekit=e)}append(e){return __awaiter$1(this,void 0,void 0,(function*(){const t=yield this._dataForQueueOptions(e);return this._queueModifier.append(t),this.queue}))}insertAt(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const i=yield this._dataForQueueOptions(t);return this._queueModifier.insertAt(e,i),this.queue}))}_dataForQueueOptions(e){return __awaiter$1(this,void 0,void 0,(function*(){const t=this.constructContext(e,this.context);return Object.assign(Object.assign({},e),{context:t})}))}clear(){return __awaiter$1(this,void 0,void 0,(function*(){return this._queueModifier.clear(),this.queue}))}changeToMediaAtIndex(e=0){return __awaiter$1(this,void 0,void 0,(function*(){isLinearScrubbingEnabled$2()?yield this._changeToMediaAtIndexLinear(e):yield this._changeToMediaAtIndexNonLinear(e)}))}_changeToMediaAtIndexLinear(e=0){return __awaiter$1(this,void 0,void 0,(function*(){yield this.stop(),yield this._changeToMediaAtIndex(e,!0)}))}_changeToMediaAtIndexNonLinear(e=0){var t,i,r;return __awaiter$1(this,void 0,void 0,(function*(){yield this.stop();const s=null===(t=this.queue.item(e))||void 0===t?void 0:t.id,n=null===(r=null===(i=this._mediaItemPlayback)||void 0===i?void 0:i.playOptions)||void 0===r?void 0:r.get(s);let a=(null==n?void 0:n.startTime)||0;const o=yield this._changeToMediaAtIndex(e,!0);o&&(o.id!==s&&(a=0),this._dispatcher.publish(He.playbackPlay,{item:o,position:a}))}))}changeToMediaItem(e){return __awaiter$1(this,void 0,void 0,(function*(){const t=this.queue.indexForItem(e);return-1===t?Promise.reject(new MKError(MKError.MEDIA_DESCRIPTOR)):this.changeToMediaAtIndex(t)}))}activate(){zr.debug("mk: base controller - activate"),this._dispatcher.unsubscribe(Hr.playbackStateDidChange,this.onPlaybackStateDidChange),this._dispatcher.subscribe(Hr.playbackStateDidChange,this.onPlaybackStateDidChange),this._skipIntro.activate(),this._upNext.activate(),this._rollMonitor.activate()}deactivate(){return __awaiter$1(this,void 0,void 0,(function*(){yield this.stop(),this._dispatcher.unsubscribe(Hr.playbackStateDidChange,this.onPlaybackStateDidChange),this._skipIntro.deactivate(),this._upNext.deactivate(),this._rollMonitor.deactivate()}))}destroy(){return __awaiter$1(this,void 0,void 0,(function*(){yield this.deactivate(),this._dispatcher.unsubscribe(Hr.autoplayEnabledDidChange,this.updateAutoplay)}))}hasCapabilities(e){switch(e){case Jr.SEEK:return this._seekable.canSeek;case Jr.REPEAT:return this._repeatable.canSetRepeatMode;case Jr.SHUFFLE:return this._shuffler.canSetShuffleMode;case Jr.EDIT_QUEUE:return this._queueModifier.canModifyQueue;case Jr.PAUSE:case Jr.SKIP_NEXT:case Jr.SKIP_TO_ITEM:return!0;case Jr.SKIP_PREVIOUS:default:return!1}}pause(e){return __awaiter$1(this,void 0,void 0,(function*(){return this._mediaItemPlayback.pause(e)}))}play(){return __awaiter$1(this,void 0,void 0,(function*(){if(this.nowPlayingItem)return this._mediaItemPlayback.play();if(!this._queue||this._queue.isEmpty)return;if(this.nowPlayingItemIndex>=0)return this.changeToMediaAtIndex(this.nowPlayingItemIndex);const{queue:e}=this;if(-1!==e.nextPlayableItemIndex)return this.changeToMediaAtIndex(e.nextPlayableItemIndex);e.isRestricted&&e.items.every(e=>e.isRestricted)&&this._dispatcher.publish(Hr.mediaPlaybackError,new MKError(MKError.CONTENT_RESTRICTED,"Content restricted"))}))}playSingleMediaItem(e,t){return __awaiter$1(this,void 0,void 0,(function*(){isLinearScrubbingEnabled$2()?yield this._playSingleMediaItemLinear(e,t):yield this._playSingleMediaItemNonLinear(e,t)}))}_playSingleMediaItemLinear(e,t){return __awaiter$1(this,void 0,void 0,(function*(){yield fetchHLSMetadata(e,t),this._dispatcher.publish(Hr.queueItemsDidChange,[e]),yield this._mediaItemPlayback.startMediaItemPlayback(e,!0)}))}_playSingleMediaItemNonLinear(e,t){return __awaiter$1(this,void 0,void 0,(function*(){yield fetchHLSMetadata(e,t),this._dispatcher.publish(Hr.queueItemsDidChange,[e]);const i=yield this._mediaItemPlayback.startMediaItemPlayback(e,!0);i&&this._dispatcher.publish(He.playbackPlay,{item:i,position:0,userInitiated:!0})}))}onPlaybackStateDidChange(t,i){return __awaiter$1(this,void 0,void 0,(function*(){i.state===e.PlaybackStates.ended&&(this.continuous||this.repeatMode===os.one)&&(zr.debug("controller detected track ended event, moving to next item."),this._dispatcher.publish(He.applicationActivityIntent,{endReasonType:Xe.TRACK_SKIPPED_FORWARDS,userInitiated:!1}),yield this._next())}))}preload(){return __awaiter$1(this,void 0,void 0,(function*(){return this._mediaItemPlayback.preload()}))}prepend(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const i=yield this._dataForQueueOptions(e);return this._queueModifier.prepend(i,t),this.queue}))}prepareToPlay(e){return __awaiter$1(this,void 0,void 0,(function*(){return this._mediaItemPlayback.prepareToPlay(e)}))}showPlaybackTargetPicker(){this._mediaItemPlayback.showPlaybackTargetPicker()}seekBackward(){return __awaiter$1(this,void 0,void 0,(function*(){return this._seekable.seekBackward()}))}seekForward(){return __awaiter$1(this,void 0,void 0,(function*(){return this._seekable.seekForward(this.skipToNextItem.bind(this))}))}skipToNextItem(){return __awaiter$1(this,void 0,void 0,(function*(){return this._next(!0)}))}getNewSeeker(){return this._mediaItemPlayback.getNewSeeker()}seekToTime(e,t){return __awaiter$1(this,void 0,void 0,(function*(){yield this._seekable.seekToTime(e,t)}))}setQueue(e){return __awaiter$1(this,void 0,void 0,(function*(){return yield this.extractGlobalValues(e),yield this._mediaItemPlayback.stop(),this.returnQueueForOptions(e)}))}extractGlobalValues(e){return __awaiter$1(this,void 0,void 0,(function*(){this._context=this.constructContext(e),void 0!==e.featureName&&e.context&&(zr.warn("featureName is deprecated, pass it inside context"),e.context.featureName=e.featureName)}))}stop(e){return __awaiter$1(this,void 0,void 0,(function*(){yield this._mediaItemPlayback.stop(e)}))}_changeToMediaAtIndex(e=0,t=!1){return __awaiter$1(this,void 0,void 0,(function*(){if(this.queue.isEmpty)return;this.queue.position=e;const i=this.queue.item(this.queue.position);if(!i)return;const r=yield this._mediaItemPlayback.startMediaItemPlayback(i,t);if(r||i.state!==A.unsupported)return r;yield this.skipToNextItem()}))}_next(e=!1,t=!1){return __awaiter$1(this,void 0,void 0,(function*(){return this._nextAtIndex(this.queue.nextPlayableItemIndex,e,t)}))}_nextAtIndex(t,i=!1,r=!1){return __awaiter$1(this,void 0,void 0,(function*(){if(this.queue.isEmpty)return;const{_mediaItemPlayback:s}=this;if(t<0)return zr.debug("controller/index._next no next item available, stopping playback"),yield this.stop({userInitiated:i}),void(s.playbackState=e.PlaybackStates.completed);const n=this.isPlaying,a=s.currentPlaybackTime,o=yield this._changeToMediaAtIndex(t,i);return this._notifySkip(n,o,r,{userInitiated:i,position:a,direction:Xe.TRACK_SKIPPED_FORWARDS}),o}))}_notifySkip(e,t,i,r){const{userInitiated:s,direction:n,position:a}=r,o=this._dispatcher;i?(zr.debug("seamlessAudioTransition transition, PAF play"),o.publish(He.playbackPlay,{item:t,position:0,endReasonType:Xe.NATURAL_END_OF_TRACK})):e?t?o.publish(He.playbackSkip,{item:t,userInitiated:s,direction:n,position:a}):o.publish(He.playbackStop,{userInitiated:s,position:a}):t&&o.publish(He.playbackPlay,Object.assign({item:t,position:0},s?{endReasonType:Xe.MANUALLY_SELECTED_PLAYBACK_OF_A_DIFF_ITEM}:{}))}_prepareQueue(e){zr.debug("mk: _prepareQueue"),this.hasAuthorization&&(e.isRestricted=this.storekit.restrictedEnabled||!1),e.repeatable=this._repeatable}}__decorate$1([Bind(),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[String,Boolean]),__metadata$1("design:returntype",void 0)],PlaybackController.prototype,"updateAutoplay",null);function rejectOnLast(){return Promise.reject("The last middleware in the stack should not call next")}function processMiddleware(e,...t){return e.length?function createNextFunction([e,...t]){return(...i)=>e(createNextFunction(t),...i)}([...e,rejectOnLast])(...t):Promise.reject("processMiddleware requires at mimimum one middleware function")}function parameterizeString(e,t){return function(e){try{return function recursiveTokenizeParameterizedString(e,t=[]){if(e.startsWith("{{")){const i=e.indexOf("}}");if(-1===i)throw new Error("UNCLOSED_PARAMETER");const r={type:gs.Parameter,value:e.slice(2,i)};return i+2<e.length?recursiveTokenizeParameterizedString(e.slice(i+2),[...t,r]):[...t,r]}{const i=e.indexOf("{{");return-1===i?[...t,{type:gs.Static,value:e}]:recursiveTokenizeParameterizedString(e.slice(i),[...t,{type:gs.Static,value:e.slice(0,i)}])}}(e)}catch(Pt){if("UNCLOSED_PARAMETER"===Pt.message)throw new Error(`Unclosed parameter in path: "${e}"`);throw Pt}}(e).map(e=>{switch(e.type){case gs.Parameter:return e.value in t?encodeURIComponent(""+t[e.value]):`{{${e.value}}}`;case gs.Static:default:return e.value}}).join("")}var gs;function constructUrlMiddleware(e,t){let i=t.url;return i||(i=addPathToURL(t.baseUrl,t.path)),t.urlParameters&&(i=parameterizeString(i,t.urlParameters)),t.queryParameters&&(i=addQueryParamsToURL(i,t.queryParameters)),e(Object.assign(Object.assign({},t),{url:i}))}function unwrapJSONFromResponse(e){return __awaiter(this,void 0,void 0,(function*(){try{return yield e.json()}catch(Pt){return}}))}function fetchMiddlewareFactory(e){return function(t,i){return __awaiter(this,void 0,void 0,(function*(){const t=yield e(i.url,i.fetchOptions),r={request:i,response:t,data:yield unwrapJSONFromResponse(t)};if(!t.ok)throw MKError.responseError(t);return r}))}}!function(e){e[e.Static=0]="Static",e[e.Parameter=1]="Parameter"}(gs||(gs={}));const fs=fetchMiddlewareFactory("undefined"!=typeof fetch?fetch:()=>{throw new Error("window.fetch is not defined")});var vs;!function(e){e.Replace="REPLACE",e.Merge="MERGE"}(vs||(vs={}));const _s=["url"];class APISession{constructor(e){this.reconfigure(e)}get config(){return this._config}request(e,t={},i={}){var r;return processMiddleware(this.middlewareStack,Object.assign(Object.assign(Object.assign({},this.config.defaultOptions),i),{baseUrl:this.config.url,path:e,fetchOptions:mergeFetchOptions(null===(r=this.config.defaultOptions)||void 0===r?void 0:r.fetchOptions,i.fetchOptions),queryParameters:Object.assign(Object.assign({},this.config.defaultQueryParameters),t),urlParameters:Object.assign(Object.assign({},this.config.defaultUrlParameters),i.urlParameters)}))}reconfigure(e,t=vs.Replace){t===vs.Merge&&(e=deepmerge(this.config,e)),_s.forEach(t=>{if(void 0===e[t])throw new Error(`Session requires a valid SessionConfig, missing "${t}"`)}),this._config=e,this.middlewareStack=this.createMiddlewareStack()}createMiddlewareStack(){return Array.isArray(this.config.middleware)?[constructUrlMiddleware,...this.config.middleware,this.makeFetchMiddleware()]:[constructUrlMiddleware,this.makeFetchMiddleware()]}makeFetchMiddleware(){return"function"==typeof this.config.fetchFunction?fetchMiddlewareFactory(this.config.fetchFunction):fs}}const bs={music:{url:"https://api.music.apple.com"},apps:{url:"https://amp-api.apps.apple.com"},books:{url:"https://amp-api.books.apple.com"},fitness:{url:"https://amp-api.fitness.apple.com"}};bs.music={url:"https://amp-api.music.apple.com"},bs.videos={url:"https://amp-api.videos.apple.com"},bs.podcasts={url:"https://amp-api.podcasts.apple.com"};class MediaAPIV3{constructor(e){const{realmConfig:t}=e,i=__rest(e,["realmConfig"]);for(const r in bs){let e=deepmerge(bs[r],i);const s=null==t?void 0:t[r];s&&(e=deepmerge(e,s)),this.configure(r,e)}}configure(e,t,i=vs.Merge){var r;this.storefrontId=t.storefrontId;const s=function(e){let t={};e.url&&(t.url=e.url);e.storefrontId&&(t.defaultUrlParameters={storefrontId:e.storefrontId});e.mediaUserToken&&(t.defaultOptions={fetchOptions:{headers:{"Media-User-Token":e.mediaUserToken}}});e.developerToken&&(t=deepmerge(t,{defaultOptions:{fetchOptions:{headers:{Authorization:"Bearer "+e.developerToken}}}}));e.options&&(t=deepmerge(t,e.options));return t}(t);if(this[e])this[e].session.reconfigure(s,i);else{const t=new APISession(s),i=t.request.bind(t);i.session=t;const n="undefined"!=typeof process&&"test"===(null===(r=process.env)||void 0===r?void 0:r.NODE_ENV);Object.defineProperty(this,e,{value:i,writable:n,enumerable:!0})}}}class StationTrackLoader{constructor(e,t,{dispatcher:i,logger:r,apiManager:s},n={}){this.queue=e,this.station=t,this.context=n,this.isActive=!1,this.dispatcher=i,this.logger=r,this.apiManager=s}activate(){this.dispatcher.unsubscribe(Hr.queuePositionDidChange,this.checkLoadMore),this.dispatcher.subscribe(Hr.queuePositionDidChange,this.checkLoadMore),this.isActive=!0}deactivate(){this.dispatcher.unsubscribe(Hr.queuePositionDidChange,this.checkLoadMore),this.isActive=!1}start(){return this.isActive||this.activate(),this.loadNextTracks()}checkLoadMore(){if(!(this.queue.isEmpty||this.queue.nextPlayableItemIndex>=0))return this.loadNextTracks()}loadNextTracks(){var e,t,i;return __awaiter$1(this,void 0,void 0,(function*(){let r=[];const{apiManager:s}=this;if((null==s?void 0:s.api)instanceof MediaAPIV3){const t=yield s.api.music("v1/me/stations/next-tracks/"+this.station.id,void 0,{fetchOptions:{method:"POST"}});r=null===(e=null==t?void 0:t.data)||void 0===e?void 0:e.data}else{const e={};Yr.features["enhanced-hls"]&&(e.extend={songs:["extendedAssetUrls"]}),r=null!==(i=yield null===(t=s.mediaAPI)||void 0===t?void 0:t.nextStationTracks(this.station.id,null,{queryParameters:e}))&&void 0!==i?i:[]}if(0===r.length)throw this.logger.warn("No track data is available for the current station",{stationId:this.station.id}),new MKError(MKError.CONTENT_UNAVAILABLE,"No track data is available for the current station.");const n=descriptorToMediaItems({context:this.context,loaded:r,container:this.station});this.queue.splice(this.queue.length,0,n)}))}}var Ts;__decorate$1([Bind(),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[]),__metadata$1("design:returntype",void 0)],StationTrackLoader.prototype,"checkLoadMore",null),function(e){e.artist="artist",e.song="song",e.station="station",e.radioStation="radioStation"}(Ts||(Ts={}));const isIdentityQueue=e=>e&&void 0!==e.identity,{queueIsReady:Ss}=Hr;class ContinuousPlaybackController extends PlaybackController{constructor(e){super(e),this.type=ps.continuous,this._isLive=!1,this._continuous=!0}get continuous(){return!0}set continuous(e){if(!0!==e)throw new MKError(MKError.UNSUPPORTED_ERROR,"Continuous playback cannot be disabled for station queues.")}get context(){return Object.assign({featureName:Ge.STATION},this._context)}get isLive(){return this._isLive}set isLive(e){e!==this._isLive&&(this._isLive=e,this._dispatcher.publish(Hr.capabilitiesChanged))}changeToMediaItem(e){return __awaiter$1(this,void 0,void 0,(function*(){this.generateMethodNotAvailable("changeToMediaItem")}))}hasCapabilities(e){switch(e){case Jr.PAUSE:case Jr.SKIP_NEXT:return!this.isLive;case Jr.SKIP_PREVIOUS:case Jr.SKIP_TO_ITEM:return!1;default:return super.hasCapabilities(e)}}pause(e){const t=Object.create(null,{pause:{get:()=>super.pause}});return __awaiter$1(this,void 0,void 0,(function*(){if(!this.isLive)return t.pause.call(this,e);this.generateMethodNotAvailable("pause")}))}skipToPreviousItem(){return __awaiter$1(this,void 0,void 0,(function*(){this.generateMethodNotAvailable("skipToPreviousItem")}))}_dataForQueueOptions(e){const t=Object.create(null,{_dataForQueueOptions:{get:()=>super._dataForQueueOptions}});return __awaiter$1(this,void 0,void 0,(function*(){const i=yield t._dataForQueueOptions.call(this,e);return this.isLive&&(i.loaded=this.station),i}))}returnQueueForOptions(e){var t;return __awaiter$1(this,void 0,void 0,(function*(){const i=isIdentityQueue(e)?yield this.loadStationByIdentity(e.identity):yield this.loadStationByStationId(this.generateStationId(e));if(void 0===i)return Promise.reject(new MKError(MKError.UNSUPPORTED_ERROR,"Cannot load requested station"));this.station=i,this.isLive=isIdentityQueue(e)||!!(null==i?void 0:i.isLive)||!!(null===(t=null==i?void 0:i.attributes)||void 0===t?void 0:t.isLive);const r={services:{dispatcher:this._dispatcher},descriptor:yield this._dataForQueueOptions(e)};return this.queue=new Queue(r),this.isLive||(this.trackLoader=new StationTrackLoader(this.queue,i,{dispatcher:this._dispatcher,logger:zr,apiManager:this._services.apiManager},this.context),yield this.trackLoader.start()),this._seekable=this.isLive?new BaseSeekable(this._mediaItemPlayback):new Seekable(this._dispatcher,this._mediaItemPlayback),this._dispatcher.publish(Ss,this.queue.items),this.queue}))}getNewSeeker(){return this.hasCapabilities(Jr.SEEK)?super.getNewSeeker():new UnsupportedSeeker}skipToNextItem(){const e=Object.create(null,{skipToNextItem:{get:()=>super.skipToNextItem}});return __awaiter$1(this,void 0,void 0,(function*(){if(!this.isLive)return e.skipToNextItem.call(this);this.generateMethodNotAvailable("skipToNextItem")}))}generateMethodNotAvailable(e){zr.warn(e+" is not supported for this type of playback")}generateStationId(e){let t;if(isQueueURLOption(e)){const{contentId:i,kind:r,storefrontId:s}=formattedMediaURL(e.url);e[r]=i,Qr.storefrontId=s,t=r}const i=e;if(i.artist)return"ra."+i.artist;if(i.song)return"ra."+i.song;if(i.station)return i.station;if(i.radioStation)return i.radioStation;throw new MKError(MKError.UNSUPPORTED_ERROR,t?t+" is not a supported option. Use setQueue instead.":"Unsupported options specified for setStationQueue. You may want setQueue instead.")}loadStationByIdentity(e){var t,i,r;return __awaiter$1(this,void 0,void 0,(function*(){const{apiManager:s}=this._services;if((null==s?void 0:s.api)instanceof MediaAPIV3){const r=yield s.api.music("v1/catalog/{{storefrontId}}/stations",{filter:{identity:e}});return null===(i=null===(t=null==r?void 0:r.data)||void 0===t?void 0:t.data)||void 0===i?void 0:i[0]}const n=yield null===(r=null==s?void 0:s.mediaAPI)||void 0===r?void 0:r.stations(void 0,{filter:{identity:e}});return n&&n[0]}))}loadStationByStationId(e){var t,i,r;return __awaiter$1(this,void 0,void 0,(function*(){const{apiManager:s}=this._services;if((null==s?void 0:s.api)instanceof MediaAPIV3){const r=yield s.api.music("v1/catalog/{{storefrontId}}/stations/"+e);return null===(i=null===(t=null==r?void 0:r.data)||void 0===t?void 0:t.data)||void 0===i?void 0:i[0]}return null===(r=null==s?void 0:s.mediaAPI)||void 0===r?void 0:r.station(e)}))}activate(){super.activate(),this.trackLoader&&this.trackLoader.activate()}deactivate(){const e=Object.create(null,{deactivate:{get:()=>super.deactivate}});return __awaiter$1(this,void 0,void 0,(function*(){yield e.deactivate.call(this),this.trackLoader&&this.trackLoader.deactivate()}))}}__decorate$1([Bind(),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[Number]),__metadata$1("design:returntype",Boolean)],ContinuousPlaybackController.prototype,"hasCapabilities",null);class PercentageWatcher{constructor(e,t,i){this.dispatcher=e,this.callback=t,this.percentage=i,this.threshold=-1}startMonitor(){this.dispatcher.unsubscribe(Hr.playbackDurationDidChange,this.updateThreshold),this.dispatcher.unsubscribe(Hr.playbackTimeDidChange,this.handleTimeChange),this.dispatcher.subscribe(Hr.playbackDurationDidChange,this.updateThreshold),this.dispatcher.subscribe(Hr.playbackTimeDidChange,this.handleTimeChange)}stopMonitor(){this.dispatcher.unsubscribe(Hr.playbackDurationDidChange,this.updateThreshold),this.dispatcher.unsubscribe(Hr.playbackTimeDidChange,this.handleTimeChange),this.threshold=-1}handleTimeChange(e,{currentPlaybackDuration:t,currentPlaybackTime:i}){return __awaiter$1(this,void 0,void 0,(function*(){this.threshold<0&&this.updateThreshold(e,{duration:t}),i<this.threshold||(this.stopMonitor(),yield this.callback(i,this))}))}updateThreshold(e,{duration:t}){this.threshold=t*this.percentage}}__decorate$1([Bind(),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[Object,Object]),__metadata$1("design:returntype",Promise)],PercentageWatcher.prototype,"handleTimeChange",null),__decorate$1([Bind(),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[Object,Object]),__metadata$1("design:returntype",void 0)],PercentageWatcher.prototype,"updateThreshold",null);class Preloader extends PlaybackMonitor{constructor(e){super(e),this.isSeamlessAudioTransitionsEnabled=!1,this.watchers=[new PercentageWatcher(this.dispatcher,this.handlePlaybackThreshold,.3)],this.isSeamlessAudioTransitionsEnabled=Yr.features["seamless-audio-transitions"]}handlePlaybackThreshold(){return __awaiter$1(this,void 0,void 0,(function*(){const e=this.getNextPlayableItem();e&&(yield this.playbackController.prepareToPlay(e,!0))}))}shouldMonitor(){if(!super.shouldMonitor())return!1;if(!this.playbackController.hasAuthorization||this.playbackController.previewOnly)return!1;const e=this.getNextPlayableItem(),t=void 0!==e;return this.isSeamlessAudioTransitionsEnabled?t:t&&!(null==e?void 0:e.isPreparedToPlay)}getNextPlayableItem(){return this.playbackController.queue.nextPlayableItem}}function dasherize(e){return e.replace(/([A-Z])/g,"-$1").replace(/[-_\s]+/g,"-").toLowerCase()}const recursiveRelationshipLoad=(e,t,i)=>__awaiter$1(void 0,void 0,void 0,(function*(){const[r,s,n]=t,a=i.length;if(a>0&&a<n.limit+n.offset)return i;const o=Object.assign({},n);let l;o.offset=a;try{l=yield e(r,s,o)}catch(d){return i}return i.push(...l),l.length<o.limit?i:recursiveRelationshipLoad(e,t,i)})),getNamedQueueOptions=(e,t)=>{const i=[],r=e.namedQueueOptions;for(const s in t)Object.keys(r).includes(s)&&i.push([s,r[s]]);return i},loadSelectedQueueValue=(e,t,i,s)=>__awaiter$1(void 0,void 0,void 0,(function*(){const[n,a]=i,o=Array.isArray(s),l=o?""+s[0]:""+s,d=yield e.getAPIForItem(l);if(d instanceof MediaAPIV3){let e=dasherize(n);e.endsWith("s")||(e+="s");const t=(r(l)?"v1/me/library/":"v1/catalog/{{storefrontId}}/")+e+(o?"":"/{{id}}"),i={};o&&(i.ids=s);const a=yield d.music(t,i,{urlParameters:{id:s}});return o?a.data.data:a.data.data[0]}let c=t.parameters;Yr.features["enhanced-hls"]&&(c=Object.assign(Object.assign({},c),{extend:{songs:["extendedAssetUrls"]}}));let u=yield d[a.apiMethod](s,c);return a.loadedQueueTransform&&(u=a.loadedQueueTransform(u)),o||(yield function(e,t,i,r={}){return __awaiter$1(this,void 0,void 0,(function*(){if(void 0===t)return i;void 0===r.limit&&(r.limit=100),void 0===r.offset&&(r.offset=0);const{relationship:s,method:n}=t,a=e[n].bind(e);let o;return isDataRecord(i)?(void 0===i[s]&&i.setProperty(s,[],"relationships"),o=i[s]):(i.relationships=i.relationships||{},void 0===i.relationships[s]&&Object.defineProperty(i.relationships,s,{value:{data:[]},enumerable:!0}),o=i.relationships[s].data),yield recursiveRelationshipLoad(a,[i.id,s,r],o),i}))}(d,a.relationshipMethod,u)),u})),Es=["library-songs","songs"];class AutoplayTrackLoader{constructor(e,t,{dispatcher:i,logger:r,apiManager:s},n={}){this.queue=e,this.repeatable=t,this.context=n,this.isActive=!1,this.errorIds=new Set,this.dispatcher=i,this.logger=r,this.apiManager=s}activate(){this.isActive||(this.dispatcher.unsubscribe(Hr.queuePositionDidChange,this.onQueueChanged),this.dispatcher.subscribe(Hr.queuePositionDidChange,this.onQueueChanged),this.dispatcher.unsubscribe(Hr.repeatModeDidChange,this.onRepeatableChanged),this.dispatcher.subscribe(Hr.repeatModeDidChange,this.onRepeatableChanged),this.isActive=!0)}deactivate(){this.isActive&&(this.dispatcher.unsubscribe(Hr.queuePositionDidChange,this.onQueueChanged),this.dispatcher.unsubscribe(Hr.repeatModeDidChange,this.onRepeatableChanged),this.isActive=!1,this.station=void 0,this.queue.hasAutoplayStation=!1)}start(){if(!this.isActive)return this.activate(),this.loadNextTracks()}stop(){this.isActive&&(this.deactivate(),this.cleanupQueue())}onRepeatableChanged(){this.repeatable.repeatMode===os.none?this.checkLoadMore():this.cleanupQueue()}onQueueChanged(){if(!(this.queue.nextPlayableItemIndex>=0))return this.checkLoadMore()}get api(){var e;const t=this.apiManager.mediaAPI;return null!==(e=null==t?void 0:t.v3)&&void 0!==e?e:t}checkLoadMore(){var e;const t=null!==(e=this.queue.unplayedAutoplayItems.length)&&void 0!==e?e:0,i=Yr.autoplay.maxUpcomingTracksToMaintain;if(!(this.queue.isEmpty||this.queue.unplayedUserItems.length>Yr.autoplay.maxQueueSizeForAutoplay))return t<i?this.loadNextTracks(i-t):this.loadNextTracks()}cleanupQueue(){this.queue.removeQueueItems((e,t)=>!(t<=this.queue.position)&&!!e.isAutoplay)}loadNextTracks(e=Yr.autoplay.maxUpcomingTracksToMaintain){var t,i,r;return __awaiter$1(this,void 0,void 0,(function*(){if(this.repeatable.repeatMode!==os.none)return;let s,{station:n}=this;if(this.station){try{s=yield this.api.music("v1/me/stations/next-tracks/"+this.station.id,{limit:e},{fetchOptions:{method:"POST"}}),s=null===(t=null==s?void 0:s.data)||void 0===t?void 0:t.data}catch(o){return}if(!this.isActive)return}else{const t=yield this.startStation(e);if(!t||!this.isActive)return void(this.queue.hasAutoplayStation=!1);n=this.station=t.station,this.queue.hasAutoplayStation=!0,s=t.tracks,(null===(i=null==t?void 0:t.tracks)||void 0===i?void 0:i.length)||this.logger.warn("No track data is available for the current station",{stationId:null==n?void 0:n.id})}const a=descriptorToMediaItems({context:Object.assign(Object.assign({},this.context),{featureName:"now_playing",reco_id:(null===(r=this.context.featureName)||void 0===r?void 0:r.startsWith("listen-now"))?void 0:this.context.reco_id}),loaded:s,container:n});this.queue.appendQueueItems(toQueueItems(a,{isAutoplay:!0}))}))}startStation(e){var t,i;return __awaiter$1(this,void 0,void 0,(function*(){const{userAddedItems:s}=this.queue,n=null!==(t=s[s.length-2])&&void 0!==t?t:s[s.length-1],a=null==n?void 0:n.container,o=a?{container:{id:a.id,type:a.type}}:void 0,l=this.queue.items.slice(-1*Yr.autoplay.maxQueueSizeInRequest).reduce((e,{id:t,type:i})=>{const s=((e,t)=>(r(e)&&!(null!=t?t:"").startsWith("library-")?"library-":"")+normalizeContentType(t))(t,i);return(e=>Es.includes(e))(s)&&!this.errorIds.has(t)&&e.push({id:t,type:s,meta:o}),e},[]);if(0===l.length)return;const d={data:l};let c;try{c=yield this.api.music("v1/me/stations/continuous",{"limit[results:tracks]":e,with:["tracks"]},{fetchOptions:{method:"POST",body:JSON.stringify(d,void 0,2)}}),c=null===(i=null==c?void 0:c.data)||void 0===i?void 0:i.results}catch(u){l.forEach(e=>this.errorIds.add(e.id))}return c}))}}__decorate$1([Bind(),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[]),__metadata$1("design:returntype",void 0)],AutoplayTrackLoader.prototype,"onRepeatableChanged",null),__decorate$1([Bind(),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[]),__metadata$1("design:returntype",void 0)],AutoplayTrackLoader.prototype,"onQueueChanged",null),__decorate$1([(e,t,i)=>{const r=i.value,s="_singlePromise_"+t,n="undefined"!=typeof Symbol?Symbol(s):s;return i.value=function(...e){if(this[n])return this[n];const t=this[n]=r.apply(this,e),reset=()=>{this[n]=void 0};return t.then(reset,reset),t},i},__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[Number]),__metadata$1("design:returntype",Promise)],AutoplayTrackLoader.prototype,"loadNextTracks",null);const{queueIsReady:ks}=Hr;var Ps,Is;!function(e){e.album="album",e.musicVideo="musicVideo",e.playlist="playlist",e.song="song",e.episode="episode",e.podcast="podcast",e.uploadedAudio="uploadedAudio",e.uploadedVideo="uploadedVideo"}(Ps||(Ps={})),function(e){e.albums="albums",e.musicVideos="musicVideos",e.playlists="playlists",e.songs="songs",e.episodes="episodes",e.podcasts="podcasts",e.uploadedAudio="uploadedAudios",e.uploadedVideo="uploadedVideos"}(Is||(Is={}));class SerialPlaybackController extends PlaybackController{constructor(e){var t;super(e),this.type=ps.serial,this._queue=new Queue(e),this._repeatable=new Repeatable(this._dispatcher),this._seekable=new Seekable(this._dispatcher,this._mediaItemPlayback),this._shuffler=new Shuffler(this,{dispatcher:this._dispatcher}),this._queueModifier=new ModifiableQueue(this._queue,this._mediaItemPlayback),this._isSeamlessAudioTransitionsEnabled=!!(null===(t=null==e?void 0:e.bag)||void 0===t?void 0:t.features["seamless-audio-transitions"]);const i={controller:this,services:e.services};this._preloader=new Preloader(i)}get autoplayEnabled(){return this._autoplayEnabled}set autoplayEnabled(e){var t;this._autoplayEnabled=e;const i=e?"start":"stop";null===(t=this._autoplayTrackLoader)||void 0===t||t[i]()}activate(){super.activate(),this._preloader.activate(),this._dispatcher.subscribe(rr,this.onSeamlessAudioTransition)}deactivate(){const e=Object.create(null,{deactivate:{get:()=>super.deactivate}});return __awaiter$1(this,void 0,void 0,(function*(){yield e.deactivate.call(this),this._preloader.deactivate(),this._dispatcher.unsubscribe(rr,this.onSeamlessAudioTransition)}))}onSeamlessAudioTransition(e,t){zr.debug("controller handling seamless audio transition, PAF stop",t),this._dispatcher.publish(He.playbackStop,{endReasonType:Xe.NATURAL_END_OF_TRACK,position:t.previous.playbackDuration/1e3,isPlaying:!1}),asAsync(this._next(!1,!0))}hasCapabilities(e){var t,i,r;return e===Jr.SKIP_PREVIOUS||(e!==Jr.REPEAT&&e!==Jr.SHUFFLE||!(null===(i=null===(t=this.queue)||void 0===t?void 0:t.currentQueueItem)||void 0===i?void 0:i.isAutoplay))&&((e!==Jr.SEEK&&e!==Jr.PAUSE||!(null===(r=this.nowPlayingItem)||void 0===r?void 0:r.isAssetScrubbingDisabled))&&super.hasCapabilities(e))}prepareToPlay(e,t=!1){return __awaiter$1(this,void 0,void 0,(function*(){if(zr.debug("mk: SerialController - prepareToPlay - ",{item:e,preload:t}),e.isPlayable)return this._mediaItemPlayback.prepareToPlay(e).catch(e=>{const i=!t&&-1===[MKError.DEVICE_LIMIT,MKError.STREAM_UPSELL].indexOf(e.errorCode);if(this.continuous&&i)return this._dispatcher.publish(He.applicationActivityIntent,{endReasonType:Xe.TRACK_SKIPPED_FORWARDS,userInitiated:!1}),this._next();throw e})}))}prepend(e,t){const i=Object.create(null,{prepend:{get:()=>super.prepend}});return __awaiter$1(this,void 0,void 0,(function*(){const r=yield i.prepend.call(this,e,t);if(this.shouldTransitionSeamlessly){const e=this.queue,t=e.position,i=e.item(t+1);zr.debug("prepend preparing ",i.title),yield this._mediaItemPlayback.prepareToPlay(i)}return r}))}returnQueueForOptions(e){return __awaiter$1(this,void 0,void 0,(function*(){void 0!==(e=parseQueueURLOption(e)).startPosition&&(logDeprecation("startPosition",{message:"startPosition has been deprecated in favor of startWith"}),void 0===e.startWith&&(e.startWith=e.startPosition));const t=yield this._dataForQueueOptions(e),i={services:{dispatcher:this._dispatcher,mediaItemPlayback:this._mediaItemPlayback},descriptor:t};if(void 0!==e.shuffleMode&&(this.shuffleMode=e.shuffleMode),this.queue=new Queue(i),"number"==typeof e.startTime){const t=this.queue.nextPlayableItem;t&&this._mediaItemPlayback.playOptions.set(t.id,{startTime:e.startTime})}if(0===this.queue.length)throw zr.warn("No item data is available for the current media queue",e),new MKError(MKError.CONTENT_UNAVAILABLE,"No item data is available for the current media queue.");return this._autoplayTrackLoader&&this._autoplayTrackLoader.deactivate(),this._autoplayTrackLoader=new AutoplayTrackLoader(this.queue,this._repeatable,{dispatcher:this._dispatcher,logger:zr,apiManager:this._services.apiManager},this._context),this.autoplayEnabled&&this._autoplayTrackLoader.start(),this._dispatcher.publish(ks,this.queue.items),this.queue}))}skipToPreviousItem(){return __awaiter$1(this,void 0,void 0,(function*(){return this._previous(!0)}))}_dataForQueueOptions(e){const t=Object.create(null,{_dataForQueueOptions:{get:()=>super._dataForQueueOptions}});return __awaiter$1(this,void 0,void 0,(function*(){const i=e,r=((e,t)=>{const i=getNamedQueueOptions(e,t);if(i.length>1)throw new MKError(MKError.UNSUPPORTED_ERROR,"Queues with multiple media types are not supported.");if(0===i.length)return;const[r]=i,[s,n]=r;if(Array.isArray(t[s])!==n.isPlural)throw new MKError(MKError.UNSUPPORTED_ERROR,n.isPlural?`Queue option ${s} must be an array of id values`:`Queue option ${s} must be a single id value`);return r})(this._services.apiManager.apiService,e);return void 0===r||(i.loaded=yield((e,t,i)=>__awaiter$1(void 0,void 0,void 0,(function*(){const[r]=i,s=t[r];if(Array.isArray(s)){const r=new Map;s.forEach(e=>{const t=e.indexOf("."),i=-1===t?"":e.substring(0,t);r.has(i)||r.set(i,[]);const s=r.get(i);s&&s.push(e)});const n=(yield Promise.all([...r.values()].map(r=>loadSelectedQueueValue(e,t,i,r)))).reduce((e,t)=>{var i;return(t=null!==(i=t.data)&&void 0!==i?i:t).forEach(t=>{e.set(t.id,t)}),e},new Map),a=[];return s.forEach(e=>{const t=n.get(e);t&&a.push(t)}),a}return loadSelectedQueueValue(e,t,i,s)})))(this._services.apiManager.apiService,e,r)),Object.assign(Object.assign({},yield t._dataForQueueOptions.call(this,e)),i)}))}_changeToMediaAtIndex(e=0,t=!1){const i=Object.create(null,{_changeToMediaAtIndex:{get:()=>super._changeToMediaAtIndex}});return __awaiter$1(this,void 0,void 0,(function*(){const r=yield i._changeToMediaAtIndex.call(this,e,t),s=this.queue.nextPlayableItem;return s&&this.shouldTransitionSeamlessly&&(yield this.prepareToPlay(s)),r}))}_next(e=!1,t=!1){return __awaiter$1(this,void 0,void 0,(function*(){let i=this.queue.nextPlayableItemIndex;return this.repeatMode===os.one&&-1!==this.nowPlayingItemIndex&&(i=this.nowPlayingItemIndex),this._nextAtIndex(i,e,t)}))}_previous(e=!1){return __awaiter$1(this,void 0,void 0,(function*(){if(this.queue.isEmpty)return;const t=this.queue;if(-1===t.previousPlayableItemIndex)return;const i=this.isPlaying,r=this._mediaItemPlayback.currentPlaybackTime,s=yield this._changeToMediaAtIndex(t.previousPlayableItemIndex,e);return this._notifySkip(i,s,!1,{userInitiated:e,direction:Xe.TRACK_SKIPPED_BACKWARDS,position:r}),s}))}_prepareQueue(e){super._prepareQueue(e),this._shuffler.checkAndReshuffle()}get shouldTransitionSeamlessly(){return this._isSeamlessAudioTransitionsEnabled&&this.hasAuthorization&&!this.previewOnly}}__decorate$1([Bind(),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[Object,Object]),__metadata$1("design:returntype",void 0)],SerialPlaybackController.prototype,"onSeamlessAudioTransition",null),__decorate$1([Bind(),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[Number]),__metadata$1("design:returntype",Boolean)],SerialPlaybackController.prototype,"hasCapabilities",null);class MKDialog{constructor(e,t=""){this._message=e,this._explanation=t,this.id="musickit-dialog",this.scrimId=this.id+"-scrim",this.styleId=this.id+"-style",this._okButtonString="OK",[this.id,this.scrimId,this.styleId].forEach(e=>{try{const t=document.getElementById(e);t.parentElement.removeChild(t)}catch(t){}}),this._appendStyle("\n#musickit-dialog {\n  --mk-dialog-background: rgba(255, 255, 255, 1);\n  --mk-dialog-text: rgba(0, 0, 0, 0.95);\n  --mk-dialog-border: rgba(0, 0, 0, 0.07);\n  --mk-dialog-scrim: rgba(255, 255, 255, 0.8);\n  --mk-dialog-primary: rgba(0, 122, 255, 1);\n}\n\n@media (prefers-color-scheme: dark) {\n  #musickit-dialog {\n      --mk-dialog-background: rgba(30, 30, 30, 1);\n      --mk-dialog-text: rgba(255, 255, 255, 0.85);\n      --mk-dialog-border: rgba(255, 255, 255, 0.1);\n      --mk-dialog-scrim: rgba(38, 38, 38, 0.8);\n      --mk-dialog-primary: rgba(8, 132, 255, 1);\n  }\n}\n\n#musickit-dialog-scrim {\n  position: fixed;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  width: 100%;\n  height: 100%;\n  background: rgba(0, 0, 0, 0.35);\n}\n\n#musickit-dialog * {\n  -webkit-tap-highlight-color: transparent;\n  -webkit-touch-callout: none;\n  -ms-touch-action: none;\n  -webkit-user-select: none;\n  -moz-user-select: none;\n  -ms-user-select: none;\n  user-select: none;\n  font-family: -apple-system, SF UI Text, Helvetica Neue, Helvetica, sans-serif;\n  font-size: 15px;\n  line-height: 20px;\n}\n\n#musickit-dialog *:focus { outline: 0; }\n\n#musickit-dialog {\n  display: -webkit-box;\n  display: -moz-box;\n  display: -ms-flexbox;\n  display: -webkit-flex;\n  display: flex;\n  -webkit-flex-direction: column;\n  -moz-flex-direction: column;\n  flex-direction: column;\n  -webkit-justify-content: space-between;\n  -moz-justify-content: space-between;\n  justify-content: space-between;\n  min-width: 277px;\n  max-width: 290px;\n  min-height: 109px;\n  background: var(--mk-dialog-background);\n  box-shadow: 0px 0px 9px rgba(0, 0, 0, 0.18);\n  border-radius: 10px;\n  color: var(--mk-dialog-text);\n  position: fixed;\n  top: 50%;\n  left: 50%;\n  margin-left: -142px;\n  margin-top: -67px;\n  z-index: 9999999999999999999999999;\n}\n\n#musickit-dialog #mk-dialog-body {\n  display: -webkit-box;\n  display: -moz-box;\n  display: -ms-flexbox;\n  display: -webkit-flex;\n  display: flex;\n  -webkit-flex-direction: column;\n  -moz-flex-direction: column;\n  flex-direction: column;\n  flex-grow: 1;\n  -webkit-justify-content: space-evenly;\n  -moz-justify-content: space-evenly;\n  justify-content: space-evenly;\n  -webkit-align-items: stretch;\n  align-items: stretch;\n  padding: 10px 20px;\n  min-height: 74px;\n  text-align: center;\n}\n\n#musickit-dialog .mk-dialog h5 {\n  font-weight: 500;\n  line-height: 20px;\n  margin: 7px 0 0 0;\n  padding: 0;\n}\n\n#musickit-dialog .mk-dialog p {\n  margin: 0 0 7px 0;\n  padding: 0;\n  paddin-top: 3px;\n  line-height: 18px;\n  font-size: 13px;\n  font-weight: 300;\n}\n\n#musickit-dialog #mk-dialog-actions {\n  border-top: 1px solid var(--mk-dialog-border);\n  display: -webkit-box;\n  display: -moz-box;\n  display: -ms-flexbox;\n  display: -webkit-flex;\n  display: flex;\n  -webkit-flex-direction: row;\n  -moz-flex-direction: colrowumn;\n  flex-direction: row;\n  max-height: 41px;\n  min-height: 34px;\n  -webkit-justify-self: flex-end;\n  -moz-justify-self: flex-end;\n  justify-self: flex-end;\n}\n\n#musickit-dialog #mk-dialog-actions button {\n  flex-grow: 1;\n  border: 0;\n  background: none;\n  color: var(--mk-dialog-primary);\n  padding: 0;\n  margin: 0;\n  min-height: 34px;\n  height: 41px;\n  text-align: center;\n}\n\n#musickit-dialog #mk-dialog-actions *:nth-child(2) {\n  border-left: 1px solid var(--mk-dialog-border);\n  font-weight: 500;\n}\n")}static presentError(e){const t=e.dialog;void 0!==t?MKDialog.serverDialog(t).present():new MKDialog(e.message).present()}static serverDialog(e){const t=new this(e.message,e.explanation);return e.okButtonAction&&e.okButtonAction.url&&(t._okButtonActionURL=e.okButtonAction.url),e.okButtonString&&(t._okButtonString=e.okButtonString),e.cancelButtonString&&(t._cancelButtonString=e.cancelButtonString),t}static clientDialog(e){const t=new this(e.message,e.explanation);return e.okButtonAction&&(t._okButtonAction=e.okButtonAction),e.cancelButtonAction&&(t._cancelButtonAction=e.cancelButtonAction),e.okButtonString&&(t._okButtonString=e.okButtonString),e.cancelButtonString&&(t._cancelButtonString=e.cancelButtonString),t}get actions(){return this.cancelButton?`<div id="mk-dialog-actions">${this.cancelButton}${this.okButton}</div>`:`<div id="mk-dialog-actions">${this.okButton}</div>`}get cancelButton(){if("string"==typeof this._cancelButtonString)return`<button type="button">${this._cancelButtonString}</button>`}set cancelButton(e){this._cancelButtonString=e}get explanation(){return`<p id="mk-dialog-explanation">${this._explanation}</p>`}get hasOKButtonAction(){return!!this._okButtonActionURL||!!this._okButtonAction}get message(){return`<h5 id="mk-dialog-title">${this._message}</h5>`}get okButton(){return this.hasOKButtonAction&&this._okButtonActionURL?`<button type="button" data-ok-action-url='${this._okButtonActionURL}'>${this._okButtonString}</button>`:`<button type="button">${this._okButtonString}</button>`}present(){const e=document.createDocumentFragment(),t=document.createElement("div");t.id=this.scrimId,e.appendChild(t);const i=document.createElement("div");i.id=this.id,i.classList.add("mk-dialog"),i.setAttribute("role","alertDialog"),i.setAttribute("aria-modal","true"),i.setAttribute("aria-labeledby","mk-dialog-title"),i.setAttribute("aria-describedby","mk-dialog-explanation");let r=`\n      <div id="mk-dialog-body">\n        ${this.message}\n        ${this.explanation}\n      </div>`;r=`\n      ${r}\n      ${this.actions}\n    `,i.innerHTML=r,e.appendChild(i),document.body.appendChild(e),document.querySelector(`#${i.id} #mk-dialog-actions *:first-child`).focus(),setTimeout(()=>{document.querySelector(`#${i.id} #mk-dialog-actions *:first-child`).addEventListener("click",()=>{this._cancelButtonAction&&this._cancelButtonAction(),i.parentElement.removeChild(i),t.parentElement.removeChild(t)}),this.hasOKButtonAction&&(this._okButtonActionURL?document.querySelector(`#${i.id} #mk-dialog-actions *:last-child`).addEventListener("click",e=>{window.open(e.target.dataset.okActionUrl,"_blank"),i.parentElement.removeChild(i),t.parentElement.removeChild(t)}):this._okButtonAction&&document.querySelector(`#${i.id} #mk-dialog-actions *:last-child`).addEventListener("click",e=>{this._okButtonAction(),i.parentElement.removeChild(i),t.parentElement.removeChild(t)}))})}_appendStyle(e){const t=document.createElement("style");t.id=this.styleId,t.styleSheet?t.styleSheet.cssText=e:t.innerHTML=e,document.body.appendChild(t)}}var As;e.SupportedAPIs=void 0,(As=e.SupportedAPIs||(e.SupportedAPIs={})).UTS="uts-api",As.MEDIA="media-api";class APIServiceManager{constructor(e,t){this.store=e,this._dispatcher=t,this._apisByType={}}get api(){return this.getApiByType(this._defaultAPI)}get apiService(){if(void 0!==this._defaultAPI)return this._apisByType[this._defaultAPI];zr.error("There is no API instance configured")}get mediaAPI(){return this.getApiByType(e.SupportedAPIs.MEDIA)}get utsAPI(){return this.getApiByType(e.SupportedAPIs.UTS)}getApiByType(e){let t;if(void 0!==e&&(t=this._apisByType[e]),void 0===t||void 0===t.api)throw new MKError(MKError.CONFIGURATION_ERROR,"There is no API instance configured for the requested type: "+e);return t.api}set defaultApiType(e){this._defaultAPI=e}registerAPIService(e){return __awaiter$1(this,void 0,void 0,(function*(){const{apiType:t,configureFn:i,options:r}=e,s=r.apiOptions||{};void 0===this._defaultAPI&&(this._defaultAPI=t),this._apisByType[t]=yield i.call(this,{apiOptions:s,store:this.store,dispatcher:this._dispatcher})}))}}const ws={};function adaptAddEventListener(e,t,i,r={}){const{once:s}=r,n=function(e,t){const i=getCallbacksForName(e),wrappedCallback=(e,i)=>{t(i)};return i.push([t,wrappedCallback]),wrappedCallback}(t,i);!0===s?e.subscribeOnce(t,n):e.subscribe(t,n)}function getCallbacksForName(e){let t=ws[e];return t||(t=[],ws[e]=t),t}class RTCStreamingTracker{constructor(e){this.options=e}configure(e,t){return __awaiter$1(this,void 0,void 0,(function*(){return this.instance=e,this}))}loadScript(){return __awaiter$1(this,void 0,void 0,(function*(){if(!Yr.urls.rtc)throw new Error("bag.urls.rtc is not configured");yield loadScript(Yr.urls.rtc)}))}prepareReportingAgent(e){var t;this.clearReportingAgent();const i=e||this.instance.nowPlayingItem,r=i?i.defaultPlayable:void 0,{Sender:s,ClientName:n,ServiceName:a,ApplicationName:o,ReportingStoreBag:l,DeviceName:d}=window.rtc.RTCReportingAgentConfigKeys,c={firmwareVersion:this.generateBrowserVersion(),model:this.options.browserName};r?((null===(t=r.mediaMetrics)||void 0===t?void 0:t.MediaIdentifier)&&(c.MediaIdentifier=r.mediaMetrics.MediaIdentifier),r.channelId&&(c.ContentProvider=r.channelId)):"musicVideo"===(null==e?void 0:e.type)?c.MediaIdentifier="adamid="+e.id:(null==e?void 0:e.isLiveVideoStation)&&(c.MediaIdentifier="raid="+e.id),void 0===this._storeBag&&(this._storeBag=this.generateStoreBag());const u={[s]:"HLSJS",[n]:this.options.clientName,[a]:this.options.serviceName,[o]:this.options.applicationName,[l]:this._storeBag,[d]:this.options.osVersion,userInfoDict:c};return zr.debug("RTC: creating reporting agent with config",u),this.reportingAgent=new window.rtc.RTCReportingAgent(u),zr.debug("RTC: created reporting agent",this.reportingAgent),this.reportingAgent}shouldConfigure(e){return __awaiter$1(this,void 0,void 0,(function*(){return!0}))}shouldTrackPlayActivity(e,t){return!0}cleanup(){this.clearReportingAgent()}clearReportingAgent(){void 0!==this.reportingAgent&&(this.reportingAgent.destroy(),zr.debug("RTC: called destroy on reporting agent",this.reportingAgent),this.reportingAgent=void 0)}generateBrowserVersion(){return this.options.browserMajorVersion?`${this.options.browserMajorVersion}.${this.options.browserMinorVersion||0}`:"unknown"}generateStoreBag(){var e,t;const{storeBagURL:i,clientName:r,applicationName:s,serviceName:n,browserName:a}=this.options,o=`${`${Yr.app.name}-${Yr.app.build}`}/${null===(e=this.instance)||void 0===e?void 0:e.version}`,l={HLSJSVersion:null===(t=null===window||void 0===window?void 0:window.Hls)||void 0===t?void 0:t.version,iTunesAppVersion:o},d=new window.rtc.RTCStorebag.RTCReportingStoreBag(i,r,n,s,a,l);return zr.debug("RTC: created store bag",d),d}}const Rs=[He.playbackPause,He.playbackPlay,He.playbackScrub,He.playbackSeek,He.playbackSkip,He.playbackStop,He.playerActivate,He.playerExit,Hr.nowPlayingItemWillChange],Os={[He.playbackPause]:"pause",[He.playbackPlay]:"play",[He.playbackScrub]:"scrub",[He.playbackSeek]:"seek",[He.playbackSkip]:"skip",[He.playbackStop]:"stop",[He.playerActivate]:"activate",[He.playerExit]:"exit"};class PlayActivityService{constructor(e,t){this.isBuffering=!1,this.apis=e,this.dispatcher=t}cleanup(){this.currentItem=void 0,this.teardownWatchers(),this.apis.forEach(e=>e.cleanup())}configure(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const i=yield Promise.all(this.apis.map(t=>t.shouldConfigure(e))),r=this.apis.filter((e,t)=>i[t]);if(0===r.length)return;this.cleanup(),this.instance=e;const s=r.map(i=>i.configure(e,t));try{yield Promise.all(s)}catch(n){zr.error("Error configuring a play activity service",n)}finally{this.setupWatchers(),this.clearIntention()}}))}getTrackerByType(e){return this.apis.find(t=>t instanceof e)}handleEvent(e,t={}){const{item:i}=t;void 0!==i&&(this.currentItem=i),zr.debug(e,t);const r=Os[e];if(void 0===r)return;const s=this.addIntention(e,t);switch(delete s.item,e){case He.playbackPause:case He.playbackPlay:case He.playbackScrub:case He.playbackSeek:case He.playbackSkip:case He.playbackStop:return this.callApis(e,r,this.currentItem,s);case He.playerActivate:s.flush="boolean"==typeof t.isPlaying?!t.isPlaying:void 0;case He.playerExit:return this.callApis(e,r,s);case Hr.nowPlayingItemWillChange:this.currentItem=i}}addIntention(e,t){let i=Object.assign({},t);return this.shouldAddIntention(e)?(i=Object.assign(Object.assign(Object.assign({},this.lastUserIntent),this.lastApplicationIntent),i),this.clearIntention(),i):i}callApis(e,t,...i){return __awaiter$1(this,void 0,void 0,(function*(){const r=this.apis.map(r=>{if("function"==typeof r[t]&&r.shouldTrackPlayActivity(e,this.currentItem))return r[t](...i)});return Promise.all(r)}))}clearIntention(){this.lastUserIntent=void 0,this.lastApplicationIntent=void 0}onPlaybackStateChange(t,i){return __awaiter$1(this,void 0,void 0,(function*(){const{state:t}=i,r={position:this.instance.currentPlaybackTime,playingDate:void 0};return r.playingDate=this.instance.currentPlayingDate,t===e.PlaybackStates.waiting?(this.isBuffering=!0,this.callApis("bufferStart","bufferStart",this.currentItem,r)):t===e.PlaybackStates.playing&&this.isBuffering?(this.isBuffering=!1,this.callApis("bufferEnd","bufferEnd",this.currentItem,r)):void 0}))}recordApplicationIntent(e,t){this.lastApplicationIntent=t}recordUserIntent(e,t){this.lastUserIntent=t}shouldAddIntention(e){return[He.playbackPause,He.playbackStop].includes(e)}setupWatchers(){Rs.forEach(e=>{this.dispatcher.subscribe(e,this.handleEvent)}),this.dispatcher.subscribe(He.userActivityIntent,this.recordUserIntent),this.dispatcher.subscribe(He.applicationActivityIntent,this.recordApplicationIntent),this.dispatcher.subscribe(Hr.playbackStateDidChange,this.onPlaybackStateChange)}teardownWatchers(){Rs.forEach(e=>{this.dispatcher.unsubscribe(e,this.handleEvent)}),this.dispatcher.unsubscribe(He.userActivityIntent,this.recordUserIntent),this.dispatcher.unsubscribe(He.applicationActivityIntent,this.recordApplicationIntent),this.dispatcher.unsubscribe(Hr.playbackStateDidChange,this.onPlaybackStateChange)}}__decorate$1([Bind(),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[String,Object]),__metadata$1("design:returntype",void 0)],PlayActivityService.prototype,"handleEvent",null),__decorate$1([Bind(),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[Object,Object]),__metadata$1("design:returntype",Promise)],PlayActivityService.prototype,"onPlaybackStateChange",null),__decorate$1([Bind(),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[Object,Object]),__metadata$1("design:returntype",void 0)],PlayActivityService.prototype,"recordApplicationIntent",null),__decorate$1([Bind(),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[Object,Object]),__metadata$1("design:returntype",void 0)],PlayActivityService.prototype,"recordUserIntent",null);const Cs=createLocalStorageFlag("mk-force-safari-hlsjs");function requiresHlsJs(e){return __awaiter$1(this,void 0,void 0,(function*(){const t=null!=e?e:yield findKeySystemPreference(),i=!("true"!==Cs.get()||0===Qr.realm);return supportsDrm()&&(t!==Ie.FAIRPLAY||i)}))}const loadLiveRadioAssets=(e,t,i)=>__awaiter$1(void 0,void 0,void 0,(function*(){var r,s;const n=new Headers({Authorization:"Bearer "+t,Accept:"application/json","Content-Type":"application/json","X-Apple-Music-User-Token":""+i}),a=urlEncodeParameters(Object.assign(Object.assign({},e.playParams),{keyFormat:"web"})),o=`${Yr.urls.mediaApi}/play/assets?${a}`,l=yield fetch(o,{method:"GET",headers:n});if(500===l.status){const t=new MKError(MKError.SERVER_ERROR);throw t.data=e,t}if(403===l.status){let t;try{t=yield l.json(),t=null===(r=null==t?void 0:t.errors)||void 0===r?void 0:r[0]}catch(c){}const i="40303"===(null==t?void 0:t.code)?MKError.SUBSCRIPTION_ERROR:MKError.ACCESS_DENIED,n=new MKError(i,null!==(s=null==t?void 0:t.title)&&void 0!==s?s:null==t?void 0:t.detail);throw n.data=e,n}if(!l.ok){const t=new MKError(MKError.CONTENT_UNAVAILABLE);throw t.data=e,t}const d=(yield l.json()).results;return zr.debug(`media-item: loaded data from ${o}: ${JSON.stringify(d)}`),d})),prepareOffersHlsUrlForEncryptedPlayback=e=>__awaiter$1(void 0,void 0,void 0,(function*(){const t=Yr.urls.hlsOffersKeyUrls;if(!t)throw new MKError(MKError.CONTENT_UNSUPPORTED,"HLS OFFERS");e.updateWithLoadedKeys(t),yield fetchMasterManifestUrl(e,e.offersHlsUrl)})),prepareLiveRadioForEncryptedPlayback=(e,t,i)=>__awaiter$1(void 0,void 0,void 0,(function*(){if(!Yr.features["playready-live-radio"]&&Le===Ie.PLAYREADY&&"video"!==e.attributes.mediaKind&&!Yr.features["mse-live-radio"])throw new MKError(MKError.CONTENT_UNSUPPORTED,"LIVE_RADIO");const r=(yield loadLiveRadioAssets(e,t,i)).assets[0];e.updateWithLoadedKeys({"hls-key-cert-url":r.fairPlayKeyCertificateUrl,"hls-key-server-url":r.keyServerUrl,"widevine-cert-url":r.widevineKeyCertificateUrl}),filterUnavailableLiveRadioUrls(r,e),e.isLiveVideoStation?e.assetURL=r.url:yield fetchMasterManifestUrl(e,r.url)})),fetchMasterManifestUrl=(e,t)=>__awaiter$1(void 0,void 0,void 0,(function*(){let i;try{i=yield fetch(t)}catch(s){throw makeContentUnavailableError(e)}const r=yield i.text();extractAssetsFromMasterManifest(r,t,e)})),extractAssetsFromMasterManifest=(e,t,i)=>{const r=/^#EXT-X-STREAM-INF:.*BANDWIDTH=(\d+),CODECS="(.*)"\s*\n(.*$)/gim;let s;for(;s=r.exec(e);){let[e,r,n,a]=s;/^http(s)?:\/\//.test(a)||(a=rewriteLastUrlPath(t,a)),i.assets.push({bandwidth:Number(r),codec:n,URL:a})}},filterUnavailableLiveRadioUrls=(e,t)=>{const i=new URL(e.url);if(!i.host.endsWith(".apple.com")&&!i.host.endsWith(".applemusic.com"))throw makeContentUnavailableError(t)},makeContentUnavailableError=e=>{const t=new MKError(MKError.CONTENT_UNAVAILABLE);return t.data=e,t},prepareItemWithMZPlay=(e,t,i)=>__awaiter$1(void 0,void 0,void 0,(function*(){if(zr.debug("mk: loadWithMZPlay",e.playParams),"podcast-episodes"===e.type)return void(e.assetURL=e.attributes.assetUrl);if(!(yield hasMusicSubscription()))return;const s=e.playParams.id,n=new Headers({Authorization:"Bearer "+t,Accept:"application/json","Content-Type":"application/json","X-Apple-Music-User-Token":""+i});let a={salableAdamId:s};if(e.isCloudItem){a={},e.playParams.purchasedId&&(a.purchaseAdamId=e.playParams.purchasedId),e.playParams.catalogId&&(a.subscriptionAdamId=e.playParams.catalogId);const t=/^a\.(\d+)$/;t.test(s)?a.subscriptionAdamId=s.replace(t,"$1"):r(s)&&(a.universalLibraryId=s)}if(!Yr.urls.webPlayback)throw new Error("bag.urls.webPlayback is not configured");const o=yield fetch(Yr.urls.webPlayback,{method:"POST",body:JSON.stringify(a),headers:n}),l=yield o.text(),d=JSON.parse(l);if(!d||!d.songList){const t=MKError.serverError(d);return e.updateFromLoadError(t),zr.debug("mk: prepareItemWithMZPlay - rejecting with error",t),Promise.reject(t)}const[c]=d.songList;e.updateFromSongList(c)}));function playMediaItem(t,i,r,s,n){return __awaiter$1(this,void 0,void 0,(function*(){const a=r.isPaused()&&!s;zr.debug("playMediaItem",i,a);const o=yield function(e,t){return __awaiter$1(this,void 0,void 0,(function*(){return!!e.previewURL&&(!!t.previewOnly||!e.playRawAssetURL&&(!e.isUTS&&!(yield hasMusicSubscription())||(!(!e.isUTS||"Preview"!==e.type)||(!hasAuthorization()||!supportsDrm()||!e.isPlayable))))}))}(i,r);if(zr.debug("mk: shouldPreview",o),o)return supportsDrm()||r.dispatch(Hr.drmUnsupported,{item:i}),i.playbackType=e.PlaybackType.preview,r.nowPlayingItem=i,yield r.playItemFromUnencryptedSource(i.previewURL,a),i;if(function(e){return!(!e.playRawAssetURL||!e.attributes.assetUrl)}(i))return zr.debug("shouldPlayRawAsset",i),i.playbackType=e.PlaybackType.unencryptedFull,r.nowPlayingItem=i,yield r.playItemFromUnencryptedSource(i.attributes.assetUrl,a,n),i;if(isBroadcastRadio(i)){if(!Yr.features["broadcast-radio"]){const e=new MKError(MKError.CONTENT_UNAVAILABLE);throw e.data=i,e}const s=yield loadLiveRadioAssets(i,t.store.developerToken,t.store.userToken),n=s.assets[0];return i.playbackType=e.PlaybackType.unencryptedFull,i.trackInfo=s["track-info"],r.nowPlayingItem=i,yield r.playItemFromUnencryptedSource(n.url,a),i}if(!i||!i.isPlayable)return Promise.reject(new MKError(MKError.MEDIA_PLAYBACK,"Not Playable"));try{yield prepareForEncryptedPlayback(t,i,r,n)}catch(Pt){return zr.error("prepareForEncryptedPlayback Error: userInitiated "+s),s?Promise.reject(Pt):void r.dispatch(Hr.mediaPlaybackError,Pt)}return yield function(e){return new Promise((t,i)=>{const{ageGatePolicy:r}=e;if(!r||!r.age||!r.frequencyInMinutes)return zr.debug("No ageGatePolicy. Resolving handleAgeGate()"),t(void 0);const s=getLocalStorage(),n=null==s?void 0:s.ageGatePolicyAge,a=null==s?void 0:s.ageGatePolicyExpiration;if(n&&a&&parseInt(a,10)>Date.now()&&parseInt(n,10)>=r.age)return t(void 0);MKDialog.clientDialog({okButtonString:"Yes",okButtonAction:()=>(null==s||s.setItem("ageGatePolicyAge",r.age.toString()),null==s||s.setItem("ageGatePolicyExpiration",(Date.now()+60*r.frequencyInMinutes*1e3).toString()),t(void 0)),cancelButtonString:"No",cancelButtonAction:()=>i(new MKError("AGE_GATE","Age Gate Declined")),explanation:`This content may not be appropriate for ages younger than ${r.age}.`,message:`Are you ${r.age} or older?`}).present()})}(i),zr.debug("About to play item as encrypted",i),yield r.playItemFromEncryptedSource(i,s,n),i}))}function prepareToPlayMediaItem(e,t,i){return __awaiter$1(this,void 0,void 0,(function*(){const{developerToken:r,userToken:s}=e.store;if(void 0===r||void 0===s)return Promise.reject(new MKError(MKError.AUTHORIZATION_ERROR,"Unable to prepare media item for play."));t.isPreparedToPlay?zr.warn("media-item: item is prepared to play"):(zr.debug("media-item: item.prepareToPlay playParams",t.playParams),t.state=A.loading,t.isUTS?yield((e,t,i)=>__awaiter$1(void 0,void 0,void 0,(function*(){var r,s,n;const a=yield t.getPlayablesForContent({canonicalId:e.id,reload:!0,returnRawResponse:!0});if(e.playables=null===(r=null==a?void 0:a.data)||void 0===r?void 0:r.playables,e.channels=null===(s=null==a?void 0:a.data)||void 0===s?void 0:s.channels,!(null===(n=e.playables)||void 0===n?void 0:n.length))return;const o=e.playables.reduce((e,t)=>(void 0!==t.assets&&e.push(t.assets),e),[]);if(0===o.length)return;const[l]=o;let{hlsUrl:d}=l;Yr.features.xtrick&&(d=addQueryParamsToURL(d,{xtrick:!0})),Yr.features.isWeb&&(d=addQueryParamsToURL(d,{webbrowser:!0})),e.bingeWatching&&(d=addQueryParamsToURL(d,{bingeWatching:!0}),e.bingeWatching=!1),e.updateWithLoadedAssets(o,d),e.updateWithLoadedKeys({"hls-key-cert-url":l.fpsCertificateUrl,"hls-key-server-url":l.fpsKeyServerUrl,"widevine-cert-url":l.wideVineCertificateUrl},l.fpsKeyServerQueryParameters),yield fetchHLSMetadata(e,i),e.state=A.ready})))(t,e.utsAPI,i):yield((e,t,i)=>__awaiter$1(void 0,void 0,void 0,(function*(){e.hasOffersHlsUrl?yield prepareOffersHlsUrlForEncryptedPlayback(e):e.isLiveRadioStation?yield prepareLiveRadioForEncryptedPlayback(e,t,i):yield prepareItemWithMZPlay(e,t,i)})))(t,r,s))}))}function prepareForEncryptedPlayback(e,t,i,r){return __awaiter$1(this,void 0,void 0,(function*(){if(zr.debug("prepareForEncryptedPlayback"),!hasAuthorization())return i.destroy(),Promise.reject(new MKError(MKError.AUTHORIZATION_ERROR,"Unable to prepare for playback."));try{yield e.store.validateAgeVerification(t)}catch(Pt){return Pt.errorCode===MKError.CONTENT_RESTRICTED&&t.restrict(),i.destroy(),Promise.reject(Pt)}try{yield prepareToPlayMediaItem(e,t,r)}catch(Pt){if([MKError.AUTHORIZATION_ERROR].includes(Pt.errorCode))yield e.store.storekit.revokeUserToken();else if(Pt.errorCode===MKError.TOKEN_EXPIRED)try{return yield e.store.storekit.renewUserToken(),yield prepareToPlayMediaItem(e,t,r),t.playbackData=_playbackDataForItem(t,i),t}catch(s){}if(Pt)return i.destroy(),Promise.reject(Pt)}return t.playbackData=_playbackDataForItem(t,i),t}))}function _playbackDataForItem(t,i){if(zr.debug("mk: _playbackDataForItem",t),t.isCloudUpload)return t.assets[0];if("musicVideo"!==t.type&&!t.isLiveVideoStation){if(!t.isLiveRadioStation&&!t.hasOffersHlsUrl){const[e]=t.assets.filter(e=>{var t;if(!("flavor"in e))return!1;const r=new RegExp(`\\d{1,2}\\:(c${function(){var e;return null===(e=window.WebKitMediaKeys)||void 0===e?void 0:e.isTypeSupported(Ue+".1_0",De.AVC1)}()?"bc":"tr"}p)(\\d{2,3})`,"i"),s=r.test(e.flavor),n=null!==(t=e.flavor.match(r))&&void 0!==t?t:[];return s&&parseInt(n[2],10)<=i.bitrate});return e}{const r=t.assets.reduce((e,t)=>{const i=t.bandwidth;return e[i]||(e[i]=[]),e[i].push(t),e},{}),s=Object.keys(r).sort((e,t)=>parseInt(e,10)-parseInt(t,10)),n=i.bitrate===e.PlaybackBitrate.STANDARD?s[0]:s[s.length-1];t.assetURL=r[n][0].URL}}}function getPlayerType(e){var t,i;switch(null==e?void 0:e.type){case"contributors":case"modalities":case"movie":case"musicVideo":case"musicMovie":case"trailer":case"tvEpisode":case"uploadedVideo":case"uploaded-videos":case"music-videos":case"music-movies":case"tv-episodes":case"workouts":case"Bonus":case"Episode":case"Movie":case"Preview":case"Promotional":case"RealityVideo":case"Season":case"Show":case"SportingEvent":case"Vod":case"EditorialVideoClip":case"LiveService":return"video";case"podcast-episodes":return"audio";default:return null!==(i=null===(t=null==e?void 0:e.attributes)||void 0===t?void 0:t.mediaKind)&&void 0!==i?i:"audio"}}const{audioTracksSwitched:Ms,audioTracksUpdated:Ds,inlineStylesParsed:Ns,textTracksSwitched:Ls,textTracksUpdated:xs}=Me;class HlsJsTracks extends Notifications{constructor(e){super([Ms,Ds,Ns,Ls,xs]),this.session=e,this._audioTracks=[],this._textTracks=[];const{MANIFEST_LOADED:t,AUDIO_TRACK_SWITCHED:i,SUBTITLE_TRACK_SWITCH:r,INLINE_STYLES_PARSED:s}=window.Hls.Events;this.session.on(t,this.handleManifestLoaded),this.session.on(i,this.handleAudioTrackSwitched),this.session.on(r,this.handleSubtitleTrackSwitch),this.session.on(s,this.handleInlineStylesParsed)}get audioTracks(){return this._audioTracks}get textTracks(){return this._textTracks}set audioTrack(e){this.session&&e&&e.id&&(this.session.audioSelectedPersistentID=e.id)}set textTrack(e){var t;this.session.subtitleSelectedPersistentID=null!==(t=null==e?void 0:e.id)&&void 0!==t?t:-1}selectForcedTrack(){const{session:e}=this;if(!(null==e?void 0:e.audioTracks))return;const t=e.audioTracks.filter(t=>t.persistentID===e.audioSelectedPersistentID),i=t&&t.length&&t[0];if(!i)return;const r=e.subtitleMediaOptions.filter(e=>0===e.MediaSelectionOptionsDisplaysNonForcedSubtitles&&e.MediaSelectionOptionsExtendedLanguageTag===i.lang),s=null==r?void 0:r[0];let n;return s?(E.debug("hlsjsTracks: found forced track for "+s.MediaSelectionOptionsExtendedLanguageTag),e.subtitleSelectedPersistentID=s.MediaSelectionOptionsPersistentID,n=this.normalizeTextTrack(s)):e.subtitleSelectedPersistentID=-1,n}audioTracksUpdated(e,t){const i=t&&t.audioMediaSelectionGroup&&t.audioMediaSelectionGroup.MediaSelectionGroupOptions||[];window.hlsSession=this.session;const r=i.map(this.normalizeAudioTrack,this);this._audioTracks=r,this.dispatchEvent(Ds,r)}handleAudioTrackSwitched(){this.dispatchEvent(Ms,{selectedId:this.session.audioSelectedPersistentID})}handleInlineStylesParsed(e,t){this.dispatchEvent(Ns,t)}handleManifestLoaded(e,t){this.audioTracksUpdated(e,t),this.subtitleTracksUpdated(e,t)}handleSubtitleTrackSwitch(e,t){this.dispatchEvent(Ls,t)}subtitleTracksUpdated(e,t){const i=t&&t.subtitleMediaSelectionGroup&&t.subtitleMediaSelectionGroup.MediaSelectionGroupOptions||[],r=[];i.forEach(e=>{0!==e.MediaSelectionOptionsDisplaysNonForcedSubtitles&&r.push(this.normalizeTextTrack(e))}),this._textTracks=r,this.dispatchEvent(xs,r)}normalizeAudioTrack(e){var t;const i="public.accessibility.describes-video"===(null===(t=e.MediaSelectionOptionsTaggedMediaCharacteristics)||void 0===t?void 0:t[0])?"description":"main";return Object.assign(Object.assign({},this.normalizeSelectionOption(e)),{enabled:!1,kind:i})}normalizeTextTrack(e){var t;let i;return i=(null===(t=e.MediaSelectionOptionsTaggedMediaCharacteristics)||void 0===t?void 0:t.includes("public.accessibility.describes-music-and-sound"))||"clcp"===e.MediaSelectionOptionsMediaType?"captions":"subtitles",Object.assign(Object.assign({},this.normalizeSelectionOption(e)),{mode:"disabled",kind:i})}normalizeSelectionOption(e){return{id:e.MediaSelectionOptionsPersistentID,label:e.MediaSelectionOptionsName,language:e.MediaSelectionOptionsExtendedLanguageTag}}destroy(){const{MANIFEST_LOADED:e,AUDIO_TRACK_SWITCHED:t,SUBTITLE_TRACK_SWITCH:i,INLINE_STYLES_PARSED:r}=window.Hls.Events;this.session.off(e,this.handleManifestLoaded),this.session.off(t,this.handleAudioTrackSwitched),this.session.off(i,this.handleSubtitleTrackSwitch),this.session.off(r,this.handleInlineStylesParsed)}}__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],HlsJsTracks.prototype,"handleAudioTrackSwitched",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",void 0)],HlsJsTracks.prototype,"handleInlineStylesParsed",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",void 0)],HlsJsTracks.prototype,"handleManifestLoaded",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",void 0)],HlsJsTracks.prototype,"handleSubtitleTrackSwitch",null);const Us=createLocalStorageFlag("mk-linear-scrubbing-enabled"),Fs={keySystemGenericError:"keySystemGenericError"},js={};js[Ie.FAIRPLAY]="fairplaystreaming",js[Ie.PLAYREADY]="playready",js[Ie.WIDEVINE]="widevine";const Bs=!!createLocalStorageFlag("mk-block-report-cdn-server").json(),configureCdnReporting=e=>{const{Hls:t}=window;if(t&&Bs){const i=function deepClone(e){if("object"!=typeof e||null===e)throw new TypeError("Source is not an Object");const t=Array.isArray(e)?[]:{};for(const i in e)hasOwn(e,i)&&("object"==typeof e[i]&&null!==e[i]?t[i]=deepClone(e[i]):t[i]=e[i]);return t}(t.DefaultConfig.fragLoadPolicy);i.default.reportCDNServer=!1,i.customURL.reportCDNServer=!1,e.fragLoadPolicy=i}};class HlsJsVideoPlayer extends VideoPlayer{constructor(e){var t;super(e),this._channelsByGroup={},this._rtcTracker=null===(t=null==e?void 0:e.playbackServices)||void 0===t?void 0:t.getRTCStreamingTracker(),this._license=new License}get shouldDispatchErrors(){return!this.userInitiated||this._playbackDidStart}get currentPlayingDate(){var e;return null===(e=this._hls)||void 0===e?void 0:e.playingDate}initializeExtension(){var e;return __awaiter(this,void 0,void 0,(function*(){this._keySystem=yield findKeySystemPreference();try{if(!Ae.urls.hls)throw new Error("bag.urls.hls is not configured");yield Promise.all([loadScript(Ae.urls.hls),null===(e=this._rtcTracker)||void 0===e?void 0:e.loadScript()])}catch(t){throw E.error("hlsjs-video-player failed to load script "+Ae.urls.hls,t),t}}))}destroy(){var e;if(E.debug("hlsjs-video-player.destroy"),null===(e=this._hlsJsTracks)||void 0===e||e.destroy(),this._hls){const{ERROR:e,INTERNAL_ERROR:t,MANIFEST_PARSED:i,KEY_REQUEST_STARTED:r,LICENSE_CHALLENGE_CREATED:s,LEVEL_SWITCHED:n}=window.Hls.Events,a=this._hls;a.stopLoad(),a.detachMedia(),a.off(e,this.handleHlsError),a.off(t,this.handleHlsError),a.off(i,this.handleManifestParsed),a.off(r,this.handleKeyRequestStarted),a.off(s,this.handleLicenseChallengeCreated),a.off(n,this.handleLevelSwitched),a.destroy()}super.destroy(),asAsync(this._license.stop())}playHlsStream(e,t){E.debug("hlsjs-video-player.playHlsStream",e,t);const{_keySystem:i}=this;if(!i)return;let r,s;this.createHlsPlayer(),i===Ie.WIDEVINE&&(r="WIDEVINE_SOFTWARE",s={initDataTypes:["cenc","keyids"],distinctiveIdentifier:"optional",persistentState:"required"});const n={subs:"accepts-css",platformInfo:{requiresCDMAttachOnStart:!0,maxSecurityLevel:r,keySystemConfig:s},appData:{serviceName:Ae.app.name}},{_rtcTracker:a,_hls:o}=this;if(a){const e=a.prepareReportingAgent(t);void 0!==e&&(n.appData.reportingAgent=e)}E.debug("RTC: loadSource with load options",n),o.loadSource(e,n),o.attachMedia(this.video),t&&(this._licenseServerUrl=t.keyURLs["hls-key-server-url"],i===Ie.FAIRPLAY?o.setProtectionData({fairplaystreaming:{serverCertUrl:t.keyURLs["hls-key-cert-url"]}}):o.setProtectionData({widevine:{serverCertUrl:t.keyURLs["widevine-cert-url"]}}))}createHlsPlayer(){const{_keySystem:e}=this,{Hls:t}=window,i=kr.get(),r={clearMediaKeysOnPromise:!1,customTextTrackCueRenderer:!0,debug:!!i,debugLevel:i,enablePerformanceLogging:!!i,enablePlayReadyKeySystem:!0,enableQueryParamsForITunes:!0,enableRtcReporting:void 0!==this._rtcTracker,keySystemPreference:js[e],useMediaKeySystemAccessFilter:!0,nativeControlsEnabled:Pe.isAndroid};configureCdnReporting(r),(e=>{const t=Tr.json();t&&isAppleHostname(t.socketurl)&&"carry-"===determineCdnBasePrefix()&&(e.socketurl=t.socketurl,e.socketid=t.socketid,e.log=t.log)})(r);const s=new t(r),{ERROR:n,INTERNAL_ERROR:a,MANIFEST_PARSED:o,KEY_REQUEST_STARTED:l,LICENSE_CHALLENGE_CREATED:d,LEVEL_SWITCHED:c}=t.Events;s.on(n,this.handleHlsError),s.on(a,this.handleHlsError),s.on(o,this.handleManifestParsed),s.on(l,this.handleKeyRequestStarted),s.on(d,this.handleLicenseChallengeCreated),s.on(c,this.handleLevelSwitched),this._hls=s,this._hlsJsTracks=new HlsJsTracks(this._hls),this.setupTrackManagers(this._hlsJsTracks)}handleLevelSwitched(e,t){var i,r;const{level:s}=t;if(!s)return;const n=null===(i=this._levels)||void 0===i?void 0:i.find(e=>e.persistentId===s);if(!n||(null===(r=this._currentLevel)||void 0===r?void 0:r.persistentId)===(null==n?void 0:n.persistentId))return;this._currentLevel=n;const a=void 0!==n.audioGroupId?this._channelsByGroup[n.audioGroupId]:void 0;this._dispatcher.publish(He.hlsLevelUpdated,{level:n,channels:a})}handleHlsError(e,t){E.warn("HLS.js error",JSON.stringify(t));let i=new MKError(MKError.UNSUPPORTED_ERROR,t.reason);i.data=t;const{keySystemGenericError:r}=Fs;if(t.details!==r){if("output-restricted"===t.reason&&(i=new MKError(MKError.OUTPUT_RESTRICTED,t.reason)),t.fatal){if(this._hls.destroy(),!this.shouldDispatchErrors)throw i;this._dispatcher.publish(Ye.mediaPlaybackError,i)}}else this._dispatcher.publish(r,i)}handleManifestParsed(e,t){var i,r;this._levels=null!==(i=t.levels)&&void 0!==i?i:[],this.nowPlayingItem.state=A.ready,this._channelsByGroup=(null!==(r=t.audioTracks)&&void 0!==r?r:[]).reduce((e,t)=>(e[t.groupId]=t.channels,e),{}),Us.json()?asAsync(this.play()):asAsync(this._playMedia())}handleKeyRequestStarted(e,t){E.debug("hlsjs-video.handleKeyRequestStarted"),this._hls.generateKeyRequest(t.keyuri,{})}handleLicenseChallengeCreated(e,t){var i;return __awaiter(this,void 0,void 0,(function*(){const{_licenseServerUrl:e,nowPlayingItem:r,_keySystem:s,userInitiated:n}=this;try{const a=yield null===(i=this._license)||void 0===i?void 0:i.start(e,r,t,s,n),l={statusCode:a.status};(null==a?void 0:a.license)&&(s===Ie.FAIRPLAY?l.ckc=o(a.license):l.license=o(a.license));const d=a["renew-after"];d&&(l.renewalDate=new Date(Date.now()+1e3*d)),this._hls.setLicenseResponse(t.keyuri,l)}catch(a){const e=a.data,i={};void 0!==(null==e?void 0:e.status)&&(i.statusCode=+e.status),E.warn("Passing license response error to Hls.js",i),this._hls.setLicenseResponse(t.keyuri,i),this.onPlaybackLicenseError(a)}}))}seekToTime(e){return __awaiter(this,void 0,void 0,(function*(){this._hls?(E.debug("hlsjs-video: hls seekTo",e),this._hls.seekTo=e):(E.debug("hlsjs-video: media element seek to",e),this._targetElement.currentTime=e)}))}}__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",void 0)],HlsJsVideoPlayer.prototype,"handleLevelSwitched",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",void 0)],HlsJsVideoPlayer.prototype,"handleHlsError",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",void 0)],HlsJsVideoPlayer.prototype,"handleManifestParsed",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",void 0)],HlsJsVideoPlayer.prototype,"handleKeyRequestStarted",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object]),__metadata("design:returntype",Promise)],HlsJsVideoPlayer.prototype,"handleLicenseChallengeCreated",null),__decorate([AsyncDebounce(250),__metadata("design:type",Function),__metadata("design:paramtypes",[Number]),__metadata("design:returntype",Promise)],HlsJsVideoPlayer.prototype,"seekToTime",null);const{mediaPlaybackError:Ks}=Ye,{playbackLicenseError:$s,playbackSessionError:Vs}=Me;class NativeSafariVideoPlayer extends VideoPlayer{get currentPlayingDate(){}initializeExtension(){return __awaiter(this,void 0,void 0,(function*(){if(!this.video)return void E.warn("NativeSafariVideoPlayer.initializeExtension No video element, not initializing extension");const e=new MediaExtension(this.video,'video/mp4;codecs="avc1.42E01E"');this.extension=e,yield e.initializeKeySystem(),e.addEventListener($s,this.onPlaybackLicenseError),e.addEventListener(Vs,this.onPlaybackSessionError)}))}destroy(){E.debug("native-safari-video-player.destroy");const{extension:e,video:t}=this;e&&t&&(e.removeEventListener($s,this.onPlaybackLicenseError),e.removeEventListener(Vs,this.onPlaybackSessionError),t.removeEventListener("loadedmetadata",this.onMetadataLoaded),super.destroy())}playHlsStream(e){var t;return __awaiter(this,void 0,void 0,(function*(){E.debug("native-safari-video-player.playHlsStream",e);const{video:i}=this;if(!i)return void E.error("NativeSafariVideoPlayer.playHlsStream No video element");this.setupTrackManagers(),i.src=e;const{nowPlayingItem:r}=this;r&&(null===(t=this.extension)||void 0===t||t.setMediaItem(r)),i.addEventListener("loadedmetadata",this.onMetadataLoaded)}))}onPlaybackSessionError(e){this._dispatcher.publish(Ks,new MKError(MKError.MEDIA_SESSION,e))}onMetadataLoaded(){E.debug("native-safari-video-player.onMetadataLoaded");const{nowPlayingItem:e}=this;e&&(e.state=A.ready),asAsync(this._playMedia())}seekToTime(e){return __awaiter(this,void 0,void 0,(function*(){E.debug("native-safari-video-player: media element seek to",e),this._targetElement.currentTime=e}))}}__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object]),__metadata("design:returntype",void 0)],NativeSafariVideoPlayer.prototype,"onPlaybackSessionError",null),__decorate([Bind(),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],NativeSafariVideoPlayer.prototype,"onMetadataLoaded",null),__decorate([AsyncDebounce(250),__metadata("design:type",Function),__metadata("design:paramtypes",[Number]),__metadata("design:returntype",Promise)],NativeSafariVideoPlayer.prototype,"seekToTime",null);const Ws=createLocalStorageFlag("mk-safari-force-native-live-stream");class Factory{constructor(e){this._playersByType={},this._playerOptions=e}getPlayerForMediaItem(e,t,i){var r;return __awaiter(this,void 0,void 0,(function*(){E.debug("mk: getPlayerForMediaItem",e,t);const s=getPlayerType(e);let n=this._playersByType[s];if((null==n?void 0:n.isDestroyed)&&(E.debug("mk: existingPlayer was previously destroyed. Removing from factory."),n=void 0,delete this._playersByType[s]),n&&n===i)return i;if(n)return this._applyPlayerState(n,t),n;const{_playerOptions:a}=this;let o;switch(s){case"audio":o=new AudioPlayer(a),this._playersByType[s]=o;break;case"video":{const t=yield null===(r=this._playerOptions.playbackServices)||void 0===r?void 0:r.requiresHlsJs(),i=this._shouldForceHlsJsPlayer(e);o=t||i?new HlsJsVideoPlayer(a):new NativeSafariVideoPlayer(a);break}default:throw new Error("Invalid player type requested: "+s)}return yield o.initialize(),this._applyPlayerState(o,t),o}))}_shouldForceHlsJsPlayer(e){var t,i,r,s;return"true"!==Ws.get()&&(e.isLiveVideoStation||e.isLinearStream||(null===(s=null===(r=null===(i=null===(t=e.playables)||void 0===t?void 0:t[0])||void 0===i?void 0:i.assets)||void 0===r?void 0:r.fpsKeyServerUrl)||void 0===s?void 0:s.startsWith("https://linear.tv.apple.com")))}_applyPlayerState(e,t){return t?(E.debug("_applyPlayerState",t),Object.keys(t).forEach(i=>{void 0!==e[i]&&(e[i]=t[i])}),e):e}destroy(){Object.values(this._playersByType).forEach(e=>e.destroy())}}const{mediaCanPlay:Hs,mediaPlaybackError:zs,playerTypeDidChange:qs}=Ye,{playbackLicenseError:Ys}=Me,{keySystemGenericError:Gs}=Fs;let Qs=!1;class MediaItemPlayback{constructor(e){this.playerState={playbackRate:1,volume:1},this.playOptions=new Map,this._hasSmartPlayed=!1,this._previewOnly=!1;const{playbackServices:t}=e;var i,r;this.hasMusicSubscription=t.hasMusicSubscription,this.playMediaItem=t.playMediaItem,this.prepareForEncryptedPlayback=t.prepareForEncryptedPlayback,i=e.tokens,ji=i,e.bag&&(r=e.bag,Object.assign(Ae,r)),this._dispatcher=e.services.dispatcher,this._playerFactory=new Factory(e),this._currentPlayer=new PlayerStub(e),this._dispatcher.subscribe(Hs,this.handleSmartPlay),this._dispatcher.subscribe(Ys,this.onPlaybackLicenseError),this._dispatcher.subscribe(Gs,this.onKeySystemGenericError)}get currentPlaybackTime(){var e,t;if(!this._hasSmartPlayed){const i=null===(t=null===(e=this.nowPlayingItem)||void 0===e?void 0:e.playEvent)||void 0===t?void 0:t.playCursorInSeconds;if(i)return this._currentPlayer.calculateTime(i)}return this._currentPlayer.currentPlaybackTime}get currentPlaybackTimeRemaining(){return this._currentPlayer.currentPlaybackTimeRemaining}get currentPlayingDate(){return this._currentPlayer.currentPlayingDate}get audioTracks(){return this._currentPlayer.audioTracks}get currentAudioTrack(){return this._currentPlayer.currentAudioTrack}set currentAudioTrack(e){this._currentPlayer.currentAudioTrack=e}get currentPlaybackDuration(){return this._currentPlayer.currentPlaybackDuration}get currentBufferedProgress(){return this._currentPlayer.currentBufferedProgress}set currentBufferedProgress(e){this._currentPlayer.currentBufferedProgress=e}get currentPlaybackProgress(){return this._currentPlayer.currentPlaybackProgress}set currentPlaybackProgress(e){this._currentPlayer.currentPlaybackProgress=e}get currentTextTrack(){return this._currentPlayer.currentTextTrack}set currentTextTrack(e){this._currentPlayer.currentTextTrack=e}get previewOnly(){return this._previewOnly}set previewOnly(e){this._previewOnly=e,this._currentPlayer&&(this._currentPlayer.previewOnly=e)}get formattedCurrentPlaybackDuration(){return this._currentPlayer.formattedCurrentPlaybackDuration}get isPlaying(){return this._currentPlayer.isPlaying}get isPrimaryPlayer(){return this._currentPlayer.isPrimaryPlayer}set isPrimaryPlayer(e){this._currentPlayer.isPrimaryPlayer=e}get isReady(){return this._currentPlayer.isReady}get nowPlayingItem(){return this._currentPlayer.nowPlayingItem}get playbackRate(){return this._currentPlayer.playbackRate}set playbackRate(e){this._updatePlayerState("playbackRate",e)}get playbackState(){return this._currentPlayer.playbackState}set playbackState(e){this._currentPlayer.setPlaybackState(e,this.nowPlayingItem)}get playbackTargetAvailable(){return this._currentPlayer.playbackTargetAvailable}get playbackTargetIsWireless(){return this._currentPlayer.playbackTargetIsWireless}get textTracks(){return this._currentPlayer.textTracks}get volume(){return this._currentPlayer.volume}set volume(e){this._updatePlayerState("volume",e)}clearNextManifest(){this._currentPlayer.clearNextManifest()}destroy(){var e,t,i;this._playerFactory.destroy(),null===(e=this._dispatcher)||void 0===e||e.unsubscribe(Hs,this.handleSmartPlay),null===(t=this._dispatcher)||void 0===t||t.unsubscribe(Ys,this.onPlaybackLicenseError),null===(i=this._dispatcher)||void 0===i||i.unsubscribe(Gs,this.onKeySystemGenericError)}exitFullscreen(){return this._currentPlayer.exitFullscreen()}getNewSeeker(){return this._currentPlayer.newSeeker()}mute(){this._volumeAtMute=this.volume,this.volume=0}pause(e){return __awaiter$1(this,void 0,void 0,(function*(){return this._currentPlayer.pause(e)}))}play(){return __awaiter$1(this,void 0,void 0,(function*(){return this._currentPlayer.play()}))}preload(){return __awaiter$1(this,void 0,void 0,(function*(){return this._currentPlayer.preload()}))}prepareToPlay(e){var t;return __awaiter$1(this,void 0,void 0,(function*(){E.debug("invoking prepareToPlay for ",e.title);const i=yield this.prepareForEncryptedPlayback(e,this._currentPlayer),r=null===(t=this._currentPlayback)||void 0===t?void 0:t.item,s=Ae.features["seamless-audio-transitions"],n="song"===(null==r?void 0:r.type)&&"song"===e.type;return s&&n&&(E.debug(`setting ${e.title} for seamless audio transition`),yield this._currentPlayer.setNextSeamlessItem(e)),i}))}requestFullscreen(e){return this._currentPlayer.requestFullscreen(e)}showPlaybackTargetPicker(){this._currentPlayer.showPlaybackTargetPicker()}seekToTime(t,i=e.SeekReasonType.Manual){return __awaiter$1(this,void 0,void 0,(function*(){yield this._currentPlayer.seekToTime(t,i)}))}setPresentationMode(e){return __awaiter$1(this,void 0,void 0,(function*(){return this._currentPlayer.setPresentationMode(e)}))}startMediaItemPlayback(e,t=!1){var i;return __awaiter$1(this,void 0,void 0,(function*(){E.debug("MediaItemPlayback: startMediaItemPlayback",e),e.resetState(),(e=>{if(e.isLinearStream&&(Pe.isiOS||Pe.isMacOs&&navigator.maxTouchPoints>2)){E.warn("Cannot play linear stream on iOS or iPad");const t=new MKError(MKError.CONTENT_UNSUPPORTED,"IOS LINEAR");throw t.data={item:e},t}})(e),(e=>{if(!supportsDrm()){const t=new MKError(MKError.CONTENT_UNSUPPORTED,"NO DRM");throw t.data={item:e},E.warn("No DRM detected"),t}})(e),yield((e,t)=>__awaiter$1(void 0,void 0,void 0,(function*(){var i,r;if(null===(r=null===(i=e.container)||void 0===i?void 0:i.attributes)||void 0===r?void 0:r.requiresSubscription){if(!(yield t())){const t=new MKError(MKError.SUBSCRIPTION_ERROR);throw t.data=e,t}}})))(e,this.hasMusicSubscription);const r=yield this._getPlayerForMediaItem(e);if(yield this.setCurrentPlayer(r),!(null===(i=this._currentPlayer)||void 0===i?void 0:i.hasMediaElement))return E.warn(`MediaItemPlayback: Could not play media of type ${e.type}, marking item as unsupported and skipping.`),void e.notSupported();try{e.beginMonitoringStateDidChange(e=>{var t;return null===(t=this._dispatcher)||void 0===t?void 0:t.publish(gt.mediaItemStateDidChange,e)}),e.beginMonitoringStateWillChange(e=>{var t;return null===(t=this._dispatcher)||void 0===t?void 0:t.publish(gt.mediaItemStateWillChange,e)});const i=this.playOptions.get(e.id);i&&this.playOptions.delete(e.id);const r=yield this.playMediaItem(e,this._currentPlayer,t,i);return this._currentPlayback={item:e,userInitiated:t},r}catch(Pt){throw E.error(Pt),Pt}}))}stop(e){return __awaiter$1(this,void 0,void 0,(function*(){yield this._currentPlayer.stop(e)}))}unmute(){this.volume>0||(this.volume=this._volumeAtMute||1,this._volumeAtMute=void 0)}_getPlayerForMediaItem(e){return __awaiter$1(this,void 0,void 0,(function*(){E.debug("MediaItemPlayback:  _getPlayerForMediaItem",e.id);const t=yield this._playerFactory.getPlayerForMediaItem(e,this.playerState,this._currentPlayer);return t.previewOnly=this._previewOnly,t}))}setCurrentPlayer(e){var t;return __awaiter$1(this,void 0,void 0,(function*(){this._currentPlayer!==e&&(E.debug("MediaItemPlayback: setting currentPlayer",e),yield this._currentPlayer.stop(),this._hasSmartPlayed=!1,this._currentPlayer=e,null===(t=this._dispatcher)||void 0===t||t.publish(qs,{player:e}))}))}handleSmartPlay(){var e,t;const i=this.nowPlayingItem;if(this._hasSmartPlayed||!i)return;if(!(null===(e=null==i?void 0:i.playEvent)||void 0===e?void 0:e.isDone)||!1){E.debug("BasePlayer.handleSmartPlay is resuming playCursor");const e=null===(t=i.playEvent)||void 0===t?void 0:t.playCursorInSeconds;e&&this._currentPlayer.seekToTime(e)}this._hasSmartPlayed=!0}onKeySystemGenericError(e,t){var i;return __awaiter$1(this,void 0,void 0,(function*(){Qs?null===(i=this._dispatcher)||void 0===i||i.publish(zs,t):(Qs=!0,E.warn("Retrying playback after keysystemGenericError"),yield this.restartPlayback())}))}onPlaybackLicenseError(e,t){var i;return __awaiter$1(this,void 0,void 0,(function*(){t.errorCode===MKError.PLAYREADY_CBC_ENCRYPTION_ERROR?(E.warn("MediaItemPlayback: PLAYREADY_CBC_ENCRYPTION_ERROR...retrying with different key system"),yield this.restartPlayback()):null===(i=this._dispatcher)||void 0===i||i.publish(zs,t)}))}restartPlayback(){return __awaiter$1(this,void 0,void 0,(function*(){yield this.stop();const{_currentPlayback:e}=this;if(e){const{item:t,userInitiated:i}=e;t.resetState(),yield this.startMediaItemPlayback(t,i)}}))}_updatePlayerState(e,t){this.playerState[e]=t,this._currentPlayer[e]=t}}__decorate$1([Bind(),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[]),__metadata$1("design:returntype",void 0)],MediaItemPlayback.prototype,"handleSmartPlay",null),__decorate$1([Bind(),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[Object,Object]),__metadata$1("design:returntype",Promise)],MediaItemPlayback.prototype,"onKeySystemGenericError",null),__decorate$1([Bind(),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[Object,Object]),__metadata$1("design:returntype",Promise)],MediaItemPlayback.prototype,"onPlaybackLicenseError",null);const Xs=[MKError.AGE_VERIFICATION,MKError.CONTENT_EQUIVALENT,MKError.CONTENT_RESTRICTED,MKError.CONTENT_UNAVAILABLE,MKError.CONTENT_UNSUPPORTED,MKError.SERVER_ERROR,MKError.SUBSCRIPTION_ERROR,MKError.UNSUPPORTED_ERROR];var Js;e.PlaybackMode=void 0,(Js=e.PlaybackMode||(e.PlaybackMode={}))[Js.PREVIEW_ONLY=0]="PREVIEW_ONLY",Js[Js.MIXED_CONTENT=1]="MIXED_CONTENT",Js[Js.FULL_PLAYBACK_ONLY=2]="FULL_PLAYBACK_ONLY";const Zs=createLocalStorageFlag("mk-bag-features-overrides");class MKInstance{constructor(t,i={}){if(this._autoplayEnabled=!1,this.privateEnabled=!1,this.siriInitiated=!1,this.sourceType=ut.MUSICKIT,this.version=e.version,this._bag=Yr,this._playbackControllers={},this._playbackErrorDialog=!0,this._playbackMode=e.PlaybackMode.MIXED_CONTENT,this._whenConfigured=void 0,"string"!=typeof t)throw new Error("MusicKit was initialized without an developerToken.");Object.assign(Yr.features,function(e=[]){const t={};return e.forEach(e=>{"-"===e.charAt(0)?(e=e.substr(1),t[e]=!1):t[e]=!0}),t}(i.features));const r=Zs.json();r&&(zr.warn("Overriding bag.features with",r),Yr.features=Object.assign(Object.assign({},Yr.features),r)),Object.assign(Yr.autoplay,i.autoplay),this.context={};const s=new PubSub;this.capabilities=new Capabilities(s),i.playbackActions&&(this.playbackActions=i.playbackActions);const n=new TimingAccuracy(!!Yr.features["player-accurate-timing"]),a=new BitrateCalculator(s,i.bitrate);this._services={dispatcher:s,timing:n,bitrateCalculator:a},void 0!==i.playActivityAPI&&(this._services.playActivity=new PlayActivityService(i.playActivityAPI,s)),i.services=this._services,this._configureLogger(i),Yr.app=i.app||{},Yr.store=new DataStore({filter:getFilterFromFlags(i.storeFilterTypes||[]),shouldDisableRecordReuse:!!Yr.features["disable-data-store-record-reuse"]}),Object.assign(Yr.urls,i.urls||{});const o=function(e,t){return Qr=new Store(e,t),Qr}(t,i);this._services.apiManager=new APIServiceManager(o,s);const l=new MediaItemPlayback(this._createPlayerControllerOptions());if(this._services.mediaItemPlayback=l,i.sourceType&&(this.sourceType=i.sourceType),this._initializeInternalEventHandling(),i.bitrate&&(this.bitrate=i.bitrate),i.prefix&&/^(?:web|preview)$/.test(i.prefix)&&(this.prefix=Yr.prefix=i.prefix),i.suppressErrorDialog&&(this._playbackErrorDialog=!i.suppressErrorDialog),void 0!==i.playbackMode&&(this.playbackMode=i.playbackMode),this.privateEnabled=i.privateEnabled||!1,this.siriInitiated=i.siriInitiated||!1,this.id=generateUUID(),zr.log("MusicKit JS Version: "+this.version),zr.debug("Link Parameters",i.linkParameters),zr.log("InstanceId",this.id),Yr.app&&zr.debug("App",Yr.app),i.userToken){const{userToken:e}=i;"function"==typeof e?Qr.dynamicMusicUserToken=e:this.musicUserToken=e}}get developerToken(){return Qr.developerToken}get api(){return this._services.apiManager.api}get audioTracks(){return this._mediaItemPlayback.audioTracks}get authorizationStatus(){return Qr.authorizationStatus}get bitrate(){return this._services.bitrateCalculator.bitrate}set bitrate(e){this._services.bitrateCalculator.bitrate=e}get browserSupportsPictureInPicture(){return function(){if(ke)return E.warn("dom-helpers: Browser checks are not supported in Node environments"),!1;const e=Re,t=e&&e.webkitSupportsPresentationMode&&"function"==typeof e.webkitSetPresentationMode,i=document.pictureInPictureEnabled;return!(!t&&!i)}()}get browserSupportsVideoDrm(){return supportsDrm()}get cid(){return(2===this.realm||this.sourceType!==ut.MUSICKIT)&&Qr.cid}get continuous(){return this._playbackController.continuous}set continuous(e){this._playbackController.continuous=e}get autoplayEnabled(){return this._autoplayEnabled}set autoplayEnabled(e){0!==this.realm&&(e=!1),e!==this.autoplayEnabled&&(this._autoplayEnabled=e,this._services.dispatcher.publish(Hr.autoplayEnabledDidChange,this.autoplayEnabled))}get currentAudioTrack(){return this._mediaItemPlayback.currentAudioTrack}set currentAudioTrack(e){this._mediaItemPlayback.currentAudioTrack=e}get currentPlaybackDuration(){return this._mediaItemPlayback.currentPlaybackDuration}get currentPlaybackProgress(){return this._mediaItemPlayback.currentPlaybackProgress}get currentPlaybackTime(){return this._mediaItemPlayback.currentPlaybackTime}get currentPlayingDate(){return this._mediaItemPlayback.currentPlayingDate}get currentPlaybackTimeRemaining(){return this._mediaItemPlayback.currentPlaybackTimeRemaining}get currentTextTrack(){return this._mediaItemPlayback.currentTextTrack}set currentTextTrack(e){this._mediaItemPlayback.currentTextTrack=e}get isAuthorized(){return Qr.isAuthorized}get isPlaying(){return this._playbackController.isPlaying}get isRestricted(){return Qr.isRestricted}get metricsClientId(){return Qr.metricsClientId}set metricsClientId(e){Qr.metricsClientId=e}get musicUserToken(){return Qr.musicUserToken}set musicUserToken(e){e&&Qr.musicUserToken===e||(Qr.musicUserToken=e)}updateUserTokenFromStorage(){return Qr.updateUserTokenFromStorage()}get needsGDPR(){return Qr.needsGDPR}get nowPlayingItem(){return this._mediaItemPlayback.nowPlayingItem}get nowPlayingItemIndex(){return this._playbackController.nowPlayingItemIndex}get playbackMode(){return this._playbackMode}set playbackMode(t){if(-1===Object.values(e.PlaybackMode).indexOf(t))return;this._playbackMode=t;const i=t===e.PlaybackMode.PREVIEW_ONLY,r=this._services.mediaItemPlayback;r&&(r.previewOnly=i)}get playbackRate(){return this._mediaItemPlayback.playbackRate}set playbackRate(e){this._mediaItemPlayback.playbackRate=e}get playbackState(){return this._mediaItemPlayback.playbackState}get playbackTargetAvailable(){return this._mediaItemPlayback.playbackTargetAvailable}get playbackTargetIsWireless(){return this._mediaItemPlayback.playbackTargetIsWireless}get previewOnly(){return this.playbackMode===e.PlaybackMode.PREVIEW_ONLY}set previewOnly(t){this.playbackMode=t?e.PlaybackMode.PREVIEW_ONLY:e.PlaybackMode.MIXED_CONTENT}get queue(){return this._playbackController.queue}get queueIsEmpty(){return this._playbackController.queue.isEmpty}get realm(){return Qr.realm}get repeatMode(){return this._playbackController.repeatMode}set repeatMode(e){this._playbackController.repeatMode=e}set requestUserToken(e){Qr.requestUserToken=e}get restrictedEnabled(){return Qr.restrictedEnabled}get seekSeconds(){return this._playbackController.seekSeconds}get services(){return this._services}set shuffle(e){this._playbackController.shuffle=e}get shuffleMode(){return this._playbackController.shuffleMode}set shuffleMode(e){this._playbackController.shuffleMode=e}get storefrontCountryCode(){return Qr.storefrontCountryCode}get subscribeURL(){return Qr.subscribeURL}get subscribeFamilyURL(){return Qr.subscribeFamilyURL}get subscribeIndividualURL(){return Qr.subscribeIndividualURL}get subscribeStudentURL(){return Qr.subscribeStudentURL}get textTracks(){return this._mediaItemPlayback.textTracks}get videoContainerElement(){return this.context.videoContainerElement}set videoContainerElement(e){this.context.videoContainerElement=e}get volume(){return this._mediaItemPlayback.volume}set volume(e){this._mediaItemPlayback.volume=e}get storefrontId(){return Qr.storefrontId}set storefrontId(e){Qr.storefrontId=e}get _mediaItemPlayback(){return this._services.mediaItemPlayback}get _playbackController(){if(void 0!==this._playbackControllerInternal)return this._playbackControllerInternal;zr.debug("setting _playbackController");const e=this._getPlaybackControllerByType(ps.serial);return this._playbackController=e,e}set _playbackController(e){this._playbackControllerInternal=e,this._playbackControllerInternal.autoplayEnabled=this._autoplayEnabled,this._playbackControllerInternal.activate(),this.capabilities.updateChecker(this._playbackControllerInternal.hasCapabilities),this.capabilities.controller=this._playbackControllerInternal}addEventListener(e,t,i={}){adaptAddEventListener(this._services.dispatcher,e,t,i)}authorize(){return __awaiter$1(this,void 0,void 0,(function*(){return this.deferPlayback(),Qr.authorize()}))}canAuthorize(){return supportsDrm()&&!this.isAuthorized}canUnauthorize(){return supportsDrm()&&this.isAuthorized}changeToMediaAtIndex(e){return __awaiter$1(this,void 0,void 0,(function*(){this._isPlaybackSupported()&&(yield this._validateAuthorization(),this._signalChangeItemIntent(),yield this._playbackController.changeToMediaAtIndex(e))}))}changeToMediaItem(e){return __awaiter$1(this,void 0,void 0,(function*(){zr.debug("instance.changeToMediaItem",e),this._isPlaybackSupported()&&(yield this._validateAuthorization(),this._signalChangeItemIntent(),yield this._playbackController.changeToMediaItem(e))}))}changeUserStorefront(e){return __awaiter$1(this,void 0,void 0,(function*(){this.storefrontId=e}))}cleanup(){var e;return __awaiter$1(this,void 0,void 0,(function*(){null===(e=this._services.mediaItemPlayback)||void 0===e||e.destroy(),this._signalIntent({endReasonType:Xe.EXITED_APPLICATION});const t=Object.keys(this._playbackControllers).map(e=>this._playbackControllers[e].destroy());try{yield Promise.all(t)}catch(i){zr.error("Error cleaning up controller",i)}this._services.dispatcher.clear()}))}configure(e){return __awaiter$1(this,void 0,void 0,(function*(){return this._whenConfigured=this._configure(e),this._whenConfigured}))}_configure(e){return __awaiter$1(this,void 0,void 0,(function*(){yield Qr.storekit.whenAuthCompleted;const t=e.map(this._services.apiManager.registerAPIService,this._services.apiManager);yield Promise.all(t),yield this._configurePlayActivity(),this._initializeExternalEventPublishing()}))}deferPlayback(){zr.debug("deferPlayback",this._playbackControllerInternal),deferPlayback()}getApiByType(e){var t;return null===(t=this._services.apiManager)||void 0===t?void 0:t.getApiByType(e)}me(){return __awaiter$1(this,void 0,void 0,(function*(){try{return yield Qr.storekit.me()}catch(e){return Promise.reject(new MKError(MKError.AUTHORIZATION_ERROR,"Unauthorized"))}}))}musicSubscriptionOffers(){return Qr.storekit.musicSubscriptionOffers(this.storefrontId)}musicSubcriptionOffers(){return logDeprecation("musicSubcriptionOffers",{message:"musicSubcriptionOffers has been deprecated, use musicSubscriptionOffers instead"}),this.musicSubscriptionOffers()}hasMusicSubscription(){return hasMusicSubscription(Qr.storekit)}mute(){return this._mediaItemPlayback.mute()}pause(e){return __awaiter$1(this,void 0,void 0,(function*(){if(this._isPlaybackSupported()){try{this._signalIntent({endReasonType:Xe.PLAYBACK_MANUALLY_PAUSED}),yield this._playbackController.pause(e)}catch(Pt){this._handlePlaybackError(Pt)}return Promise.resolve()}}))}play(){return __awaiter$1(this,void 0,void 0,(function*(){if(zr.debug("instance.play()"),this._isPlaybackSupported()){yield this._validateAuthorization();try{yield this._playbackController.play()}catch(Pt){this._handlePlaybackError(Pt)}return Promise.resolve()}}))}playMediaItem(e,t){return __awaiter$1(this,void 0,void 0,(function*(){zr.debug("mk: playMediaItem",e),this.deferPlayback();try{t&&this._mediaItemPlayback.playOptions.set(e.id,t);const i=yield this._playbackController.playSingleMediaItem(e,t);return this.services.dispatcher.publish(Hr.capabilitiesChanged),i}catch(Pt){zr.error("mk:playMediaItem error",Pt),this._handlePlaybackError(Pt)}}))}playNext(e,t=!1){return __awaiter$1(this,void 0,void 0,(function*(){if(this._isPlaybackSupported())return this._playbackController.queue?(this.deferPlayback(),this._playbackController.prepend(e,t)):this.setQueue(e)}))}playLater(e){return __awaiter$1(this,void 0,void 0,(function*(){if(this._isPlaybackSupported())return this._playbackController.queue?(this.deferPlayback(),this._playbackController.append(e)):this.setQueue(e)}))}playAt(e,t){return __awaiter$1(this,void 0,void 0,(function*(){if(this._isPlaybackSupported())return this._playbackController.queue?(this.deferPlayback(),this._playbackController.insertAt(e,t)):this.setQueue(t)}))}clearQueue(){return __awaiter$1(this,void 0,void 0,(function*(){return this._mediaItemPlayback.clearNextManifest(),this._playbackController.clear()}))}removeEventListener(e,t){!function(e,t,i){const r=getCallbacksForName(t);let s;for(let n=r.length-1;n>=0;n--){const[e,t]=r[n];if(e===i){s=t,r.splice(n,1);break}}s&&e.unsubscribe(t,s)}(this._services.dispatcher,e,t)}shouldDisplayPrivacyLink(e){return __awaiter$1(this,void 0,void 0,(function*(){return Qr.shouldDisplayPrivacyLink(e)}))}exitFullscreen(){return this._mediaItemPlayback.exitFullscreen()}requestFullscreen(e){return this._mediaItemPlayback.requestFullscreen(e)}getNewSeeker(){return this._playbackController.getNewSeeker()}seekToTime(t,i=e.SeekReasonType.Manual){return __awaiter$1(this,void 0,void 0,(function*(){if(this._isPlaybackSupported()){yield this._validateAuthorization();try{yield this._playbackController.seekToTime(t,i)}catch(Pt){this._handlePlaybackError(Pt)}return Promise.resolve()}}))}setQueue(e){return __awaiter$1(this,void 0,void 0,(function*(){if(zr.debug("instance.setQueue()",e),!this._isPlaybackSupported())return void zr.warn("Playback is not supported");if(this._isStationQueueOptions(e))return zr.warn("setQueue options contained a station queue request. Changing to setStationQueue mode."),this.setStationQueue(e);this._signalChangeItemIntent(),this.deferPlayback(),yield this._updatePlaybackController(this._getPlaybackControllerByType(ps.serial));const t=yield this._playbackController.setQueue(e);return void 0!==e.repeatMode&&(this._playbackController.repeatMode=e.repeatMode),void 0!==e.autoplay&&(logDeprecation("autoplay",{message:"autoplay has been deprecated, use startPlaying instead"}),void 0===e.startPlaying&&(e.startPlaying=e.autoplay)),e.startPlaying&&(yield this.play()),t}))}setStationQueue(e){return __awaiter$1(this,void 0,void 0,(function*(){if(!this._isPlaybackSupported())return;this._signalChangeItemIntent(),this.deferPlayback(),yield this._updatePlaybackController(this._getPlaybackControllerByType(ps.continuous)),yield this._validateAuthorization(!0),e=parseQueueURLOption(e);const t=this._playbackController.setQueue(e);return void 0!==e.autoplay&&(logDeprecation("autoplay",{message:"autoplay has been deprecated, use startPlaying instead"}),void 0===e.startPlaying&&(e.startPlaying=e.autoplay)),e.startPlaying&&(yield this.play()),t}))}setPresentationMode(e){return __awaiter$1(this,void 0,void 0,(function*(){return this._mediaItemPlayback.setPresentationMode(e)}))}skipToNextItem(){return __awaiter$1(this,void 0,void 0,(function*(){if(this._isPlaybackSupported()){yield this._validateAuthorization(),this._signalIntent({endReasonType:Xe.TRACK_SKIPPED_FORWARDS,direction:Xe.TRACK_SKIPPED_FORWARDS});try{yield this._playbackController.skipToNextItem()}catch(Pt){this._handlePlaybackError(Pt)}}}))}skipToPreviousItem(){return __awaiter$1(this,void 0,void 0,(function*(){if(this._isPlaybackSupported()){yield this._validateAuthorization(),this._signalIntent({endReasonType:Xe.TRACK_SKIPPED_BACKWARDS,direction:Xe.TRACK_SKIPPED_BACKWARDS});try{yield this._playbackController.skipToPreviousItem()}catch(Pt){this._handlePlaybackError(Pt)}}}))}seekForward(){return __awaiter$1(this,void 0,void 0,(function*(){if(this._isPlaybackSupported()){yield this._validateAuthorization();try{this._signalIntent({endReasonType:Xe.TRACK_SKIPPED_FORWARDS,direction:Xe.TRACK_SKIPPED_FORWARDS}),yield this._playbackController.seekForward()}catch(Pt){this._handlePlaybackError(Pt)}}}))}seekBackward(){return __awaiter$1(this,void 0,void 0,(function*(){if(this._isPlaybackSupported()){yield this._validateAuthorization();try{yield this._playbackController.seekBackward()}catch(Pt){this._handlePlaybackError(Pt)}}}))}showPlaybackTargetPicker(){this._playbackController.showPlaybackTargetPicker()}stop(e){var t;return __awaiter$1(this,void 0,void 0,(function*(){if(this._isPlaybackSupported()){this._signalIntent({endReasonType:null==e?void 0:e.endReasonType,userInitiated:null===(t=null==e?void 0:e.userInitiated)||void 0===t||t});try{yield this._playbackController.stop(e)}catch(Pt){this._handlePlaybackError(Pt)}}}))}resetSubscribeViewEligibility(){Qr.storekit.resetSubscribeViewEligibility()}unauthorize(){return __awaiter$1(this,void 0,void 0,(function*(){return Qr.unauthorize()}))}unmute(){return this._mediaItemPlayback.unmute()}_createPlayerControllerOptions(){return{tokens:Qr,bag:Yr,playbackServices:{getRTCStreamingTracker:()=>{var e;return null===(e=this._services.playActivity)||void 0===e?void 0:e.getTrackerByType(RTCStreamingTracker)},hasMusicSubscription:hasMusicSubscription,playMediaItem:(e,t,i,r)=>playMediaItem(this._services.apiManager,e,t,i,r),prepareForEncryptedPlayback:(e,t)=>prepareForEncryptedPlayback(this._services.apiManager,e,t),requiresHlsJs:requiresHlsJs},services:this._services,context:this.context,autoplayEnabled:this.autoplayEnabled,privateEnabled:this.privateEnabled,siriInitiated:this.siriInitiated,storekit:null==Qr?void 0:Qr.storekit}}_getPlaybackControllerByType(e){const t=this._playbackControllers[e];if(t)return t;let i;switch(e){case ps.serial:i=new SerialPlaybackController(this._createPlayerControllerOptions());break;case ps.continuous:i=new ContinuousPlaybackController(this._createPlayerControllerOptions());break;default:throw new MKError(MKError.UNSUPPORTED_ERROR,"Unsupported controller requested: "+e)}return this._playbackControllers[e]=i,i}_handlePlaybackError(e){if(zr.error("mediaPlaybackError",e),Xs.includes(e.name))throw e;this._playbackErrorDialog&&!ke&&MKDialog.presentError(e)}_initializeInternalEventHandling(){Qr.storekit.addEventListener(Hr.userTokenDidChange,()=>{this._whenConfigured&&this._whenConfigured.then(()=>this._configurePlayActivity().catch()).catch()});const t=this._services.dispatcher;t.subscribe(Hr.mediaPlaybackError,(e,t)=>this._handlePlaybackError(t)),t.subscribe(Hr.playbackStateDidChange,(t,i)=>{i.state===e.PlaybackStates.paused&&(zr.debug("mk: playbackStateDidChange callback - calling storekit.presentSubscribeViewForEligibleUsers"),Qr.storekit.presentSubscribeViewForEligibleUsers({state:i.state,item:this.nowPlayingItem},!1))})}_initializeExternalEventPublishing(){[Hr.authorizationStatusDidChange,Hr.needsGDPRDidChange,Hr.storefrontCountryCodeDidChange,Hr.storefrontIdentifierDidChange,Hr.userTokenDidChange,Hr.eligibleForSubscribeView].forEach(e=>{Qr.storekit.addEventListener(e,t=>this._services.dispatcher.publish(e,t))});const e=$e[this.storefrontId.toUpperCase()],t=Ke[e];this._services.dispatcher.subscribe(sr,(e,i)=>{i.resolveAdamIdFromStorefront(t),this._services.dispatcher.publish(Hr.timedMetadataDidChange,i)})}_configureLogger(e){e.debug&&(zr.enabled=!0,zr.level=parseInt(e.logLevel,10)||1)}_configurePlayActivity(){return __awaiter$1(this,void 0,void 0,(function*(){void 0!==this._services.playActivity&&(yield this._services.playActivity.configure(this,{services:this._services}))}))}_isPlaybackSupported(){return!ke||(zr.warn("Media playback is not supported in Node environments."),!1)}_isStationQueueOptions(e){return!(!(e=>!!e&&(!!isIdentityQueue(e)||(!!isQueueURLOption(e)||Object.keys(Ts).some(t=>void 0!==e[t]))))(e=parseQueueURLOption(e))||(e=>{if(!e)return!1;if(isQueueURLOption(e))return!0;if(isQueueItems(e))return!0;return Object.keys(Ps).concat(Object.keys(Is)).some(t=>void 0!==e[t])})(e))}_updatePlaybackController(e){return __awaiter$1(this,void 0,void 0,(function*(){zr.debug("mk: _updatePlaybackController",e),this._playbackControllerInternal!==e&&(this._playbackControllerInternal&&(yield this._playbackControllerInternal.deactivate()),this._playbackController=e)}))}_signalChangeItemIntent(){this._signalIntent({endReasonType:Xe.MANUALLY_SELECTED_PLAYBACK_OF_A_DIFF_ITEM})}_signalIntent(e){this.services.dispatcher.publish(He.userActivityIntent,Object.assign({userInitiated:!0},e))}_validateAuthorization(t=!1){return __awaiter$1(this,void 0,void 0,(function*(){(t||this.playbackMode===e.PlaybackMode.FULL_PLAYBACK_ONLY)&&(void 0!==this._playbackControllerInternal&&this._playbackControllerInternal.isReady&&this._playbackControllerInternal.isPlaying||(yield this.authorize()))}))}}function dispatchDocumentEvent(e){if(ke)return;const t=new Event(e,{bubbles:!0,cancelable:!0});setTimeout(()=>document.dispatchEvent(t))}__decorate$1([AsyncDebounce(250,{isImmediate:!0,cancelledValue:void 0}),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[Object]),__metadata$1("design:returntype",Promise)],MKInstance.prototype,"pause",null),__decorate$1([AsyncDebounce(250,{isImmediate:!0,cancelledValue:void 0}),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[]),__metadata$1("design:returntype",Promise)],MKInstance.prototype,"play",null),__decorate$1([SerialAsync("skip"),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[]),__metadata$1("design:returntype",Promise)],MKInstance.prototype,"skipToNextItem",null),__decorate$1([SerialAsync("skip"),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[]),__metadata$1("design:returntype",Promise)],MKInstance.prototype,"skipToPreviousItem",null),__decorate$1([SerialAsync("seek"),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[]),__metadata$1("design:returntype",Promise)],MKInstance.prototype,"seekForward",null),__decorate$1([SerialAsync("seek"),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[]),__metadata$1("design:returntype",Promise)],MKInstance.prototype,"seekBackward",null);const en="undefined"!=typeof window&&"undefined"!=typeof document;let tn=!1;const rn=[];function configure$3(e,t=MKInstance,i){return __awaiter$1(this,void 0,void 0,(function*(){if(!e)throw new MKError(MKError.INVALID_ARGUMENTS,"configuration required");const r={},{developerToken:s,mergeQueryParams:n}=e;if(!s)throw new MKError(MKError.CONFIGURATION_ERROR,"Missing developer token");n&&en&&window.location&&(r.linkParameters=Object.assign(Object.assign({},e.linkParameters||{}),parseQueryParams(window.location.href))),yield findKeySystemPreference();const a=new t(s,Object.assign(Object.assign({},e),r));return tn||(yield function(){return __awaiter$1(this,void 0,void 0,(function*(){const e=rn.map(e=>e.cleanup());yield Promise.all(e),rn.splice(0,rn.length)}))}()),i&&(yield i(a)),rn.push(a),dispatchDocumentEvent(Hr.configured),a}))}function transformParameters(e,t=25){if(e)return e.limit&&(e.limit=e.limit>t?t:e.limit),e}function transformStoreData(e){const t=Object.assign({},e),{href:i}=t;return void 0!==i&&(delete t.href,t.attributes=Object.assign(Object.assign({},t.attributes),{href:i})),t}en&&(asAsync(function(){var e;return __awaiter$1(this,void 0,void 0,(function*(){if(ke)return;const t=findScript("musickit.js");if(""!==(null===(e=null==t?void 0:t.dataset)||void 0===e?void 0:e.webComponents))return;const i="noModule"in t,r=`components/musickit-components/musickit-components${i?".esm":""}.js`,s="https:"+cdnBaseURL(r)+r,n={};i&&(n.type="module"),t.hasAttribute("async")&&(n.async=""),t.hasAttribute("defer")&&(n.defer=""),yield loadScript(s,n),dispatchDocumentEvent(Hr.webComponentsLoaded)}))}()),dispatchDocumentEvent(Hr.loaded));function transformTrackParameters(e){return e.map(e=>"string"==typeof e?{id:e,type:"songs"}:{id:e.id,type:e.type||"songs"})}const sn=["extend","include","l","platform","views"];class LocalDataStore{constructor(e={}){this.enableDataStore=!1;let t=!1;e.features&&hasOwn(e.features,"api-data-store")&&(this.enableDataStore=!!e.features["api-data-store"]),e.features&&hasOwn(e.features,"disable-data-store-record-reuse")&&(t=!!e.features["disable-data-store-record-reuse"]),this.enableDataStore&&(this._store=e.store||new DataStore({shouldDisableRecordReuse:t}),this._store.mapping=transformStoreData)}get hasDataStore(){return this.enableDataStore&&void 0!==this._store}delete(e,t){this.hasDataStore&&this._store.remove(e,t)}read(e,t,i,r){r||"function"!=typeof i||(r=i,i=void 0);const s={};let n=!1;if(i&&(n=Object.keys(i).some(e=>/^(fields|extend)/.test(e)),i.views&&(s.views=i.views),i.include&&(s.relationships=i.include)),this.hasDataStore&&!n){let r,n=[];if(i&&(n=Object.keys(i).reduce((e,t)=>(-1===sn.indexOf(t)&&e.push([t,i[t]]),e),n)),r=n&&1===n.length?this._store.query(n[0][0],n[0][1]):this._store.peek(e,t,s),Array.isArray(r)){if(!i&&r.length)return r}else if(r)return r}if("function"==typeof r)return r()}write(e){return this._prepareDataForDataStore(e,e=>this._store.save(e))}parse(e){return this._prepareDataForDataStore(e,e=>this._store.populateDataRecords(e,{}))}_prepareDataForDataStore(e,t){return this.hasDataStore?Array.isArray(e)?t({data:e}):Object.keys(e).reduce((i,r)=>{const s=e[r];return hasOwn(s,"data")&&(i[r]=t({data:s.data})),"meta"===r&&(i[r]=e[r]),i},{}):e}}const ChunkedIdApi=(e,t=100,i=1e3)=>(r,s,n)=>{if(void 0===n||"function"!=typeof n.value)throw new TypeError(`Only methods can be decorated with @ChunkedIdApi, but ${s} is not a method.`);return{configurable:!0,get(){const r=n.value;function chunkedIdApi(...s){return __awaiter(this,void 0,void 0,(function*(){const n=s[e];if(n&&Array.isArray(n)){const a=n[0].length||20,o=Math.min(t,Math.floor(i/a)),l=Math.ceil(n.length/o);if(l>1){const t=s.slice(0,e),i=s.slice(e+1),a=[];let d=0;for(let e=1;e<=l;e++){const s=Math.min(e*o,n.length),l=[...t,n.slice(d,s),...i];a.push(r.apply(this,l)),d+=o}const c=yield Promise.all(a);return[].concat(...c)}}return r.apply(this,s)}))}return Object.defineProperty(this,s,{value:chunkedIdApi,configurable:!0,writable:!0}),chunkedIdApi}}},formatTimezoneOffset=(e=new Date)=>{const t=e.getTimezoneOffset(),i=Math.floor(Math.abs(t)/60),r=Math.round(Math.abs(t)%60);let s="+";return 0!==t&&(s=t>0?"-":"+"),`${s}${leadingZeros(i,2)}:${leadingZeros(r,2)}`},leadingZeros=(e,t=2)=>{let i=""+e;for(;i.length<t;)i="0"+i;return i};class Books extends TokenSession{constructor(e,t,i,r,s={},n){super("https://api.books.apple.com/v1",e,Object.assign(Object.assign({},n),{userToken:t,storage:r})),this.storefrontId=jr.ID,i&&(this.storefrontId=i),this._store=new LocalDataStore(s),this.defaultIncludePaginationMetadata=s.features&&hasOwn(s.features,"api-pagination-metadata")}audioBook(e,t,i){return this.resource("audio-books",e,t,i)}audioBooks(e,t,i){return this.collection("audio-books",e,t,i)}collection(e,t,i,r){return __awaiter(this,void 0,void 0,(function*(){const s=`catalog/${this.storefrontId}/${e}`;return t&&((i=i||{}).ids=t),makeRequest(this,s,i,r)}))}parseResultData(e,t){return e?this._store.write(t):this._store.parse(t)}resource(e,t,i,r){return __awaiter(this,void 0,void 0,(function*(){if(!(null==r?void 0:r.reload)){const r=this._store.read(e,t,i);if(r)return r}const[s]=yield this.collection(e,t,i,r);return s}))}}__decorate([ChunkedIdApi(1),__metadata("design:type",Function),__metadata("design:paramtypes",[String,Object,Object,Object]),__metadata("design:returntype",Promise)],Books.prototype,"collection",null);class Podcasts extends TokenSession{constructor(e,t,i=jr.ID,r,s={},n){super("https://amp-api.podcasts.apple.com/v1",e,Object.assign(Object.assign({},n),{userToken:t,storage:r})),this.storefrontId=i,this._store=new LocalDataStore(s),this.defaultIncludePaginationMetadata=s.features&&hasOwn(s.features,"api-pagination-metadata")}catalogResource(e,t,i,r){return this.resource(e,t,i,r)}catalogResources(e,t,i,r){return this.collection(e,t,i,r)}catalogResourceRelationship(e,t,i,r,s){return this.collection(`${e}/${t}/${i}`,void 0,r,s)}search(e,t,i){return this.collection("search",void 0,Object.assign({term:e,types:"podcasts"},t),i)}artist(e,t,i){return this.catalogResource("artists",e,t,i)}artists(e,t,i){return this.catalogResources("artists",e,t,i)}artistRelationship(e,t,i,r){return this.catalogResourceRelationship("artists",e,t,i,r)}charts(e,t,i){return this.catalogResources("charts",void 0,Object.assign({types:e},t),i)}podcast(e,t,i){return this.catalogResource("podcasts",e,Object.assign({include:"episodes"},t),i)}podcasts(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this.catalogResources("podcasts",e,Object.assign({include:"episodes"},t),i)}))}podcastRelationship(e,t,i,r){return __awaiter(this,void 0,void 0,(function*(){return this.catalogResourceRelationship("podcasts",e,t,i,r)}))}episode(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this.resource("podcast-episodes",e,t,i)}))}episodes(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this.catalogResources("podcast-episodes",e,t,i)}))}collection(e,t,i,r){return __awaiter(this,void 0,void 0,(function*(){let s;if(t){const r={};r["charts"===e?"types":"ids"]=t,s=Object.assign(r,i)}else s=i;return makeRequest(this,`catalog/${this.storefrontId}/${e}`,s,r)}))}parseResultData(e,t){return e?this._store.write(t):this._store.parse(t)}resource(e,t,i,r){return __awaiter(this,void 0,void 0,(function*(){if(!(null==r?void 0:r.reload)){const r=this._store.read(e,t,i);if(r)return r}const[s]=yield this.collection(e,t,i,r);return s}))}}__decorate([ChunkedIdApi(1),__metadata("design:type",Function),__metadata("design:paramtypes",[String,Object,Object,Object]),__metadata("design:returntype",Promise)],Podcasts.prototype,"collection",null);const nn=new Set(["editorial-items"]);class Fitness extends TokenSession{constructor(e,t,i=jr.ID,r,s={},n){var a;super("https://amp-api.fitness.apple.com/v1",e,Object.assign(Object.assign({},n),{userToken:t,storage:r})),this.storefrontId=jr.ID,this.storefrontId=i,this._store=new LocalDataStore(s),this.defaultIncludePaginationMetadata=!!(null===(a=null==s?void 0:s.features)||void 0===a?void 0:a["api-pagination-metadata"])}workout(e,t,i){return this.resource("workouts",e,t,i)}contributor(e,t,i){return this.resource("contributors",e,t,i)}editorialItem(e,t,i){return this.resource("editorial-items",e,t,i)}modalities(e,t,i){return this.collection("modalities",e,t,i)}modality(e,t,i){return this.resource("modalities",e,t,i)}workoutProgram(e,t,i){return this.resource("workout-programs",e,t,i)}collection(e,t,i,r){let s;s=t?Object.assign({ids:t},i):i;let n="catalog";nn.has(e)&&(n="editorial");return makeRequest(this,`${n}/${this.storefrontId}/${e}`,s,r)}parseResultData(e,t){return e?this._store.write(t):this._store.parse(t)}resource(e,t,i,r){return __awaiter(this,void 0,void 0,(function*(){const s=this._store.read(e,t,i);if(s)return s;const[n]=yield this.collection(e,t,i,r);return n}))}}__decorate([ChunkedIdApi(1),__metadata("design:type",Function),__metadata("design:paramtypes",[String,Object,Object,Object]),__metadata("design:returntype",Promise)],Fitness.prototype,"collection",null);class TVLibrary extends TokenSession{constructor(e,t,i,r={},s){super("https://amp-api.videos.apple.com/v1",e,Object.assign(Object.assign({},s),{userToken:t,storage:i})),this._store=new LocalDataStore(r),this.defaultIncludePaginationMetadata=r.features&&hasOwn(r.features,"api-pagination-metadata")}genres(e,t){return __awaiter(this,void 0,void 0,(function*(){return this.collection("genres",Object.assign({types:"tv-episodes,movies"},e),t)}))}movies(e,t){return __awaiter(this,void 0,void 0,(function*(){return this.collection("movies",e,t)}))}purchases(e,t){return __awaiter(this,void 0,void 0,(function*(){return this.collection("",Object.assign({types:"tv-episodes,movies"},e),t)}))}tvEpisodes(e,t){return __awaiter(this,void 0,void 0,(function*(){return this.collection("tv-episodes",e,t)}))}collection(e,t,i){return __awaiter(this,void 0,void 0,(function*(){try{return yield makeRequest(this,"me/purchases/"+e,t,i)}catch(Pt){if(Pt.name===MKError.CONTENT_UNAVAILABLE)return(null==i?void 0:i.includePagination)?{data:[],meta:{}}:[];throw Pt}}))}parseResultData(e,t){return e?this._store.write(t):this._store.parse(t)}}__decorate([ChunkedIdApi(1),__metadata("design:type",Function),__metadata("design:paramtypes",[String,Object,Object]),__metadata("design:returntype",Promise)],TVLibrary.prototype,"collection",null);const RecommendationUpdate=()=>(e,t,i)=>{if(void 0===i||"function"!=typeof i.value)throw new TypeError(`Only methods can be decorated with @RecommendationUpdate, but ${t} is not a method.`);return{configurable:!0,get(){const e=i.value;function recommendationUpdate(...t){return __awaiter(this,void 0,void 0,(function*(){const i=yield e.apply(this,t),r=new Map,s=[],n=new Date;if(!i||!Array.isArray(i))return i;if(i.forEach((e,t)=>{var i,a;const o=e.id,l=null!==(i=e.nextUpdateDate)&&void 0!==i?i:null===(a=e.attributes)||void 0===a?void 0:a.nextUpdateDate;if(!o||!l)return;new Date(l)<n&&(s.push(o),r.set(o,t))}),!s.length)return i;let[a,o,l,...d]=t;l=Object.assign(Object.assign({},l),{reload:!0});const c=[s,o,l,...d];return(yield e.apply(this,c)).forEach(e=>{const t=r.get(e.id);void 0!==t&&(i[t]=e)}),i}))}return Object.defineProperty(this,t,{value:recommendationUpdate,configurable:!0,writable:!0}),recommendationUpdate}}};function makeAlbumKey(e){var t;return(null===(t=e.artwork)||void 0===t?void 0:t.url)+""+e.artistName+""+e.name}class ServerLedger{constructor(e,t,i){this._data=this._initData(),this._catalogApi=t,this._storageKey="mk-server-ledger:"+(e||""),this._sessionStorage=i||getSessionStorage(),this.load()}_initData(){return{lastTimestamp:0,albums:{added:Object.create(null),removed:Object.create(null)},playlists:{added:Object.create(null),removed:Object.create(null)}}}_checkTimestamp(){const e=this._data.lastTimestamp;e&&e+24e5<Date.now()&&(this._data=this._initData(),this._sessionStorage&&this._sessionStorage.removeItem(this._storageKey))}added(e){this.load();const t=null==e?void 0:e.playlists,i=null==e?void 0:e.albums;return t||i?(t&&t.forEach(e=>{const t=Date.now();this._data.playlists.added[e]=t,this._data.lastTimestamp=t}),i&&i.forEach(e=>{const t=Date.now();this._data.albums.added[e]=t,this._data.lastTimestamp=t}),this.save(),e):e}removed(e){this.load();const t=null==e?void 0:e.playlists;return t?(ensureArray(t).forEach(e=>{if(0!==e.indexOf("pl.")){const t=Date.now();this._data.playlists.removed[e]=t,this._data.lastTimestamp=t}}),this.save(),e):e}reconcile(e,t,i,r,s){var n,a;return __awaiter(this,void 0,void 0,(function*(){this._checkTimestamp();const s=t.data||t;if(!s||!Array.isArray(s)||Array.isArray(i))return t;const o=this._data.albums.added,l=this._data.playlists.removed,d=this._data.playlists.added,c=[],u=r&&!r.offset||!!i&&(void 0===i.offset||0===i.offset);let h=!1;if("all"===e||"playlists"===e){for(let e=s.length-1;e>=0;e--){const t=s[e],i=null===(n=t.playParams)||void 0===n?void 0:n.globalId;"library-playlists"===t.type&&(l[t.id]?s.splice(e,1):i&&d[i]&&(delete d[i],h=!0,u||s.splice(e,1)))}if(u&&this._catalogApi){const e=Object.keys(d);if(e.length){const t=yield this._catalogApi.playlists(e);c.splice(0,0,...t)}}}if(this._catalogApi&&("all"===e||"albums"===e)){const e=Object.keys(o);if(e.length){const t=yield this._catalogApi.albums(e),i=Object.create(null);t.forEach((t,r)=>{const s=makeAlbumKey(t);i[s]={catalogId:e[r],album:t}});for(let e=s.length-1;e>=0;e--){const t=s[e];if(null===(a=t.playParams)||void 0===a||a.globalId,"library-albums"===t.type){const r=makeAlbumKey(t),n=i[r];n&&(delete o[n.catalogId],h=!0,u?delete i[r]:s.splice(e,1))}}if(u){const e=Object.keys(i).map(e=>i[e].album);e.length&&c.splice(0,0,...e)}}}if(h&&this.save(),u&&c.length&&(c.sort((e,t)=>{const i=this._data.albums.added[e.id]||this._data.playlists.added[e.id]||0;return(this._data.albums.added[t.id]||this._data.playlists.added[t.id]||0)-i}),s.splice(0,0,...c)),!s.length)throw new MKError(MKError.CONTENT_UNAVAILABLE,"The requested content is not available.");const p=t.meta;return p&&void 0===p.total&&(p.total=s.length),t}))}load(){if(!this._sessionStorage)return;const e=this._sessionStorage.getItem(this._storageKey);if(e)try{this._data=JSON.parse(e),this._data.albums&&this._data.playlists||(this._data=this._initData())}catch(t){this._data||(this._data=this._initData())}else this._data=this._initData()}save(){if(!this._sessionStorage)return;const e=this._data,t=0===Object.keys(e.albums.added).length&&0===Object.keys(e.albums.removed).length&&0===Object.keys(e.playlists.added).length&&0===Object.keys(e.playlists.removed).length;try{if(t)this._sessionStorage.getItem(this._storageKey)&&this._sessionStorage.removeItem(this._storageKey);else{const e=JSON.stringify(this._data);this._sessionStorage.setItem(this._storageKey,e)}}catch(i){}}}const an="me/library";class Library extends TokenSession{constructor(e,t,i,r={},s,n){super(e,t,Object.assign(Object.assign({},n),{userToken:i})),this._last=0,this._store=new LocalDataStore(r),this._serverLedger=new ServerLedger(i,s),this.defaultIncludePaginationMetadata=r.features&&hasOwn(r.features,"api-pagination-metadata")}add(e){return __awaiter(this,void 0,void 0,(function*(){const t=transformKeys(e,dasherize),i=Date.now();if(i-this._last<1e3)return Promise.reject(new MKError(MKError.QUOTA_EXCEEDED));const r=new Headers({Authorization:"Bearer "+this.developerToken,[br]:this.userToken}),s=Object.keys(t).map(e=>`ids[${e}]=${t[e].join(",")}`).join("&");try{const e=yield fetch(`${this.url}/${an}?${s}`,{method:"POST",headers:r});return e.ok?(this._last=i,this._serverLedger.added(t)):Promise.reject(MKError.responseError(e))}catch(n){return Promise.reject(MKError.responseError(n))}}))}remove(e){return __awaiter(this,void 0,void 0,(function*(){if(!this.developerToken||!this.userToken)return Promise.reject("Invalid tokens");const t=new Headers({Authorization:"Bearer "+this.developerToken,[br]:this.userToken}),i=transformKeys(e,dasherize),r=Object.keys(i)[0],s=Object.values(i)[0];try{const e=yield fetch(`${this.url}/${an}/${r}/${s}`,{method:"DELETE",headers:t});return e.ok?this._serverLedger.removed(i):Promise.reject(MKError.responseError(e))}catch(n){return Promise.reject(MKError.responseError(n))}}))}album(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this.resource("albums",e,t,i)}))}albumRelationship(e,t,i,r){return __awaiter(this,void 0,void 0,(function*(){return this.collection(`albums/${e}/${t}`,void 0,i,r)}))}albums(e,t,i){return __awaiter(this,void 0,void 0,(function*(){let r;try{r=yield this.collection("albums",e,t,Object.assign(Object.assign({},i),{shouldCacheResults:!1}))}catch(s){if(s.errorCode!==MKError.CONTENT_UNAVAILABLE)throw s;r={data:[],meta:{}}}return this._serverLedger.reconcile("albums",r,e,t,i)}))}artist(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this.resource("artists",e,t,i)}))}artistRelationship(e,t="albums",i,r){return __awaiter(this,void 0,void 0,(function*(){return this.collection(`artists/${e}/${t}`,void 0,i,r)}))}artists(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this.collection("artists",e,t,i)}))}createPlaylist(e={},t){return __awaiter(this,void 0,void 0,(function*(){let i;const{name:r,description:s,tracks:n=[]}=e,a={attributes:{name:r,description:s},relationships:{tracks:{data:transformTrackParameters(n)}}},o=JSON.stringify(a);try{i=yield this.request(an+"/playlists",t,{body:o,method:"POST"})}catch(Pt){return Promise.reject(MKError.responseError(Pt))}try{const[e]=this._store.write(i);return e}catch(Pt){return Promise.reject(MKError.parseError(Pt))}}))}deletePlaylist(e,t){return __awaiter(this,void 0,void 0,(function*(){let i;const r=`${an}/playlists/${e}`;try{i=yield this.request(r,t,{method:"DELETE"})}catch(Pt){return Promise.reject(MKError.responseError(Pt))}this.purgePlaylistFromCaches(e)}))}editPlaylist(e,t,i){return __awaiter(this,void 0,void 0,(function*(){let r;const s=JSON.stringify({attributes:t});try{r=yield this.request(`${an}/playlists/${e}`,i,{body:s,method:"PATCH"})}catch(Pt){return Promise.reject(MKError.responseError(Pt))}try{const i=t,r="library-playlists";return this._store.write({data:[{type:r,id:e,attributes:i}]}),t}catch(Pt){return Promise.reject(MKError.parseError(Pt))}}))}updatePlaylistTracklist(e,t){return __awaiter(this,void 0,void 0,(function*(){yield this.putPlaylistTracklisting(e,t,"PUT"),this.purgePlaylistFromCaches(e)}))}appendTracksToPlaylist(e,t){return __awaiter(this,void 0,void 0,(function*(){yield this.putPlaylistTracklisting(e,t,"POST"),this.purgePlaylistFromCaches(e)}))}playlistFolder(e,t,i){return this.resource("playlist-folders",e,t,i)}playlistFolders(e,t,i){return this.collection("playlist-folders",e,t,i)}playlistFoldersRoot(e,t){return e=Object.assign(Object.assign({},e),{filter:Object.assign(Object.assign({},null==e?void 0:e.filter),{identity:"playlistsroot"})}),this.playlistFolders(void 0,e,t)}playlistFolderChildren(e,t,i){const r=`playlist-folders/${e}/children`;return this.collection(r,void 0,t,i)}musicVideo(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this.resource("music-videos",e,t,i)}))}musicVideos(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this.collection("music-videos",e,t,i)}))}parseResultData(e,t){return e?this._store.write(t):this._store.parse(t)}playlist(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return t=Object.assign({include:"tracks"},t),this.resource("playlists",e,t,i)}))}createCatalogPlaylist(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return i=Object.assign({method:"POST"},i),this.resource(`playlists/${e}/catalog`,void 0,t,i)}))}playlistRelationship(e,t="tracks",i,r){return __awaiter(this,void 0,void 0,(function*(){return this.collection(`playlists/${e}/${t}`,void 0,i,r)}))}playlists(e,t,i){return __awaiter(this,void 0,void 0,(function*(){let r;try{r=e&&e.length>0?yield Promise.all(e.map(e=>this.playlist(e,t,i))):yield this.collection("playlists",e,t,Object.assign(Object.assign({},i),{shouldCacheResults:!1}))}catch(s){if(s.errorCode!==MKError.CONTENT_UNAVAILABLE)throw s;r={data:[],meta:{}}}return this._serverLedger.reconcile("playlists",r,e,t,i)}))}recentlyAdded(e,t){return __awaiter(this,void 0,void 0,(function*(){const i=null==e?void 0:e.limit;let r;try{r=yield this.collection("recently-added",void 0,transformParameters(e,i||10),Object.assign(Object.assign({},t),{shouldCacheResults:!1}))}catch(s){if(s.errorCode!==MKError.CONTENT_UNAVAILABLE)throw s;r={data:[],meta:{}}}return this._serverLedger.reconcile("all",r,void 0,e,t)}))}search(e,t,i){return __awaiter(this,void 0,void 0,(function*(){t=this._denormalizeLibraryTypes(t);const r=Object.assign({term:e,types:"library-albums"},t);return this.collection("search",void 0,r,Object.assign(Object.assign({},i),{shouldCacheResults:!1}))}))}song(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this.resource("songs",e,t,i)}))}songRelationship(e,t,i,r){return __awaiter(this,void 0,void 0,(function*(){return this.collection(`songs/${e}/${t}`,void 0,i,r)}))}songs(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this.collection("songs",e,t,i)}))}collection(e,t,i,r){return __awaiter(this,void 0,void 0,(function*(){!t||t.length||i||(i=transformParameters(t,100),t=void 0);const s=t?Object.assign({ids:t},i):i;return makeRequest(this,`${an}/${e}`,s,r)}))}resource(e,t,i,r){return __awaiter(this,void 0,void 0,(function*(){if(!(null==r?void 0:r.reload)){const r=this._store.read(e,t,i);if(r)return r}let s=`${an}/${e}`;t&&(s=`${s}/${t}`);const[n]=yield makeRequest(this,s,i,r);return n}))}purgePlaylistFromCaches(e){this._store.delete("library-playlists",e),this.networkCache.removeItemsMatching(this.constructURL(`${an}/playlists/${e}`,{}),!1)}putPlaylistTracklisting(e,t,i="PUT"){return __awaiter(this,void 0,void 0,(function*(){const r=transformTrackParameters(t),s=JSON.stringify({data:r});try{yield this.request(`${an}/playlists/${e}/tracks`,void 0,{body:s,method:i})}catch(Pt){return Promise.reject(MKError.responseError(Pt))}}))}_denormalizeLibraryTypes(e={},t="types"){let i=e[t];return i?("string"==typeof i&&(i=i.split(",")),e[t]=i.map(e=>e.replace(/^(albums|music-videos|playlists|songs)$/,"library-$1")),e):e}}var on,ln;__decorate([ChunkedIdApi(1),__metadata("design:type",Function),__metadata("design:paramtypes",[String,Object,Object,Object]),__metadata("design:returntype",Promise)],Library.prototype,"collection",null),function(e){e[e.Global=0]="Global",e.Lyrics="lyrics",e.Catalog="catalog",e.Personalized="me",e.Editorial="editorial",e.Engagement="engagement",e.Social="social"}(on||(on={})),function(e){e.songs="songs",e.albums="albums",e.playlists="playlists",e.stations="stations",e["music-videos"]="music-videos",e["library-music-videos"]="library-music-videos",e["library-playlists"]="library-playlists",e["library-songs"]="library-songs"}(ln||(ln={}));class API$1 extends TokenSession{constructor(e,t,i,r,s,n,a={},o){super(e,t,Object.assign(Object.assign({},o),{userToken:r,storage:n})),this.storefrontId=jr.ID,this.resourceRelatives={artists:{albums:{include:"tracks"},playlists:{include:"tracks"},songs:null}},this.defaultIncludePaginationMetadata=a.features&&hasOwn(a.features,"api-pagination-metadata"),this._store=new LocalDataStore(a),i&&(this.storefrontId=i.toLowerCase()),r&&s&&(this.userStorefrontId=s.toLowerCase()),this._podcastsAPI=new Podcasts(t,r,i,n,a,Object.assign({},o)),this.fitness=new Fitness(t,r,i,n,a,Object.assign({},o)),this.tvLibrary=new TVLibrary(t,r,n,a,Object.assign({},o)),this.library=new Library(e,t,r,a,this,Object.assign({},o)),this.books=new Books(t,r,i,n,a,Object.assign({},o)),this.v3=new MediaAPIV3({developerToken:t,mediaUserToken:r,storefrontId:i,realmConfig:{music:{url:e.replace(/\/v[0-9]+(\/)?$/,"")}}})}get needsEquivalents(){const{userStorefrontId:e}=this;return void 0!==e&&""!==e&&e!==this.storefrontId}activity(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this.resource(on.Catalog,"activities",e,t,i)}))}activities(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this.collection(on.Catalog,"activities",e,t,i)}))}album(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this.resource(on.Catalog,"albums",e,t,i)}))}albumRelationship(e,t,i,r){return __awaiter(this,void 0,void 0,(function*(){return this.collection(on.Catalog,`albums/${e}/${t}`,void 0,i,r)}))}albums(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this.collection(on.Catalog,"albums",e,t,i)}))}appleCurator(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this.resource(on.Catalog,"apple-curators",e,t,i)}))}appleCurators(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this.collection(on.Catalog,"apple-curators",e,t,i)}))}artist(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this.resource(on.Catalog,"artists",e,t,i)}))}artistRelationship(e,t,i,r){return __awaiter(this,void 0,void 0,(function*(){return this.collection(on.Catalog,`artists/${e}/${t}`,void 0,i,r)}))}artistView(e,t,i,r){return this.collection(on.Catalog,`artists/${e}/view/${t}`,void 0,i,r)}artists(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this.collection(on.Catalog,"artists",e,t,i)}))}audioBook(e,t,i){return this.books.audioBook(e,t,i)}audioBooks(e,t,i){return this.books.audioBooks(e,t,i)}catalogResources(e,t={},i){const r=function(e){const t={};if(!e)return t;for(const i of e){if(!i)continue;const{type:e,id:r}=i;e in t||(t[e]=[]),t[e].push(r)}return t}(e);return t=Object.assign(Object.assign({},t),{ids:r}),makeRequest(this,`${on.Catalog}/${this.storefrontId}`,t,i)}changeStation(e,t,i={}){return __awaiter(this,void 0,void 0,(function*(){return yield makeRequest(this,"me/stations/change-station/"+e,t,Object.assign(Object.assign({},i),{reload:!0,method:"POST",shouldCacheResults:!1}))}))}charts(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this.collection(on.Catalog,"charts",e,t,Object.assign(Object.assign({},i),{returnRawJSONApiRecords:!0}))}))}contents(e,t,i){return this.collection(on.Catalog,"contents",e,t,i)}curator(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this.resource(on.Catalog,"contents",e,t,i)}))}curators(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this.collection(on.Catalog,"contents",e,t,i)}))}curatorRelationship(e,t,i,r){return __awaiter(this,void 0,void 0,(function*(){return this.collection(on.Catalog,`curators/${e}/${t}`,void 0,i,r)}))}episode(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this._podcastsAPI.catalogResource("podcast-episodes",e,t,i)}))}episodes(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this._podcastsAPI.catalogResources("podcast-episodes",e,t,i)}))}genre(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this.resource(on.Catalog,"genres",e,t,i)}))}genres(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this.collection(on.Catalog,"genres",e,t,i)}))}grouping(e,t,i){return __awaiter(this,void 0,void 0,(function*(){!t&&isObject$1(e)&&(t=e,e=void 0);const r={platform:"desktop"},s=Object.assign(Object.assign({},r),t);return this.resource(on.Editorial,"groupings",e,s,Object.assign(Object.assign({},i),{shouldCacheResults:!1}))}))}groupings(e,t={},i){return __awaiter(this,void 0,void 0,(function*(){const r={platform:"desktop"},s=Object.assign(Object.assign({},r),t);return this.collection(on.Editorial,"groupings",e,s,Object.assign(Object.assign({},i),{shouldCacheResults:!1}))}))}lyric(e,t,i){return this.resource(on.Catalog,`songs/${e}/lyrics`,"",t,Object.assign({reload:!0},i))}lyricSnippet(e,t,i){return this.collection(on.Lyrics,"snippet/songs",e,t,Object.assign(Object.assign({},i),{returnRawJSONApiRecords:!0}))}historyHeavyRotation(e,t){return __awaiter(this,void 0,void 0,(function*(){return this.collection(on.Personalized,"history/heavy-rotation",void 0,transformParameters(e,10),t)}))}multiplex(e,t,i){return __awaiter(this,void 0,void 0,(function*(){const r=this._store.read("multiplex",e,t);return r||(i=Object.assign({returnRawJSONApiRecords:!0},i),makeRequest(this,`${on.Editorial}/${this.storefrontId}/multiplex/${e}`,t,i))}))}multiroom(e,t,i){return __awaiter(this,void 0,void 0,(function*(){const r=this._store.read("multirooms",e,t);if(r)return r;const[s]=yield this.collection(on.Editorial,"multirooms/"+e,void 0,t,i);return s}))}musicMovie(e,t,i){return this.resource(on.Catalog,"music-movies",e,t,i)}musicMovies(e,t,i){return this.collection(on.Catalog,"music-movies",e,t,i)}musicVideo(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this.resource(on.Catalog,"music-videos",e,t,i)}))}musicVideos(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this.collection(on.Catalog,"music-videos",e,t,i)}))}nextStationTracks(e,t,i={}){var r;return __awaiter(this,void 0,void 0,(function*(){const s=null!==(r=i.queryParameters)&&void 0!==r?r:{};(null==t?void 0:t.clean)&&(s.clean=t.clean,delete t.clean),(null==t?void 0:t.limit)&&(s.limit=t.limit,delete t.limit);return yield makeRequest(this,"me/stations/next-tracks/"+e,t,Object.assign(Object.assign({},i),{reload:!0,method:"POST",queryParameters:s,shouldCacheResults:!1}))}))}continuousStation(e,t,i={}){return __awaiter(this,void 0,void 0,(function*(){return yield makeRequest(this,"me/stations/continuous",e,Object.assign(Object.assign({},i),{reload:!0,method:"POST",queryParameters:t,returnRawJSONApiRecords:!0,shouldCacheResults:!1}))}))}playlist(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this.resource(on.Catalog,"playlists",e,t,i)}))}playlistRelationship(e,t,i,r){return __awaiter(this,void 0,void 0,(function*(){return this.collection(on.Catalog,`playlists/${e}/${t}`,void 0,i,r)}))}playlists(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this.collection(on.Catalog,"playlists",e,t,i)}))}podcast(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this._podcastsAPI.catalogResource("podcasts",e,Object.assign({include:"episodes"},t),i)}))}podcastRelationship(e,t,i,r){return __awaiter(this,void 0,void 0,(function*(){return this._podcastsAPI.catalogResourceRelationship("podcasts",e,t,i,r)}))}podcasts(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this._podcastsAPI.catalogResources("podcasts",e,Object.assign({include:"episodes"},t),i)}))}recentPlayed(e,t){return __awaiter(this,void 0,void 0,(function*(){return this.collection(on.Personalized,"recent/played",void 0,transformParameters(e,10),t)}))}recentRadioStations(e,t){return __awaiter(this,void 0,void 0,(function*(){return this.collection(on.Personalized,"recent/radio-stations",void 0,transformParameters(e,10),t)}))}recordLabel(e,t,i){return this.resource(on.Catalog,"record-labels",e,t,i)}recordLabels(e,t,i){return this.collection(on.Catalog,"record-labels",e,t,i)}recordLabelView(e,t,i,r){return this.collection(on.Catalog,`record-labels/${e}/view/${t}`,void 0,i,r)}personalRecommendation(e,t,i,r=!0){return __awaiter(this,void 0,void 0,(function*(){const s=yield this.personalRecommendations(e,t,i,r),[n]=s;return n}))}refreshPersonalRecommendation(e,t,i){const r=formatTimezoneOffset();return t=Object.assign({timezone:r},t),i=Object.assign(Object.assign({},i),{method:"POST",queryParameters:t}),this.resource(on.Personalized,"recommendations",e,void 0,i)}personalRecommendations(e,t,i={},r=!0){return __awaiter(this,void 0,void 0,(function*(){const s=formatTimezoneOffset(),n=yield this.collection(on.Personalized,"recommendations",e,Object.assign({timezone:s},t),Object.assign(Object.assign({},i),{shouldCacheResults:r,returnRawJSONApiRecords:!0}));this._reindexRelationships(n,"recommendations");try{return mapRequestResult(n,e=>this.parseResultData(!1,e))}catch(Pt){return Promise.reject(MKError.parseError(Pt))}}))}personalRecommendationView(e,t,i,r={}){return __awaiter(this,void 0,void 0,(function*(){return this.collection(on.Personalized,`recommendations/${e}/view/${t}`,void 0,i,r)}))}recommendations(e,t,i={}){return __awaiter(this,void 0,void 0,(function*(){const r=formatTimezoneOffset(),s=yield this.collection(on.Global,"recommendations/"+this.storefrontId,e,Object.assign({timezone:r},t),Object.assign(Object.assign({},i),{shouldCacheResults:!1,returnRawJSONApiRecords:!0}));this._reindexRelationships(s,"recommendations");try{return mapRequestResult(s,e=>this.parseResultData(!1,e))}catch(Pt){return Promise.reject(MKError.parseError(Pt))}}))}recommendedFriends(e,t,i={}){return i=Object.assign(Object.assign({},i),{method:"POST",body:JSON.stringify(Object.assign({ids:{socialProfiles:e}},i.body))}),this.collection(on.Global,"social/recommended-friends",void 0,t,Object.assign(Object.assign({},i),{shouldCacheResults:!1,returnRawJSONApiRecords:!0}))}room(e,t,i){return __awaiter(this,void 0,void 0,(function*(){const r=this._store.read("rooms",e,t);if(r&&r.hasAttributes("title"))return r;const s=yield this.collection(on.Editorial,"rooms/"+e,void 0,t,i),[n]=s;return n}))}roomContents(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this.collection(on.Editorial,`rooms/${e}/contents`,void 0,t,i)}))}search(e,t,i){return __awaiter(this,void 0,void 0,(function*(){const r=Object.assign({term:e},t);return i=Object.assign(Object.assign({},i),{useRawResponse:!0}),this.collection(on.Catalog,"search",void 0,r,Object.assign(Object.assign({},i),{shouldCacheResults:!1}))}))}searchHints(e,t,i){return __awaiter(this,void 0,void 0,(function*(){const r=Object.assign({term:e},t),s=yield this.collection(on.Catalog,"search/hints",void 0,r,Object.assign(Object.assign({},i),{returnRawJSONApiRecords:!0}));return"topResults"===(null==r?void 0:r.with)&&"topResults"in s&&(s.topResults=this.parseResultData(!0,s.topResults)),s}))}searchQuery(e,t){return __awaiter(this,void 0,void 0,(function*(){return t=Object.assign(Object.assign({},t),{useRawResponse:!0}),this.collection(on.Catalog,"search/query",void 0,e,Object.assign(Object.assign({},t),{shouldCacheResults:!1}))}))}searchSuggestions(e,t,i){var r;return __awaiter(this,void 0,void 0,(function*(){t=Object.assign({term:e},t);const s=yield this.collection(on.Catalog,"search/suggestions",void 0,t,Object.assign(Object.assign({},i),{returnRawJSONApiRecords:!0}));return Array.isArray(null===(r=s)||void 0===r?void 0:r.suggestions)&&s.suggestions.forEach(e=>{"topResults"===e.kind&&(e.content=this.parseResultData(!0,[e.content])[0])}),s}))}socialBadgingMap(e,t){return this.collection(on.Global,"social/badging-map",void 0,e,Object.assign(Object.assign({},t),{returnRawJSONApiRecords:!0}))}socialProfile(e,t,i){return this.resource(on.Social,"social-profiles",e,t,i)}socialProfiles(e,t,i){return this.collection(on.Social,"social-profiles",e,t,i)}personalSocialProfile(e,t){return this.resource(on.Personalized,"social-profile",void 0,e,t)}socialPost(e,t={},i){return __awaiter(this,void 0,void 0,(function*(){e.startsWith("sa.")?t.filter={post:e}:t.ids=e;const[r]=yield this.collection(on.Catalog,"contents","",t,i);return r}))}socialSearch(e,t={},i){return __awaiter(this,void 0,void 0,(function*(){return t=Object.assign(Object.assign({},t),{term:e}),this.collection(on.Social,"search",void 0,t,i)}))}song(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this.resource(on.Catalog,"songs",e,t,i)}))}songRelationship(e,t,i,r){return __awaiter(this,void 0,void 0,(function*(){return this.collection(on.Catalog,`songs/${e}/${t}`,void 0,i,r)}))}songs(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return!t&&isObject$1(e)&&(t=e,e=void 0),this.collection(on.Catalog,"songs",e,t,i)}))}tastePreferences(e,t){return __awaiter(this,void 0,void 0,(function*(){return this.collection(on.Personalized,"taste/taste-preferences",void 0,e,Object.assign(Object.assign({},t),{shouldCacheResults:!1}))}))}saveTastePreferences(e){return __awaiter(this,void 0,void 0,(function*(){e=e.map(e=>e instanceof DataRecord?e.serialize().data:e);const t={method:"POST",body:JSON.stringify({data:e}),shouldCacheResults:!0};try{return yield makeRequest(this,"me/taste/taste-preferences",void 0,t)}catch(Pt){return Pt.name===MKError.CONTENT_UNAVAILABLE?[]:Promise.reject(MKError.parseError(Pt))}}))}tvEpisode(e,t,i){return this.resource(on.Catalog,"tv-episodes",e,Object.assign({include:"seasons"},t),i)}tvEpisodes(e,t,i){return this.collection(on.Catalog,"tv-episodes",e,Object.assign({include:"seasons"},t),i)}tvSeason(e,t,i){return this.resource(on.Catalog,"tv-seasons",e,Object.assign({include:"episodes"},t),i)}tvSeasons(e,t,i){return this.collection(on.Catalog,"tv-seasons",e,Object.assign({include:"episodes"},t),i)}tvShow(e,t,i){return this.resource(on.Catalog,"tv-shows",e,t,i)}tvShows(e,t,i){return this.collection(on.Catalog,"tv-shows",e,t,i)}uploadedAudio(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return t=Object.assign({include:"curator,artists"},t),this.resource(on.Catalog,"uploaded-audios",e,t,i)}))}uploadedAudios(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return t=Object.assign({include:"curator,artists"},t),this.collection(on.Catalog,"uploaded-audios",e,t,i)}))}uploadedVideo(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return t=Object.assign({include:"curator,artists"},t),this.resource(on.Catalog,"uploaded-videos",e,t,i)}))}uploadedVideos(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return t=Object.assign({include:"curator,artists"},t),this.collection(on.Catalog,"uploaded-videos",e,t,i)}))}upsellMarketingItems(e,t){return this.collection(on.Engagement,"upsell/marketing-items",void 0,e,t)}station(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this.resource(on.Catalog,"stations",e,t,i)}))}stations(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return!t&&isObject$1(e)&&(t=e,e=void 0),this.collection(on.Catalog,"stations",e,t,i)}))}storefront(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this.resource(on.Global,"storefronts",e,t,i)}))}storefronts(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this.collection(on.Global,"storefronts",e,t,i)}))}musicSummary(e,t,i){return __awaiter(this,void 0,void 0,(function*(){return this.resource(on.Personalized,"music-summaries",e,t,i)}))}musicSummarySearch(e={},t){return __awaiter(this,void 0,void 0,(function*(){return this.collection(on.Personalized,"music-summaries/search",void 0,e,t)}))}addToLibrary(e){return __awaiter(this,void 0,void 0,(function*(){return this.developerToken&&this.userToken&&this.library?this.library.add(e):Promise.reject("Invalid tokens")}))}rating(e,t,i){return __awaiter(this,void 0,void 0,(function*(){const[r]=yield this.ratings(e,t,i);return r}))}ratings(e,t,i){if(!this.developerToken||!this.userToken)return Promise.reject("Invalid tokens");const[r]=Object.keys(e),s=e[r],n=Array.isArray(s);if(n&&0===s.length)return Promise.resolve([]);let a="me/ratings/"+formatRatingsContentType(r,n?s[0]:s);return n?t=Object.assign(Object.assign({},t),{ids:s.map(normalizeAdamId)}):a=`${a}/${normalizeAdamId(s)}`,makeRequest(this,a,t,Object.assign({shouldCacheResults:!1,reload:!0,includePagination:!1},i))}putRating(e,t,i){return __awaiter(this,void 0,void 0,(function*(){if(!this.developerToken||!this.userToken)return Promise.reject("Invalid tokens");const[r]=Object.keys(e),s=e[r],n=formatRatingsContentType(r,s),a={method:"PUT",body:JSON.stringify({type:"rating",attributes:{value:t}}),includePagination:!1},o=yield makeRequest(this,`me/ratings/${n}/${normalizeAdamId(s)}`,i,Object.assign({shouldCacheResults:!1},a)),[l]=o;return l}))}deleteRating(e,t){return __awaiter(this,void 0,void 0,(function*(){if(!this.developerToken||!this.userToken)return Promise.reject("Invalid tokens");const[i]=Object.keys(e),r=e[i],s=formatRatingsContentType(i,r);if(Array.isArray(r))return Promise.all(r.map(e=>this.deleteRating({[i]:e},t))).then(()=>{});yield makeRequest(this,`me/ratings/${s}/${r}`,t,{method:"DELETE",shouldCacheResults:!1,returnRawJSONApiRecords:!0});try{this._store.delete(s,r)}catch(Pt){return Promise.reject(MKError.parseError(Pt))}}))}equivalent(e,t){return __awaiter(this,void 0,void 0,(function*(){let i=`catalog/${this.userStorefrontId}/${e}`,r={};switch(e){case"albums":case"songs":r={"filter[equivalents]":t};break;case"artists":case"playlists":i=`${i}/${t}`;break;default:return Promise.reject(new MKError(MKError.INVALID_ARGUMENTS,"Invalid equivalent type"))}return this.resource(on.Global,i,"",r)}))}collection(e,t,i,r,s){return __awaiter(this,void 0,void 0,(function*(){let n,a,o=null==s?void 0:s.shouldCacheResults;switch(n=i?Object.assign({["charts"===t?"types":"ids"]:i},r):r,e){case on.Catalog:case on.Editorial:case on.Engagement:case on.Social:case on.Lyrics:const i=this.storefrontId;a=`${e}/${i}/${t}`;break;case on.Global:a=t;break;case on.Personalized:a=`${e}/${t}`,o=!1}return makeRequest(this,a,n,Object.assign(Object.assign({},s),{shouldCacheResults:o}))}))}parseResultData(e,t){return e?this._store.write(t):this._store.parse(t)}resource(e,t,i,r,s){return __awaiter(this,void 0,void 0,(function*(){if(!(null==s?void 0:s.reload)){const e=this._store.read(t,i,r);if(e)return e}const[n]=yield this.collection(e,t,i,r,s);return n}))}_reindexRelationships(e,t){("data"in e?e.data:e).forEach(e=>{hasOwn(e,"relationships")&&hasOwn(e.relationships,t)&&hasOwn(e.relationships[t],"data")&&Array.isArray(e.relationships[t].data)&&e.relationships[t].data.forEach((e,t)=>{e.id=`${e.id}-${t}`})})}}let dn;__decorate([RecommendationUpdate(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object,Object,Object]),__metadata("design:returntype",Promise)],API$1.prototype,"personalRecommendations",null),__decorate([RecommendationUpdate(),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object,Object]),__metadata("design:returntype",Promise)],API$1.prototype,"recommendations",null),__decorate([ChunkedIdApi(2),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,String,Object,Object,Object]),__metadata("design:returntype",Promise)],API$1.prototype,"collection",null);const cn={album:{isPlural:!1,apiMethod:"album",relationshipMethod:{method:"albumRelationship",relationship:"tracks"}},albums:{isPlural:!0,apiMethod:"albums"},audioBook:{isPlural:!1,apiMethod:"audioBook"},audioBooks:{isPlural:!0,apiMethod:"audioBooks"},episode:{isPlural:!1,apiMethod:"episode"},episodes:{isPlural:!0,apiMethod:"episodes"},musicVideo:{isPlural:!1,apiMethod:"musicVideo"},musicVideos:{isPlural:!0,apiMethod:"musicVideos"},musicMovie:{isPlural:!1,apiMethod:"musicMovie"},musicMovies:{isPlural:!0,apiMethod:"musicMovies"},podcast:{isPlural:!1,apiMethod:"podcast"},podcasts:{isPlural:!0,apiMethod:"podcasts"},playlist:{isPlural:!1,apiMethod:"playlist",relationshipMethod:{method:"playlistRelationship",relationship:"tracks"}},playlists:{isPlural:!0,apiMethod:"playlists"},song:{isPlural:!1,apiMethod:"song"},songs:{isPlural:!0,apiMethod:"songs"},tvEpisode:{isPlural:!1,apiMethod:"tvEpisode"},tvEpisodes:{isPlural:!0,apiMethod:"tvEpisodes"},uploadedAudio:{isPlural:!1,apiMethod:"uploadedAudio"},uploadedAudios:{isPlural:!0,apiMethod:"uploadedAudios"},uploadedVideo:{isPlural:!1,apiMethod:"uploadedVideo"},uploadedVideos:{isPlural:!0,apiMethod:"uploadedVideos"}};class MediaAPIService{constructor(e){if(this._dispatcher=e,!Yr.urls.mediaApi)throw new Error("bag.urls.mediaApi is not configured");this.url=Yr.urls.mediaApi,this.namedQueueOptions=cn,this._dispatcher.subscribe(He.apiStorefrontChanged,(e,{storefrontId:t})=>__awaiter$1(this,void 0,void 0,(function*(){yield this._updateStorefrontId(t)})))}get api(){if(void 0===this._api)throw new MKError(MKError.CONFIGURATION_ERROR,"The API cannot be accessed before it is configured.");return this._api}get storefrontId(){return this.store&&this.store.storefrontId}configure(e){return __awaiter$1(this,void 0,void 0,(function*(){if(void 0!==e.store)return this.store=e.store,[Hr.authorizationStatusDidChange,Hr.userTokenDidChange,Hr.storefrontIdentifierDidChange,Hr.storefrontCountryCodeDidChange].forEach(e=>{this.store.storekit.addEventListener(e,()=>this.resetAPI())}),this._initializeAPI(e),this}))}clear(){this.api&&this.api.clearNetworkCache&&this.api.clearNetworkCache()}getAPIForItem(e){return __awaiter$1(this,void 0,void 0,(function*(){return r(e)?(yield this.store.authorize(),this.api.library||this.api):this.api}))}resetAPI(){return __awaiter$1(this,void 0,void 0,(function*(){this.clear(),this._initializeAPI()}))}_initializeAPI(e){if(void 0!==(null==e?void 0:e.api))return void(this._api=e.api);const t=e&&e.store||this.store;if(void 0===t)return;const i=Yr.features["api-session-storage"]?getSessionStorage():void 0,r=e&&e.storefrontId||t.storefrontId,s=new API$1(this.url,t.developerToken,r,t.storekit.userToken,t.storekit.storefrontCountryCode,i,Yr,e&&e.apiOptions&&e.apiOptions.sessionOptions);this._api=s.v3,this._api=s}_updateStorefrontId(e){return __awaiter$1(this,void 0,void 0,(function*(){this.api&&e===this.api.storefrontId||(yield this.configure({dispatcher:this._dispatcher,store:this.store,storefrontId:e}))}))}}var un=new Logger$1;function isRecordValid(e){const t=void 0!==e.cachingPolicy,i=t&&"cache"in e.cachingPolicy&&!e.cachingPolicy.cache,r=t&&void 0!==e._mjs.expiration&&Date.now()>e._mjs.expiration,s=e._mjs.invalid;return!(i||r||s)}const hn=["browseWebLanding","contentEpisodes","episodeItunesSeasons","favoritesContains","getPostPlayShelf","getMovieDetailById","getEpisodeDetailById","getShowDetailById","showEpisodeNextepisode","showItunesSeasons","viewShowEpisodes","watchlistContinueWatching"],pn=["v2/browse/watchNow","v2/browse/movies","v2/browse/tv","v2/browse/kids","v2/browse/sports","v2/browse/person/{personId}","v2/browse/collection/{collectionId}","v2/browse/channel/{brandId}","v2/browse/room/{roomId}","v2/browse/genre/{genreId}","v3/shows/{showId}","v3/movies/{movieId}","v3/episodes/{episodeId}","v3/canvases/{canvasType}/{entityId}"],yn=["Episode","Movie","Show"];class UTSStore extends DataStore{constructor(e){super(e),this._canvasPathToID={},this._allowPersonalizedCache=!1,this._allowPersonalizedCache=e.allowPersonalizedCache}isCanvas(e){return pn.includes(e)}static isNotCached(e){return hn.includes(e)||/search/i.test(e)}updateRecordMetadata(e,{args:t,path:i,pathTemplate:r}){var s;const n=e._mjs.sourcePaths,a=n?n.includes(i)?n:n.concat([i]):[i];e._mjs.sourcePaths=a,this.isCanvas(r)&&(un.debug("adding id to _browseCanvases",i,e.id),this._canvasPathToID[i]=Object.assign({id:e.id},this._canvasPathToID[i]));const o=t[0]&&"object"==typeof t[0]?t[0]:{};e._mjs.previousTokens=null!==(s=e._mjs.previousTokens)&&void 0!==s?s:[],e._mjs.previousTokens.push(o.nextToken)}getCachedRecord(e){var t,i;const{args:r,methodName:s,path:n,pathTemplate:a,queryParams:o,skipDataStoreCache:l}=e;un.debug(`uts: ${s} getCachedRecord`,e);const d=this.isCanvas(a),c="skip"in o;if(UTSStore.isNotCached(s)||c)return;let u=r[0]&&"object"==typeof r[0]?r[0].id||r[0].collectionId||r[0].showId||r[0].showOrSeasonId||r[0].personId:r[0];if(d&&this._canvasPathToID[n]&&(u=this._canvasPathToID[n].id),un.debug(`uts: ${s} getCachedRecord - id used to query data store:`,u),!u)return;const[h]=this.query(e=>e.id===u);if(un.debug(`uts: ${s} getCachedRecord - query result:`,h),!h)return;if(l){un.debug(`uts: ${s} getCachedRecord - skipDataStoreCache enabled, removing cached record`,h.type,h.id);return(null===(t=h._mjs.parents)||void 0===t?void 0:t.length)>0&&"Shelf"===h.type?void(h._mjs.previousTokens=[]):void this.removeCachedRecord(h)}const p=null===(i=h._mjs)||void 0===i?void 0:i.previousTokens,y=o.nextToken;if(UTSStore.hasPath(h,n)&&(null==p?void 0:p.includes(y))){if(isRecordValid(h))return h.nextToken===y&&(h.nextToken=null),h;un.debug(`uts: ${s} getCachedRecord - Removing invalid record`,h.type,h.id),this.removeCachedRecord(h)}}replaceShelf(e){this.populateDataRecords(e,this._records,{})}removeCachedRecord(e){var t;(null===(t=null==e?void 0:e.shelves)||void 0===t?void 0:t.length)>0&&e.shelves.forEach(e=>{this.remove(e.type,e.id)}),this.remove(e.type,e.id)}invalidateWithEvent(e,t){un.debug("uts: invalidateWithEvent",e),this._invalidateCanvasAndShelvesForEvent(e),this._invalidateProductRecords(e,t)}_invalidateProductRecords(e,t){t&&ensureArray(t).forEach(e=>{const[t]=this.query(t=>t.id===e.id);t&&(yn.includes(t.type)?(un.debug("uts: filtering sourcePaths for record:",t),UTSStore._removePersonalizedPaths(t),t.show&&(un.debug("uts: filtering sourcePaths for show record:",t.show),UTSStore._removePersonalizedPaths(t.show))):t._mjs.invalid=!0)})}_invalidateCanvasAndShelvesForEvent(e){Object.values(this._canvasPathToID).forEach(t=>{if(t&&t.id){const i=this.peek("Canvas",t.id);UTSStore._hasInvalidationEvent(i,e)?i._mjs.invalid=!0:i&&i.shelves&&i.shelves.length>0&&i.shelves.forEach(t=>{UTSStore._hasInvalidationEvent(t,e)&&(t._mjs.invalid=!0)})}})}static _hasInvalidationEvent(e,t){var i,r,s;return null!==(s=null===(r=null===(i=null==e?void 0:e.cachingPolicy)||void 0===i?void 0:i.invalidationEvents)||void 0===r?void 0:r.includes(t))&&void 0!==s&&s}static _removePersonalizedPaths(e){var t,i;e._mjs.sourcePaths=null===(i=null===(t=e._mjs)||void 0===t?void 0:t.sourcePaths)||void 0===i?void 0:i.filter(e=>!this.isPersonalizedPath(e))}static hasPath(e,t){var i,r;return(null!==(r=null===(i=null==e?void 0:e._mjs)||void 0===i?void 0:i.sourcePaths)&&void 0!==r?r:[]).includes(t)}static isPersonalizedPath(e){return e.endsWith("personalized")||/v\d\/view\/show\/.+\/(episodes|playables)/.test(e)}makeRecord(e,t=!1){const{args:i,path:r,response:s,isPersonalized:n,methodName:a}=e;if(!s)return;if(t||UTSStore.isNotCached(a)||r.endsWith("personalized")&&!this._allowPersonalizedCache)return this.populateDataRecords(s,{});n&&s.data&&s.data.content&&(s.data.content.cachingPolicy={cache:!0,maxAge:900});const o={},l=null==i?void 0:i[0];isObject$1(l)&&(hasOwn(l,"skip")&&l.skip>0||hasOwn(l,"nextToken")&&l.nextToken)&&(o.extendRelationships=!0);const d=this.save(s,o);return ensureArray(d).forEach(t=>this.updateRecordMetadata(t,e)),d}}class UTSRequest{constructor(e,t,i){this.methodName=e,this.args=i;const r="object"==typeof i[0]?Object.assign({},i[0]):[...i];this.pathTemplate=t.url.replace(/(?:.+)\/uts\/?/i,"");const{formattedPath:s,pathKeys:n}=((e,t)=>{let i=e;const r=e.match(/{[^}]+}/g)||[],s=[];return r.forEach((e,r)=>{const n=e.replace(/{|}/g,"");i=i.replace(e,encodeURIComponent(Array.isArray(t)?t[r]:t[n])),s.push(n)}),{formattedPath:i,pathKeys:s}})(this.pathTemplate,r);this.path=s,this.pathKeys=n,this.queryParams=Array.isArray(r)?{}:r,this.pathKeys.forEach(e=>delete r[e]),this.queryParams.body&&(this.body=this.queryParams.body,delete this.queryParams.body);let a=!1;"reload"in this.queryParams&&(a=this.queryParams.reload,delete this.queryParams.reload),"returnRawResponse"in this.queryParams&&(this.returnRawResponse=this.queryParams.returnRawResponse,delete this.queryParams.returnRawResponse),this.skipDataStoreCache=a,this.isPersonalized=UTSStore.isPersonalizedPath(this.path);const o=UTSRequest.getRouteMethod(e),l=this.pathTemplate.startsWith("v2");this.fetchOptions={contentType:"POST"===o&&l?P.FORM:P.JSON,method:o,useRawResponse:!0,reload:a||this.isPersonalized||UTSStore.isNotCached(e)}}set response(e){null!==(null==e?void 0:e.data)&&"object"==typeof(null==e?void 0:e.data)&&(e.data.methodName=this.methodName),this._response=e}get response(){return this._response}static getRouteMethod(e){return e.startsWith("post")||e.startsWith("add")||"markItemAsWatched"===e?"POST":e.startsWith("remove")||e.startsWith("delete")?"DELETE":"GET"}}function basic(e){const t={id:e.id,type:e.type||"Shelf",attributes:{},relationships:{}};return t.attributes=Object.assign({},e),t}function canvas(e){const t={id:e.canvas.id,type:e.canvas.type,attributes:Object.assign({},e.canvas),relationships:{}};var i;e.canvas.shelves&&!(null==(i=e.canvas.shelves)?void 0:i.some(e=>void 0===e.id))&&(t.relationships.shelves={data:e.canvas.shelves.map(e=>(e.type="Shelf",e))},delete e.canvas.shelves);const r=__rest(e,["canvas"]);return t.attributes=Object.assign({},e.canvas),e.person&&(t.relationships.person={data:e.person},delete e.person),e.genre&&(t.relationships.genre={data:e.genre},delete e.genre),t.attributes=Object.assign(Object.assign({},t.attributes),r),t}function collection(e){var t;const i=null!==(t=e.shelf)&&void 0!==t?t:e;return{id:i.id,type:"Shelf",attributes:Object.assign({},i),relationships:{}}}var mn,gn;!function(e){e.show="show"}(mn||(mn={})),function(e){e.bundles="bundles",e.episodes="episodes",e.movies="movies",e.seasons="seasons"}(gn||(gn={}));const fn=[...Object.values(mn),...Object.values(gn)];function product(e){return Object.keys(e).reduce((t,i)=>("content"===i?(t.id=e.content.id,t.type=e.content.type,t.attributes=Object.assign(Object.assign({},t.attributes),e[i])):"playables"===i?t.attributes[i]=e[i]:"episodes"!==i||Array.isArray(e[i])?"seasons"!==i||Array.isArray(e[i])?fn.includes(i)?t.relationships[i]={data:e[i]}:t.attributes[i]=e[i]:t.relationships[i]={data:Object.assign({id:e.content.id+".seasons",type:"Collection"},e[i])}:t.relationships[i]={data:Object.assign({id:"episodes."+e.content.id,type:"Episodes"},e[i])},t),{attributes:{},relationships:{}})}function sportingEvent(e){if(e.content){const t=e.content.relatedSportingEvents||[];return delete e.content.relatedSportingEvents,{id:e.content.id,type:e.content.type,attributes:Object.assign({},e.content),relationships:{channels:{data:e.channels||[]},relatedSportingEvents:{data:t}}}}return basic(e)}function watchlist(e){const{items:t}=e,i=__rest(e,["items"]),r=e.channels;return{id:"watchlist",type:"Watchlist",attributes:Object.assign({},i),relationships:{items:{data:t},channels:{data:r}}}}function transform(e){var t;let i="unknown";const r=e.methodName;return delete e.methodName,"watchlistContinueWatching"===r?i="Watchlist":"showItunesSeasons"===r?(e.content={id:"itunesSeasons",type:"itunesSeasons"},i="Product"):"contentEpisodes"===r?(e.content={id:"contentEpisodes",type:"contentEpisodes"},i="Product"):e.type?i=e.type:e.canvas?(e.canvas.type=null!==(t=e.canvas.type)&&void 0!==t?t:"Canvas",i=e.canvas.type):e.content?i="SportingEvent"===e.content.type?e.content.type:"Product":e.showId?(e.content={id:e.showId,type:"Show"},i="Product"):e.shelf&&(i="Collection"),function(e){switch(e){case"Canvas":return canvas;case"Product":return product;case"SportingEvent":return sportingEvent;case"Watchlist":return watchlist;case"Collection":return collection;default:return basic}}(i)(e)}const vn={shows:{method:"GET",url:"https://tv.apple.com/uts/v3/shows/{showId}",requiredParamsType:"Default"},movies:{method:"GET",url:"https://tv.apple.com/uts/v3/movies/{movieId}",requiredParamsType:"Default"},episodes:{method:"GET",url:"https://tv.apple.com/uts/v3/episodes/{episodeId}",requiredParamsType:"Default"}},_n={caller:"MediaKit-Web",sfh:"143441,33",v:"46"};var bn;!function(e){e.PLAY="PLAY",e.UPNEXT_ADD_REMOVE="UPNEXT_ADD_REMOVE"}(bn||(bn={}));class API extends URLSession{constructor(e="https://uts-api.itunes.apple.com/uts",t={},i,r){var s,n;super(e,t),this._isV3Config=!1,this.fetchOptions={},this.v3={},this.version="2.2224.3",i.debug&&(un.enabled=!0,un.level="number"==typeof i.logLevel?i.logLevel:1),i.developerToken&&(this.developerToken=new DeveloperToken(i.developerToken),this.headers.set("Authorization","Bearer "+this.developerToken.token),this.userToken=i.userToken,this.userToken&&this.headers.set("Media-User-Token",this.userToken)),this._dataStoreEnabled=!!i.dataStoreEnabled,this._dataStoreEnabledNoCache=!!i.dataStoreEnabledNoCache,this._store=new UTSStore({mapping:transform,allowPersonalizedCache:!!(null===(s=i.features)||void 0===s?void 0:s.includes("uts-personalized-cache"))}),this._isV3Config=!!(null===(n=i.features)||void 0===n?void 0:n.includes("uts-config-v3")),this.initializedOptions=Object.assign(Object.assign({},_n),r),this.fetchOptions=this._fetchOptions}static configure(e={}){return __awaiter(this,void 0,void 0,(function*(){un.debug("Configuring with options: ",e);const{hostname:t,baseUrl:i,sessionOptions:r,debug:s,logLevel:n,developerToken:a,userToken:o,dataStoreEnabled:l,dataStoreEnabledNoCache:d,features:c}=e,u=__rest(e,["hostname","baseUrl","sessionOptions","debug","logLevel","developerToken","userToken","dataStoreEnabled","dataStoreEnabledNoCache","features"]),h=new this(t||i,r,{dataStoreEnabled:l,dataStoreEnabledNoCache:d,debug:s,developerToken:a,features:c,logLevel:n,userToken:o},u);return yield h._updateAPIConfiguration(u),Object.keys(h.routes).forEach(e=>{h[e]=h._generateServerRoute(e,h.routes[e])}),Object.keys(vn).forEach(e=>{h.v3[e]=h._generateServerRoute(e,vn[e])}),h}))}get config(){return this._config}get routes(){var e,t,i,r,s,n;return null!==(n=null!==(i=null===(t=null===(e=this.config)||void 0===e?void 0:e.endpoints)||void 0===t?void 0:t.serverRoutes)&&void 0!==i?i:null===(s=null===(r=this.config)||void 0===r?void 0:r.applicationProps)||void 0===s?void 0:s.routes)&&void 0!==n?n:{}}getRequiredParams(e="Default"){var t,i,r,s,n;return null!==(n=null!==(i=null===(t=this.config)||void 0===t?void 0:t.requiredRequestKeyValuePairs)&&void 0!==i?i:null===(s=null===(r=this.config)||void 0===r?void 0:r.applicationProps)||void 0===s?void 0:s.requiredParamsMap[e])&&void 0!==n?n:{}}reconfigure(e){return __awaiter(this,void 0,void 0,(function*(){un.debug("uts: reconfigure with options:",e);const{userToken:t}=e,i=__rest(e,["userToken"]);return"userToken"in e&&(this.userToken=t,t?this.headers.set("Media-User-Token",this.userToken):(un.debug("uts: removing MUT header and clearing config"),this.headers.delete("Media-User-Token"),this._config=void 0)),this._dataStoreEnabled&&this._store.clear(),this.clearNetworkCache(),this.initializedOptions=Object.assign(Object.assign({},this.initializedOptions),i),this._updateAPIConfiguration()}))}reconfigureRatings(e={}){return __awaiter(this,void 0,void 0,(function*(){return e.tvr||delete this.initializedOptions.tvr,e.mr||delete this.initializedOptions.mr,this.reconfigure(e)}))}invalidate(e,t){return __awaiter(this,void 0,void 0,(function*(){this._dataStoreEnabled?this._store.invalidateWithEvent(e,t):this.clearNetworkCache()}))}decorate(e){return __awaiter(this,void 0,void 0,(function*(){const t=Object.assign({ids:e},this.getRequiredParams()),i=Object.assign(Object.assign({},this.fetchOptions),{useRawResponse:!0});let r;un.debug(`Fetch decorate endpointParams: ${t}, fetchOptions: ${this.fetchOptions}, endpointOptions: ${i}`);try{r=yield this._makeUTSRequest("v2/activity/playables/decorate",t,i)}catch(s){r=void 0}return r}))}getNpPayloadContent(e,t,i,r){const s={context:{user:{id:i,keyspace:"cid"},userAgent:navigator.userAgent,appleStoreFront:this.initializedOptions.sfh,source:"Client_Device",cadence:"Contract",bundleId:r,millisecondsSinceEvent:0},event:{}};return"vod"===e?s.event.vodEvent=t:"live"===e&&(s.event.liveEvent=t),s}playActivity(e,t,i,r){return __awaiter(this,void 0,void 0,(function*(){const s={headers:{Authorization:"Bearer "+this.developerToken.token,"Media-User-Token":this.userToken},method:"POST",body:JSON.stringify(this.getNpPayloadContent(e,t,i,r))};return yield fetch("/api/np/play/json",s)}))}_generateServerRoute(e,t){if(t&&t.url&&!t.needsMescal)return(...i)=>__awaiter(this,void 0,void 0,(function*(){var r,s,n,a;const o=new UTSRequest(e,t,i),{path:l,queryParams:d,fetchOptions:c,methodName:u,body:h,returnRawResponse:p}=o,y=Object.assign(Object.assign({},this.getRequiredParams(t.requiredParamsType)),d);let m=y;if(h&&(m=h,c.queryParameters=y),!this._dataStoreEnabled||p)return this._makeUTSRequest(l,m,c);const g=this._dataStoreEnabledNoCache?void 0:this._store.getCachedRecord(o);if(g)return"Canvas"===g.type&&(yield this._handleInvalidShelves(g,o)),un.debug(`uts: ${u} - returning cached record`,g),g;if(un.debug(`uts: ${u} - no record found in cache, making request`),o.response=yield this._makeUTSRequest(l,m,c),null===(null===(r=o.response)||void 0===r?void 0:r.data)||"object"!=typeof(null===(s=o.response)||void 0===s?void 0:s.data))return o.response;const f=null===(a=null===(n=o.response)||void 0===n?void 0:n.data)||void 0===a?void 0:a.canvas;if(f){const[e]=this._dataStoreEnabledNoCache?[]:this._store.query(e=>e.id===f.id);if(e&&!UTSStore.hasPath(e,l))return un.debug("uts: Duplicate canvas found"),this._store.updateRecordMetadata(e,o),e}const v=this._store.makeRecord(o,this._dataStoreEnabledNoCache);return un.debug(`uts: ${u} - returning new or updated record`,v),v}))}_makeUTSRequest(e,t,i){return __awaiter(this,void 0,void 0,(function*(){const r=Object.assign({},t),s=Object.assign(Object.assign({},this.fetchOptions),i);try{e=this.resolvePathVersion(e);let t=yield this.request(e,r,s);return this._needsConfigurationRefresh(t)&&(this.clearNetworkCache(),yield this._updateAPIConfiguration(),t=yield this.request(e,r,s)),t}catch(Pt){return Promise.reject(Pt)}}))}resolvePathVersion(e){return this.url.endsWith("v2")?e.replace(/v\d\//,""):e}_needsConfigurationRefresh(e){const t=e.utsk,i=this.getRequiredParams().utsk;return!!t&&t!==i}_updateAPIConfiguration(e=this.getRequiredParams()){return __awaiter(this,void 0,void 0,(function*(){un.debug("UTS: Fetching new config with options",e);const t={},i=Object.assign(Object.assign({},this.fetchOptions),{method:"POST",contentType:P.JSON}),r=Object.assign(Object.assign(Object.assign({},this.initializedOptions),e),{ts:Date.now()});r.utsFeatureFlags&&(t.featureFlags=r.utsFeatureFlags,delete r.utsFeatureFlags),i.queryParameters=r,this._config=yield this.request(this.resolvePathVersion(this._isV3Config?"v3/configurations":"v2/init/config"),t,i)}))}_handleInvalidShelves(e,t){return __awaiter(this,void 0,void 0,(function*(){if(!(this._dataStoreEnabled&&e&&e.shelves&&e.shelves.some(isDataRecord)))return;yield Promise.all(e.shelves.filter(e=>!isRecordValid(e)).map(e=>__awaiter(this,void 0,void 0,(function*(){un.debug("uts: _handleInvalidShelves - fetching and replacing shelf with id:",e.id);let i={};e.url&&(i=parseQueryParams(e.url));const r=yield this._makeUTSRequest("v3/shelves/"+e.id,Object.assign(Object.assign(Object.assign({},this.getRequiredParams()),t.queryParams),i),Object.assign(Object.assign({},t.fetchOptions),{reload:!0}));this._store.replaceShelf(r)}))))}))}}const loadedQueueTransform=e=>transform(e.data);function makeUtsApiNamedOptions(e=!1){return{show:{isPlural:!1,apiMethod:"viewProduct",loadedQueueTransform:e?loadedQueueTransform:void 0},episode:{isPlural:!1,apiMethod:"viewProduct",loadedQueueTransform:e?loadedQueueTransform:void 0},product:{isPlural:!1,apiMethod:"viewProduct",loadedQueueTransform:e?loadedQueueTransform:void 0},movie:{isPlural:!1,apiMethod:"viewProduct",loadedQueueTransform:e?loadedQueueTransform:void 0}}}class UTSAPIService{constructor(){if(this.url=Yr.urls.utsBase,this.defaults={caller:"web",dataStoreEnabled:!0,pfm:"web",v:"46"},this.namedQueueOptions=makeUtsApiNamedOptions(),!ke){const e=getLocalStorage();(null==e?void 0:e.utsBaseURLOverride)&&(this.url=null==e?void 0:e.utsBaseURLOverride)}void 0!==this.url&&(this.defaults.baseUrl=this.url)}clear(){}configure(e){return __awaiter$1(this,void 0,void 0,(function*(){const t=void 0!==e.apiOptions?e.apiOptions:{};return!1===t.dataStoreEnabled&&(this.namedQueueOptions=makeUtsApiNamedOptions(!0)),e.store&&(t.developerToken=e.store.developerToken,e.store.musicUserToken&&(t.userToken=e.store.musicUserToken),e.store.precache&&(e.apiOptions={underlyingStorage:e.store.precache})),this.api=yield API.configure(Object.assign(Object.assign({},this.defaults),t)),this}))}getAPIForItem(e){return __awaiter$1(this,void 0,void 0,(function*(){if(void 0===this.api)throw new Error("UTS API has not been configured");return this.api}))}}class DecorateLiveMonitor{constructor(e,t,i){this.dispatcher=e,this.callback=t,this.decoratedLive=i,this.currentIndex=0,this.hasSentEventStart=!1}startMonitor(){this.dispatcher.unsubscribe(Hr.playbackTimeDidChange,this.handleTimeChange),this.dispatcher.subscribe(Hr.playbackTimeDidChange,this.handleTimeChange)}stopMonitor(){this.dispatcher.unsubscribe(Hr.playbackTimeDidChange,this.handleTimeChange)}handleTimeChange(){const e=Date.now(),t=this.decoratedLive.events[this.currentIndex];t?(e>=t.startTime&&!this.hasSentEventStart&&(this.hasSentEventStart=!0,this.callback("Event_Start",this.decoratedLive,t)),e>=t.endTime&&(this.hasSentEventStart=!1,this.currentIndex+=1,this.callback("Event_End",this.decoratedLive,t)),this.currentIndex>=this.decoratedLive.events.length&&this.stopMonitor()):this.stopMonitor()}}__decorate$1([Bind(),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[]),__metadata$1("design:returntype",void 0)],DecorateLiveMonitor.prototype,"handleTimeChange",null);const Tn=new Set(["play","stop","Event_End","Event_Start"]),Sn=new Set(["exit","pause","play","scrub","seek","skip","stop"]);class BookmarkAPI{configure(e){var t;return __awaiter$1(this,void 0,void 0,(function*(){return this.dispatcher=e.services.dispatcher,this.mediaItemPlayback=e.services.mediaItemPlayback,this.utsAPI=null===(t=e.services.apiManager)||void 0===t?void 0:t.utsAPI,this}))}cleanup(){this.clearItem()}shouldConfigure(e){return __awaiter$1(this,void 0,void 0,(function*(){return!!Yr.features.bookmarking&&e.isAuthorized}))}shouldTrackPlayActivity(t,i){if(!i||!this.utsAPI)return!1;const r=-1===[e.PlaybackType.none,e.PlaybackType.preview].indexOf(i.playbackType),s="Bonus"!==i.type;return zr.debug("Bookmark shouldTrackPlayActivity",r&&s,t),r&&s}activate(e={}){return Promise.resolve()}exit(e={}){return __awaiter$1(this,void 0,void 0,(function*(){yield this.trackActivity("exit",void 0,e.position)}))}pause(e,t={}){return __awaiter$1(this,void 0,void 0,(function*(){yield this.trackActivity("pause",e,t.position)}))}play(e,t={}){return __awaiter$1(this,void 0,void 0,(function*(){const i=void 0===t.position?0:t.position;yield this.trackActivity("play",e,i)}))}scrub(e,t={}){return __awaiter$1(this,void 0,void 0,(function*(){yield this.trackActivity("scrub",e,t.position)}))}seek(e,t={}){return __awaiter$1(this,void 0,void 0,(function*(){yield this.trackActivity("seek",e,t.position)}))}skip(e,t={}){return __awaiter$1(this,void 0,void 0,(function*(){yield this.trackActivity("skip",e,t.position)}))}stop(e,t={}){var i;return __awaiter$1(this,void 0,void 0,(function*(){let r=t.position;const s=null===(i=this.currentItemTiming)||void 0===i?void 0:i.totalContentLength;if(!(null==e?void 0:e.isLinearStream)&&void 0!==s&&void 0!==r){const e=s-r;e>=0&&e<5&&(r=s+.5)}yield this.trackActivity("stop",e,r)}))}clearItem(){this.currentItem=void 0,this.decorated=void 0,this.decoratedLive=void 0,this.currentItemTiming=void 0,this.currentPlayable=void 0,this.currentAppBundleIds=void 0,this.clearWatcher()}clearWatcher(){void 0!==this.watcher&&(this.watcher.stopMonitor(),this.watcher=void 0)}determineRelativePosition(e,t){return e<=t.mainContentStarts?0:e>=t.mainContentEnds?t.mainContentEnds:e-t.mainContentStarts}generateLiveEvent(e,t,i,r){var s,n;let a;"play"===e?a="Tune_In":"stop"===e?a="Tune_Out":"Event_Start"!==e&&"Event_End"!==e||(a=e),zr.debug("generateLiveEvent",t,i,r);const o={bundleId:null!==(s=this.currentAppBundleIds)&&void 0!==s?s:"com.apple.tv",millisecondsSinceEvent:0,channel:{channelCanonicalId:i.serviceId,channelBrandId:i.channelId,channelExternalLiveServiceId:i.externalServiceId,channelInternalLegId:null!==(n=i.legId)&&void 0!==n?n:i.serviceId},cause:a};if(o.expectedStartTimeEpochMillis=i.scheduleStartTime,o.cleanupTimeEpochMillis=i.scheduleEndTime,r){let e;"number"==typeof r.endTime&&"number"==typeof r.startTime&&(e=r.endAirTime-r.startAirTime),o.content={contentCanonicalId:r.canonicalId,contentBrandId:r.channelId,contentExternalPlayableId:r.playableExternalId,contentMediaLengthInMilliseconds:e,contentLiveFeatureOrLiveEndCredits:"Event_Start"===a?"Live_Feature":"Live_End_Credits",contentInternalLegId:r.legId},o.expectedStartTimeEpochMillis=r.startTime,o.cleanupTimeEpochMillis=r.endTime}return o}generateVodEvent(e,t,i,r){const s={playable:{externalPlayableId:e.id.split(":").pop(),brandId:t.brandId},internalLegId:t.internalLegId,canonicalId:t.canonicalId,mediaLengthInMilliseconds:Math.floor(1e3*i.totalContentLength),mainContentLengthInMilliseconds:Math.floor(1e3*i.mainContentLength),playHeadInMilliseconds:Math.floor(1e3*r),mainContentPlayHeadInMilliseconds:Math.floor(1e3*this.determineRelativePosition(r,i)),featureOrEndCredits:r>i.mainContentEnds?"End_Credits":"Feature"};return"Episode"===t.contentType&&(s.tvEpisode={externalShowId:t.externalShowId,canonicalShowId:t.canonicalShowId,currentOrPreviousEpisode:t.isCurrent?"Latest_And_Current_Episode":"Previous_Episode",openOrClosedShow:t.isShowClosed?"Show_Closed_No_More_Episodes_Expected":"Show_Open_More_Episodes_Expected"}),s}getAppBundleIds(e,t){var i,r;const s=null==t?void 0:t.channels;if(!Array.isArray(s)||void 0===(null==e?void 0:e.channelId))return;const n=s.find(t=>t.id===e.channelId);return null!==(r=null===(i=null==n?void 0:n.appBundleIds)||void 0===i?void 0:i[0])&&void 0!==r?r:void 0}onContentCompletionThreshhold(e){return __awaiter$1(this,void 0,void 0,(function*(){yield this.trackActivity("exit",this.currentItem,e),this.dispatcher.publish(He.mediaContentComplete,this.currentItem)}))}setupVodWatcher(e,t){this.clearWatcher(),this.watcher=new SpanWatcher(this.dispatcher,this.onContentCompletionThreshhold,e,t,!0),this.watcher.startMonitor()}onLiveEvent(e,t,i){return __awaiter$1(this,void 0,void 0,(function*(){if("Event_Start"===e||"Event_End"===e){const r=yield Qr.storekit.pldfltcid(),{currentAppBundleIds:s,currentPlayable:n,utsAPI:a}=this;if(!r||!a||!n)return;const o=this.generateLiveEvent(e,n,t,i);yield a.playActivity("live",o,r,null!=s?s:"com.apple.tv")}}))}setupLiveWatcher(e){this.dispatcher&&(this.clearWatcher(),this.watcher=new DecorateLiveMonitor(this.dispatcher,this.onLiveEvent,e),this.watcher.startMonitor())}trackActivity(e,t,i){var r;return __awaiter$1(this,void 0,void 0,(function*(){if(void 0===i||void 0===this.utsAPI)return;if(void 0!==t&&(yield this.updateItem(t)),void 0===this.currentItem)return;const{decorated:s,decoratedLive:n,currentPlayable:a,currentAppBundleIds:o}=this;let{currentItemTiming:l}=this;const d=yield Qr.storekit.pldfltcid();if(!d)return;let c;if(n&&a&&Tn.has(e))c=this.generateLiveEvent(e,a,n),yield this.utsAPI.playActivity("live",c,d,null!=o?o:"com.apple.tv");else if(s&&a&&l&&Sn.has(e)){const e=null===(r=this.mediaItemPlayback)||void 0===r?void 0:r.currentPlaybackDuration;if(isNaN(l.totalContentLength)||e&&e<l.totalContentLength){const t=null!=e?e:NaN;isNaN(t)||(this.currentItemTiming=l=Object.assign(Object.assign({},l),{mainContentEnds:t,mainContentLength:t,totalContentLength:t}))}c=this.generateVodEvent(a,s,l,i),yield this.utsAPI.playActivity("vod",c,d,null!=o?o:"com.apple.tv")}}))}updateItem(e){var t,i,r;return __awaiter$1(this,void 0,void 0,(function*(){if(void 0===this.utsAPI)return;if(this.currentItem&&this.currentItem.id!==e.id&&this.clearItem(),void 0!==this.currentItem)return;this.currentItem=e;const s=e.defaultPlayable;if(void 0!==s)if(this.currentPlayable=s,this.currentItemTiming=(e=>{var t,i;const r=parseRollItems(e,["pre-roll"]),s=parseRollItems(e,["post-roll"]),n=r.reduce(addRollItemDuration,0),a=s.reduce(addRollItemDuration,0),o=null!==(i=null!==(t=e.hlsMetadata["up-next.start"])&&void 0!==t?t:e.hlsMetadata["watched.time"])&&void 0!==i?i:e.hlsMetadata["feature.duration"],l=parseFloat(o);return{mainContentStarts:n,mainContentEnds:l,mainContentLength:l-n,totalContentLength:l+a}})(e),this.currentAppBundleIds=this.getAppBundleIds(s,e),e.isLinearStream){const e=yield this.utsAPI.activityDecorateLive({channelId:s.channelId,externalServiceId:s.externalServiceId});this.decoratedLive=null!==(t=null==e?void 0:e.data)&&void 0!==t?t:e,this.decoratedLive&&(null===(i=this.decoratedLive.events)||void 0===i?void 0:i.length)&&this.setupLiveWatcher(this.decoratedLive)}else{if(hasContentCompletionThresholdData(e)){const t=(e=>Math.min(Math.round(getUpNextStart(e)),Math.round(getWatchedTime(e))))(e);this.setupVodWatcher(t,Number.POSITIVE_INFINITY)}const t=1e3*parseInt(""+s.duration,10),i=`${s.channelId}:${s.externalId}:${t}`,n=yield this.utsAPI.decorate(i);this.decorated=null===(r=null==n?void 0:n.data)||void 0===r?void 0:r[i]}}))}}__decorate$1([Bind(),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[Number]),__metadata$1("design:returntype",Promise)],BookmarkAPI.prototype,"onContentCompletionThreshhold",null),__decorate$1([Bind(),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[String,Object,Object]),__metadata$1("design:returntype",Promise)],BookmarkAPI.prototype,"onLiveEvent",null);var En={setDelegate:!0};function isDefined(e){return void 0!==e}function isDefinedNonNull(e){return isDefined(e)&&null!==e}function isEmptyString(e){return isString(e)&&0===e.length}function isEmptyArray(e){return isArray$1(e)&&0===e.length}function isEmptyObject(e){return isObject(e)&&0===Object.keys(e).length}function isFunction$1(e){return"function"==typeof e}function isNumber$1(e){return"number"==typeof e}function isInteger$2(e){return isNumber$1(e)&&e%1==0}function isString(e){return"string"==typeof e||e instanceof String}function isArray$1(e){return!!e&&e.constructor===Array}function isObject(e){return!!e&&e.constructor===Object}function hasGetterAndSetterMethods(e){return isObject(e)&&isFunction$1(e.__lookupGetter__)&&isFunction$1(e.__lookupSetter__)&&isFunction$1(e.__defineGetter__)&&isFunction$1(e.__defineSetter__)}function extend$5(e){var t=[!0,!0,!0].concat(Array.prototype.slice.call(arguments));return copyKeysAndValues$1.apply(null,t)}function copyKeysAndValues$1(e,t,i,r){for(var s,n=i&&r||{},a=3;a<arguments.length;a++)for(var o in s=arguments[a])if(Object.prototype.hasOwnProperty.call(s,o)){var l=s[o];(e||null!=l)&&(t||"function"!=typeof l)&&(n[o]=l)}return n}function attachMethods$1(e,t,i,r){var s=!1;if(e&&t){r=r||{},i=i||t;var captureFunction=function(e,t,i,r){var returnValue=function(){return i[r].apply(e,arguments)};return t&&(returnValue.origFunction=t),returnValue.attachedMethod=!0,returnValue};for(var n in t)if(!(n in r)&&t[n]&&isFunction$1(t[n])){var a=e[n],o=null;a&&isFunction$1(a)&&(o=!0===a.attachedMethod?a:a.bind(e)),e[n]=captureFunction(i,o,t,n),s=!0}}return s}function detachMethods(e){var t=!1;for(var i in e){if(isFunction$1(e[i])&&!0===e[i].attachedMethod)if(e[i].origFunction)for(;e[i].origFunction;)e[i]=e[i].origFunction,t=!0;else delete e[i]}return t}function dedupedArray(e,t){var i={};if(e)for(var r=0;r<e.length;r++)i[e[r]]=0;if(t)for(var s=0;s<t.length;s++)i[t[s]]=0;return Object.keys(i)}var kn=Object.freeze({__proto__:null,_utResetNonOverridableFunctions:function(){En={setDelegate:!0}},shallowClone:function(e){var t,i,r={},s=hasGetterAndSetterMethods(e);for(var n in e)t=null,i=null,s&&(t=e.__lookupGetter__(n),i=e.__lookupSetter__(n)),t||i?(t&&r.__defineGetter__(n,t),i&&r.__defineSetter__(n,i)):r[n]=e[n];return r},isDefined:isDefined,isDefinedNonNull:isDefinedNonNull,isDefinedNonNullNonEmpty:function(e){return isDefinedNonNull(e)&&!isEmptyString(e)&&!isEmptyArray(e)&&!isEmptyObject(e)},isEmptyString:isEmptyString,isEmptyArray:isEmptyArray,isEmptyObject:isEmptyObject,isFunction:isFunction$1,isNumber:isNumber$1,isInteger:isInteger$2,isString:isString,isElement:function(e){return!!e&&1==e.nodeType},isArray:isArray$1,isObject:isObject,values:function(e){var t=[];for(var i in e){var r=e[i];e.hasOwnProperty(i)&&!isFunction$1(r)&&t.push(r)}return t},keys:function(e){var t=[];for(var i in e)e.hasOwnProperty(i)&&!isFunction$1(e[i])&&t.push(i);return t},hasAnyKeys:function(e){for(var t in e)if(e.hasOwnProperty(t))return!0},hasAnyNonNullKeys:function(e){for(var t in e)if(e.hasOwnProperty(t)&&e[t])return!0},hasGetterAndSetterMethods:hasGetterAndSetterMethods,methods:function(e){var t=[];for(var i in e){var r=e[i];e.hasOwnProperty(i)&&isFunction$1(r)&&t.push(r)}return t},invert:function(e){var t={};for(var i in e)e.hasOwnProperty(i)&&!isFunction$1(e[i])&&(t[e[i]]=i);return t},extend:extend$5,copyKeysAndValues:copyKeysAndValues$1,addNonOverrideableFunctions:function(e){for(var t=0;t<e.length;t++){var i=e[t];En[i]=!0}},attachMethods:attachMethods$1,detachMethods:detachMethods,attachDelegate:function(e,t){var i=!1;if(e&&t&&e!==t){var r={};Object.keys(t).forEach((function(t){e[t]||(r[t]=!0)})),extend$5(r,En),i=attachMethods$1(e,t,null,r)}return i},setDelegates:function(e,t){var i={};for(var r in e)t[r]&&isFunction$1(e[r].setDelegate)&&(i[r]=e[r].setDelegate(t[r]));return i},resetDelegates:function(e){var t=!1;for(var i in e){var r=e[i];r&&"object"==typeof r&&isFunction$1(r.setDelegate)&&(t|=detachMethods(r))}return!!t},copyDelegatedFunctions:function(e,t){var i=null;if(e&&t&&t.setDelegate){var r,s={};for(r in e)isFunction$1(e[r])&&e[r].origFunction&&(s[r]=e[r]);i=t.setDelegate(s)}return i},dedupedArray:dedupedArray}),Pn={maxWait:1500,initialDelay:100,factor:2},ExponentialStrategy=function(e,t,i){this.delay=e||Pn.initialDelay,this.maxWait=isNumber$1(t)?t:Pn.maxWait,this.factor=i||Pn.factor,this.timeWaited=0};ExponentialStrategy.prototype.nextDelay=function(){var e=null,t=this.maxWait-this.timeWaited;return t>0&&(this.delay=Math.min(this.delay,t),this.timeWaited+=this.delay),(0===this.maxWait||t>0)&&(e=this.delay,this.delay=this.delay*this.factor),e};var In=Object.freeze({__proto__:null,exponentialBackoff:function(e,t,i,r,s,n){!function _backoff(e,t,i,r){t.call(t,i,(function(){var s=e.nextDelay();s?setTimeout(_backoff.bind(null,e,t,i,r),s):r.apply(r,arguments)}))}(new ExponentialStrategy(r,s,n),e,t,i)}});function disabled(e){return!!this.value("disabled",e)}function denylistedEvents(e){var t=this.value("denylistedEvents",e);return dedupedArray(this.value("blacklistedEvents",e),t)}function denylistedFields(e){var t=this.value("denylistedFields",e);return dedupedArray(this.value("blacklistedFields",e),t)}function removeDenylistedFields$1(e,t){if(e)for(var i=denylistedFields.call(this,t),r=0;r<i.length;r++){var s=i[r];s&&s in e&&delete e[s]}return e}function metricsDisabledOrDenylistedEvent$1(e,t){return disabled.call(this,t)||!!e&&denylistedEvents.call(this,t).indexOf(e)>-1}function deResFields(e){return this.value("deResFields",e)||[]}var An=Object.freeze({__proto__:null,disabled:disabled,blacklistedEvents:function(e){return denylistedEvents.call(this,e)},denylistedEvents:denylistedEvents,blacklistedFields:function(e){return denylistedFields.call(this,e)},denylistedFields:denylistedFields,removeBlacklistedFields:function(e,t){return removeDenylistedFields$1.call(this,e,t)},removeDenylistedFields:removeDenylistedFields$1,metricsDisabledOrBlacklistedEvent:function(e,t){return metricsDisabledOrDenylistedEvent$1.call(this,e,t)},metricsDisabledOrDenylistedEvent:metricsDisabledOrDenylistedEvent$1,deResFields:deResFields,applyDeRes:function(e,t){var i;return e&&deResFields.call(this,t).forEach((function(t){(i=t.fieldName)in e&&(e[i]=function(e,t,i){var r=void 0;if(isDefined(e))if(isDefined(t)||(t=1048576),isDefined(i)||(i=2),isNumber$1(e)&&isNumber$1(t)&&t>0&&isInteger$2(i)&&i>=0){var s=Math.pow(10,i);r=Math[e>0?"floor":"ceil"](e/t/s)*s}else r=NaN;return r}(e[i],t.magnitude,t.significantDigits))})),e}}),wn="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxy",Rn=wn+"z";function snakeCaseToCamelCase(e,t){var i="";if(e)for(var r,s=e.toLowerCase().split("_"),n=0;n<s.length;n++)r=s[n][0],(0!==n||t)&&(r=r.toUpperCase()),i+=r+s[n].slice(1);return i}function randomHexCharacter(e,i,r){var s,n=t.crypto||t.msCrypto;return s=e?(16*e()|0).toString(16):n&&n.getRandomValues?(15&n.getRandomValues(new Uint8Array(1))[0]).toString(16):n&&n.randomBytes?n.randomBytes(1).toString("hex")[0]:(16*Math.random()|0).toString(16),i&&r&&(s<i||s>r)&&(s=randomHexCharacter(e,i,r)),s}var On=Object.freeze({__proto__:null,base10Alphabet:"0123456789",base16Alphabet:"0123456789ABCDEF",base36Alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",base61Alphabet:wn,base62Alphabet:Rn,startsWith:function(e,t,i){var r=!1;return e&&t&&(e=e.substr(0,t.length),i&&(e=e.toLowerCase(),t=t.toLowerCase()),r=0===e.indexOf(t)),r},endsWith:function(e,t,i){var r=!1;if(e&&t){i&&(e=e.toLowerCase(),t=t.toLowerCase());var s=e.length-t.length;r=s>=0&&e.lastIndexOf(t)===s}return r},trim:function(e,t,i){var r=null,s=new RegExp("^[\t\n\v\f\r             　\u2028\u2029​]+"),n=new RegExp("[\t\n\v\f\r             　\u2028\u2029​]+$");if(e)if(i||t&&"\t\n\v\f\r             　\u2028\u2029​"!=t||!e.trim){var a=null,o=null,l=null;t&&void 0!==t?(a="["+(t=t.replace(/([.?*+^$[\]\\(){}-])/g,"\\$1"))+"]",o=new RegExp("^"+a+"+"),l=new RegExp(a+"+$")):(a="\t\n\v\f\r             　\u2028\u2029​",o=s,l=n),r=e.replace(o,"").replace(l,"")}else r=e.trim();return r},snakeCaseToCamelCase:snakeCaseToCamelCase,snakeCaseToUpperCamelCase:function(e){return snakeCaseToCamelCase(e,!0)},exceptionString:function(e,t){return"The function "+e+"."+t+"() must be overridden with a platform-specific delegate function.If you have no data for this function, have your delegate return null or undefined (no 'return')"},paramString:function(e){var t="",i="",r=!0;for(var s in e){var n=e[s];(n||0===n||!1===n)&&(t+=i+s+"="+encodeURIComponent(n),r&&(i="&",r=!1))}return t},versionStringFromUserAgent:function(e,t){var i=null;t=t||"\\S+";var r=new RegExp("\\b"+t+"/(\\S+)\\b","i").exec(e);return r&&r[1]&&(i=r[1]),i},requestId:function(e){var t=Date.now(),i=Math.floor(1e5*Math.random());return e+"z"+(t=t.toString(36).toUpperCase())+"z"+(i=i.toString(36).toUpperCase())},uuid:function(e){for(var t,i="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx",r="",s=0,n=i.length;s<n;s++)r+="x"===(t=i.charAt(s))?randomHexCharacter(e):"y"===t?randomHexCharacter(e,"8","b"):t;return r},randomHexCharacter:randomHexCharacter,convertNumberToBaseAlphabet:function(e,t){var i="",r=t.length;if(r<=36)i=e.toString(r).toUpperCase();else{for(var s,n,a=[];e>0;)s=e%r,n=t.charAt(s),a.push(n),e=(e-s)/r;i=a.reverse().join("")}return""===i&&(i="0"),i},cryptoRandomBase62String:function(e){var i;if(16777215==Math.floor(4294967295/256)){var r,s,n,a,o,l=t.crypto||t.msCrypto;if(l&&l.getRandomValues)r=l.getRandomValues(new Uint32Array(16/Uint32Array.BYTES_PER_ELEMENT)),o=!0;else if(l&&l.randomBytes){var d=l.randomBytes(16);r=new Uint32Array(d.buffer,d.byteOffset,d.byteLength/Uint32Array.BYTES_PER_ELEMENT),o=!0}else for(r=new Uint32Array(16/Uint32Array.BYTES_PER_ELEMENT),s=0;s<r.length;s++)r[s]=Math.floor(Math.random()*Math.floor(4294967295));if(r){for(i="",s=0;s<r.length;s++)for(a=r[s],n=0;n<6;n++)i+=Rn[a%62],a=Math.floor(a/62);e&&(i="1_"+(o?"1":"2")+"_"+i)}}return i}});function _valueForKeyPath(e,t,i){var r=t;if(e&&t)for(var s=e.split("."),n=0;r&&n<s.length;n++){var a=s[n];!(a in r)&&i&&(r[a]={}),r=a in r?r[a]:null}return r}function valueForKeyPath$1(e){var t=null;if(e&&arguments.length>1)for(var i=sourcesArray(Array.prototype.slice.call(arguments,1)),r=i.length-1;r>=0;r--){var s=i[r];if(isDefinedNonNull(t=_valueForKeyPath(e,s)))break}return t}function sourcesArray(e){var t=[],i=[];i=i.concat(e),arguments&&arguments.length>1&&(i=i.concat(Array.prototype.slice.call(arguments,1)));for(var r=0;r<i.length;r++){var s=i[r];t=t.concat(s)}return t}var Cn=Object.freeze({__proto__:null,valueForKeyPath:valueForKeyPath$1,createObjectAtKeyPath:function(e,t){return _valueForKeyPath(e,t,!0)},sourcesArray:sourcesArray});function mergeAndCleanEventFields(e){for(var t=[!1,!1,!1].concat(Array.prototype.slice.call(arguments)),i=[],r=0;r<t.length;r++){var s=t[r];if(s&&s.constructor===Array)for(var n=0;n<s.length;n++)i.push(s[n]);else i.push(s)}return copyKeysAndValues$1.apply(null,i)}var Mn=Object.freeze({__proto__:null,mergeAndCleanEventFields:mergeAndCleanEventFields,processMetricsData:function(e,t,i,r){var s=mergeAndCleanEventFields(r),n=s;if(e&&t){var a={};if(i||(t=t.filter((function(e){return e in s}))),t.length)for(var o=0;o<t.length;o++){var l=t[o],d=e[l];isFunction$1(d)&&(a[l]=d.call(e,s))}n=mergeAndCleanEventFields(n,a)}return n},applyFieldsMap:function(e,t,i,r){var s,n,a;if(e&&t&&i){var o,l;if(n={},s=valueForKeyPath$1(t,i,i.custom))if(isArray$1(s))for(o=0;o<s.length;++o)isDefinedNonNull(l=e[s[o]])&&(n[s[o]]=l);else if(isObject(s)){for(var d in s)for(o=0;o<s[d].length;++o)if(isDefinedNonNull(l=valueForKeyPath$1(s[d][o],e))){n[d]=l;break}}else a="metrics: incorrect data type provided to applyFieldsMap (only accepts objects and Arrays)";else a="metrics: unable to get "+t+" section from fieldsMap"}else{var c=[];e||c.push("data"),t||c.push("sectionName"),i||c.push("fieldsMap"),a="metrics: missing argument(s): "+c.join(",")+" not provided to applyFieldsMap"}return a&&isFunction$1(r)&&r(a),n}});function makeAjaxRequest$2(e,t,i,r,s,n){var a=new XMLHttpRequest;i=i||void 0,n=n||{},r=isFunction$1(r)?r:function(){},s=isFunction$1(s)?s:function(){};var o=!1!==n.async;n.timeout&&o&&(a.timeout=n.timeout),a.onload=function(){a.status>=200&&a.status<300?r(a.response):s(new Error("XHR error: server responded with status "+a.status+" "+a.statusText),a.status)},a.onerror=function(){s(new Error("XHR error"))},a.open(t,e,o),a.withCredentials="boolean"!=typeof n.withCredentials||n.withCredentials,a.setRequestHeader("Content-type","application/json"),a.send(i)}var Dn=Object.freeze({__proto__:null,makeAjaxGetRequest:function(e,t,i){makeAjaxRequest$2(e,"GET",null,t,i)},makeAjaxRequest:makeAjaxRequest$2}),Nn={LOCAL_STORAGE:"localStorage",SESSION_STORAGE:"sessionStorage"},_storageObject=function(e){var t=null,i=!1;return function(){return e?t=e:(i||(console.error("storageObject: storage object not found. Override this function if there is a platform-specific implementation"),i=!0),t||(t={storage:{},getItem:function(e){return this.storage[e]},setItem:function(e,t){this.storage[e]=t},removeItem:function(e){delete this.storage[e]}})),t}};function _defaultStorageObject(e){var t=null,i=e===Nn.LOCAL_STORAGE;try{t="undefined"!==(i?typeof localStorage:typeof sessionStorage)?i?localStorage:sessionStorage:null}catch(r){t=null,console.error("_utils.storage._defaultStorageObject: Unable to retrieve storage object: "+r)}return t}var Ln=_storageObject(_defaultStorageObject(Nn.LOCAL_STORAGE)),xn=_storageObject(_defaultStorageObject(Nn.SESSION_STORAGE));var Un=Object.freeze({__proto__:null,_utDefaultStorageObject:function(e){return _defaultStorageObject(e)},localStorageObject:Ln,sessionStorageObject:xn,saveObjectToStorage:function(e,t,i){var r=null;if(i)try{e.setItem(t,JSON.stringify(i)),r=i}catch(s){}else r=e.removeItem(t);return r},objectFromStorage:function(e,t){var i=null,r=e.getItem(t);if(r)try{i=JSON.parse(r)}catch(s){i=void 0}return i}});function FlagSymbol(e){this.key=e}FlagSymbol.prototype.toString=function(){return this.key};var Fn={flagArguments:{INCLUDE_CALL_STACK:new FlagSymbol("INCLUDE_CALL_STACK"),MIRROR_TO_SERVER:new FlagSymbol("MIRROR_TO_SERVER"),SUPPRESS_CLIENT_OUTPUT:new FlagSymbol("SUPPRESS_CLIENT_OUTPUT")},setDelegate:function(e){return kn.attachDelegate(this,e)},execute:function(e,t,i){var r=e.levelStringToIntMap[t];if(e.level()!==e.NONE&&e.level()<=r){var s=Array.prototype.slice.call(i),n=Fn.nonFlagLogArguments(s),a=Fn.logOptions(e,r,s),o=a.includeCallStack?(new Error).stack:null,l=o?n.concat("\n"+o):n;if(e[t]._lastLog=l,a.mirrorToServer,a.throwInsteadOfPrint)throw new Error(n.toString());a.suppressClientOutput||(console[t]?console[t].apply(console,l):console.log.apply(console,l))}},isFlagObject:function(e){return e&&e===Fn.flagArguments[e.toString()]},nonFlagLogArguments:function(e){return e.filter((function(e){return!Fn.isFlagObject(e)}))},logOptions:function(e,t,i){var r,s={};return i.forEach((function(e){Fn.isFlagObject(e)&&(r=On.snakeCaseToCamelCase(e.toString()),s[r]=!0)})),kn.isFunction(e.mirrorToServerLevel)&&e.mirrorToServerLevel()!==e.NONE&&e.mirrorToServerLevel()<=t&&(s.mirrorToServer=!0),e.throwLevel()!==e.NONE&&e.throwLevel()<=t&&(s.throwInsteadOfPrint=!0),s},sendToServer:function(e,t,i,r){}},jn={NONE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4},Bn={MIN_LEVEL:jn.NONE,MAX_LEVEL:jn.ERROR,levelIntToStringMap:{0:"none",1:"debug",2:"info",3:"warn",4:"error"},levelStringToIntMap:{none:0,debug:1,info:2,warn:3,error:4}};kn.extend(Bn,jn);var Kn={loggerName:"defaultLogger",level:Bn.INFO,throwLevel:Bn.NONE},$n=!1,Vn={};function Logger(e){this._loggerName=e,this._level,this._throwLevel,$n||($n=!0,kn.extend(Logger.prototype,Bn),kn.extend(Logger.prototype,Fn.flagArguments))}function loggerNamed(e){var t=Vn[e=e||Kn.loggerName];return t||(t=new Logger(e),Vn[e]=t),t}Logger.level=function(){return Kn.level},Logger.throwLevel=function(){return Kn.throwLevel},Logger.prototype.setDelegate=function(e){return kn.attachDelegate(this,e)},Logger.prototype.loggerName=function(){return this._loggerName},Logger.prototype.levelParameterAsInt=function(e){var t,i=null;return kn.isString(e)?t=this.levelStringToIntMap[e.toLowerCase()]:kn.isNumber(e)&&(t=e),t>=this.MIN_LEVEL&&t<=this.MAX_LEVEL&&(i=t),i},Logger.prototype.setLevel=function(e){var t=this.levelParameterAsInt(e);null!==t&&(this._level=t)},Logger.prototype.setThrowLevel=function(e){var t=this.levelParameterAsInt(e);null!==t&&(this._throwLevel=t)},Logger.prototype.level=function(){var e=this._level;return kn.isNumber(e)?e:Logger.level()},Logger.prototype.levelString=function(){return this.levelIntToStringMap[this.level()]},Logger.prototype.throwLevel=function(){var e=this._throwLevel;return kn.isNumber(e)?e:Logger.throwLevel()},Logger.prototype.debug=function(){Fn.execute(this,"debug",arguments)},Logger.prototype.info=function(){Fn.execute(this,"info",arguments)},Logger.prototype.warn=function(){Fn.execute(this,"warn",arguments)},Logger.prototype.error=function(){Fn.execute(this,"error",arguments)},Logger.prototype.lastLog=function(e){return this[e]?this[e]._lastLog:null};var Wn=kn.attachDelegate,Hn={setDelegate:function(e){return Wn(this,e)},localStorageObject:Un.localStorageObject,sessionStorageObject:Un.sessionStorageObject},zn=kn.attachDelegate,qn={setDelegate:function(e){return zn(this,e)},makeAjaxRequest:Dn.makeAjaxRequest},Yn=kn.attachDelegate,Gn=kn.hasAnyKeys,Qn=kn.isArray,Xn=Un.saveObjectToStorage,Jn=Un.objectFromStorage,Zn=In.exponentialBackoff,ea=Cn.valueForKeyPath,ta={blacklistedFields:["capacitySystem","capacitySystemAvailable","capacityDisk","capacityData","capacityDataAvailable"],compoundSeparator:"_",configBaseUrl:"https://xp.apple.com/config/1/report",constraints:{profiles:{AMPWeb:{precedenceOrderedRules:[{filters:"any",fieldConstraints:{clientId:{generateValue:!0,namespace:"AMPWeb_isSignedOut",expirationPeriod:864e5}}},{filters:{valueMatches:{isSignedIn:[!0]}},fieldConstraints:{clientId:{generateValue:!0,namespace:"AMPWeb_isSignedIn",expirationPeriod:15552e6}}}]},strict:{precedenceOrderedRules:[{filters:"any",fieldConstraints:{clientId:{generateValue:!0,scopeFieldName:"parentPageUrl",scopeStrategy:"mainDomain",expirationPeriod:864e5},consumerId:{blacklisted:!0},dsId:{blacklisted:!0},parentPageUrl:{scope:"hostname"}}},{filters:{valueMatches:{eventType:["click"],actionType:["signUp"]}},fieldConstraints:{parentPageUrl:{scope:"fullWithoutParams"}}},{filters:{valueMatches:{eventType:["dialog"],dialogType:["upsell"],result:["upsell"]}},fieldConstraints:{parentPageUrl:{scope:"fullWithoutParams"}}},{filters:{valueMatches:{userType:["signedIn"]}},fieldConstraints:{clientId:{scopeStrategy:"all"}}},{filters:{valueMatches:{userType:["signedIn"],eventType:["click","dialog","media","search"]}},fieldConstraints:{clientId:{blacklisted:!0},consumerId:{blacklisted:!1},dsId:{blacklisted:!1}}},{filters:{valueMatches:{userType:["signedIn"],eventType:["page","impressions"]},nonEmptyFields:["pageHistory"]},fieldConstraints:{clientId:{blacklisted:!0},consumerId:{blacklisted:!1},dsId:{blacklisted:!1}}}]}}},fieldsMap:{cookies:["itcCt","itscc"],custom:{impressions:["id","adamId","link.type","station-hash"],location:["id","adamId","dataSetId","name","fcKind","kindIds","type","link.type","station-hash","core-seed-name"]},single:{targetId:["id","adamId","contentId","type","link.type","fcId","userPreference","label","station-hash","linkIdentifier"]}},metricsUrl:"https://xp.apple.com/report",postFrequency:6e4,postFrequencyLowLatency:5e3,tokenSeparator:"|"},ia={},_appendSectionAndSubsectionToConfigSources=function(e,t,i){if(i){e.push(i);var r=i[t];r&&Gn(r)&&e.push(r)}},Config=function(e){this._topic=e,this._debugSource=null,this._cachedSource=null,this._serviceSource=null,this._initCalled=!1,this._initialized=!1,this._showedDebugWarning=!1,this._showedNoProvidedSourceWarning=!1,this._keyPathsThatSuppressWarning={configBaseUrl:!0},this.DEBUG_SOURCE_KEY="mtClientConfig_debugSource"+ta.compoundSeparator+this._topic,this.CACHED_SOURCE_KEY="mtClientConfig_cachedSource"+ta.compoundSeparator+this._topic};Config.createConfig=function(e,t,i,r){var s=Config.getConfig(e);return e&&"noTopicConfig"!==e&&!s._initCalled&&s.init(t,i,r),s},Config.getConfig=function(e){var t=ia[e=e||"noTopicConfig"];return t||(t=new Config(e),ia[e]=t),t},Config.cleanupConfig=function(e){if(e&&ia[e]){var t=ia[e];t.setCachedSource(),t.setDebugSource(),delete ia[e]}},Config.defaultConfig=function(){return Config.getConfig()},Config.value=function(e,t){var i=t&&ia[t]||Config.defaultConfig();return i.value.call(i,e)},Config.environment=Hn,Config.logger=loggerNamed("mt-client-config"),Config.network=qn,Config.prototype._defaults=function(){return ta},Config.prototype._setInitialized=function(e){this._initialized=e},Config.prototype._setInitCalled=function(e){this._initCalled=e},Config.prototype._setShowedDebugWarning=function(e){this._showedDebugWarning=e},Config.prototype._setShowedNoProvidedSourceWarning=function(e){this._showedNoProvidedSourceWarning=e},Config.prototype.setDelegate=function(e){return Yn(this,e)},Config.prototype.topic=function(){return this._topic},Config.prototype.configHostname=function(){},Config.prototype.configUrl=function(){var e,t=this.configHostname();return e=t?"https://"+t+"/config/1/report":this.value("configBaseUrl"),"noTopicConfig"!==this._topic?e+="/"+this.topic():Config.logger.error("config.configUrl(): Topic must be provided"),e},Config.prototype.sources=function(){},Config.prototype.value=function(e){var t,i=this.cachedSource(),r=this.serviceSource(),s=this.sources(),n=this.debugSource(),a=i||r||s||n;return s||r||e in this._keyPathsThatSuppressWarning||this._showedNoProvidedSourceWarning||(this._showedNoProvidedSourceWarning=!0,Config.logger.warn("Metrics config: No config provided via delegate or fetched via init(), using default/cached config values.")),n&&(this._showedDebugWarning||(this._showedDebugWarning=!0,Config.logger.warn('"debugSource" found.\nThis will override any same-named client-supplied configSource fields.\nThis setting "sticks" across session, use "setDebugSource(null)" to clear'))),Qn(s)||(s=[s]),t=0===e.indexOf("blacklisted")?a?[i,r,s,n]:[ta]:[ta,i,r,s,n],t=this.configSourcesWithOverrides(t,this.topic()),ea.apply(null,[e].concat(t))},Config.prototype.configSourcesWithOverrides=function(e,t){var i=e;if(e&&e.length&&t){i=[];for(var r=0;r<e.length;r++){var s=e[r];if(s)if(Qn(s)&&s.length){for(var n=[],a=0;a<s.length;a++)_appendSectionAndSubsectionToConfigSources(n,t,s[a]);i.push(n)}else _appendSectionAndSubsectionToConfigSources(i,t,s)}}return i},Config.prototype.setDebugSource=function(e){return this._debugSource=e||null,Xn(Hn.localStorageObject(),this.DEBUG_SOURCE_KEY,this._debugSource)},Config.prototype.debugSource=function(){return this._debugSource||(this._debugSource=Jn(Hn.localStorageObject(),this.DEBUG_SOURCE_KEY)),this._debugSource},Config.prototype.setCachedSource=function(e){return this._cachedSource=e||null,Xn(Hn.localStorageObject(),this.CACHED_SOURCE_KEY,this._cachedSource)},Config.prototype.cachedSource=function(){return this._cachedSource||(this._cachedSource=Jn(Hn.localStorageObject(),this.CACHED_SOURCE_KEY)),this._cachedSource},Config.prototype.setServiceSource=function(e){return this._serviceSource=e,this._serviceSource},Config.prototype.serviceSource=function(){return this._serviceSource},Config.prototype.fetchConfig=function(e,t,i){i=i||function(){};Zn(qn.makeAjaxRequest.bind(qn,e,"GET",null),(function(e){var r;try{e=JSON.parse(e),r=!0}catch(s){i.call(i,s)}r&&t&&t.call(t,e)}),i)},Config.prototype.init=function(e,t,i){if(!this._initCalled){this._initCalled=!0,t=t||function(){};var r=function(){this._initialized=!0,t.call(t)}.bind(this);if(e)this.setDelegate({sources:e}),r();else{this.setCachedSource(this.cachedSource());var s=this.configUrl(),n=function(e){this.setCachedSource(e),this.setServiceSource(e),r()}.bind(this);this.fetchConfig(s,n,i)}}},Config.prototype.initialize=function(e,t,i){return this.init.apply(this,Array.prototype.slice.call(arguments))},Config.prototype.initialized=function(){return this._initialized},kn.attachDelegate;var ra=An.metricsDisabledOrDenylistedEvent,sa=An.removeDenylistedFields,na={},aa=["dsId","consumerId"];function recordEvent(e,t,i){var r=null;return i&&!ra.call(Config,i.eventType,t)&&(sa.call(Config,i,t),_removeIdentifiableFieldsForTopic(t,i),e.apply(null,Array.prototype.slice.call(arguments,1)),r=i),r}function _removeIdentifiableFieldsForTopic(e,t){na[e]=na[e]||{},na[e].anonymous&&aa.forEach((function(e){delete t[e]}))}var oa=kn.attachDelegate,la={setDelegate:function(e){return oa(this,e)},makeAjaxRequest:Dn.makeAjaxRequest};kn.isString,kn.isFunction,An.disabled;var da=1e4,ca="events",ua="1.0",ha=2;function enrichAndSerializeEvents(e){var t=null;if(e&&e.length){var i={};i.deliveryVersion=ua,i.postTime=Date.now(),i[ca]=e;try{t=JSON.stringify(i)}catch(r){loggerNamed("mt-event-queue").error("Error stringifying events as JSON: "+r)}}return t}function _immediateRecordEvent(e,t){var i=enrichAndSerializeEvents([t]);if(i){var r=function(e){return Config.value("metricsUrl",e)+"/"+ha+"/"+e}(e),s={timeout:function(e){var t=Config.value("requestTimeout",e)||da;return t=Math.min(t,Config.value("postFrequency",e))}(e)};na[e]&&na[e].anonymous&&(s.withCredentials=!1),la.makeAjaxRequest(r,"POST",i,null,null,s)}}kn.attachDelegate;var pa,ya,ma={_document:function(){if("undefined"!=typeof document)return document;throw"metricskit-delegates-html.environment HTML delegate 'document' object not found"},_window:function(){if("undefined"!=typeof window)return window;throw"metricskit-delegates-html.environment HTML delegate 'window' object not found"},cookie:function(){return ma._window().document.cookie},pageUrl:function(){return ma._window().location.href},parentPageUrl:function(){var e,t=ma._window(),i=t.parent;if(i!==t)try{e=i.location.href}catch(r){e=ma._document().referrer}return e},pixelRatio:function(){return ma._window().devicePixelRatio},screenHeight:function(){return ma._window().screen.height},screenWidth:function(){return ma._window().screen.width},userAgent:function(){return ma._window().navigator.userAgent},windowInnerHeight:function(){return ma._window().innerHeight},windowInnerWidth:function(){return ma._window().innerWidth},windowOuterHeight:function(){return ma._window().outerHeight},windowOuterWidth:function(){return ma._window().outerWidth},timeOriginOffset:function(){var e=null,t=ma._window().performance;return t&&t.timing&&(e=t.timing.navigationStart),e},app:function(){},appVersion:function(){},capacityData:function(){},capacityDataAvailable:function(){},capacityDisk:function(){},capacitySystem:function(){},capacitySystemAvailable:function(){},connectionType:function(){},dsId:function(){},hardwareBrand:function(){},hardwareFamily:function(){},hardwareModel:function(){},hostApp:function(){},hostAppVersion:function(){},os:function(){},osBuildNumber:function(){},osLanguages:function(){},osVersion:function(){},resourceRevNum:function(){},storeFrontCountryCode:function(){},storeFrontHeader:function(){},userType:function(){}},ga={recordEvent:function(e,t){return recordEvent.apply(null,[_immediateRecordEvent].concat(Array.prototype.slice.call(arguments)))},sendMethod:function(){return"javascript"},setProperties:function(e,t){na[e]=na[e]||{},na[e]=t},cleanup:function(){na={}}};function environmentBaseFieldNames(){return ya||(ya=["app","appVersion","hardwareFamily","hardwareModel","os","osBuildNumber","osLanguages","osVersion","resourceRevNum","screenHeight","screenWidth","userAgent"].concat(["delegateApp","hardwareBrand","storeFrontCountryCode","storeFrontHeader"])),ya}var fa,va=kn.attachDelegate,_a=On.cryptoRandomBase62String,ba=On.exceptionString;function Base$1(e){this.setDelegate({topic:e}),fa||(fa=!0,environmentBaseFieldNames().forEach((function(e){Base$1.prototype[e]=function(t){return t&&t.hasOwnProperty(e)?t[e]:this.environment()[e]()}})))}Base$1._className="eventHandlers.base",Base$1.prototype.setDelegate=function(e){return va(this,e)},Base$1.prototype.topic=function(){throw ba(Base$1._className,"topic")},Base$1.prototype.environment=function(){throw ba(Base$1._className,"environment")},Base$1.prototype.eventRecorder=function(){throw ba(Base$1._className,"eventRecorder")},Base$1.prototype.metricsData=function(){throw ba(Base$1._className,"metricsData")},Base$1.prototype.processMetricsData=function(){throw ba(Base$1._className,"processMetricsData")},Base$1.prototype.knownFields=function(){return pa||(pa=environmentBaseFieldNames().concat(["baseVersion","clientEventId","connection","eventTime","eventType","eventVersion","timezoneOffset","xpPostFrequency","xpSendMethod"])),pa},Base$1.prototype.baseVersion=function(){return 1},Base$1.prototype.clientEventId=function(e){return e&&e.clientEventId||_a(!0)},Base$1.prototype.connection=function(e){return e&&e.connection||this.environment().connectionType()},Base$1.prototype.dsId=function(e){return e&&e.dsId||this.environment().dsId()},Base$1.prototype.eventTime=function(e){return e&&e.eventTime||Date.now()},Base$1.prototype.eventVersion=function(e){return e&&e.eventVersion||null},Base$1.prototype.timezoneOffset=function(e){return e&&e.timezoneOffset||(new Date).getTimezoneOffset()},Base$1.prototype.xpPostFrequency=function(e){return e&&e.xpPostFrequency||Config.value("postFrequency",this.topic())},Base$1.prototype.xpSendMethod=function(e){return e&&e.xpSendMethod||this.eventRecorder().sendMethod()};var Ta,Sa=Base$1,Ea=kn.attachDelegate,ka=On.exceptionString,Pa=Un.localStorageObject,Ia=Un.sessionStorageObject;function Environment$1(){Ta||(Ta=!0,["app","appVersion","hardwareFamily","hardwareModel","os","osBuildNumber","osLanguages","osVersion","resourceRevNum","screenHeight","screenWidth","userAgent"].forEach((function(e){Environment$1.prototype[e]=function(){throw ka(Environment$1._className,e)}})),["delegateApp","hardwareBrand","storeFrontCountryCode","storeFrontHeader"].forEach((function(e){Environment$1.prototype[e]=function(){}})))}Environment$1._className="system.environment",Environment$1.prototype.setDelegate=function(e){return Ea(this,e)},Environment$1.prototype.connectionType=function(){throw ka(Environment$1._className,"connectionType")},Environment$1.prototype.dsId=function(){},Environment$1.prototype.localStorageObject=Pa,Environment$1.prototype.sessionStorageObject=Ia;var Aa=Environment$1,wa=kn.extend;function MetricsData$2(){this._eventData={}}MetricsData$2.prototype.updateData=function(){wa.apply(null,[this._eventData].concat(Array.prototype.slice.call(arguments)))};var Ra,Oa=MetricsData$2;function topic(){return Ra}var Ca="unknown",Ma="next",Da="previous",Na="location",La="interval",xa="playhead",Ua="scrub",Fa="transition",ja="interruption",Ba="buffering",Ka="play",$a="seek",Va="skipIntro",Wa="actionType",Ha="consumerId",za="consumerNs",qa="dsId",Ya="eventType",Ga="eventVersion",Qa="isOffline",Xa="videoViewportHeight",Ja="videoViewportWidth",Za={TYPE:{MANUAL:"manual",AUTOMATIC:"automatic",UNKNOWN:Ca},PLAY_START_REASON:{PLAY:Ka,UNPAUSE:"unpause",NEXT:Ma,PREVIOUS:Da,SEEK:$a,TRANSITION:Fa,INTERRUPTION:ja,FOREGROUND:"foreground",FOCUS:"focus",BUFFERING:Ba,UNKNOWN:Ca},PLAY_START_REASON_TYPE:{SKIP_INTRO:Va},PLAY_STOP_REASON:{COMPLETE:"complete",TRANSITION:Fa,PLAY_OTHER:"playOther",PAUSE:"pause",SEEK:$a,NEXT:Ma,INTERRUPTION:ja,BACKGROUND:"background",EXIT:"exit",INACTIVITY:"inactivity",BUFFERING:Ba,ERROR:"error",FAILURE:"failure",UNKNOWN:Ca,CLOSE_PLAYER:"closePlayer"},PLAY_STOP_REASON_TYPE:{SKIP_INTRO:Va},SEEK_START_REASON:{NEXT:Ma,PREVIOUS:Da,LOCATION:Na,INTERVAL:La,PLAYHEAD:xa,SCRUB:Ua,UNKNOWN:Ca,SKIP_INTRO:Va},SEEK_STOP_REASON:{NEXT:Ma,PREVIOUS:Da,LOCATION:Na,INTERVAL:La,PLAYHEAD:xa,SCRUB:Ua,UNKNOWN:Ca,SKIP_INTRO:Va}},eo={ACTIVITY_TYPE:{PLAY:Ka,SEEK:$a},ACTION_TYPE:{START:"start",STOP:"stop"},EVENT_TYPE:{PLAY_ACTIVITY:"playActivity",SEEK_ACTIVITY:"seekActivity"}},to={INCLUDES_START_POSITIONS:"includesStartPositions",INCLUDES_END_POSITIONS:"includesEndPositions"},io=Aa;function VPAFKitEnvironment(){io.apply(this,arguments)}VPAFKitEnvironment.prototype=new io,VPAFKitEnvironment.prototype.constructor=VPAFKitEnvironment,VPAFKitEnvironment.prototype.consumerId=function(){},VPAFKitEnvironment.prototype.consumerNs=function(){},VPAFKitEnvironment.prototype.isOffline=function(){},VPAFKitEnvironment.prototype.videoViewportHeight=function(){},VPAFKitEnvironment.prototype.videoViewportWidth=function(){};var ro=kn.attachDelegate,so=On.exceptionString,no={setDelegate:function(e){return ro(this,e)},recordEvent:function(e,t){throw so("system.eventRecorder","recordEvent")},sendMethod:function(){throw so("system.eventRecorder","sendMethod")},flushUnreportedEvents:function(e){}},ao={};ao.environment=new VPAFKitEnvironment,ao.eventRecorder=no,ao.logger=loggerNamed("mt-vpafkit");var oo=Sa,lo=Mn.processMetricsData,VPAFKitBase=function(){oo.apply(this,arguments)};(VPAFKitBase.prototype=new oo).constructor=VPAFKitBase,VPAFKitBase.prototype.environment=function(){return ao.environment},VPAFKitBase.prototype.eventRecorder=function(){return ao.eventRecorder},VPAFKitBase.prototype.knownFields=function(){var e=oo.prototype.knownFields().concat([Wa,Ha,za,qa,Qa,Xa,Ja]);return e},VPAFKitBase.prototype.consumerId=function(e){var t=Ha;return e&&t in e?e[t]:this.environment().consumerId()},VPAFKitBase.prototype.consumerNs=function(e){var t=za;return e&&t in e?e[t]:this.environment().consumerNs()},VPAFKitBase.prototype.isOffline=function(e){var t=Qa;return e&&t in e?e[t]:this.environment().isOffline()},VPAFKitBase.prototype.videoViewportHeight=function(e){var t=Xa;return e&&t in e?e[t]:this.environment().videoViewportHeight()},VPAFKitBase.prototype.videoViewportWidth=function(e){var t=Ja;return e&&t in e?e[t]:this.environment().videoViewportWidth()};var co=new VPAFKitBase((function(){return topic()}));co.metricsData=function(){return co.processMetricsData.apply(co,[null].concat(Array.prototype.slice.call(arguments)))},co.processMetricsData=function(e){var t=null;if(!Config.metricsDisabledOrBlacklistedEvent(e,topic())){var i=Array.prototype.slice.call(arguments,1);if(this!==co){var r=co.metricsData.apply(co,i);i=[r].concat(i)}t=lo(this,this.knownFields(),!0,i)}return Config.removeBlacklistedFields(t,topic()),t};var uo=kn.attachDelegate,ho=kn.extend,MediaActivity=function(e,t){this._defaultEventType=e,this._reasonConstants=t,this._defaultActionType};ho(MediaActivity,eo),Object.defineProperties(MediaActivity.prototype,{TYPE:{get:function(){return Za.TYPE}},REASON:{get:function(){return this._reasonConstants}}}),MediaActivity.prototype.setDelegate=function(e){return uo(this,e)},MediaActivity.prototype.knownFields=function(){var e=[Wa,Ya,Ga];return e},MediaActivity.prototype.eventType=function(e){return this._defaultEventType},MediaActivity.prototype.eventVersion=function(e){var t=co.eventVersion(e);return null!==t?t:1},MediaActivity.prototype.actionType=function(e){return this._defaultActionType};var StartMediaActivity=function(e,t){MediaActivity.apply(this,arguments),this._defaultActionType=MediaActivity.ACTION_TYPE.START};(StartMediaActivity.prototype=new MediaActivity).constructor=StartMediaActivity,StartMediaActivity.prototype.metricsData=function(e,t,i,r){var s=this.eventType(),n={position:e,overallPosition:t,startType:i,startReason:r},a=Array.prototype.slice.call(arguments,4);return co.processMetricsData.apply(this,[s,n].concat(a))};var StopMediaActivity=function(e,t){MediaActivity.apply(this,arguments),this._defaultActionType=MediaActivity.ACTION_TYPE.STOP};(StopMediaActivity.prototype=new MediaActivity).constructor=StopMediaActivity,StopMediaActivity.prototype.metricsData=function(e,t,i,r,s){var n=this.eventType(),a={position:e,overallPosition:t,stopType:i,stopReason:r,startPosition:(s=s||{}).position,startOverallPosition:s.overallPosition,startTime:s.eventTime,startType:s.startType,startReason:s.startReason,startReasonType:s.startReasonType};n===MediaActivity.EVENT_TYPE.SEEK_ACTIVITY&&(a.startAssetId=s.assetId);var o=Array.prototype.slice.call(arguments,5);return co.processMetricsData.apply(this,[n,a].concat(o))};var po=new StartMediaActivity(MediaActivity.EVENT_TYPE.PLAY_ACTIVITY,Za.PLAY_START_REASON),yo=new StopMediaActivity(MediaActivity.EVENT_TYPE.PLAY_ACTIVITY,Za.PLAY_STOP_REASON),mo=new StartMediaActivity(MediaActivity.EVENT_TYPE.SEEK_ACTIVITY,Za.SEEK_START_REASON),go=new StopMediaActivity(MediaActivity.EVENT_TYPE.SEEK_ACTIVITY,Za.SEEK_STOP_REASON),fo=Object.freeze({__proto__:null,base:co,playStart:po,playStop:yo,seekStart:mo,seekStop:go}),vo=kn.extend,MediaActivity$1=function(e){this._activityType=e,this._startMetricsData=null,this._isStopped=!1};MediaActivity$1.ACTIVITY_TYPE=eo.ACTIVITY_TYPE,Object.defineProperties(MediaActivity$1.prototype,{isStopped:{get:function(){return this._isStopped}},type:{get:function(){return this._activityType}},startOverallPosition:{get:function(){return this._startMetricsData?this._startMetricsData.overallPosition:null}}}),vo(MediaActivity$1.prototype,Za),MediaActivity$1.prototype.started=function(e,t,i,r){var s=this._startEventHandler();s&&(this._startMetricsData=s.metricsData.apply(s,arguments),this.type!=MediaActivity$1.ACTIVITY_TYPE.SEEK&&no.recordEvent(topic(),this._startMetricsData))},MediaActivity$1.prototype.stopped=function(e,t,i,r){var s=this._stopEventHandler();if(s){this._isStopped=!0;var n=[e,t,i,r,this._startMetricsData].concat(Array.prototype.slice.call(arguments,4)),a=s.metricsData.apply(s,n);no.recordEvent(topic(),a)}},MediaActivity$1.prototype._startEventHandler=function(){var e;switch(this.type){case MediaActivity$1.ACTIVITY_TYPE.PLAY:e=po;break;case MediaActivity$1.ACTIVITY_TYPE.SEEK:e=mo}return e},MediaActivity$1.prototype._stopEventHandler=function(){var e;switch(this.type){case MediaActivity$1.ACTIVITY_TYPE.PLAY:e=yo;break;case MediaActivity$1.ACTIVITY_TYPE.SEEK:e=go}return e};var _o=kn.isInteger,TimeTracker=function(e,t){this._date=new Date,this._position=t,this._validatePlaybackRate(e),this._playbackRate=e};Object.defineProperties(TimeTracker.prototype,{playbackRate:{get:function(){return this._playbackRate}}}),TimeTracker.prototype.update=function(e,t){this._date=new Date,this._position=t,this._validatePlaybackRate(e),this._playbackRate=e},TimeTracker.prototype.estimatedTime=function(e){var t;_o(e)?t=e:(ao.logger.error("VPAFKit error: position should be an integer"),t=Math.round(e));var i=(t-this._position)/(0==this.playbackRate?1:this.playbackRate);return this._date.getTime()+Math.round(i)},TimeTracker.prototype._validatePlaybackRate=function(e){0==e&&ao.logger.error("VPAFKit error: playbackRate should not be zero.")};var bo=kn.attachDelegate,To=kn.extend,So=kn.isFunction,Eo=kn.isNumber,ko=Oa,Po=to.INCLUDES_START_POSITIONS,Io=to.INCLUDES_END_POSITIONS,MediaActivityTracker=function(e){ko.apply(this,arguments),this._playlist=e,this._playActivity=null,this._playStartPlaylistItem=null,this._seekActivity=null,this._timeTracker=null,this._shouldGenerateTransitions=!0};(MediaActivityTracker.prototype=new ko).constructor=MediaActivityTracker,To(MediaActivityTracker.prototype,Za),Object.defineProperties(MediaActivityTracker.prototype,{shouldGenerateTransitions:{get:function(){return this._shouldGenerateTransitions},set:function(e){this._shouldGenerateTransitions=e}}}),MediaActivityTracker.prototype.setDelegate=function(e){return bo(this,e)},MediaActivityTracker.prototype.playStarted=function(e,t,i){return this.playStartedWithPlaybackRate.apply(this,[1].concat(Array.prototype.slice.call(arguments)))},MediaActivityTracker.prototype.playStartedWithPlaybackRate=function(e,t,i,r){if(this._hasUnstoppedActivity(this._playActivity))this._error("inconsistent state: did you forget to call playStopped?");else{var s=this._playlistItem(t,Po);s&&(this._playStarted.apply(this,[s].concat(Array.prototype.slice.call(arguments,1))),this.shouldGenerateTransitions&&(this._timeTracker=new TimeTracker(e,t)))}},MediaActivityTracker.prototype.playStopped=function(e,t,i){this._generatePlaylistTransitionsIfNecessary(e),this._hasUnstoppedActivity(this._playActivity)?this._playStopped.apply(this,Array.prototype.slice.call(arguments)):this._error("inconsistent state: did you forget to call playStarted?"),this._playStartPlaylistItem=null,this._timeTracker=null},MediaActivityTracker.prototype.playTransitioned=function(e){this.playStopped.apply(this,[e,this.TYPE.AUTOMATIC,this.PLAY_STOP_REASON.TRANSITION].concat(Array.prototype.slice.call(arguments,1))),this.playStarted.apply(this,[e,this.TYPE.AUTOMATIC,this.PLAY_START_REASON.TRANSITION].concat(Array.prototype.slice.call(arguments,1)))},MediaActivityTracker.prototype.seekStarted=function(e,t,i){if(this._hasUnstoppedActivity(this._seekActivity))this._error("inconsistent state: did you forget to call seekStopped?");else{var r=this._playlistItem(e,Po);if(r){var s=this._activityArguments.apply(this,[r].concat(Array.prototype.slice.call(arguments)));this._seekActivity=new MediaActivity$1(MediaActivity$1.ACTIVITY_TYPE.SEEK),this._seekActivity.started.apply(this._seekActivity,s)}}},MediaActivityTracker.prototype.seekStopped=function(e,t,i){var r=this._playlistItem(e,Io);if(r&&this._hasUnstoppedActivity(this._seekActivity)){var s=this._activityArguments.apply(this,[r].concat(Array.prototype.slice.call(arguments)));this._seekActivity.stopped.apply(this._seekActivity,s)}else this._error("inconsistent state: did you forget to call seekStarted?")},MediaActivityTracker.prototype.synchronize=function(e,t){if(this.shouldGenerateTransitions){var i=e>0,r=this._hasUnstoppedActivity(this._playActivity);r&&i?(this._generatePlaylistTransitionsIfNecessary(t),this._timeTracker.update(e,t)):r&&!i?this._error("inconsistent state: did you forget to call playStopped?"):!r&&i&&this._error("inconsistent state: did you forget to call playStarted?")}},MediaActivityTracker.prototype._playStarted=function(e,t,i,r){var s=this._activityArguments.apply(this,[e].concat(Array.prototype.slice.call(arguments,1)));this._playStartPlaylistItem=e,this._playActivity=new MediaActivity$1(MediaActivity$1.ACTIVITY_TYPE.PLAY),this._playActivity.started.apply(this._playActivity,s)},MediaActivityTracker.prototype._playStopped=function(e,t,i){var r=this._playStartPlaylistItem,s=this._activityArguments.apply(this,[r].concat(Array.prototype.slice.call(arguments)));this._playActivity.stopped.apply(this._playActivity,s)},MediaActivityTracker.prototype._playlistItem=function(e,t){var i;return this._playlist&&So(this._playlist.getItem)&&(i=this._playlist.getItem(e,t)),i||this._error("unable to get item from playlist"),i},MediaActivityTracker.prototype._playlistItems=function(e,t){var i=[];return this._playlist&&So(this._playlist.getItems)?i=this._playlist.getItems(e,t):this._error("unable to get items from playlist"),i},MediaActivityTracker.prototype._relativePosition=function(e,t){var i;return(t=t||this._playlistItem(e))&&Eo(t.startOverallPosition)&&(i=e-t.startOverallPosition+(t.startPosition||0)),i},MediaActivityTracker.prototype._combineEventData=function(e,t){var i=this._playlist?this._playlist.eventData:null,r=e?e.eventData:null,s=[];return i&&s.push(i),r&&s.push(r),this._eventData&&s.push(this._eventData),t&&(s=s.concat(t)),s},MediaActivityTracker.prototype._activityArguments=function(e,t,i,r){var s=this._relativePosition(t,e),n=this._combineEventData(e,Array.prototype.slice.call(arguments,4)),a=[s,t,i,r].concat(n);return a},MediaActivityTracker.prototype._generatePlaylistTransitionsIfNecessary=function(e){if(this.shouldGenerateTransitions&&this._hasUnstoppedActivity(this._playActivity)){var t,i,r,s=this._playActivity.startOverallPosition||0,n=this._playlistItems(s,e);this._playlist._returnsOrderedItems||n.sort(this._playlistItemComparator);for(var a=0;a+1<n.length;a++)if(!((t=(i=n[a+1]).startOverallPosition)<=s)){if(t>=e)break;r={eventTime:this._timeTracker?this._timeTracker.estimatedTime(t):null},this._playStopped(t,this.TYPE.AUTOMATIC,this.PLAY_STOP_REASON.TRANSITION,r),this._playStarted(i,t,this.TYPE.AUTOMATIC,this.PLAY_START_REASON.TRANSITION,r)}}},MediaActivityTracker.prototype._hasUnstoppedActivity=function(e){return e&&!e.isStopped},MediaActivityTracker.prototype._error=function(e){ao.logger.error(this.constructor.name+" error: "+e)},MediaActivityTracker.prototype._playlistItemComparator=function(e,t){return e.startOverallPosition==t.startOverallPosition?0:e.startOverallPosition<t.startOverallPosition?-1:1};var Ao=Oa,MediaPlaylistItem=function(e){Ao.apply(this,arguments),this._startOverallPosition=e,this._startPosition=0};(MediaPlaylistItem.prototype=new Ao).constructor=MediaPlaylistItem,Object.defineProperties(MediaPlaylistItem.prototype,{startOverallPosition:{get:function(){return this._startOverallPosition}},startPosition:{get:function(){return this._startPosition},set:function(e){this._startPosition=e}},eventData:{get:function(){return this._eventData}}});var HLSRollItem=function(e,t){MediaPlaylistItem.apply(this,arguments),this._duration=t};(HLSRollItem.prototype=new MediaPlaylistItem).constructor=HLSRollItem,Object.defineProperties(HLSRollItem.prototype,{duration:{get:function(){return this._duration}},endOverallPosition:{get:function(){return this.startOverallPosition+this.duration}}}),HLSRollItem.prototype.containsOverallPosition=function(e){return this.startOverallPosition<=e&&this.endOverallPosition>e};var MediaPlaylist=function(){};MediaPlaylist.prototype.RANGE_OPTIONS=to,Object.defineProperties(MediaPlaylist.prototype,{eventData:{get:function(){}}}),MediaPlaylist.prototype.getItem=function(e,t){},MediaPlaylist.prototype.getItems=function(e,t){};var wo=kn.attachDelegate,Ro=kn.copyKeysAndValues,Oo=kn.extend,Co=kn.isInteger,HLSVideoPlaylist=function(e){MediaPlaylist.apply(this,arguments),this._startPosition=e,this._mainFeatureMetricsData=Ro.apply(null,[!1,!1,!1,null].concat(Array.prototype.slice.call(arguments,1))),this._rollItems=[]};(HLSVideoPlaylist.prototype=new MediaPlaylist).constructor=HLSVideoPlaylist,HLSVideoPlaylist.prototype.setDelegate=function(e){return wo(this,e)},HLSVideoPlaylist.prototype.addRollInfoItems=function(e){e&&e.length&&e.forEach((function(e){this.addRollInfoItem(e)}),this)},HLSVideoPlaylist.prototype.addRollInfoItem=function(e){e&&this.addRollItem(1e3*e.start,1e3*e.duration,e.metricsData)},HLSVideoPlaylist.prototype.addRollItem=function(e,t){var i=new HLSRollItem(e,t);i.updateData.apply(i,Array.prototype.slice.call(arguments,2)),this._addRollItem(i)},HLSVideoPlaylist.prototype.updateMainFeatureMetricsData=function(){Oo.apply(null,[this._mainFeatureMetricsData].concat(Array.prototype.slice.call(arguments)))},HLSVideoPlaylist.prototype.getItem=function(e,t){var i,r=this._indexOfLastRollItemWithStartBeforePosition(e);if(Co(r)){for(;t!=this.RANGE_OPTIONS.INCLUDES_START_POSITIONS&&this._rollItems[r].startOverallPosition==e&&r>0;)r--;(i=this._rollItems[r]).containsOverallPosition(e)||t==this.RANGE_OPTIONS.INCLUDES_END_POSITIONS&&i.endOverallPosition==e||(i=this._mainFeatureItemWithStartOverallPosition(i.endOverallPosition))}else i=this._mainFeatureItemWithStartOverallPosition(this._startPosition);return i},HLSVideoPlaylist.prototype.getItems=function(e,t){var i=[];if(this._rollItems.length){var r=this._indexOfLastRollItemWithStartBeforePosition(e);for(Co(r)||(i.push(this._mainFeatureItemWithStartOverallPosition(this._startPosition)),r=0);r<this._rollItems.length;){var s=this._rollItems[r];if(s.startOverallPosition>t)break;if(s.endOverallPosition>=e&&i.push(s),r++,s.endOverallPosition<t)if(r<this._rollItems.length){var n=this._rollItems[r];n.startOverallPosition&&n.startOverallPosition>s.endOverallPosition&&i.push(this._mainFeatureItemWithStartOverallPosition(s.endOverallPosition))}else i.push(this._mainFeatureItemWithStartOverallPosition(s.endOverallPosition))}}else i.push(this._mainFeatureItemWithStartOverallPosition(this._startPosition));return i},HLSVideoPlaylist.prototype._addRollItem=function(e){if(e){var t=this._insertionIndexForItemWithPosition(e.startOverallPosition);this._rollItems.splice(t,0,e)}},HLSVideoPlaylist.prototype._indexOfLastRollItemWithStartBeforePosition=function(e){var t,i=this._rollItems[0];return i&&Co(e)&&i.startOverallPosition<=e&&(t=this._insertionIndexForItemWithPosition(e)-1),t},HLSVideoPlaylist.prototype._insertionIndexForItemWithPosition=function(e){for(var t=0,i=this._rollItems.length;t<i;){var r=Math.floor((t+i)/2);this._rollItems[r].startOverallPosition>e?i=r:t=r+1}return t},HLSVideoPlaylist.prototype._mainFeatureItemWithStartOverallPosition=function(e){var t=new MediaPlaylistItem(e);return t.startPosition=this._featurePlayheadProgress(e),t.updateData(this._mainFeatureMetricsData),t},HLSVideoPlaylist.prototype._featurePlayheadProgress=function(e){e=e||0;var t,i,r=this._indexOfLastRollItemWithStartBeforePosition(e),s=this._startPosition||0;Co(r)||(r=-1);for(var n=r;n>=0;n--)t=this._rollItems[n],0===n?s+=t.startOverallPosition:(i=this._rollItems[n-1],s+=t.startOverallPosition-i.endOverallPosition);return s};var Mo=Object.freeze({__proto__:null,createTracker:function(e){var t=new MediaActivityTracker(e);return t.updateData.apply(t,Array.prototype.slice.call(arguments,1)),t},createHLSVideoPlaylist:function(e){var t=new HLSVideoPlaylist(e);return t.updateMainFeatureMetricsData.apply(t,Array.prototype.slice.call(arguments,1)),t}});var Do=Object.freeze({__proto__:null,applyFieldsMap:function(e,t){var i=Config.value("fieldsMap",topic());return Mn.applyFieldsMap(e,t,i)}}),No=Object.freeze({__proto__:null,eventFields:Do}),Lo=kn.setDelegates,xo=kn.attachMethods,Uo=kn.copyDelegatedFunctions,Fo=An.metricsDisabledOrBlacklistedEvent,jo=An.removeBlacklistedFields;function PlayActivity(){this.config=Config.defaultConfig(),this._initCalled=!1}PlayActivity.prototype._utReset=function(){this.config=Config.defaultConfig(),this._initCalled=!1},PlayActivity.prototype.init=function(e,t,i,r,s){if(!this._initCalled){this._initCalled=!0,i&&(Lo(fo,i),Lo(ao,i)),function(e){Ra=e}(e);var n=Config.getConfig(e),a={metricsDisabledOrBlacklistedEvent:Fo,removeBlacklistedFields:jo};xo(n,a,n),xo(Config,a,Config),Uo(this.config,n),n.setDebugSource(this.config.debugSource()),n.init(t,r,s),this.config=n}},PlayActivity.prototype.system=ao,PlayActivity.prototype.eventHandlers=fo,PlayActivity.prototype.mediaActivityTracker=Mo,PlayActivity.prototype.utils=No;var Bo=new PlayActivity;const Ko={"ac-3":"AC3","mp4a.a5":"AC3",alac:"Apple Lossless","ec-3":"EC3","mp4a.a6":"EC3",flac:"Free Lossless","mp4a.40.2":"AAC","mp4a.40.5":"AAC","mp4a.40.29":"AAC","mp4a.40.34":"MP3","mp4a.40.42":"AAC"},$o=/^[0-9]+\/JOC$/,isAtmos=(e,t)=>"EC3"===Ko[e]&&(e=>$o.test(e))(t),Vo=["dvh1.05.01","dvhe.05.06"],Wo={PQ:"HDR",HLG:"HDR",SDH:"SDH"},convertToVideoColorRange=(e,t)=>(e=>-1!==Vo.indexOf(e))(e)?"DolbyVision":(e=>{var t;return null!==(t=Wo[e])&&void 0!==t?t:e})(t),Ho={initial:"idle",states:{idle:{on:{PLAY:{target:"playing",context:{reason:"PLAY",manual:"MANUAL"}}}},binging:{on:{PLAY:{target:"playing",context:{reason:"NEXT",manual:"~~previous~~"}}}},playing:{on:{BUFFER_START:{target:"buffering",context:{reason:"BUFFERING",manual:"AUTOMATIC"}},EXIT:{target:"idle",context:{reason:"EXIT"}},PAUSE:{target:"paused",context:{reason:"PAUSE"}},STOP:{target:"idle",context:{}},NEXT:{target:"binging",context:{reason:"NEXT"}},NEW:{target:"idle",context:{}}}},paused:{on:{PLAY:{target:"playing",context:{reason:"UNPAUSE"}},NEW:{target:"idle",context:{}}}},buffering:{on:{BUFFER_STOP:{target:"playing",context:{reason:"BUFFERING",manual:"AUTOMATIC"}}}}}},zo={manual:"UNKNOWN",reason:"UNKNOWN"};class VPAFStateMachine{constructor(){this.currentState=Ho.initial,this.currentContext=zo}isAllowedTransition(e){return void 0!==this.getNextState(e)}transition(e,t={}){const i=this.getNextState(e);if(!i)return;const r={};return hasOwn(t,"manual")&&(void 0!==t.manual?r.manual=t.manual?"MANUAL":"AUTOMATIC":r.manual="UNKNOWN"),void 0!==t.reason&&(r.reason=t.reason),this.currentContext=Object.assign(Object.assign(Object.assign(Object.assign({},zo),i.context),r),this.preservePreviousContext(i.context)),this.currentState=i.target,this.currentContext}reset(){this.currentState=Ho.initial,this.currentContext=zo}getNextState(e){return Ho.states[this.currentState].on[e]}preservePreviousContext(e){const t={};return["manual","reason","reasonType"].forEach(i=>{"~~previous~~"===e[i]&&(t[i]=this.currentContext[i])}),t}}const qo={[He.playbackPause]:"PAUSE",[He.playbackPlay]:"PLAY",[He.playbackStop]:"STOP",[He.playerExit]:"EXIT"},Yo={[Xe.EXITED_APPLICATION]:"EXIT",[Xe.FAILED_TO_LOAD]:"FAILURE",[Xe.MANUALLY_SELECTED_PLAYBACK_OF_A_DIFF_ITEM]:"PLAY_OTHER",[Xe.NATURAL_END_OF_TRACK]:"COMPLETE",[Xe.PLAYBACK_PAUSED_DUE_TO_INACTIVITY]:"INACTIVITY",[Xe.SCRUB_BEGIN]:"SEEK",[Xe.TRACK_SKIPPED_BACKWARDS]:"SEEK",[Xe.TRACK_SKIPPED_FORWARDS]:"SEEK",[ls.NEXT_ITEM]:"NEXT"},Go={captions:"closedCaptionLocale",subtitles:"subtitleLocale"},Qo={[e.PresentationMode.pictureinpicture]:"pictureInPicture",[e.PresentationMode.inline]:"foreground",_default:"foreground"},Xo=createLocalStorageFlag("mk-linear-scrubbing-enabled"),isLinearScrubbingEnabled=()=>Xo.json();function asMilliseconds(e){return Math.round(1e3*e)}function ensurePositionData(e,t){if((null==t?void 0:t.isLinearStream)&&isLinearScrubbingEnabled()){if(void 0===e.playingDate)throw new Error('VPAFTrackerAPI: The property `playingDate` is required on data for "linear" content');return e}if(void 0===e.position)throw new Error('VPAFTrackerAPI: The property `position` is required on data "vod" content');return e}class VPAFTrackerAPI{constructor(){this.isScrubbing=!1,this.vpafKitInited=!1,this.lastTrackedEvent=void 0,this.state=new VPAFStateMachine,Bo.config.setDelegate({configHostname:()=>"daf.xp.apple.com"})}get currentItem(){return this._currentItem}set currentItem(e){this._currentItem=e,this.currentSkipItems=e?parseSkipItems(e):void 0}configure(e,t){var i,r;return __awaiter$1(this,void 0,void 0,(function*(){if(this.instance=e,this.dispatcher=t.services.dispatcher,!Qr.storekit.cid)try{yield Qr.storekit.infoRefresh()}catch(n){}const s=null===(r=null===(i=t.services.apiManager)||void 0===i?void 0:i.utsAPI)||void 0===r?void 0:r.config;return new Promise((e,t)=>{let i=[];navigator.languages?i=navigator.languages:navigator.language?i=[navigator.language]:navigator.userLanguage&&(i=[navigator.userLanguage]);const onSuccess=()=>(Bo.system.environment.setDelegate({app:()=>"com.apple.tv",appVersion:()=>"1.0",consumerId:()=>Qr.storekit.cid,consumerNs:()=>"TV",isOffline:()=>!1,delegateApp:()=>"web-tv-player",osLanguages:()=>i,resourceRevNum:()=>Yr.app.build,storeFrontCountryCode(){var e,t;return null!==(t=null===(e=null==s?void 0:s.userProps)||void 0===e?void 0:e.country)&&void 0!==t?t:""}}),this.setupListeners(),this.vpafKitInited=!0,e(this));if(this.vpafKitInited)return onSuccess();const r={environment:ma,eventRecorder:ga};Bo.init("xp_amp_tv_vpaf",null,r,onSuccess,e=>{t(e)})})}))}cleanup(){this.tracker=void 0,this.isScrubbing=!1,this.scrubStopPosition=void 0,this.teardownListeners(),this.stopSynchronizing()}shouldConfigure(e){return __awaiter$1(this,void 0,void 0,(function*(){return!0}))}shouldTrackPlayActivity(e,t){if(!t)return!1;const i=t.defaultPlayable;if(!i||!i.vpafMetrics)return!1;const r=qo[e];return void 0===r||this.state.isAllowedTransition(r)}activate(e={}){return Promise.resolve()}bufferStart(e,t){var i;return __awaiter$1(this,void 0,void 0,(function*(){if(void 0!==this.currentItem&&this.isCurrentItem(e)||(yield this.play(e,t)),!(yield this.shouldTrack(e)))return;if("seek"===(null===(i=this.lastTrackedEvent)||void 0===i?void 0:i.reason))return;const r=this.calculatePlaybackPosition(e,ensurePositionData(t,e));this.state.transition("BUFFER_START"),this.trackEvent("playStopped",r)}))}bufferEnd(e,t){var i;return __awaiter$1(this,void 0,void 0,(function*(){if(!(yield this.shouldTrack(e)))return;if("seek"===(null===(i=this.lastTrackedEvent)||void 0===i?void 0:i.reason))return;const r=this.calculatePlaybackPosition(e,ensurePositionData(t,e));this.state.transition("BUFFER_STOP"),this.trackEvent("playStarted",r)}))}exit(e={}){return __awaiter$1(this,void 0,void 0,(function*(){(yield this.shouldTrack())&&(this.state.transition("EXIT"),this.trackEvent("playStopped",this.calculatePlaybackPosition(void 0,ensurePositionData(e,e.item))),this.stopSynchronizing())}))}pause(e,t={}){return __awaiter$1(this,void 0,void 0,(function*(){const i=this.calculatePlaybackPosition(e,ensurePositionData(t,e));if(!(yield this.shouldTrack(e)))return;const r=t.endReasonType===ls.NEXT_ITEM?"NEXT":"PAUSE";this.state.transition(r,this.getExplicitStateContext(t)),this.trackEvent("playStopped",i)}))}play(e,t={}){return __awaiter$1(this,void 0,void 0,(function*(){if(!(yield this.shouldTrack(e)))return;const i=this.calculatePlaybackPosition(e,Object.assign({position:0},t));this.state.transition("PLAY",this.getExplicitStateContext(t)),this.trackEvent("playStarted",i)}))}scrub(e,t={}){return __awaiter$1(this,void 0,void 0,(function*(){if(void 0===e||void 0===t.position)return;const i=this.calculatePlaybackPosition(e,ensurePositionData(t,e));this.isScrubbing&&void 0===t.endReasonType?this.scrubStopPosition=i:this.isScrubbing&&this.scrubEnd(e,i)}))}seek(e,t={}){return __awaiter$1(this,void 0,void 0,(function*(){if(void 0===e)return;if(e.isLinearStream){if(!isLinearScrubbingEnabled())return;if(void 0===t.playingDate||void 0===t.startPlayingDate)return}else if(!e.isLinearStream&&(void 0===t.position||void 0===t.startPosition))return;if(this.isSkippingIntro(t)||this.isSeekingInterval(t)){const i=t,r={},s=this.getSkipActionName(i.position);return this.isSkippingIntro(i)&&"string"==typeof s&&(r.actionName=s),this.trackSeekStart(e,Object.assign(Object.assign({},t),{position:t.startPosition,playingDate:t.startPlayingDate}),r),void this.trackSeekStop(e,t,r)}const i=e.isLinearStream?t.playingDate.getTime():asMilliseconds(t.position),r=e.isLinearStream?t.startPlayingDate.getTime():asMilliseconds(t.startPosition);yield this.scrubStart(e,r),this.scrubEnd(e,i)}))}skip(e,t={}){return Promise.resolve()}stop(e,t={}){return __awaiter$1(this,void 0,void 0,(function*(){if(!(yield this.shouldTrack(e)))return;const i=this.calculatePlaybackPosition(e,ensurePositionData(t,e));this.state.transition("STOP",this.getExplicitStateContext(t)),this.trackEvent("playStopped",i),this.stopSynchronizing()}))}calculatePlaybackPosition(e,t){var i;if(null==e?void 0:e.isLinearStream){if(!isLinearScrubbingEnabled())return Date.now();if(void 0===t.playingDate)throw new Error("VPAF: Can't report playback position for linear stream without playingDate value");return t.playingDate.getTime()}return asMilliseconds(null!==(i=t.position)&&void 0!==i?i:0)}calculateOverallLength(e,t,i){const r=parseFloat(e.hlsMetadata["feature.duration"]);if(isNaN(r))return asMilliseconds(t.duration);return asMilliseconds(i.reduce((e,t)=>e+t.duration,r))}createTracker(e){return __awaiter$1(this,void 0,void 0,(function*(){if(void 0===e||this.isCurrentItem(e))return;this.state.transition("NEW"),this.currentItem=e;const t=e.defaultPlayable;if(void 0===t)return;const i=this.getMainFeatureData(e,t),r=this.transformRollItems(e);zr.debug("VPAF: Creating HLS Playlist",i);const s=Bo.mediaActivityTracker.createHLSVideoPlaylist(0,i);zr.debug("VPAF: adding roll items",r),s.addRollInfoItems(r);const n=Bo.utils.eventFields.applyFieldsMap(t,"utsVpafPlayable"),a=Bo.utils.eventFields.applyFieldsMap(e.attributes,"utsVpafContent"),o=Object.assign(Object.assign(Object.assign({},t.vpafMetrics),this.getAdditionalTrackingData(e,t)),{overallLength:this.calculateOverallLength(e,t,r),featureAssetId:i.assetId});return zr.debug("VPAF: creating tracker with",[n,a,o]),this.tracker=Bo.mediaActivityTracker.createTracker(s,n,a,o),this.startSynchronizing(),this.tracker}))}getCurrentAudioSelection(){var e,t,i,r;const s=null===(t=null===(e=this.instance)||void 0===e?void 0:e.currentAudioTrack)||void 0===t?void 0:t.language;if(void 0===s)return;const n="description"===(null===(r=null===(i=this.instance)||void 0===i?void 0:i.currentAudioTrack)||void 0===r?void 0:r.kind)?"audioDescriptionLocale":"audioLocale";return{[n]:s,["audioLocale"===n?"audioDescriptionLocale":"audioLocale"]:void 0}}getMainFeatureData(e,t){var i;const r=null===(i=null==e?void 0:e.hlsMetadata)||void 0===i?void 0:i["feature.adam-id"],s={url:e.attributes.url,assetId:r};return e.isLinearStream||(s.assetPlacement="feature"),!0===e.attributes.isAdultContent&&(s.sensitiveContentType="adult"),s}transformRollItems(e){return parseRollItems(e).map(e=>({start:e.start,duration:e.duration,metricsData:{assetPlacement:e.type.replace("-",""),assetId:e["adam-id"],isSkippable:e.skippable}}))}getMappedStopReason(e){if(void 0!==e.endReasonType)return Yo[e.endReasonType]}getExplicitStateContext(e){return{manual:e.userInitiated,reason:this.getMappedStopReason(e)}}handleLevelUpdated(e,t){var i;const{level:r,channels:s}=t;if(!r)return;const{audioCodec:n,videoRange:a,videoCodec:o}=r;if(!(n&&s||a&&o))return;const l={};n&&s&&(l.audioFormat=((e,t)=>{var i,r;const s=null!==(i=null==e?void 0:e.toLowerCase())&&void 0!==i?i:"";return isAtmos(s,t)?"Atmos":null!==(r=Ko[s])&&void 0!==r?r:e})(n,s)),a&&o&&(l.videoColorRange=convertToVideoColorRange(o,a)),null===(i=this.tracker)||void 0===i||i.updateData(l)}handleAudioTrackChange(){const{tracker:e}=this;if(void 0===e)return;const t=this.getCurrentAudioSelection();t&&e.updateData(t)}handleForcedTextTrackChange(e,t){var i;null===(i=this.tracker)||void 0===i||i.updateData({forcedSubtitleLocale:null==t?void 0:t.language})}handlePresentationModeChange(e,{mode:t}){var i,r;const s=null!==(i=Qo[t])&&void 0!==i?i:Qo._default;null===(r=this.tracker)||void 0===r||r.updateData({playbackFocus:s})}handleTargetWirelessChange(){var e;null===(e=this.tracker)||void 0===e||e.updateData({delegatedPlayback:this.getDelegatedPlayback()})}handleTextTrackChange(){var e;const{tracker:t}=this;if(void 0===t)return;const i=null===(e=this.instance)||void 0===e?void 0:e.currentTextTrack;if(!i||"captions"!==i.kind&&"subtitles"!==(null==i?void 0:i.kind))return;const r=""===i.language?void 0:i.language,s={closedCaptionLocale:"captions"===i.kind?r:void 0,subtitleLocale:"subtitles"===i.kind?r:void 0};t.updateData(s)}isSkippingIntro(t){return t.seekReasonType===e.SeekReasonType.SkipIntro}isSeekingInterval(t){return t.seekReasonType===e.SeekReasonType.Interval}shouldTrack(e){return __awaiter$1(this,void 0,void 0,(function*(){return yield this.createTracker(e),void 0!==this.tracker}))}isCurrentItem(e){return void 0!==this.currentItem&&void 0!==e&&this.currentItem.id===e.id}getAdditionalTrackingData(e,t){var i,r,s;const{instance:n}=this,a=null===(i=null==n?void 0:n.videoContainerElement)||void 0===i?void 0:i.querySelector("video"),o=null===(r=t.primaryLocale)||void 0===r?void 0:r.locale,l=null!==(s=this.getCurrentAudioSelection())&&void 0!==s?s:void 0!==o?{audioLocale:o}:{},d=null==n?void 0:n.currentTextTrack,c={programmingType:e.isLinearStream?"live":"videoOnDemand",downloadState:"streaming",videoViewportHeight:null==a?void 0:a.clientHeight,videoViewportWidth:null==a?void 0:a.clientWidth,playbackFocus:Qo._default,delegatedPlayback:this.getDelegatedPlayback()};if(d){const e=Go[d.kind];e&&d.language&&(c[e]=d.language)}return Object.assign(Object.assign({},c),l)}getDelegatedPlayback(){var e;return(null===(e=this.instance)||void 0===e?void 0:e.playbackTargetIsWireless)?"Airplay":"None"}getSkipActionName(e){var t;const i=(null!==(t=this.currentSkipItems)&&void 0!==t?t:[]).find(t=>t.target===e);return null==i?void 0:i.label}onVideoComponentScrubStart(e){return this.scrubStart(this.currentItem,asMilliseconds(e.detail.currentSeconds))}setupListeners(){void 0!==this.dispatcher&&(this.dispatcher.subscribe(Hr.audioTrackChanged,this.handleAudioTrackChange),this.dispatcher.subscribe(Hr.textTrackChanged,this.handleTextTrackChange),this.dispatcher.subscribe(Hr.forcedTextTrackChanged,this.handleForcedTextTrackChange),this.dispatcher.subscribe(He.hlsLevelUpdated,this.handleLevelUpdated),this.dispatcher.subscribe(Hr.playbackTargetIsWirelessDidChange,this.handleTargetWirelessChange),this.dispatcher.subscribe(Hr.presentationModeDidChange,this.handlePresentationModeChange)),ke||window.addEventListener("triggerSeekStart",this.onVideoComponentScrubStart)}teardownListeners(){void 0!==this.dispatcher&&(this.dispatcher.unsubscribe(Hr.audioTrackChanged,this.handleAudioTrackChange),this.dispatcher.unsubscribe(Hr.textTrackChanged,this.handleTextTrackChange),this.dispatcher.unsubscribe(Hr.forcedTextTrackChanged,this.handleForcedTextTrackChange),this.dispatcher.unsubscribe(He.hlsLevelUpdated,this.handleLevelUpdated),this.dispatcher.unsubscribe(Hr.playbackTargetIsWirelessDidChange,this.handleTargetWirelessChange),this.dispatcher.unsubscribe(Hr.presentationModeDidChange,this.handlePresentationModeChange)),ke||window.removeEventListener("triggerSeekStart",this.onVideoComponentScrubStart)}scrubEnd(e,t){this.trackEvent("seekStopped",t,this.tracker.TYPE.MANUAL,this.tracker.SEEK_STOP_REASON.SCRUB),"playing"===this.state.currentState&&(this.trackEvent("playStopped",this.scrubStopPosition,this.tracker.TYPE.AUTOMATIC,this.tracker.PLAY_STOP_REASON.SEEK),this.trackEvent("playStarted",t,this.tracker.TYPE.AUTOMATIC,this.tracker.PLAY_START_REASON.SEEK)),this.isScrubbing=!1,this.scrubStopPosition=void 0}scrubStart(e,t){return __awaiter$1(this,void 0,void 0,(function*(){(yield this.shouldTrack(e))&&(this.isScrubbing=!0,this.scrubStopPosition=t,this.trackEvent("seekStarted",t,this.tracker.TYPE.MANUAL,this.tracker.SEEK_START_REASON.SCRUB))}))}startSynchronizing(){void 0===this.synchronizeTimeout&&(this.synchronizeTimeout=setInterval(this.synchronize,6e4))}stopSynchronizing(){void 0!==this.synchronizeTimeout&&(clearInterval(this.synchronizeTimeout),this.synchronizeTimeout=void 0)}synchronize(){if(void 0===this.tracker||void 0===this.instance)return void this.stopSynchronizing();const e="paused"===this.state.currentState,{playbackRate:t,currentPlaybackTime:i}=this.instance,r=e?0:t,s=Math.round(1e3*i);zr.debug(`VPAF: synchronize rate: ${r} and current time: ${s}`),this.tracker.synchronize(r,s)}trackSeekStart(t,i,r={}){const s=i.seekReasonType===e.SeekReasonType.SkipIntro?this.tracker.SEEK_START_REASON.SKIP_INTRO:this.tracker.SEEK_START_REASON.INTERVAL,n=this.calculatePlaybackPosition(t,ensurePositionData(i,t)),a=this.tracker.TYPE.MANUAL;if(this.trackEvent("seekStarted",n,a,s,r),"playing"===this.state.currentState){const e=this.isSkippingIntro(i)?Object.assign(Object.assign({},r),{stopReasonType:this.tracker.PLAY_STOP_REASON_TYPE.SKIP_INTRO}):r;this.trackEvent("playStopped",n,a,this.tracker.PLAY_STOP_REASON.SEEK,e)}}trackSeekStop(e,t,i={}){const r=this.isSeekingInterval(t)?this.tracker.SEEK_STOP_REASON.INTERVAL:this.tracker.SEEK_STOP_REASON.SKIP_INTRO,s=this.calculatePlaybackPosition(e,ensurePositionData(t,e)),n=this.tracker.TYPE.AUTOMATIC;if(this.trackEvent("seekStopped",s,n,r,i),"playing"===this.state.currentState){const e=this.isSkippingIntro(t)?Object.assign(Object.assign({},i),{startReasonType:this.tracker.PLAY_START_REASON_TYPE.SKIP_INTRO}):i;this.trackEvent("playStarted",s,n,this.tracker.PLAY_START_REASON.SEEK,e)}}trackEvent(e,t,i,r,s){void 0===i&&(i=this.tracker.TYPE[this.state.currentContext.manual]),void 0===r&&(r="playStarted"===e?this.tracker.PLAY_START_REASON[this.state.currentContext.reason]:this.tracker.PLAY_STOP_REASON[this.state.currentContext.reason]),zr.debug("VPAF: "+e,t,i,r,s),this.tracker[e].call(this.tracker,Math.round(t),i,r,s),this.lastTrackedEvent={eventType:e,position:t,type:i,reason:r,namedArgs:s}}}__decorate$1([Bind(),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[Object,Object]),__metadata$1("design:returntype",void 0)],VPAFTrackerAPI.prototype,"handleLevelUpdated",null),__decorate$1([Bind(),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[]),__metadata$1("design:returntype",void 0)],VPAFTrackerAPI.prototype,"handleAudioTrackChange",null),__decorate$1([Bind(),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[Object,Object]),__metadata$1("design:returntype",void 0)],VPAFTrackerAPI.prototype,"handleForcedTextTrackChange",null),__decorate$1([Bind(),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[Object,Object]),__metadata$1("design:returntype",void 0)],VPAFTrackerAPI.prototype,"handlePresentationModeChange",null),__decorate$1([Bind(),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[]),__metadata$1("design:returntype",void 0)],VPAFTrackerAPI.prototype,"handleTargetWirelessChange",null),__decorate$1([Bind(),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[]),__metadata$1("design:returntype",void 0)],VPAFTrackerAPI.prototype,"handleTextTrackChange",null),__decorate$1([Bind(),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[CustomEvent]),__metadata$1("design:returntype",void 0)],VPAFTrackerAPI.prototype,"onVideoComponentScrubStart",null),__decorate$1([Bind(),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[]),__metadata$1("design:returntype",void 0)],VPAFTrackerAPI.prototype,"synchronize",null);const augmentUrlQueryParameters=e=>addQueryParamsToURL(e,{xtrick:!0,webbrowser:!0}),addPlayableToItem=(e,t,i)=>{var r,s,n,a,o;e.type=null!==(s=null!==(r=e.type)&&void 0!==r?r:t.type)&&void 0!==s?s:i,e.attributes=null!==(n=e.attributes)&&void 0!==n?n:{},e.attributes.title=null!==(o=null!==(a=e.attributes.title)&&void 0!==a?a:e.title)&&void 0!==o?o:t.title,delete e.title,((e,t)=>{var i,r,s,n;const a=null!==(s=null!==(r=null===(i=t.assets)||void 0===i?void 0:i.hlsUrl)&&void 0!==r?r:t.hlsUrl)&&void 0!==s?s:null===(n=t.clipAssets)||void 0===n?void 0:n[0].url;e.previews=a?[{url:augmentUrlQueryParameters(a)}]:[]})(e.attributes,t),((e,t)=>{const{assets:i}=t;i&&(i.fpsKeyServerUrl&&(e.keyServerQueryParameters=i.fpsKeyServerQueryParameters,e.keyURLs={"hls-key-cert-url":i.fpsCertificateUrl,"hls-key-server-url":i.fpsKeyServerUrl,"widevine-cert-url":i.wideVineCertificateUrl}),e.assetURL=augmentUrlQueryParameters(i.hlsUrl))})(e,t),e.id||(e.id=generateUUID()),e.playables=[t]},createMediaItem=e=>{var t,i;const r=JSON.stringify(e),s=JSON.parse(r),n=null===(t=s.playables)||void 0===t?void 0:t[0];s.attributes=Object.assign(Object.assign({},null!==(i=s.attributes)&&void 0!==i?i:{}),s),addPlayableToItem(s,n);return new MediaItem(s)},Jo=/^http(?:s)?\:\/\/(?:itunes|(embed\.)?(music|podcasts|tv))\.apple\.com/i,Zo=["allow-forms","allow-popups","allow-same-origin","allow-scripts","allow-storage-access-by-user-activation","allow-top-navigation-by-user-activation"],el=["autoplay *","encrypted-media *","fullscreen *","clipboard-write"],tl=createLocalStorageFlag("mk-generate-swizzle");const il=MKError.errors,rl={mediaApi:{configureFn:(e,t=!1)=>__awaiter$1(void 0,void 0,void 0,(function*(){if(dn&&!t){if(void 0===e.storefrontId||e.storefrontId===dn.storefrontId)return dn;dn.clear()}return dn=new MediaAPIService(e.dispatcher),dn.configure(e)})),apiType:e.SupportedAPIs.MEDIA,allowDefault:!1},utsApi:{configureFn:function(e){return __awaiter$1(this,void 0,void 0,(function*(){const t=new UTSAPIService;return void 0!==e.api?t.api=e.api:yield t.configure(e),t}))},apiType:e.SupportedAPIs.UTS,allowDefault:!0}},createAPIConfiguration=(e,t)=>{var i,r,s,n,a,o,l,d,c,u;const{configureFn:h,apiType:p,allowDefault:y}=rl[e],m=((e,...t)=>{const i={};return Object.keys(e).forEach(r=>{t.includes(r)||(i[r]=e[r])}),i})(null!==(i=t.apiOptions)&&void 0!==i?i:{},"utsApi","mediaApi"),g={apiType:p,configureFn:h,options:{}};if(null===(s=null===(r=t.apiOptions)||void 0===r?void 0:r[e])||void 0===s?void 0:s.api)g.options.api=t.apiOptions[e].api;else{const i=y?m:{};g.options.apiOptions=null!==(u=null!==(c=null!==(o=null===(a=null===(n=t.apiOptions)||void 0===n?void 0:n[e])||void 0===a?void 0:a.configureOptions)&&void 0!==o?o:null===(d=null===(l=t.apiOptions)||void 0===l?void 0:l[e])||void 0===d?void 0:d.apiOptions)&&void 0!==c?c:i)&&void 0!==u?u:{}}return g};class MediaKitInstance extends MKInstance{bingePlay(){var e;return __awaiter$1(this,void 0,void 0,(function*(){const t=null===(e=this.queue)||void 0===e?void 0:e.nextPlayableItem;return t&&(t.bingeWatching=!0),this.play()}))}}e.Events=Hr,e.MKError=MKError,e.MediaKitInstance=MediaKitInstance,e.PlayActivityEndReasonType=ls,e.VideoTypes={movie:!0,musicVideo:!0,musicMovie:!0,trailer:!0,tvEpisode:!0,uploadedVideo:!0,"uploaded-videos":!0,"music-videos":!0,"music-movies":!0,"tv-episodes":!0,Bonus:!0,Episode:!0,Movie:!0,Preview:!0,Promotional:!0,Season:!0,Show:!0,Vod:!0,EditorialVideoClip:!0,RealityVideo:!0,SportingEvent:!0,LiveService:!0},e.__dev=_,e.configure=function(e){return __awaiter$1(this,void 0,void 0,(function*(){e.playActivityAPI=[new VPAFTrackerAPI,new BookmarkAPI],e.realm=2,e.rtcOptions&&e.playActivityAPI.push(new RTCStreamingTracker(e.rtcOptions));return yield configure$3(e,MediaKitInstance,t=>__awaiter$1(this,void 0,void 0,(function*(){var i;const r=[createAPIConfiguration("utsApi",e)];(null===(i=e.apiOptions)||void 0===i?void 0:i.mediaApi)&&r.push(createAPIConfiguration("mediaApi",e)),yield t.configure(r)})))}))},e.createMediaItem=createMediaItem,e.createMediaItemFromPlayable=(e,t="Show")=>{if(Array.isArray(e.playables))return createMediaItem(e);const i=JSON.stringify(e),r=JSON.parse(i),s={id:r.id};addPlayableToItem(s,r,t);return new MediaItem(s)},e.enableMultipleInstances=function(){tn=!0},e.errors=il,e.formatArtworkURL=formatArtworkURL,e.formatMediaTime=function(e,t=":"){const{hours:i,minutes:r}=formattedSeconds(e);e=Math.floor(e%3600%60);const s=[];return i?(s.push(""+i),s.push(r<10?"0"+r:""+r)):s.push(""+r),s.push(e<10?"0"+e:""+e),s.join(t)},e.formattedMediaURL=formattedMediaURL,e.formattedMilliseconds=function(e){return formattedSeconds(e/1e3)},e.formattedSeconds=formattedSeconds,e.generateEmbedCode=function(e,t={height:"450",width:"660"}){var i,r;if(!Jo.test(e))throw new Error("Invalid content url");let s=null!==(i=t.height)&&void 0!==i?i:"450",n=null!==(r=t.width)&&void 0!==r?r:"660";const{kind:a,isUTS:o}=formattedMediaURL(e),l="post"===a||"musicVideo"===a||o;"song"===a||"episode"===a?s="175":l&&(s=""+Math.round(.5625*parseInt(n,10))),s=(""+s).replace(/(\d+)px/i,"$1"),n=(""+n).replace(/^(\d+)(?!px)%?$/i,"$1px");const d=(l?"width:"+n:"width:100%;"+(n?"max-width:"+n:""))+";overflow:hidden;background:transparent;";let c="https://embed.music.apple.com";["podcast","episode"].includes(a)&&!o&&(c="https://embed.podcasts.apple.com"),["movie","episode","season","show"].includes(a)&&o&&(c="https://embed.tv.apple.com");const u=tl.get()||c;return`<iframe ${[`allow="${el.join("; ")}"`,'frameborder="0"',s?`height="${s}"`:"",`style="${d}"`,`sandbox="${Zo.join(" ")}"`,`src="${e.replace(Jo,u)}"`].join(" ")}></iframe>`},e.getHlsJsCdnConfig=getHlsJsCdnConfig,e.getInstance=function(e){if(0!==rn.length)return void 0===e?rn[rn.length-1]:rn.find(t=>t.id===e)},e.getInstances=function(){return rn},e.getPlayerType=getPlayerType,Object.defineProperty(e,"__esModule",{value:!0})}));
